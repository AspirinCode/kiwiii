// https://github.com/mojaie/kiwiii Version 0.14.0. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("lodash"),require("vega")):"function"==typeof define&&define.amd?define(["d3","lodash","vega"],t):e["kw-datagrid"]=t(e.d3,e._,e.vega)}(this,function(e,t,o){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,o=o&&o.hasOwnProperty("default")?o.default:o;var s={defaultFieldProperties:function(e){return e.map(e=>(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),e))},sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id","assay_id","list"].includes(e)?"text":"none"},formatNum:function(t,o){return null==t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(o)(t):t},partialMatch:function(e,t){return null!=t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},URLQuery:function(){const e=window.location.search.substring(1).split("&").map(e=>e.split("="));return t.fromPairs(e)},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const r={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},n={datatable:"nodes",connection:"edges"};function i(e){const t=e.columns.map(e=>("numeric"===e.sort?e.format="numeric":"text"===e.sort?e.format="text":"none"===e.sort&&(e.format="raw"),e));return{id:e.id,name:e.name,dataType:n[e.format],schemaVersion:.8,revision:0,status:r[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function l(e){return{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:e.query,progress:e.progress,execTime:e.execTime,created:e.created,reference:{}}}function a(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}var d={singleToMulti:a,mappingToTable:function(e){const t=e.hasOwnProperty("field")?a(e):e,o={key:t.key,format:"text"};return{fields:s.defaultFieldProperties([o].concat(t.fields)),records:Object.entries(t.mapping).map(e=>{const o={};return o[t.key]=e[0],t.fields.forEach((t,s)=>{o[t.key]=e[1][s]}),o})}},tableToMapping:function(e,t,o=["index"]){const r={created:(new Date).toString(),fields:s.defaultFieldProperties(e.fields.filter(e=>e.key!==t).filter(e=>!o.includes(e.key))),key:t,mapping:{}};return e.records.forEach(e=>{r.mapping[e[t]]=r.fields.map(t=>e[t.key])}),r},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),o=t.shift().split(","),r=o.shift(),n=new Date,i=[],l=[];o.forEach((e,t)=>{""!==e&&(i.push(t),l.push({key:e,format:"text"}))});const a={created:n.toString(),fields:s.defaultFieldProperties(l),key:r,mapping:{}};return t.forEach(e=>{const t=e.split(","),o=t.shift();a.mapping[o]=Array(i.length),i.forEach(e=>{a.mapping[o][e]=t[e]})}),a},apply:function(e,o){const r=o.hasOwnProperty("field")?a(o):o;e.records.filter(e=>r.mapping.hasOwnProperty(e[r.key])).forEach(e=>{r.fields.forEach((t,o)=>{e[t.key]=r.mapping[e[r.key]][o]})}),e.fields=t(e.fields).concat(s.defaultFieldProperties(r.fields)).uniqBy("key").value()}};function c(e,t,o){e.text(s.formatNum(t[o.key],o.d3_format))}function p(e,t,o){e.text(t[o.key])}function u(e,t,o){e.html(t[o.key])}function h(e,t,o){e.append("a").attr("href",`profile.html?compound=${t[o.key]}`).attr("target","_blank").text(t[o.key])}function f(e,t,o){e.append("img").attr("width",180).attr("height",180).attr("src",t[o.key])}function m(e,t,o){e.append("input").attr("type","checkbox").property("checked",t[o.key]).property("disabled",!!o.disabled&&t[o.disabled]).on("click",function(){t[o.key]=this.checked})}function y(e,t,o){e.append("input").attr("type","text").style("width","90%").property("value",t[o.key]).on("change",function(){t[o.key]=this.value})}function g(e,t){e.call(t)}const x={numeric:p,text:p,raw:p,d3_format:c,compound_id:h,assay_id:p,list:p,plot:{plotCell:function(e,t,s){new o.View(o.parse(t[s.key])).initialize(e.node()).run()},plotThumbnail:function(e){return new o.View(o.parse(e)).toImageURL("png")},binaryToDataURI:function(e){return new Promise(t=>{const o=new FileReader;o.onload=(e=>{t(e.target.result)}),o.readAsDataURL(e)})}}.plotCell,image:f,checkbox:m,text_field:y,control:g,svg:u,html:u};var w={d3Format:c,text:p,html:u,compound_id:h,image:f,checkbox:m,textField:y,call:g,rowFactory:function(e){return(t,o)=>{e.forEach(e=>{const s=t.append("div").classed("dg-cell",!0).classed("align-middle",!0).classed("text-truncate",!0).style("display","inline-block").style("width",`${e.width}%`);o.hasOwnProperty(e.key)&&s.call(x[e.format],o,e)})}}};function b(e,t){e.select("input").property("value",t)}function v(e,t){e.select("textarea").property("value",t)}function k(e,t){e.select("input").property("checked",t)}function T(e,t){e.select("input").property("value",t)}var C={textBox:function(e,t,o,s,r){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","text").attr("size",s),e.call(b,r)},updateTextBox:b,textBoxValue:function(e){return e.select("input").property("value")},readonlyBox:function(e,t,o,s){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("input").classed("form-control-plaintext",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","text").property("readonly",!0),e.call(b,s)},textareaBox:function(e,t,o,s,r,n){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("textarea").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("rows",s).attr("placeholder",r).attr("id",t),e.call(v,n)},updateTextareaBox:v,textareaBoxValue:function(e){const t=e.select("textarea").property("value");if(t)return t;const o=e.select("textarea").attr("placeholder");return o||""},textareaBoxLines:function(e){const t=e.select("textarea").property("value");if(t)return t.split("\n").filter(e=>e.length>0);const o=e.select("textarea").attr("placeholder");return o?o.split("\n").filter(e=>e.length>0):[]},checkBox:function(e,t,o,s){const r=e.classed("form-group",!0).classed("form-row",!0).classed("form-check",!0).append("label").classed("form-check-label",!0).classed("col-form-label-sm",!0);r.append("input").classed("form-check-input",!0).attr("type","checkbox").attr("id",t),r.append("span").text(o),e.call(k,s)},updateCheckBox:k,checkBoxValue:function(e){return e.select("input").property("checked")},numberBox:function(e,t,o,s,r,n,i){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","number").attr("min",s).attr("max",r).attr("step",n),e.call(T,i)},updateNumberBox:T,numberBoxValue:function(e){return e.select("input").property("value")},fileInputBox:function(e,t,o,s){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",s).attr("id",t)},fileInputBoxValue:function(e){return e.select("input").property("files")[0]}};function L(t,o){t.select(".dg-body").style("height",`${o.bodyHeight}px`);const s=t.select(".dg-body").selectAll(".dg-row").data(o.recordsToShow(),o.keyFunc);s.exit().remove(),s.enter().append("div").attr("class","dg-row").style("position","absolute").style("width","100%").merge(s).style("height",`${o.rowHeight}px`).each(function(t,s){const r=o.viewportTop+s,n=r*o.rowHeight;e.select(this).style("transform",`translate(0px, ${n}px)`).classed("odd",r%2==0),e.select(this).selectAll(".dg-cell").remove(),e.select(this).call(o.rowFactory(),t,r)})}var O={updateHeader:function(e,t){const o=e.select(".dg-header");o.selectAll(".dg-hcell").remove(),o.selectAll(".dg-hcell").data(t.visibleFields).enter().append("div").classed("dg-hcell",!0).style("display","inline-block").style("width",e=>`${e.width}%`).text(e=>e.name),e.style("width","100%").dispatch("resize");const s=Math.floor(t.currentScrollTop/t.rowHeight);t.setScrollPosition(s),e.call(L,t)},updateRows:L,resizeViewport:function(e,t){e.select(".dg-viewport").style("height",`${t.viewportHeight}px`)}};function P(e,t){const o=e.select(".dg-viewport").node().getBoundingClientRect().top;t.setViewportSize(window.innerHeight-o-5),e.call(O.resizeViewport,t)}return{DatagridState:class{constructor(e){this.data=e,this.visibleFields=null,this.sortedRecords=null,this.filteredRecords=null;const t=this.data.snapshot||{sortOrder:[],filterText:null};this.sortOrder=t.sortOrder||[],this.filterText=t.filterText||null,this.defaultColumnHeight={numeric:40,text:40,none:200},this.scrollBarSpace=20,this.keyFunc=(e=>e.index),this.rowHeight=null,this.contentWidth=null,this.bodyHeight=null,this.viewportHeight=null,this.numViewportRows=null,this.previousNumViewportRows=null,this.viewportTop=null,this.previousVieportTop=null,this.viewportBottom=null,this.currentScrollTop=0,this.fixedViewportHeight=null,this.updateContentsNotifier=null,this.updateFilterNotifier=null,this.rowFactory=(()=>w.rowFactory(this.visibleFields)),this.applyData()}setViewportSize(e){this.viewportHeight=this.fixedViewportHeight||e,this.previousNumViewportRows=this.numViewportRows,this.numViewportRows=Math.ceil(this.viewportHeight/this.rowHeight)+1}setScrollPosition(e){this.previousViewportTop=this.viewportTop,this.viewportTop=e,this.viewportBottom=Math.min(this.viewportTop+this.numViewportRows,this.filteredRecords.length)}setSortOrder(e,t){const o=this.sortOrder.findIndex(e=>e.key),s={key:e,order:t};-1!==o&&this.sortOrder.splice(o,1),this.sortOrder.splice(0,0,s),this.applyOrder(e,t)}setFilterText(e){this.filterText=e,this.applyFilter()}joinFields(e){d.apply(this.data,e),this.applyData()}applyData(){this.visibleFields=this.data.fields.filter(e=>e.visible);const e=this.visibleFields.reduce((e,t)=>e+(t.widthf||1),0);this.visibleFields=this.visibleFields.map(t=>{const o={width:(t.widthf||1)/e*100,height:t.height||this.defaultColumnHeight[s.sortType(t.format)]};return Object.assign(o,t)}),this.rowHeight=this.visibleFields.reduce((e,t)=>e.height>t.height?e:t).height,this.applyOrder()}applyOrder(e,o){if(e)this.sortedRecords=t.orderBy(this.data.records.slice(),[e],[o]);else{const e=this.sortOrder.map(e=>e.key),o=this.sortOrder.map(e=>e.order);e&&(this.sortedRecords=t.orderBy(this.data.records.slice(),e,o))}this.applyFilter()}applyFilter(){if(null===this.filterText)this.filteredRecords=this.sortedRecords.slice();else{const e=this.visibleFields.filter(e=>"none"!==s.sortType(e.format)).map(e=>e.key);this.filteredRecords=this.sortedRecords.filter(t=>e.some(e=>s.partialMatch(this.filterText,t[e])))}this.bodyHeight=this.filteredRecords.length*this.rowHeight}recordsToShow(){return this.filteredRecords.slice(this.viewportTop,this.viewportBottom)}export(){return this.data.id=s.uuidv4(),this.data}},rowFilter:{setFilter:function(e,t){const o=e.classed("row",!0).classed("justify-content-end",!0).append("div").classed("col-5",!0).call(C.textBox,null,"Search",40,null);o.select("label").classed("text-right",!0),o.select("input").on("keyup",function(){t.updateFilterNotifier(C.textBoxValue(o))})}},sort:{setSort:function t(o,r){o.select(".dg-header").selectAll(".dg-hcell").filter(e=>"none"!==s.sortType(e.format)).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",t=>{const s="v"===e.select(`#sort-${t.key}`).text();e.select(`#sort-${t.key}`).text(s?"^":"v"),r.setSortOrder(t.key,s?"desc":"asc"),o.call(O.updateRows,r)}),r.updateContentsNotifier=(()=>{r.applyData(),o.call(O.updateHeader,r).call(t,r)})}},view:{resize:P,datagrid:function(e,t){e.selectAll("div").remove(),e.on("resize",()=>e.call(P,t)),e.append("div").classed("dg-header",!0),e.append("div").classed("dg-viewport",!0).style("overflow-y","auto").on("scroll",function(){const o=Math.floor(this.scrollTop/t.rowHeight);t.currentScrollTop=this.scrollTop,o!==t.previousViewportTop&&(t.setScrollPosition(o),e.call(O.updateRows,t))}).append("div").classed("dg-body",!0).style("position","relative"),t.updateContentsNotifier=(()=>{t.applyData(),e.call(O.updateHeader,t)}),t.updateFilterNotifier=(o=>{t.setFilterText(o),t.setScrollPosition(0),e.call(O.updateRows,t),e.select(".dg-viewport").node().scrollTop=0}),t.updateContentsNotifier()}},legacy:{convertTable:function(e){let t=e;return t.hasOwnProperty("schemaVersion")||t.hasOwnProperty("$schema")||(t=i(t)),"0.8"==t.schemaVersion&&(t=l(t=function(e){return e.records.forEach((e,t)=>{e.index=t,e.structure=e._structure,delete e._index,delete e._structure}),e.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")}),e}(t))),t.hasOwnProperty("$schema")||(delete t.schemaVersion,delete t.revision,t.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),t.fields.forEach(e=>{"structure"===e.key&&(e.format="svg"),delete e.width,delete e.height}),t},convertNetwork:function(t){let o=t;return o.edges.hasOwnProperty("schemaVersion")||o.edges.hasOwnProperty("$schema")||(o.nodes=i(o.nodes),o.edges=function(e,t){const o={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(o.nodeColor.id=e.snapshot.nodeColor.id,o.nodeColor.scale=e.snapshot.nodeColor.scale,o.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):o.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(o.nodeSize.id=e.snapshot.nodeSize.id,o.nodeSize.scale=e.snapshot.nodeSize.scale,o.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):o.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(o.nodeLabel.id=e.snapshot.nodeLabel.id,o.nodeLabel.size=e.snapshot.nodeLabel.size,o.nodeLabel.text=e.snapshot.nodeLabel.text,o.nodeLabel.visible=e.snapshot.nodeLabel.visible,o.nodeLabel.scale=e.snapshot.nodeLabel.scale,o.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):o.nodeLabel={id:"label",size:12,text:"index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?o.nodeContent=e.snapshot.nodeContent:o.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?o.edge=e.snapshot.edge:o.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:n[e.format],schemaVersion:.8,revision:0,reference:{nodes:e.nodeTableId},status:r[e.status],fields:s.defaultFieldProperties([{key:"source"},{key:"target"},{key:"weight"}]),records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:o}}(o.edges,o.nodes.fields)),"0.8"!=o.edges.schemaVersion&&.1!==o.edges.schemaVersion||((o=function(e){if(e.edges.hasOwnProperty("reference")||(e.edges.reference={nodes:e.edges.nodesID}),e.nodes.fields.find(e=>"_index"===e.key)){const t={};e.nodes.records.forEach((e,o)=>{e.index=o,e.structure=e._structure,t[e._index]=e.index,delete e._index,delete e._structure}),e.edges.records.forEach(e=>{e.source=t[e.source],e.target=t[e.target]}),e.nodes.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")})}return e}(o)).nodes=l(o.nodes),o.edges=function(t){const o={networkThreshold:t.networkThreshold};return o.nodeContentVisible=t.snapshot.nodeContent.structure.visible,o.nodeColor=t.snapshot.nodeColor.scale||{},o.nodeColor.field&&(o.nodeColor.field=t.snapshot.nodeColor.field.key,"_index"===o.nodeColor.field&&(o.nodeColor.field="index")),"ordinal"===o.nodeColor.scale&&(o.nodeColor.range=e.schemeCategory20),o.nodeSize=t.snapshot.nodeSize.scale||{},t.snapshot.nodeSize.field&&(o.nodeSize.field=t.snapshot.nodeSize.field.key,"_index"===o.nodeSize.field&&(o.nodeSize.field="index")),o.nodeLabel={},t.snapshot.nodeLabel.text&&(o.nodeLabel.text=t.snapshot.nodeLabel.text.key,"_index"===o.nodeLabel.text&&(o.nodeLabel.text="index")),o.nodeLabel.size=t.snapshot.nodeLabel.size,o.nodeLabel.visible=t.snapshot.nodeLabel.visible,o.nodeLabelColor=t.snapshot.nodeLabel.scale||{},t.snapshot.nodeLabel.field&&(o.nodeLabelColor.field=t.snapshot.nodeLabel.field.key,"_index"===o.nodeLabelColor.field&&(o.nodeLabelColor.field="index")),"ordinal"===o.nodeLabelColor.scale&&(o.nodeLabelColor.range=e.schemeCategory20),o.edgeVisible=t.snapshot.edge.visible,o.edgeWidth=t.snapshot.edge.scale||{},o.edgeLabel={},o.edgeLabel.size=t.snapshot.edge.label.size,o.edgeLabel.visible=t.snapshot.edge.label.visible,o.networkThreshold=t.networkThreshold||t.query.threshold,o.coords=t.snapshot.nodePositions,{id:t.id,name:t.name,dataType:t.dataType,schemaVersion:"0.10",revision:t.revision,status:t.status,fields:t.fields,records:t.records,query:{params:t.query},progress:t.progress,execTime:t.execTime,created:t.created,snapshot:o,reference:t.reference}}(o.edges)),o.edges.hasOwnProperty("$schema")||(delete o.nodes.schemaVersion,delete o.edges.schemaVersion,delete o.nodes.revision,delete o.edges.revision,o.nodes.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json",o.edges.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),o}}}});
//# sourceMappingURL=kw-datagrid.js.map
