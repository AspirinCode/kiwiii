// https://github.com/mojaie/kiwiii Version 0.13.1. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("lodash"),require("Dexie")):"function"==typeof define&&define.amd?define(["d3","lodash","Dexie"],t):e.kwcontrol=t(e.d3,e._,e.Dexie)}(this,function(e,t,a){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,a=a&&a.hasOwnProperty("default")?a.default:a;var n={defaultFieldProperties:function(e){return e.map(e=>(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),e))},sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id","assay_id","list"].includes(e)?"text":"none"},formatNum:function(t,a){return null==t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(a)(t):t},partialMatch:function(e,t){return null!=t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},URLQuery:function(){const e=window.location.search.substring(1).split("&").map(e=>e.split("="));return t.fromPairs(e)},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const r={items:"storeID, dataType, created"};let s=new a("Store");s.version(1).stores(r);var o={getAllItems:function(){return s.items.orderBy("created").reverse().toArray()},getItemsByDataType:function(e){return s.items.where("dataType").equals(e).reverse().sortBy("created").catch(t=>{console.error(`IDBError: Unexpected dataType: ${e}`,t)})},getItemByID:function(e){return s.items.where("storeID").equals(e).first().catch(t=>{console.error(`IDBError: Unexpected table ID: ${e}`,t)})},deleteItem:function(e){return s.items.where("storeID").equals(e).delete()},putItem:function(e){return e.storeID||(e.storeID=n.uuidv4()),s.items.put(e)},updateItem:function(e,t){return s.items.where("storeID").equals(e).modify(t).catch(e=>{console.error("IDBError: Update failed",e)})},reset:function(){return s.delete().then(()=>{(s=new a("Store")).version(1).stores(r)})}};const l="";var d={get:function(e,t={}){const a=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${l}${e}${a}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},json:function(e){return e.json()},text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${l}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null}};var c={fetchProgress:function(e,t="update"){return o.getItemByID(e).then(a=>{if(!a)return Promise.reject(`Store: ${e} is not available`);if(!["ready","running"].includes(a.status))return;const r={id:a.reference.workflow,command:t};return d.get("progress",r).then(d.json).then(t=>"failure"===t.status?o.updateItem(e,e=>{e.status="failure"}):o.updateItem(e,e=>{e.status=t.status,e.progress=t.progress,e.execTime=t.execTime,e.fields=n.defaultFieldProperties(t.fields),e.records=t.records}))})}};var i={buttonBox:function(e,t,a,n){e.classed("form-group",!0).classed("mb-1",!0).append("button").classed("btn",!0).classed(`btn-${n}`,!0).classed("btn-sm",!0).attr("id",t).text(a)},menuButton:function(e,t,a,n){e.classed("btn",!0).classed(`btn-${n}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("id",t).text(a)},menuButtonLink:function(e,t,a,n){e.classed("btn",!0).classed(`btn-${n}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("role","button").attr("href","#").attr("id",t).text(a)},menuModalLink:function(e,t,a,n,r){e.classed("btn",!0).classed(`btn-${n}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("id",t).attr("href","#").attr("role","button").attr("data-toggle","modal").attr("data-target",`#${r}`).text(a)},dropdownMenuButton:function(e,t,a,n){e.classed("btn-group",!0).classed("mr-1",!0).attr("id",t),e.append("button").classed("btn",!0).classed(`btn-${n}`,!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown").text(a),e.append("div").classed("dropdown-menu",!0)},dropdownMenuItem:function(e,t,a){e.classed("dropdown-item",!0).attr("id",t).attr("href","#").text(a)},dropdownMenuModal:function(e,t,a,n){e.classed("dropdown-item",!0).attr("id",t).attr("href","#").attr("data-toggle","modal").attr("data-target",`#${n}`).text(a)},dropdownMenuFile:function(t,a,n,r){t.classed("dropdown-item",!0).attr("id",a).attr("href","#").text(n).on("click",function(){e.select(this).select("input").node().click()}).append("form").style("display","none").append("input").attr("type","file").attr("accept",r)},dropdownMenuFileValue:function(e){return e.select("input").node().files[0]}};function u(e,t,a){const r=e.select("thead tr").selectAll("th").data(t);r.exit().remove(),r.enter().append("th").text(e=>e.name),a&&e.call(p,a,e=>e.key,function(e){return(t,a)=>{e.forEach(e=>{const r=a[e.key],s=t.append("td").classed("align-middle",!0);void 0!==r&&("d3_format"===e.format?s.text(n.formatNum(r,e.d3_format)):"plot"===e.format?s.text("[plot]"):"image"===e.format?s.text("[image]"):"control"===e.format?s.call(r):s.text(r))})}}(t))}function p(t,a,n,r){const s=t.select("tbody").selectAll("tr").data(a,n);s.exit().remove(),s.enter().append("tr").merge(s).each(function(t){e.select(this).selectAll("td").remove(),e.select(this).call(r,t)})}var m={render:function(e,t,a,n,r){e.classed("table",!0).classed("table-striped",!0).classed("table-hover",!0).attr("id",t),a&&e.append("caption").text(a),e.append("thead").append("tr"),e.append("tbody"),n&&e.call(u,n,r)},updateHeader:u,updateContents:p};function f(e,t){e.classed("modal",!0).attr("tabindex",-1).attr("role","dialog").attr("aria-labelledby","").attr("aria-hidden",!0).attr("id",t),e.select(".modal-dialog").remove(),e.append("div").classed("modal-dialog",!0).attr("role","document").append("div").classed("modal-content",!0)}var x={confirmDialog:function(t,a,n){const r=t.call(f,a).select(".modal-content");r.append("div").classed("modal-body",!0).append("div").classed("message",!0).text(n);const s=r.append("div").classed("modal-footer",!0);s.append("button").classed("btn",!0).classed("btn-outline-secondary",!0).classed("cancel",!0).attr("type","button").attr("data-dismiss","modal").text("Cancel"),s.append("button").classed("btn",!0).classed("btn-warning",!0).classed("ok",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${a}-submit`).text("OK").on("click",()=>{e.select("#loading-icon").style("display","inline"),t.dispatch("submit")})},submitDialog:function(t,a,n){const r=t.call(f,a).select(".modal-content"),s=r.append("div").classed("modal-header",!0);s.append("h4").classed("modal-title",!0).text(n),s.append("button").attr("type","button").attr("data-dismiss","modal").attr("aria-label","Close").classed("close",!0).append("span").attr("aria-hidden",!0).html("&times;"),r.append("div").classed("modal-body",!0),r.append("div").classed("modal-footer",!0).append("button").classed("btn",!0).classed("btn-primary",!0).classed("submit",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${a}-submit`).text("Submit").on("click",()=>{e.select("#loading-icon").style("display","inline"),t.dispatch("submit")})}};function y(t,a){t.append("td").classed("name",!0).text(a.name),t.append("td").classed("status",!0).text(a.status),t.append("td").classed("size",!0).text(a.records.length);const n=t.append("td").classed("action",!0);n.append("a").call(i.menuButtonLink,null,"Open","primary").attr("href",`${{nodes:"datagrid",edges:"network"}[a.dataType]}.html?id=${a.storeID}`).attr("target","_blank");const r=["running","ready"].includes(a.status);n.append("a").call(i.menuModalLink,null,"Delete","warning","delete-dialog").property("disabled",r).text(r?"Running":"Delete").on("click",()=>{e.select("#delete-dialog").select(".message").text(`Are you sure you want to delete ${a.name} ?`),e.select("#delete-dialog").select(".ok").on("click",()=>o.deleteItem(a.storeID).then(g))})}function g(){d.get("server").then(d.json).catch(()=>(console.info("Server did not respond"),{calc:[]})).then(t=>{const a=n.defaultFieldProperties([{key:"id",name:"Workflow ID",format:"text"},{key:"size",name:"File size",d3_format:".3s"},{key:"status",name:"Status",format:"text"},{key:"created",name:"Created",format:"date"},{key:"expires",name:"Expires",format:"date"}]);e.select("#contents").select(".calc").call(m.updateHeader,a,t.calc.records);const r=n.defaultFieldProperties([{key:"key",name:"Key",format:"text"},{key:"value",name:"Value",format:"text"}]),s=Object.entries(t).filter(e=>"calc"!==e[0]).map(e=>({key:e[0],value:e[1]}));e.select("#contents").select(".server").call(m.updateHeader,r,s)}),o.getItemsByDataType("nodes").then(t=>{e.select("#contents").select(".dg").call(m.updateContents,t,e=>e.storeID,y)}),o.getItemsByDataType("edges").then(t=>{e.select("#contents").select(".nw").call(m.updateContents,t,e=>e.storeID,y)})}return{run:function(){const t=e.select("#menubar");t.append("a").call(i.menuButtonLink,null,"+ New datagrid","primary").attr("href","datagrid.html").attr("target","_blank"),t.append("a").call(i.menuButtonLink,null,"+ New network","primary").attr("href","network.html").attr("target","_blank"),t.append("a").call(i.menuButtonLink,null,"Refresh all","outline-secondary").on("click",()=>o.getAllItems().then(e=>Promise.all(e.map(e=>c.fetchProgress(e.storeID)))).then(g)),t.append("a").call(i.menuModalLink,null,"Reset local datastore","warning","reset-dialog");const a=n.defaultFieldProperties([{key:"name",name:"Name",format:"text"},{key:"status",name:"Status",format:"text"},{key:"size",name:"Records",d3_format:"d"},{key:"action",name:"Action",format:"control"}]),r=e.select("#contents").append("div").classed("py-4",!0);r.append("h5").text("Datagrids on local storage"),r.append("table").classed("dg",!0).call(m.render,null,null,a);const s=e.select("#contents").append("div").classed("py-4",!0);s.append("h5").text("Networks on local storage"),s.append("table").classed("nw",!0).call(m.render,null,null,a);const l=e.select("#contents").append("div").classed("py-4",!0);l.append("h5").text("Server calculation job"),l.append("table").classed("calc",!0).call(m.render);const d=e.select("#contents").append("div").classed("py-4",!0);return d.append("h5").text("Server status"),d.append("table").classed("server",!0).call(m.render),e.select("#dialogs").append("div").call(x.confirmDialog,"reset-dialog","Are you sure you want to delete all local tables and reset the datastore ?").select(".ok").on("click",()=>o.reset().then(g)),e.select("#dialogs").append("div").call(x.confirmDialog,"delete-dialog",null),document.location.protocol,"onLine"in navigator&&navigator.onLine,console.info("Off-line mode is disabled for debugging"),g()}}});
//# sourceMappingURL=kwcontrol.js.map
