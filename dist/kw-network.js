// https://github.com/mojaie/kiwiii Version 1.0.0-alpha.1. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("lodash"),require("Dexie")):"function"==typeof define&&define.amd?define(["d3","lodash","Dexie"],t):e["kw-network"]=t(e.d3,e._,e.Dexie)}(this,function(e,t,l){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,l=l&&l.hasOwnProperty("default")?l.default:l;var o={sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id","assay_id","list"].includes(e)?"text":"none"},formatNum:function(t,l){return null==t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(l)(t):t},partialMatch:function(e,t){return null!=t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},URLQuery:function(){const e=window.location.search.substring(1).split("&").map(e=>e.split("="));return t.fromPairs(e)},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const a={items:"storeID, sessionStarted"};let s=new l("Store");function n(){return s.items.orderBy("sessionStarted").reverse().toArray()}function c(){return n().then(e=>t.flatten(e.map(e=>e.views)))}function r(e,t,l){return n().then(o=>{let a,s;for(let n of o){const o=n[l].findIndex(l=>l[t]===e);if(o>=0){s=n.storeID,a=o;break}}return[s,a]})}function i(){return n().then(e=>t.flatten(e.map(e=>e.dataset)))}function d(e,t){return s.items.where("storeID").equals(e).modify(t).catch(e=>{console.error("IDBError: Update failed",e)})}s.version(1).stores(a);var u={getAllItems:n,getItem:function(e){return s.items.where("storeID").equals(e).first().catch(t=>{console.error(`IDBError: Unexpected table ID: ${e}`,t)})},putItem:function(e){return e.storeID||(e.storeID=o.uuidv4().slice(0,8)),s.items.put(e)},updateItem:d,deleteItem:function(e){return s.items.where("storeID").equals(e).delete()},getAllViews:c,getView:function(e){return c().then(t=>t.find(t=>t.viewID===e))},appendView:function(e,t){return r(e,"viewID","views").then(e=>d(e[0],l=>{l.views.splice(e[1]+1,0,t)}))},updateView:function(e,l){return r(e,"viewID","views").then(e=>d(e[0],o=>{t.isFunction(l)?l(o.views[e[1]]):o.views[e[1]]=l}))},getAllCollections:i,getCollection:function(e){return i().then(t=>t.find(t=>t.collectionID===e))},appendCollection:function(e,t){return r(e,"collectionID","dataset").then(e=>d(e[0],l=>{l.dataset.splice(e[1]+1,0,t)}))},updateCollection:function(e,l){return r(e,"collectionID","dataset").then(e=>d(e[0],o=>{t.isFunction(l)?l(o.dataset[e[1]]):o.dataset[e[1]]=l}))},reset:function(){return s.delete().then(()=>{(s=new l("Store")).version(1).stores(a)})}};const p="";function f(e,t={}){const l=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${p}${e}${l}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))}function h(e){return e.json()}var m={get:f,json:h,text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${p}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null},serverStatus:function(){const e={};return f("server").then(h).then(t=>{e.server=t}).then(()=>f("schema")).then(h).then(t=>{e.schema=t}).then(()=>e)}};function g(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}var x={singleToMulti:g,mappingToTable:function(e){const t=e.hasOwnProperty("field")?g(e):e;return{fields:[{key:t.key,format:"text"}].concat(t.fields),records:Object.entries(t.mapping).map(e=>{const l={};return l[t.key]=e[0],t.fields.forEach((t,o)=>{l[t.key]=e[1][o]}),l})}},tableToMapping:function(e,t,l=["index"]){const o={created:(new Date).toString(),fields:e.fields.filter(e=>e.key!==t).filter(e=>!l.includes(e.key)),key:t,mapping:{}};return e.records.forEach(e=>{o.mapping[e[t]]=o.fields.map(t=>e[t.key])}),o},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),l=t.shift().split(","),o=l.shift(),a=new Date,s=[],n=[];l.forEach((e,t)=>{""!==e&&(s.push(t),n.push({key:e,format:"text"}))});const c={created:a.toString(),fields:n,key:o,mapping:{}};return t.forEach(e=>{const t=e.split(","),l=t.shift();c.mapping[l]=Array(s.length),s.forEach(e=>{c.mapping[l][e]=t[e]})}),c},apply:function(e,l){const o=l.hasOwnProperty("field")?g(l):l;e.records.filter(e=>o.mapping.hasOwnProperty(e[o.key])).forEach(e=>{o.fields.forEach((t,l)=>{e[t.key]=o.mapping[e[o.key]][l]})}),e.fields=t(e.fields).concat(o.fields).uniqBy("key").value()}};class b{constructor(e){this.autoIndex="index",this.collectionID=e.collectionID||null,this.name=e.name||null,this.contents=e.contents||[e],this.fields=[],this.contents.forEach(e=>{e.fields.forEach(e=>this.addField(e))})}addField(e){this.fields.find(t=>t.key===e.key)||(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),this.fields.push(e))}updateFields(e){this.fields=[],e.forEach(e=>this.addField(e))}joinFields(e){this.contents.forEach(t=>{x.apply(t,e)}),e.hasOwnProperty("fields")?e.fields.forEach(e=>this.addField(e)):this.addField(e.field)}records(){return t.flatten(this.contents.map(e=>e.records))}fetch(e){const t=this.contents.filter(e=>["running","ready","interrupted","queued"].includes(e.status)).map(t=>{const l={id:t.workflowID,command:e};return m.get("progress",l).then(m.json).then(e=>"failure"===e.status?u.updateCollection(this.collectionID,e=>{e.contents.find(e=>e.workflowID===l.id).status="failure"}):u.updateCollection(this.collectionID,t=>{const o=t.contents.findIndex(e=>e.workflowID===l.id);t.contents[o]=e}))});return Promise.all(t).then(()=>u.getCollection(this.collectionID)).then(e=>{this.contents=e.contents})}pull(){return this.fetch("pull")}abort(){return this.fetch("abort")}size(){return t.sum(this.contents.map(e=>e.records.length))}status(){return this.contents.some(e=>"interrupted"===e.status)?"interrupted":this.contents.some(e=>"running"===e.status)?"running":this.contents.some(e=>"queued"===e.status)?"queued":this.contents.some(e=>"ready"===e.status)?"ready":this.contents.some(e=>"aborted"===e.status)?"aborted":"done"}ongoing(){return["ready","queued","running","interrupted"].includes(this.status())}progress(){return t.min(this.contents.map(e=>e.progress))}execTime(){return t.sum(this.contents.map(e=>e.execTime))}export(){return{$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:this.collectionID,name:this.name,fields:this.fields,contents:this.contents}}}const y=[{key:"linear",name:"Linear",func:e.scaleLinear()},{key:"log",name:"Log",func:e.scaleLog()},{key:"quantize",name:"Quantize",func:e.scaleQuantize()},{key:"ordinal",name:"Ordinal",func:e.scaleOrdinal()}],w=[{key:"continuous",name:"Continuous",size:2},{key:"two-piece",name:"Two-piece",size:3},{key:"category10",name:"Category 10",size:10,range:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#bc80bd","#ccebc5"],unknown:"#f0f0f0"},{key:"cbsafe",name:"Colorblind safe",size:10,range:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],unknown:"#f0f0f0"},{key:"category20",name:"Category 20",size:20,range:e.schemePaired.concat(e.schemeSet2),unknown:"#f0f0f0"},{key:"category40",name:"Category 40",size:40,range:e.schemePaired.concat(e.schemePastel2,e.schemeSet2,e.schemeSet3),unknown:"#f0f0f0"}];var v={presets:[{key:"activity",name:"Activity",scale:"log",domain:[1e-4,1e-6]},{key:"percent",name:"Percent",scale:"linear",domain:[0,100]},{key:"tf",name:"True/False",scale:"quantize",domain:[1,0]},{key:"mw",name:"MW",scale:"linear",domain:[200,600]},{key:"logp",name:"LogP",scale:"linear",domain:[-2,8]}],types:y,colorPalettes:[{key:"aquamarine",name:"Aquamarine",range:["#778899","#7fffd4"],unknown:"#f0f0f0"},{key:"chartreuse",name:"Chartreuse",range:["#778899","#7fff00"],unknown:"#f0f0f0"},{key:"salmon",name:"Salmon",range:["#778899","#fa8072"],unknown:"#f0f0f0"},{key:"violet",name:"Violet",range:["#778899","#ee82ee"],unknown:"#f0f0f0"},{key:"temperature",name:"Temperature",range:["#87ceeb","#fff5ee","#fa8072"],unknown:"#f0f0f0"},{key:"spectrum",name:"Spectrum",range:["#6495ed","#ccff66","#ffa500"],unknown:"#f0f0f0"}],colorRangeTypes:w,scaleFunction:function(e){let t=y.find(t=>t.key==e.scale).func,l=e.domain;if(3==e.range.length){const t=(parseFloat(e.domain[0])+parseFloat(e.domain[1]))/2;l=[e.domain[0],t,e.domain[1]]}return"ordinal"!==e.scale&&(t=t.domain(l)),t=t.range(e.range),["linear","log"].includes(e.scale)&&(t=t.clamp(!0)),l=>{if(""===l||null==l)return e.unknown;if("ordinal"!==e.scale&&parseFloat(l)!=l)return e.unknown;if("log"===e.scale&&l<=0)return e.unknown;const o=t(l);return void 0===o?e.unknown:o}}};function k(e,t){e.select("input").property("value",t)}function B(e,t){e.select("textarea").property("value",t)}function C(e,t){e.select("input").property("checked",t)}function L(e,t){e.select("input").property("value",t)}function N(e,t){e.select("input").property("value",t)}var z={textBox:function(e,t,l,o,a){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(l),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","text").attr("size",o),e.call(k,a)},updateTextBox:k,textBoxValue:function(e){return e.select("input").property("value")},readonlyBox:function(e,t,l,o){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(l),e.append("input").classed("form-control-plaintext",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","text").property("readonly",!0),e.call(k,o)},textareaBox:function(e,t,l,o,a,s){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(l),e.append("textarea").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("rows",o).attr("placeholder",a).attr("id",t),e.call(B,s)},updateTextareaBox:B,textareaBoxValue:function(e){const t=e.select("textarea").property("value");if(t)return t;const l=e.select("textarea").attr("placeholder");return l||""},textareaBoxLines:function(e){const t=e.select("textarea").property("value");if(t)return t.split("\n").filter(e=>e.length>0);const l=e.select("textarea").attr("placeholder");return l?l.split("\n").filter(e=>e.length>0):[]},checkBox:function(e,t,l,o){const a=e.classed("form-group",!0).classed("form-row",!0).classed("form-check",!0).append("label").classed("form-check-label",!0).classed("col-form-label-sm",!0);a.append("input").classed("form-check-input",!0).attr("type","checkbox").attr("id",t),a.append("span").text(l),e.call(C,o)},updateCheckBox:C,checkBoxValue:function(e){return e.select("input").property("checked")},numberBox:function(e,t,l,o,a,s,n){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(l),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","number").attr("min",o).attr("max",a).attr("step",s),e.call(L,n)},updateNumberBox:L,numberBoxValue:function(e){return e.select("input").property("value")},colorBox:function(t,l,o){t.classed("form-row",!0).classed("align-items-center",!0),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).text(l),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).append("input").classed("form-control",!0).classed("form-control-sm",!0).attr("type","color"),t.call(N,o).on("change",()=>{e.event.stopPropagation()})},updateColorBox:N,colorBoxValue:function(e){return e.select("input").property("value")},fileInputBox:function(e,t,l,o){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(l),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",o).attr("id",t)},fileInputBoxValue:function(e){return e.select("input").property("files")[0]}};function S(e,t){const l=e.select("select").selectAll("option").data(t,e=>e.key);l.exit().remove(),l.enter().append("option").attr("value",e=>e.key).text(e=>e.name)}function V(e,t){e.select("select").property("value",t)}function A(e,t){const l=e.select("ul").selectAll("li").data(t,e=>e.key);l.exit().remove();const o=l.enter().append("li").attr("class","form-check").append("label").attr("class","form-check-label");o.append("input").attr("type","checkbox").attr("class","form-check-input").property("value",e=>e.key),o.append("span").text(e=>e.name)}function T(t,l){l&&t.selectAll("input").each(function(t){e.select(this).property("checked",l.includes(t.key))})}var $={selectBox:function(e,t,l,o,a){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(l),e.append("select").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t),o&&(e.call(S,o),e.call(V,a))},selectBoxItems:S,updateSelectBox:V,selectBoxValue:function(e){return e.select("select").property("value")},checklistBox:function(e,t,l,o,a){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(l),e.append("ul").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t),o&&(e.call(A,o),e.call(T,a))},checklistBoxItems:A,updateChecklistBox:T,checklistBoxValue:function(e){return e.selectAll("input:checked").data().map(e=>e.key)}};function I(e,t){e.select(".min").property("value",t[0]),e.select(".max").property("value",t[1])}function O(e,t){let l;l=2==t.length?[t[0],null,t[1]]:3==t.length?[t[0],t[1],t[2]]:[null,null,null],e.select(".min").property("value",l[0]).property("disabled",null===l[0]).style("opacity",null===l[0]?.3:null),e.select(".mid").attr("value",l[1]).property("disabled",null===l[1]).style("opacity",null===l[1]?.3:null),e.select(".max").property("value",l[2]).property("disabled",null===l[2]).style("opacity",null===l[2]?.3:null)}var F={rangeBox:function(e,t,l,o){e.classed("form-row",!0).classed("align-items-center",!0).attr("id",t),e.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).text(l);const a=e.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0);a.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).attr("for",`${t}-from`).text("min"),a.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("min",!0).attr("type","text").attr("id",`${t}-from`);const s=e.append("div").classed("form-group",!0).classed("col-4",!0).classed("mb-1",!0);s.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).attr("for",`${t}-to`).text("max"),s.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("max",!0).attr("type","text").attr("id",`${t}-to`),e.call(I,o)},updateRangeBox:I,rangeBoxValue:function(e){return[parseFloat(e.select(".min").property("value")),parseFloat(e.select(".max").property("value"))]},colorScaleBox:function(t,l,o,a){t.classed("form-row",!0).classed("align-items-center",!0).attr("id",l),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-3",!0).classed("mb-1",!0).text(o);const s=t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-3",!0).classed("mb-1",!0);s.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).attr("for",`${l}-from`).text("min"),s.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("min",!0).attr("type","color").attr("id",`${l}-from`);const n=t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-3",!0).classed("mb-1",!0);n.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).attr("for",`${l}-mid`).text("mid"),n.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("mid",!0).attr("type","color").attr("id",`${l}-mid`);const c=t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-3",!0).classed("mb-1",!0);c.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).attr("for",`${l}-to`).text("max"),c.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("max",!0).attr("type","color").attr("id",`${l}-to`),t.call(O,a).on("change",()=>{e.event.stopPropagation()})},updateColorScaleBox:O,colorScaleBoxValue:function(e){const t=[];return e.select(".min").property("disabled")||t.push(e.select(".min").property("value")),e.select(".mid").property("disabled")||t.push(e.select(".mid").property("value")),e.select(".max").property("disabled")||t.push(e.select(".max").property("value")),t}};var D={buttonBox:function(e,t,l,o){e.classed("form-group",!0).classed("mb-1",!0).append("button").classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).attr("id",t).text(l)},menuButton:function(e,t,l,o){e.classed("btn",!0).classed(`btn-${l}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("id",o).text(t)},menuButtonLink:function(e,t,l,o,a){e.classed("btn",!0).classed(`btn-${l}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("role","button").attr("href","#").attr("id",a),e.append("img").attr("src",o?`./assets/icon/${o}.svg`:null).style("width","1.25rem").style("height","1.25rem"),e.append("span").style("vertical-align","middle").text(t)},menuModalLink:function(e,t,l,o,a,s){e.classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("id",s).attr("href","#").attr("role","button").attr("data-toggle","modal").attr("data-target",`#${t}`),e.append("img").attr("src",a?`./assets/icon/${a}.svg`:null).style("width","1.25rem").style("height","1.25rem"),e.append("span").classed("label",!0).style("vertical-align","middle").text(l)},dropdownMenuButton:function(e,t,l,o,a){e.classed("btn-group",!0).classed("mr-1",!0).attr("id",a);const s=e.append("button").classed("btn",!0).classed(`btn-${l}`,!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown");s.append("img").attr("src",o?`./assets/icon/${o}.svg`:null).style("width","1.25rem").style("height","1.25rem"),s.append("span").style("vertical-align","middle").text(t),e.append("div").classed("dropdown-menu",!0)},dropdownMenuItem:function(e,t,l,o){e.classed("dropdown-item",!0).attr("id",o).attr("href","#"),e.append("img").attr("src",l?`./assets/icon/${l}.svg`:null).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuModal:function(e,t,l,o,a){e.classed("dropdown-item",!0).attr("id",a).attr("href","#").attr("data-toggle","modal").attr("data-target",`#${l}`),e.append("img").attr("src",`./assets/icon/${o}.svg`).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuFile:function(t,l,o,a,s){t.classed("dropdown-item",!0).attr("id",s).attr("href","#").on("click",function(){e.select(this).select("input").node().click()}),t.append("form").style("display","none").append("input").attr("type","file").attr("accept",o),t.append("img").attr("src",`./assets/icon/${a}.svg`).classed("mr-1",!0).style("width","2rem").style("height","2rem"),t.append("span").text(l)},dropdownMenuFileValue:function(e){return e.select("input").node().files[0]}};function E(t,l,o){t.select(".palette").call($.updateSelectBox,v.colorRangeTypes.find(e=>e.size===l.length).key).on("change",function(){const l=$.selectBoxValue(e.select(this)),o=v.colorPalettes.find(e=>e.key===l),a=v.colorRangeTypes.find(e=>e.size===o.range.length);t.select(".rangetype").call($.updateSelectBox,a.key),t.select(".range").call(F.updateColorScaleBox,o.range)}),t.select(".rangetype").on("change",function(){const l=$.selectBoxValue(e.select(this)),o=v.colorRangeTypes.find(e=>e.key===l).size;t.select(".range").select(".min").property("disabled",o>3).style("opacity",o<=3?null:.3),t.select(".range").select(".mid").property("disabled",3!==o).style("opacity",3===o?null:.3),t.select(".range").select(".max").property("disabled",o>3).style("opacity",o<=3?null:.3)}),t.select(".range").call(F.updateColorScaleBox,l).on("focusin",()=>{t.dispatch("change")}),t.select(".unknown").call(z.updateColorBox,o).on("focusin",()=>{t.dispatch("change")})}function P(t,l,o){t.select(".preset").on("change",function(){const l=$.selectBoxValue(e.select(this)),o=v.presets.find(e=>e.key==l);t.select(".scale").call($.updateSelectBox,o.scale),t.select(".domain").call(F.updateRangeBox,o.domain)}),t.select(".scale").call($.updateSelectBox,l).on("change",()=>{t.select(".domain").dispatch("change")}),t.select(".domain").call(F.updateRangeBox,o).on("change",function(){const l="log"===$.selectBoxValue(t.select(".scale")),o=F.rangeBoxValue(e.select(this)),a=e=>isNaN(e)||l&&e<=0;e.select(this).select(".min").style("background-color",a(o[0])?"#ffcccc":"#ffffff"),e.select(this).select(".max").style("background-color",a(o[1])?"#ffcccc":"#ffffff")})}var R={colorRangeGroup:function(e,t,l,o,a,s){e.classed("mb-3",!0),e.append("div").classed("palette",!0).classed("mb-1",!0).call($.selectBox,`${t}-palette`,"Color palette",l,"hoge"),e.append("div").classed("rangetype",!0).classed("mb-1",!0).call($.selectBox,`${t}-rangetype`,"Range type",o,v.colorRangeTypes.find(e=>e.size===a.length).key),e.append("div").classed("range",!0).classed("mb-1",!0).call(F.colorScaleBox,`${t}-range`,"Range",a),e.append("div").classed("unknown",!0).classed("mb-1",!0).call(z.colorBox,"Unknown",s),e.call(E,a,s)},updateColorRangeGroup:E,colorRangeGroupValue:function(e){const t=$.selectBoxValue(e.select(".rangetype")),l=F.colorScaleBoxValue(e.select(".range")),o=z.colorBoxValue(e.select(".unknown"));return{range:l.length?l:v.colorRangeTypes.find(e=>e.key===t).range,unknown:o}},scaleBoxGroup:function(e,t,l,o,a,s){e.classed("mb-3",!0),e.append("div").classed("preset",!0).classed("mb-1",!0).call($.selectBox,`${t}-preset`,"Scale preset",l,""),e.append("div").classed("scale",!0).classed("mb-1",!0).call($.selectBox,`${t}-scale`,"Scale type",o,a),e.append("div").classed("domain",!0).classed("mb-1",!0).call(F.rangeBox,`${t}-domain`,"Domain",s),e.call(P,a,s)},updateScaleBoxGroup:P,scaleBoxGroupValue:function(e){return{scale:$.selectBoxValue(e.select(".scale")),domain:F.rangeBoxValue(e.select(".domain"))}}};function M(e,t){e.append("div").classed("mb-3",!0).append("div").classed("fit",!0).call(D.buttonBox,"fit-to-screen","Fit to screen","primary");const l=e.append("div").classed("mb-3",!0);l.append("div").classed("focused",!0).classed("mb-1",!0).call(z.checkBox,"focused","Enable focused view",t.enableFocusedView),l.append("div").classed("overlook",!0).classed("mb-1",!0).call(z.checkBox,"overlook","Enable overlook view",t.enableOverlookView);const o=e.append("div").classed("mb-3",!0);o.append("div").classed("thld",!0).classed("mb-1",!0).call(z.numberBox,"thld","Network threshold",t.networkThresholdCutoff,1,.01,t.networkThreshold),o.append("div").classed("logd",!0).classed("mb-1",!0).call(z.readonlyBox,"logd","logD",null);const a=e.append("div").classed("form-group",!0).classed("form-row",!0);a.append("div").classed("col-6",!0).append("span").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("mb-1",!0).text("Temperature"),a.append("div").classed("col-12",!0).append("div").classed("temperature",!0).classed("progress",!0).append("div").classed("progress-bar",!0).classed("w-30",!0).attr("id","temperature").attr("role","progressbar").attr("aria-valuemin",0).attr("aria-valuemax",100),a.append("div").classed("col-12",!0).append("div").classed("stick",!0).classed("mb-1",!0).call(z.checkBox,"stick-nodes","Stick nodes",!t.simulationOnLoad),a.append("div").classed("col-12",!0).append("div").classed("restart",!0).classed("mb-1",!0).call(D.buttonBox,"restart-force","Activate","warning"),e.call(W,t)}function W(t,l){t.select(".snapshot").on("click",function(){l.snapshotNotifier()}),t.select(".fit").on("click",function(){l.fitNotifier()}),t.select(".focused").call(z.updateCheckBox,l.enableFocusedView).on("change",function(){l.enableFocusedView=z.checkBoxValue(e.select(this)),l.focusedView=z.checkBoxValue(e.select(this)),l.updateComponentNotifier()}),t.select(".overlook").call(z.updateCheckBox,l.enableOverlookView).on("change",function(){l.enableOverlookView=z.checkBoxValue(e.select(this)),l.overlookView=z.checkBoxValue(e.select(this)),l.updateComponentNotifier()}),t.select(".thld").call(z.updateNumberBox,l.networkThreshold).on("change",function(){const o=z.numberBoxValue(e.select(this));l.networkThreshold=o,l.updateComponentNotifier(),l.setForceNotifier();const a=l.es.filter(e=>e.weight>=o).length,s=l.ns.length,n=s*(s-1)/2,c=e.format(".2f")(Math.log10(a/n));t.select(".logd").call(z.updateTextBox,c)}).dispatch("change"),l.tickCallback=(e=>{const l=e.alpha(),o=l<=e.alphaMin(),a=parseInt(o?0:100*l);t.select(".temperature").select(".progress-bar").classed("bg-success",o).classed("bg-warning",!o).style("width",`${a}%`).attr("aria-valuenow",a)}),t.select(".stick").call(z.updateCheckBox,!l.simulationOnLoad).on("change",function(){const o=z.checkBoxValue(e.select(this));t.select(".temperature").style("background-color",o?"#a3e4d7":"#e9ecef").select(".progress-bar").style("width","0%").attr("aria-valuenow",0),o?l.stickNotifier():l.relaxNotifier()}),t.select(".restart").on("click",function(){t.select(".stick").call(z.updateCheckBox,!1).dispatch("change"),l.restartNotifier()})}function G(e,t){e.append("div").classed("field",!0).call($.selectBox,"color-field","Field",t.nodes.fields.filter(e=>"none"!==o.sortType(e.format)),t.nodeColor.field||""),e.append("div").classed("range",!0).call(R.colorRangeGroup,"color",v.colorPalettes,v.colorRangeTypes,t.nodeColor.range,t.nodeColor.unknown),e.append("div").classed("scale",!0).call(R.scaleBoxGroup,"color",v.presets,v.types.filter(e=>"ordinal"!==e.key),t.nodeColor.scale,t.nodeColor.domain),e.call(j,t)}function j(t,l){t.select(".field").call($.updateSelectBox,l.nodeColor.field).on("change",function(){l.nodeColor.field=$.selectBoxValue(e.select(this)),l.updateNodeAttrNotifier()}),t.select(".range").call(R.updateColorRangeGroup,l.nodeColor.range,l.nodeColor.unknown).on("change",function(){const o=R.colorRangeGroupValue(e.select(this));l.nodeColor.range=o.range,l.nodeColor.unknown=o.unknown,o.range.length>3?(l.nodeColor.scale="ordinal",t.select(".scale").selectAll("select,input").property("disabled",!0).style("opacity",.3)):t.select(".scale").selectAll("select,input").property("disabled",!1).style("opacity",null),l.updateNodeAttrNotifier()}),t.select(".scale").call(R.updateScaleBoxGroup,l.nodeColor.scale,l.nodeColor.domain).on("change",function(){const t=R.scaleBoxGroupValue(e.select(this));l.nodeColor.scale=t.scale,l.nodeColor.domain=t.domain,l.updateNodeAttrNotifier()})}function q(e,t){e.append("div").classed("field",!0).call($.selectBox,"size-field","Field",t.nodes.fields.filter(e=>"numeric"===o.sortType(e.format)),t.nodeSize.field||""),e.append("div").classed("range",!0).classed("mb-3",!0).call(F.rangeBox,"size-range","Range",t.nodeSize.range),e.append("div").classed("scale",!0).call(R.scaleBoxGroup,"size",v.presets.filter(e=>"ordinal"!==e.scale),v.types.filter(e=>"ordinal"!==e.key),t.nodeSize.scale,t.nodeSize.domain),e.call(J,t)}function J(t,l){t.select(".field").call($.updateSelectBox,l.nodeSize.field).on("change",function(){l.nodeSize.field=$.selectBoxValue(e.select(this)),l.updateNodeAttrNotifier()}),t.select(".range").call(F.updateRangeBox,l.nodeSize.range).on("change",function(){l.nodeSize.range=F.rangeBoxValue(e.select(this)),l.updateNodeAttrNotifier()}),t.select(".scale").call(R.updateScaleBoxGroup,l.nodeSize.scale,l.nodeSize.domain).on("change",function(){const t=R.scaleBoxGroupValue(e.select(this));l.nodeSize.scale=t.scale,l.nodeSize.domain=t.domain,l.updateNodeAttrNotifier()})}function _(e,t){e.append("div").append("div").classed("visible",!0).call(z.checkBox,"label-visible","Show node labels",t.nodeLabel.visible);const l=e.append("div").classed("mb-3",!0);l.append("div").classed("text",!0).classed("mb-1",!0).call($.selectBox,"label-text","Text field",t.nodes.fields.filter(e=>"none"!==o.sortType(e.format)),t.nodeLabel.text||""),l.append("div").classed("size",!0).classed("mb-1",!0).call(z.numberBox,"label-size","Font size",6,100,1,t.nodeLabel.size),e.append("div").classed("field",!0).call($.selectBox,"label-field","Color field",t.nodes.fields.filter(e=>"none"!==o.sortType(e.format)),t.nodeLabelColor.field||""),e.append("div").classed("range",!0).call(R.colorRangeGroup,"label",v.colorPalettes,v.colorRangeTypes,t.nodeLabelColor.range,t.nodeColor.unknown),e.append("div").classed("scale",!0).call(R.scaleBoxGroup,"label",v.presets,v.types.filter(e=>"ordinal"!==e.key),t.nodeLabelColor.scale,t.nodeLabelColor.domain),e.call(U,t)}function U(t,l){t.select(".visible").call(z.updateCheckBox,l.nodeLabel.visible).on("change",function(){l.nodeLabel.visible=z.checkBoxValue(e.select(this)),l.updateNodeAttrNotifier()}),t.select(".text").call($.updateSelectBox,l.nodeLabel.text).on("change",function(){l.nodeLabel.text=$.selectBoxValue(e.select(this)),l.updateNodeAttrNotifier()}),t.select(".size").call(z.updateNumberBox,l.nodeLabel.size).on("change",function(){l.nodeLabel.size=z.numberBoxValue(e.select(this)),l.updateNodeAttrNotifier()}),t.select(".field").call($.updateSelectBox,l.nodeLabelColor.field).on("change",function(){l.nodeLabelColor.field=$.selectBoxValue(e.select(this)),l.updateNodeAttrNotifier()}),t.select(".range").call(R.updateColorRangeGroup,l.nodeLabelColor.range,l.nodeColor.unknown).on("change",function(){const o=R.colorRangeGroupValue(e.select(this));l.nodeLabelColor.range=o.range,l.nodeLabelColor.unknown=o.unknown,o.range.length>3?(l.nodeLabelColor.scale="ordinal",t.select(".scale").selectAll("select,input").property("disabled",!0).style("opacity",.3)):(l.nodeLabelColor.scale=$.selectBoxValue(t.select(".range")),t.select(".scale").selectAll("select,input").property("disabled",!1).style("opacity",null)),l.updateNodeAttrNotifier()}),t.select(".scale").call(R.updateScaleBoxGroup,l.nodeLabelColor.scale,l.nodeLabelColor.domain).on("change",function(){const t=R.scaleBoxGroupValue(e.select(this));l.nodeLabelColor.scale=t.scale,l.nodeLabelColor.domain=t.domain,l.updateNodeAttrNotifier()})}function H(e,t){const l=e.append("div").classed("mb-3",!0);l.append("div").classed("label",!0).classed("mb-1",!0).call(z.checkBox,"edge-label-visible","Show edge weight label",t.edgeLabel.visible),l.append("div").classed("size",!0).classed("mb-1",!0).call(z.numberBox,"edge-label-size","Weight label font size",6,100,1,t.edgeLabel.size);const o=e.append("div").classed("mb-3",!0);o.append("div").classed("range",!0).classed("mb-3",!0).call(F.rangeBox,"edge-width-range","Range",t.edgeWidth.range),o.append("div").classed("scale",!0).classed("mb-1",!0).call($.selectBox,"edge-width-scale","Scale type",v.types.filter(e=>"ordinal"!==e.key),t.edgeWidth.scale),o.append("div").classed("domain",!0).classed("mb-1",!0).call(F.rangeBox,"edge-width-domain","Domain",t.edgeWidth.domain)}function Q(t,l){t.select(".label").call(z.updateCheckBox,l.edgeLabel.visible).on("change",function(){l.edgeLabel.visible=z.checkBoxValue(e.select(this)),l.updateEdgeAttrNotifier()}),t.select(".size").call(z.updateNumberBox,l.edgeLabel.size).on("change",function(){l.edgeLabel.size=z.numberBoxValue(e.select(this)),l.updateEdgeAttrNotifier()}),t.select(".range").call(F.updateRangeBox,l.edgeWidth.range).on("change",function(){l.edgeWidth.range=F.rangeBoxValue(e.select(this)),l.updateEdgeAttrNotifier()}),t.select(".scale").call($.updateSelectBox,l.edgeWidth.scale).on("change",function(){l.edgeWidth.scale=$.selectBoxValue(e.select(this)),l.updateEdgeAttrNotifier()}),t.select(".domain").call(F.updateRangeBox,l.edgeWidth.domain).on("change",function(){l.edgeWidth.domain=F.rangeBoxValue(e.select(this)),l.updateEdgeAttrNotifier()})}function Y(e,t,l){e.append("nav").append("div").classed("nav",!0).classed("nav-tabs",!0).attr("id",t).attr("role","tablist"),e.append("div").classed("tab-content",!0).classed("p-2",!0).attr("id",l)}function X(e,t,l){e.classed("nav-item",!0).classed("nav-link",!0).classed("py-1",!0).attr("id",`${t}-tab`).attr("data-toggle","tab").attr("href",`#${t}`).attr("role","tab").attr("aria-controls",t).attr("aria-selected","false").text(l)}function K(e,t){e.classed("tab-pane",!0).classed("fade",!0).classed("container",!0).classed("px-0",!0).attr("id",t).attr("role","tabpanel").attr("aria-labelledby",`${t}-tab`)}function Z(e,t){e.select(".control-main").call(W,t),e.select(".control-color").call(j,t),e.select(".control-size").call(J,t),e.select(".control-label").call(U,t),e.select(".control-edge").call(Q,t)}const ee=180,te=180;function le(e,t,l){const o=e.selectAll(".node").data(t,e=>e.index);o.exit().remove();const a=o.enter().append("g").attr("class","node").call(ne);a.append("circle").attr("class","node-symbol"),a.append("g").attr("class","node-content").attr("transform",`translate(${-ee/2},${-te/2})`),a.append("text").attr("class","node-label").attr("x",0).attr("text-anchor","middle");const s=a.merge(o);l?s.select(".node-content").html(e=>e.structure):s.select(".node-content").select("svg").remove()}function oe(e,t){const l=e.selectAll(".link").data(t,e=>`${e.source}_${e.target}`);l.exit().remove();const o=l.enter().append("g").attr("class","link");o.append("line").attr("class","edge-line").style("stroke","#999").style("stroke-opacity",.6),o.append("text").attr("class","edge-label").attr("text-anchor","middle").text(e=>e.weight),o.call(ce)}function ae(t,l){t.selectAll(".node").each(function(t){const a=v.scaleFunction(l.nodeColor)(t[l.nodeColor.field]),s=v.scaleFunction(l.nodeSize)(t[l.nodeSize.field]),n=v.scaleFunction(l.nodeLabelColor)(t[l.nodeLabelColor.field]);e.select(this).select(".node-symbol").attr("r",s).style("fill",a),e.select(this).select(".node-label").text(e=>{if(null===l.nodeLabel.text)return"";const t=l.nodes.fields.find(e=>e.key===l.nodeLabel.text);return"d3_format"===t.format?o.formatNum(e[l.nodeLabel.text],t.d3_format):e[l.nodeLabel.text]}).attr("font-size",l.nodeLabel.size).attr("y",parseFloat(s)+parseInt(l.nodeLabel.size)).attr("visibility",l.nodeLabel.visible?"inherit":"hidden").style("fill",n)})}function se(e,t){e.selectAll(".link").select(".edge-line").style("stroke-width",e=>v.scaleFunction(t.edgeWidth)(e.weight)),e.selectAll(".link").select(".edge-label").attr("visibility",t.edgeLabel.visible?"inherit":"hidden").attr("font-size",t.edgeLabel.size)}function ne(e){e.attr("transform",e=>`translate(${e.x}, ${e.y})`)}function ce(e){e.attr("transform",e=>`translate(${e.sx}, ${e.sy})`),e.select(".edge-line").attr("x1",0).attr("y1",0).attr("x2",e=>e.tx-e.sx).attr("y2",e=>e.ty-e.sy),e.select(".edge-label").attr("x",e=>(e.tx-e.sx)/2).attr("y",e=>(e.ty-e.sy)/2)}function re(e,t){e.select(".nw-nodes").call(ae,t),e.select(".nw-edges").call(se,t)}function ie(e,t){const l=t.nodesToRender(),o=l.length;t.enableFocusedView&&(t.focusedView=o<t.focusedViewThreshold),t.enableOverlookView&&(t.overlookView=o>t.overlookViewThreshold);const a=t.overlookView?[]:t.edgesToRender();e.select(".nw-nodes").call(le,l,t.focusedView),e.select(".nw-edges").call(oe,a),e.call(re,t),t.zoomListener&&e.call(t.zoomListener),t.dragListener&&e.select(".nw-nodes").selectAll(".node").call(t.dragListener)}function de(e,t,l){e.attr("transform",`translate(${t}, ${l})`)}function ue(e,t,l,o,a){e.attr("transform",`translate(${t}, ${l})`),e.select(".edge-line").attr("x1",0).attr("y1",0).attr("x2",o-t).attr("y2",a-l),e.select(".edge-label").attr("x",(o-t)/2).attr("y",(a-l)/2)}function pe(e,t,l){e.attr("viewBox",`0 0 ${t} ${l}`),e.select(".nw-view-boundary").attr("width",t).attr("height",l)}function fe(e,t){const l=e.node();t.setViewBox(l.offsetWidth,l.offsetHeight),e.select(".nw-view").call(pe,l.offsetWidth,l.offsetHeight)}var he={updateNodes:le,updateEdges:oe,updateNodeCoords:ne,updateEdgeCoords:ce,updateNodeAttrs:ae,updateEdgeAttrs:se,updateAttrs:re,updateComponents:ie,move:function(t,l,o,a){const s=e.select(l).call(de,o,a).datum();t.select(".nw-edges").selectAll(".link").filter(e=>s.adjacency.map(e=>e[1]).includes(e.num)).each(function(t){s.index===t.source.index||s.index===t.source?e.select(this).call(ue,o,a,t.tx,t.ty):s.index!==t.target.index&&s.index!==t.target||e.select(this).call(ue,t.sx,t.sy,o,a)})},transform:function(e,t,l,o){e.select(".nw-field").attr("transform",`translate(${t}, ${l}) scale(${o})`)},resizeViewBox:pe,networkViewFrame:function(e,t){e.style("width","100%").style("height","100%"),e.select(".nw-view").remove(),e.append("svg").classed("nw-view",!0),e.call(fe,t)},resize:fe,networkView:function(e,t){e.attr("preserveAspectRatio","xMinYMin meet").attr("pointer-events","all").attr("viewBox",`0 0 ${t.viewBox.right} ${t.viewBox.bottom}`).style("width","100%").style("height","100%"),e.select(".nw-view-boundary").remove(),e.select(".nw-field").remove(),e.append("rect").classed("nw-view-boundary",!0).attr("x",0).attr("y",0).attr("width",t.viewBox.right).attr("height",t.viewBox.bottom).attr("fill","#ffffff").attr("stroke-width",1).attr("stroke","#cccccc");const l=e.append("g").classed("nw-field",!0).style("opacity",1e-6);l.transition().duration(1e3).style("opacity",1);const o=l.append("g").classed("nw-edges",!0),a=l.append("g").classed("nw-nodes",!0);t.updateComponentNotifier=(()=>{e.call(ie,t)}),t.updateNodeNotifier=(()=>{a.call(le,t.nodesToRender())}),t.updateEdgeNotifier=(()=>{o.call(oe,t.edgesToRender())}),t.updateNodeAttrNotifier=(()=>{a.call(ae,t)}),t.updateEdgeAttrNotifier=(()=>{o.call(se,t)}),e.call(ie,t)}};function me(t,l){return e.drag().on("drag",function(){t.call(he.move,this,e.event.x,e.event.y)}).on("end",function(t){l.setCoords(t.index,e.event.x,e.event.y)})}function ge(t,l){return e.zoom().on("zoom",function(){const o=e.event.transform;if(t.call(he.transform,o.x,o.y,o.k),!l.focusedView){const e=l.prevTransform,a=o.x>e.x+20||o.x<e.x-20,s=o.y>e.y+20||o.y<e.y-20,n=o.k>e.k;(a||s&&!n)&&(l.setTransform(o.x,o.y,o.k),l.prevTransform={x:o.x,y:o.y,k:o.k},t.call(he.updateComponents,l))}}).on("end",function(){const o=e.event.transform;l.setTransform(o.x,o.y,o.k),l.prevTransform={x:o.x,y:o.y,k:o.k},t.call(he.updateComponents,l)})}function xe(t,l){const o=t.select(".nw-view-boundary").node().getBBox(),a=o.width/o.height,s=l.boundary.bottom-l.boundary.top,n=l.boundary.right-l.boundary.left,c=a>=n/s?o.height/s:o.width/n,r=-l.boundary.left*c,i=-l.boundary.top*c;l.setTransform(r,i,c),t.call(he.updateComponents,l).call(he.transform,r,i,c).call(e.zoom().transform,e.zoomIdentity.translate(r,i).scale(c))}var be={dragListener:me,zoomListener:ge,setInteraction:function(t,l){l.zoomListener=ge(t,l),l.dragListener=me(t,l),t.call(l.zoomListener),t.select(".nw-nodes").selectAll(".node").call(l.dragListener),l.fitNotifier=(()=>{t.call(xe,l)});const o=l.transform;t.call(he.transform,o.x,o.y,o.k).call(e.zoom().transform,e.zoomIdentity.translate(o.x,o.y).scale(o.k))},fit:xe};function ye(e,t,l){const o=l.ns.map(e=>({x:e.x,y:e.y}));l.setAllCoords(o),e.call(he.updateComponents,l)}function we(e,t,l){t.alpha(0).stop(),e.select(".nw-nodes").selectAll(".node").each(e=>{e.fx=e.x,e.fy=e.y}),l.dragListener=be.dragListener(e,l),e.call(ye,t,l)}function ve(t,l,o){t.select(".nw-nodes").selectAll(".node").each(e=>{e.fx=null,e.fy=null}),o.dragListener=function(t,l,o){return e.drag().on("start",()=>{e.event.active||t.call(ke,l,o)}).on("drag",t=>{t.fx=e.event.x,t.fy=e.event.y}).on("end",t=>{e.event.active||l.alphaTarget(0),t.fx=null,t.fy=null})}(t,l,o);const a=o.ns.map(e=>({x:e.x,y:e.y}));o.setAllCoords(a),t.call(he.updateComponents,o)}function ke(e,t,l){e.call(ve,t,l),t.alpha(.1).restart()}function Be(e,t,l){e.call(ve,t,l),t.alpha(1).restart()}function Ce(e,t,l){const o=l.es.filter(e=>e.weight>=l.networkThreshold);t.nodes(l.ns).force("link").links(o)}return{NetworkState:class{constructor(e,t,l){this.focusedViewThreshold=100,this.enableFocusedView=!0,this.focusedView=!1,this.overlookViewThreshold=500,this.enableOverlookView=!0,this.overlookView=!1,this.fieldWidth=1200,this.fieldHeight=1200,this.viewID=e.viewID,this.name=e.name,this.nodes=new b(t),this.edges=new b(l),this.nodeColor={field:null,scale:"linear",domain:[0,1],range:["#7fffd4","#7fffd4"],unknown:"#7fffd4"},e.hasOwnProperty("nodeColor")&&(this.nodeColor.field=e.nodeColor.field,this.nodeColor.scale=e.nodeColor.scale,this.nodeColor.domain=e.nodeColor.domain,this.nodeColor.range=e.nodeColor.range,this.nodeColor.unknown=e.nodeColor.unknown),this.nodeSize={field:null,scale:"linear",domain:[1,1],range:[40,40],unknown:40},e.hasOwnProperty("nodeSize")&&(this.nodeSize.field=e.nodeSize.field,this.nodeSize.scale=e.nodeSize.scale,this.nodeSize.domain=e.nodeSize.domain,this.nodeSize.range=e.nodeSize.range,this.nodeSize.unknown=e.nodeSize.unknown),this.nodeLabel={text:null,size:12,visible:!1},e.hasOwnProperty("nodeLabel")&&(this.nodeLabel.text=e.nodeLabel.text,this.nodeLabel.size=e.nodeLabel.size,this.nodeLabel.visible=e.nodeLabel.visible),this.nodeLabelColor={field:null,scale:"linear",domain:[1,1],range:["#cccccc","#cccccc"],unknown:"#cccccc"},e.hasOwnProperty("nodeLabelColor")&&(this.nodeLabelColor.field=e.nodeLabelColor.field,this.nodeLabelColor.scale=e.nodeLabelColor.scale,this.nodeLabelColor.domain=e.nodeLabelColor.domain,this.nodeLabelColor.range=e.nodeLabelColor.range,this.nodeLabelColor.unknown=e.nodeLabelColor.unknown),this.edgeWidth={scale:"linear",domain:[.5,1],range:[10,10],unknown:1},e.hasOwnProperty("edgeWidth")&&(this.edgeWidth.scale=e.edgeWidth.scale,this.edgeWidth.domain=e.edgeWidth.domain,this.edgeWidth.range=e.edgeWidth.range,this.edgeWidth.unknown=e.edgeWidth.unknown),this.edgeLabel={size:12,visible:!1},e.hasOwnProperty("edgeLabel")&&(this.edgeLabel.size=e.edgeLabel.size,this.edgeLabel.visible=e.edgeLabel.visible),this.networkThresholdCutoff=e.networkThresholdCutoff,this.networkThreshold=e.networkThreshold||e.networkThresholdCutoff,this.transform=e.fieldTransform||{x:0,y:0,k:1},this.zoomListener=null,this.dragListener=null,this.updateComponentNotifier=null,this.updateNodeNotifier=null,this.updateEdgeNotifier=null,this.updateNodeAttrNotifier=null,this.updateEdgeAttrNotifier=null,this.snapShotNotifier=null,this.fitNotifier=null,this.setForceNotifier=null,this.stickNotifier=null,this.relaxNotifier=null,this.restartNotifier=null,this.tickCallback=(()=>{}),this.ns=JSON.parse(JSON.stringify(this.nodes.records())),this.es=JSON.parse(JSON.stringify(this.edges.records())),this.ns.forEach(e=>{e.adjacency=[]}),this.es.forEach((e,t)=>{e.num=t,this.ns[e.source].adjacency.push([e.target,t]),this.ns[e.target].adjacency.push([e.source,t])}),this.forceField={top:0,right:this.fieldWidth,bottom:this.fieldHeight,left:0},this.viewBox={top:0,right:this.fieldWidth,bottom:this.fieldHeight,left:0},this.focusArea={},this.boundary={},this.prevTransform={x:this.transform.x,y:this.transform.y,k:this.transform.k},e.coords?(this.simulationOnLoad=!1,this.setAllCoords(e.coords),this.setFocusArea(),this.setBoundary()):this.simulationOnLoad=!0}setBoundary(){const e=this.ns.map(e=>e.x),t=this.ns.map(e=>e.y);this.boundary.top=Math.min.apply(null,t),this.boundary.left=Math.min.apply(null,e),this.boundary.bottom=Math.max.apply(null,t),this.boundary.right=Math.max.apply(null,e)}setFocusArea(){const e=this.transform.x,t=this.transform.y,l=this.transform.k;this.focusArea.top=(this.viewBox.top-t)/l-50,this.focusArea.left=(this.viewBox.left-e)/l-50,this.focusArea.bottom=(this.viewBox.bottom-t)/l+50,this.focusArea.right=(this.viewBox.right-e)/l+50}setTransform(e,t,l){this.transform.x=e,this.transform.y=t,this.transform.k=l,this.setFocusArea()}setViewBox(e,t){this.viewBox.right=e,this.viewBox.bottom=t,this.setFocusArea()}setAllCoords(e){this.ns.forEach(t=>{t.x=e[t.index].x,t.y=e[t.index].y,t.adjacency.forEach(l=>{const o=l[0],a=l[1];t.index<o?(this.es[a].sx=e[t.index].x,this.es[a].sy=e[t.index].y):(this.es[a].tx=e[t.index].x,this.es[a].ty=e[t.index].y)})}),this.setBoundary()}setCoords(e,t,l){this.ns[e].x=t,this.ns[e].y=l,this.ns[e].adjacency.forEach(o=>{const a=o[0],s=o[1];e<a?(this.es[s].sx=t,this.es[s].sy=l):(this.es[s].tx=t,this.es[s].ty=l)}),this.setBoundary()}nodesToRender(){return this.ns.filter(e=>e.y>this.focusArea.top&&e.x>this.focusArea.left&&e.y<this.focusArea.bottom&&e.x<this.focusArea.right)}edgesToRender(){return this.es.filter(e=>e.weight>=this.networkThreshold&&this.focusArea.top<Math.max(e.sy,e.ty)&&this.focusArea.left<Math.max(e.sx,e.tx)&&this.focusArea.bottom>Math.min(e.sy,e.ty)&&this.focusArea.right>Math.min(e.sx,e.tx))}save(){return Promise.all([u.updateCollection(this.nodes.collectionID,this.nodes.export()),u.updateCollection(this.edges.collectionID,this.edges.export()),u.updateView(this.viewID,this.export())])}export(){return JSON.parse(JSON.stringify({$schema:"https://mojaie.github.io/kiwiii/specs/network_v1.0.json",viewID:this.viewID,name:this.name,viewType:"network",nodes:this.nodes.collectionID,edges:this.edges.collectionID,nodeColor:this.nodeColor,nodeSize:this.nodeSize,nodeLabel:this.nodeLabel,nodeLabelColor:this.nodeLabelColor,edgeWidth:this.edgeWidth,edgeLabel:this.edgeLabel,networkThreshold:this.networkThreshold,networkThresholdCutoff:this.networkThresholdCutoff,fieldTransform:this.transform,coords:this.ns.map(e=>({x:e.x,y:e.y}))}))}showTransform(){e.select("#debug-transform").text(JSON.stringify(this.transform))}showBoundary(){e.select("#debug-boundary").text(JSON.stringify(this.boundary))}showFocusArea(){e.select("#debug-focusarea").text(JSON.stringify(this.focusArea))}showViewBox(){e.select("#debug-viewbox").text(JSON.stringify(this.viewBox))}},control:{updateNodeColorControlBox:j,controlBox:function(e,t){e.select("nav").remove(),e.select(".tab-content").remove(),e.call(Y,"control-frame-nav","control-frame-content");const l=e.select(".nav-tabs"),o=e.select(".tab-content");l.append("a").classed("active",!0).attr("aria-selected","true").call(X,"control-main","Main"),o.append("div").classed("show",!0).classed("active",!0).classed("control-main",!0).call(K,"control-main").call(M,t),l.append("a").call(X,"control-color","Color"),o.append("div").classed("control-color",!0).call(K,"control-color").call(G,t),l.append("a").call(X,"control-size","Size"),o.append("div").classed("control-size",!0).call(K,"control-size").call(q,t),l.append("a").call(X,"control-label","Label"),o.append("div").classed("control-label",!0).call(K,"control-label").call(_,t),l.append("a").call(X,"control-edge","Edge"),o.append("div").classed("control-edge",!0).call(K,"control-edge").call(H,t),e.call(Z,t)},updateControlBox:Z},component:he,force:{forceSimulation:function(t,l){return e.forceSimulation().force("link",e.forceLink().id(e=>e.index).distance(60).strength(1)).force("charge",e.forceManyBody().strength(-600).distanceMin(15).distanceMax(720)).force("collide",e.forceCollide().radius(90)).force("center",e.forceCenter(t/2,l/2)).force("x",e.forceX().strength(.002)).force("y",e.forceY().strength(.002)).stop()},activate:function(e,t,l){t.on("tick",()=>{e.select(".nw-nodes").selectAll(".node").call(he.updateNodeCoords);const o=l.ns.map(e=>({x:e.x,y:e.y}));l.setAllCoords(o),e.select(".nw-edges").selectAll(".link").call(he.updateEdgeCoords),l.tickCallback(t)}).on("end",()=>{e.call(ye,t,l),l.tickCallback(t)}),l.setForceNotifier=(()=>{e.call(Ce,t,l)}),l.stickNotifier=(()=>{e.call(we,t,l)}),l.relaxNotifier=(()=>{e.call(ke,t,l)}),l.restartNotifier=(()=>{e.call(Be,t,l)}),l.setForceNotifier(),l.simulationOnLoad?e.call(Be,t,l):e.call(we,t,l)},stick:we,relax:ke,restart:Be},interaction:be}});
//# sourceMappingURL=kw-network.js.map
