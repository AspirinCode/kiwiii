// https://github.com/mojaie/kiwiii Version 0.8.0. Copyright 2017 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("pako"),require("Dexie"),require("vega")):"function"==typeof define&&define.amd?define(["d3","pako","Dexie","vega"],t):e.kwdatatable=t(e.d3,e.pako,e.Dexie,e.vega)}(this,function(e,t,n,r){"use strict";function s(e){const t=e.columns.map(e=>(e.sortType=e.sort,e));return{id:e.id,name:e.name,dataType:D[e.format],schemaVersion:.8,revision:0,status:S[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function l(e,t){const n={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(n.nodeColor.id=e.snapshot.nodeColor.id,n.nodeColor.scale=e.snapshot.nodeColor.scale,n.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):n.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(n.nodeSize.id=e.snapshot.nodeSize.id,n.nodeSize.scale=e.snapshot.nodeSize.scale,n.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):n.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(n.nodeLabel.id=e.snapshot.nodeLabel.id,n.nodeLabel.size=e.snapshot.nodeLabel.size,n.nodeLabel.text=e.snapshot.nodeLabel.text,n.nodeLabel.visible=e.snapshot.nodeLabel.visible,n.nodeLabel.scale=e.snapshot.nodeLabel.scale,n.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):n.nodeLabel={id:"label",size:12,text:"_index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?n.nodeContent=e.snapshot.nodeContent:n.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?n.edge=e.snapshot.edge:n.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:D[e.format],schemaVersion:.8,revision:0,nodesID:e.nodeTableId,status:S[e.status],fields:P.defaultFieldProperties([{key:"source"},{key:"target"},{key:"weight"}]),records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:n}}function o(e){if(e.hasOwnProperty("edges")){const t=s(e.nodes);return{nodes:t,edges:l(e.edges,t.fields)}}return s(e)}function i(e,t,n){return new Promise((r,s)=>{const l=new FileReader,o=t?e.slice(0,t):e;l.onload=(e=>r(e.target.result)),l.onerror=(e=>s(e)),n?l.readAsArrayBuffer(o):l.readAsText(o)})}function a(e,n){const r=n?t.inflate(e,{to:"string"}):e,s=JSON.parse(r);return s.hasOwnProperty("schemaVersion")?s:s.hasOwnProperty("edges")&&s.edges.hasOwnProperty("schemaVersion")?s:o(s)}function c(e,t){try{const n=window.URL.createObjectURL(new Blob([e])),r=document.createElement("a");r.download=t,r.href=n,r.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}function d(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}function u(e,t,n){return q.updateItem(e,e=>{e[t]=n,e.revision++}).catch(r=>{console.error(`Unexpected table ID: ${e}, key: ${t} or value: ${n}`),Promise.reject(r)})}function p(e,t){const n=parseFloat(e),r=parseFloat(t);return isNaN(n)||isNaN(r)?String(t).localeCompare(String(e)):r-n}function h(e,t){return String(t).localeCompare(String(e))}function m(t,n,r){const s=t.select("thead tr").selectAll("th").data(),l=t.select("tbody").selectAll("tr").data(n,r);l.exit().remove();const o=l.enter().append("tr");o.selectAll("td").data(e=>s.map(t=>e[t.key])).enter().append("td"),o.merge(l).selectAll("td").classed("align-middle",!0).html(function(e,t){if(void 0===e)return"";if("plot"===s[t].valueType)return"[plot]";if("image"===s[t].valueType)return"[image]";if("control"!==s[t].valueType)return"raw"!==s[t].digit?E.formatNum(e,s[t].digit):e}).each((t,n,r)=>{"control"===s[n].valueType&&e.select(r[n]).call(t)})}function f(t,n,r,s,l){const o=t.select(".dg-header").datum(),i=t.select(".dg-header").selectAll(".dg-hcell").data(),a=Math.min(s,Math.max(0,n.length-l+1)),c=a+l,d=n.slice(a,Math.min(c,n.length)),u=t.select(".dg-body").selectAll(".dg-row").data(d,r).style("height",`${o.height}px`);u.exit().remove();const p=u.enter().append("div").attr("class","dg-row").style("position","absolute");p.selectAll(".dg-cell").data(i.map(e=>e.width)).enter().append("div").classed("dg-cell",!0).classed("align-middle",!0).style("display","inline-block").style("width",e=>`${e}px`),p.merge(u).order().each(function(t,n){const r=(s+n)*o.height;e.select(this).style("transform",`translate(0px, ${r}px)`).classed("odd",(s+n)%2==0).selectAll(".dg-cell").html(function(r,s){e.select(this).attr("id",`c${n}-${s}`);const l=t[i[s].key];return void 0===l?"":"plot"===i[s].valueType?"":"image"===i[s].valueType?`<img src="${l}" width="180" height="180"/>`:"raw"!==i[s].digit?E.formatNum(l,i[s].digit):l}).each(function(e,r){if("plot"!==i[r].valueType)return;if(!t.hasOwnProperty(i[r].key))return;const s=t[i[r].key];_.showPlot(s,`#c${n}-${r}`)})})}function g(t,n,r){const s=t.select(".dg-header").datum(),l=n.length*s.height;let o,i;t.select(".dg-body").style("height",`${l}px`).style("position","relative"),t.select(".dg-viewport").style("overflow-y","auto").on("scroll",function(){const l=e.select(this).node().scrollTop,a=Math.min(Math.floor(l/s.height),n.length);a!==o&&f(t,n,r,o=a,i)}),e.select(window).on("resize",function(){const e=t.select(".dg-viewport"),n=e.node().getBoundingClientRect().top,r=window.innerHeight-n-5;e.style("height",`${r}px`);const l=Math.ceil(r/s.height)+1;l!==i&&(i=l,e.dispatch("scroll"))}).dispatch("resize")}function y(e,t){e.filter(e=>e.hasOwnProperty(t)).forEach(e=>{e[t]=`<a href="profile.html?compound=${e[t]}" target="_blank">${e[t]}</a>`})}function b(){return U.getTable(j.URLQuery().id).then(t=>{J.columnDialog(t.fields,b),J.fieldFileDialog(e=>U.joinFields(j.URLQuery().id,e).then(b)),V.renderStatus(t,()=>M.fetchResults().then(b),()=>M.fetchResults("abort").then(b)),e.select("#rename").on("click",()=>{e.select("#prompt-title").text("Rename table"),e.select("#prompt-label").text("New name"),e.select("#prompt-input").attr("value",t.name),e.select("#prompt-submit").on("click",()=>{const e=x.value("#prompt-input");return U.updateTableAttribute(t.id,"name",e).then(()=>U.getTable(j.URLQuery().id)).then(e=>V.renderStatus(e,()=>M.fetchResults().then(b),()=>M.fetchResults("abort").then(b)))})});const n=JSON.parse(JSON.stringify(t.records));y(n,"id"),e.select("#datatable").call(H.createDataGrid,t).call(H.dataGridRecords,n,e=>e._index).call(H.addSort,n,e=>e._index),U.getResources().then(e=>{const n=e.filter(e=>"activity"===e.domain),r=t.records.map(e=>e.id);J.fieldFetchDialog(r,t.fields,n,e=>U.joinFields(j.URLQuery().id,e).then(b))}),J.graphDialog(n=>{const r=new FormData;return r.append("contents",new Blob([JSON.stringify(t)])),r.append("params",JSON.stringify(n)),L.post("simnet",r).then(L.json).then(t=>(t.networkThreshold=t.query.threshold,M.interactiveInsert(t).then(t=>{e.select("#loading-circle").style("display","none"),window.open(`graph.html?id=${t}`,"_blank")})),L.error)}),e.select("#export").on("click",()=>O.downloadJSON(t,t.name,!0)),e.select("#excel").on("click",()=>{const e=new FormData;return e.append("contents",new Blob([JSON.stringify(t)])),L.post("xlsx",e).then(L.blob).then(e=>O.downloadDataFile(e,`${t.name}.xlsx`),L.error)}),e.select("#sdfile").on("click",()=>{const e=new FormData;return e.append("contents",new Blob([JSON.stringify(t)])),L.post("sdfout",e).then(L.text).then(e=>O.downloadDataFile(e,`${t.name}.sdf`),L.error)})})}function v(e){return M.interactiveInsert(e).then(e=>{window.location=`datatable.html?id=${e}`})}const k=!1;e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n,r=r&&r.hasOwnProperty("default")?r.default:r;var x={value:function(t){return e.select(t).node().value},valueInt:function(t){return parseInt(e.select(t).node().value)},valueFloat:function(t){return parseFloat(e.select(t).node().value)},checked:function(t){return e.select(t).node().checked},firstFile:function(t){return e.select(t).node().files[0]},checkboxValues:function(t){return e.selectAll(t).selectAll("input:checked").nodes().map(e=>e.value)},optionValues:function(t){return e.selectAll(t).selectAll("select").nodes().map(e=>e.value)},textareaLines:function(t){return e.select(t).node().value.split("\n").filter(e=>e.length>0)},optionData:function(t){const n=e.select(t).property("selectedIndex");return e.select(t).selectAll("option").data().find((e,t)=>t===n)},checkboxData:function(t){return e.selectAll(t).selectAll("input:checked").data()}};const w=["_mw","_mw_wo_sw","_logp","_formula","_nonH"],T={id:"text",compound_id:"text",assay_id:"text",svg:"none",json:"none",plot:"none",text:"text",ec50:"numeric","active%":"numeric","inhibition%":"numeric",filesize:"numeric",numeric:"numeric",count:"numeric",int:"numeric",flag:"numeric",bool:"numeric",timestamp:"none",image:"none",control:"none",undefined:"none"},A={id:"raw",compound_id:"raw",assay_id:"raw",svg:"raw",json:"raw",plot:"raw",text:"raw",ec50:"scientific","active%":"rounded","inhibition%":"rounded",filesize:"si",numeric:"rounded",count:"raw",int:"raw",flag:"raw",bool:"raw",timestamp:"raw",image:"raw",control:"raw",undefined:"raw"};var P={defaultHiddenFields:w,defaultFieldProperties:function(e){return e.map(e=>(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!w.includes(e.key)),e.hasOwnProperty("sortType")||(e.sortType=T[e.valueType]),e.hasOwnProperty("digit")||(e.digit=A[e.valueType]),e))},ongoing:function(e){return["running","ready"].includes(e.status)}};const S={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},D={datatable:"nodes",connection:"edges"};var O={readFile:i,parseJSON:a,loadJSON:function(e){const t=e.name.endsWith("c")||e.name.endsWith(".gz");return i(e,!1,t).then(e=>a(e,t))},fetchJSON:function(e){const t=decodeURIComponent(e),n=t.endsWith("c")||t.endsWith(".gz");return fetch(t).then(e=>n?e.arrayBuffer():e.json()).then(e=>a(e,n))},downloadDataFile:c,downloadJSON:function(e,n,r=!0){const s=JSON.stringify(e),l=r?t.gzip(s):s,o=r?"c":"r";c(l,`${n}${e.hasOwnProperty("edges")?`.gf${o}`:`.nd${o}`}`)}};class I extends Array{unique(e){return this.reduce((t,n)=>(void 0===t.find(t=>t[e]===n[e])&&t.push(n),t),new I)}extend(){return this.reduce((e,t)=>(Array.prototype.push.apply(e,t),e),new I)}extendAsync(){return Promise.all(this).then(e=>e.reduce((e,t)=>(Array.prototype.push.apply(e,t),e),new I))}toArray(){return new Array(this)}toObject(){const e={};return this.forEach(t=>{e[t[0]]=t[1]}),e}}var j={URLQuery:function(){return I.from(window.location.search.substring(1).split("&")).map(e=>e.split("=")).toObject()}};const F="";var L={get:function(e,t={}){const n=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${F}${e}${n}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},json:function(e){return e.json()},text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${F}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null}},C={getSDFPropList:function(e){const t=/>.*?<(\S+)>/g,n=new Set;let r;for(;null!==(r=t.exec(e));)n.add(r[1]);return Array.from(n)},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}},R={singleToMulti:d,mappingToTable:function(e){const t=e.hasOwnProperty("field")?d(e):e,n={key:t.key,valueType:"text"};return{fields:P.defaultFieldProperties([n].concat(t.fields)),records:Object.entries(t.mapping).map(e=>{const n={};return n[t.key]=e[0],t.fields.forEach((t,r)=>{n[t.key]=e[1][r]}),n})}},tableToMapping:function(e,t,n=["_index"]){const r={created:(new Date).toString(),fields:P.defaultFieldProperties(e.fields.filter(e=>e.key!==t).filter(e=>!n.includes(e.key))),key:t,mapping:{}};return e.records.forEach(e=>{r.mapping[e[t]]=r.fields.map(t=>e[t.key])}),r},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),n=t.shift().split(","),r=n.shift(),s=new Date,l=[],o=[];n.forEach((e,t)=>{""!==e&&(l.push(t),o.push({key:e,valueType:"text"}))});const i={created:s.toString(),fields:P.defaultFieldProperties(o),key:r,mapping:{}};return t.forEach(e=>{const t=e.split(","),n=t.shift();i.mapping[n]=Array(l.length),l.forEach(e=>{i.mapping[n][e]=t[e]})}),i},apply:function(e,t){const n=t.hasOwnProperty("field")?d(t):t;e.records.filter(e=>n.mapping.hasOwnProperty(e[n.key])).forEach(e=>{n.fields.forEach((t,r)=>{e[t.key]=n.mapping[e[n.key]][r]})}),e.fields=P.defaultFieldProperties(I.from(e.fields).concat(n.fields).unique("key"))}};const z={app:"key",items:"id, dataType, created",resources:"id"};let N=new n("Store");N.version(1).stores(z);var q={getAppSetting:function(e){return N.app.where("key").equals(e).first().then(e=>{if(void 0!==e)return e.value})},putAppSetting:function(e,t){return N.app.put({key:e,value:t})},getResources:function(){return N.resources.toArray()},putResources:function(e){return N.resources.bulkPut(e)},getAllItems:function(){return N.items.orderBy("created").reverse().toArray()},getItemsByDataType:function(e){return N.items.where("dataType").equals(e).reverse().sortBy("created")},getItemById:function(e){return N.items.where("id").equals(e).first()},updateItem:function(e,t){return N.items.where("id").equals(e).modify(t)},deleteItem:function(e){return N.items.where("id").equals(e).delete()},putItem:function(e){return N.items.put(e)},reset:function(){return N.delete().then(()=>{(N=new n("Store")).version(1).stores(z)})}},U={getAppSetting:function(e){return q.getAppSetting(e).catch(t=>{console.error(`Unexpected key: ${e}`),Promise.reject(t)})},setAppSetting:function(e,t){return q.putAppSetting(e,t).catch(n=>{console.error(`Unexpected key: ${e} or value: ${t}`),Promise.reject(n)})},getResources:function(){return q.getResources()},setResources:function(e){return q.putResources(e).catch(t=>{console.error(`Unexpected resources: ${e}`),Promise.reject(t)})},getAllTables:function(){return q.getAllItems()},getTablesByDataType:function(e){return q.getItemsByDataType(e).catch(t=>{console.error(`Unexpected dataType: ${e}`),Promise.reject(t)})},getTable:function(e){return q.getItemById(e).catch(t=>{console.error(`Unexpected table ID: ${e}`),Promise.reject(t)})},setFieldProperties:function(e,t){return q.updateItem(e,e=>{e.fields.forEach((e,n)=>{e.visible=t.visibles.includes(e.key),e.sortType=t.sortTypes[n],e.digit=t.digits[n]}),e.revision++}).catch(n=>{console.error(`Unexpected table ID: ${e} or updates: ${t}`),Promise.reject(n)})},joinFields:function(e,t){return q.updateItem(e,e=>{R.apply(e,t),e.revision++}).catch(n=>{console.error(`Unexpected table ID: ${e} or mapping: ${t}`),Promise.reject(n)})},updateTableAttribute:u,insertTable:function(e){return e.fields=P.defaultFieldProperties(e.fields),q.putItem(e).catch(t=>{console.error(`Unexpected data: ${e}`),Promise.reject(t)})},updateTable:function(e){return"failure"===e.status?u(e.id,"status","failure"):q.updateItem(e.id,t=>{e.fields=P.defaultFieldProperties(e.fields),Object.assign(t,e),t.revision++})},deleteTable:function(e){return q.deleteItem(e).catch(t=>{console.error(`Unexpected table ID: ${e}`),Promise.reject(t)})},reset:function(){return q.reset()}},E={formatNum:function(t,n){const r={scientific:".3e",si:".3s",rounded:".3r"};return"raw"===n?t:void 0===t||null===t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(r[n])(t):t},partialMatch:function(e,t){return void 0!==t&&null!==t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},numericAsc:p,numericDesc:function(e,t){return p(t,e)},textAsc:h,textDesc:function(e,t){return h(t,e)}},_={showPlot:function(e,t){new r.View(r.parse(e)).initialize(t).run()},plotThumbnail:function(e){return new r.View(r.parse(e)).toImageURL("png")}},B={selectOptions:function(e,t,n,r){const s=e.selectAll("option").data(t,n);s.exit().remove(),s.enter().append("option").merge(s).attr("value",n).text(r)},checkboxList:function(e,t,n,r,s){const l=e.selectAll("li").data(t,r);l.exit().remove();const o=l.enter().append("li").attr("class","form-check").append("label");o.append("input"),o.append("span");const i=o.merge(l.select("label")).attr("class","form-check-label");i.select("input").attr("type","checkbox").attr("class","form-check-input").attr("name",n).attr("value",r),i.select("span").text(s)},checkboxListT:function(e,t,n,r,s){const l=e.selectAll("li").data(t,r);l.exit().remove();const o=l.enter().append("li").attr("class","form-check").append("label");o.append("input"),o.append("a");const i=o.merge(l.select("label")).attr("class","form-check-label");i.select("input").attr("type","checkbox").attr("class","form-check-input").attr("name",n).attr("value",r),i.select("a").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",e=>e.description||"No").text(s)},createTable:function(e,t){e.select("thead").size()&&e.select("thead").remove(),e.append("thead").append("tr"),e.select("tbody").size()&&e.select("tbody").remove(),e.append("tbody");const n=t.fields.filter(e=>e.visible),r=e.select("thead tr").selectAll("th").data(n,e=>e.key);r.exit().remove(),r.enter().append("th").merge(r).text(e=>e.name)},updateTableRecords:m,appendTableRows:function(e,t,n){const r=e.select("tbody").selectAll("tr").data();Array.prototype.push.apply(r,t),m(e,r,n)},addSort:function(t){t.select("thead tr").selectAll("th").filter(e=>"none"!==e.sortType).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",n=>{const r="v"===e.select(`#sort-${n.key}`).text(),s="numeric"===n.sortType,l=r?s?E.numericAsc:E.textAsc:s?E.numericDesc:E.textDesc;t.select("tbody").selectAll("tr").sort((e,t)=>l(e[n.key],t[n.key])),e.select(`#sort-${n.key}`).text(r?"^":"v")})},formatNumbers:function(e){e.select("thead tr").selectAll("th").each((t,n)=>{"raw"!==t.digit&&e.select("tbody").selectAll("tr").selectAll("td").filter((e,t)=>t===n).text(e=>E.formatNum(e,t.digit))})}},J={pickDialog:function(t,n){U.getAppSetting("compoundIDPlaceholder").then(t=>{e.select("#pick-queryarea").text(t)}),e.select("#pick-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const r={type:"chemsearch",targets:t.filter(e=>"chemical"===e.domain).map(e=>e.id),key:"compound_id",values:x.textareaLines("#pick-queryarea")};return L.get("run",r).then(L.json).then(n,L.error)})},propDialog:function(t,n){e.select("#prop-targets").call(B.checkboxList,t,"targets",e=>e.id,e=>e.name).on("change",function(){const t=I.from(x.checkboxData("#prop-targets")).map(e=>e.fields).extend().unique("key");e.select("#prop-key").call(B.selectOptions,t,e=>e.key,e=>e.name)}),e.select("#prop-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t={type:"chemprop",targets:x.checkboxValues("#prop-targets"),key:x.optionData("#prop-key").key,values:x.textareaLines("#prop-queryarea"),operator:x.value("#prop-operator")};return L.get("async",t).then(L.json).then(n,L.error)})},structDialog:function(t,n){e.select("#struct-qsrc").call(B.selectOptions,t,e=>e.id,e=>e.name),e.select("#struct-targets").call(B.checkboxList,t,"targets",e=>e.id,e=>e.name),U.getAppSetting("rdkit").then(t=>{e.select("#struct-method").selectAll("option.rd").attr("disabled",t?null:"disabled")}),e.selectAll("#struct-method,#struct-thldtype").on("change",function(){const t=x.value("#struct-method"),n=x.value("#struct-thldtype");e.select("#struct-thld").attr("disabled",["gls","rdmorgan","rdfmcs"].includes(t)?null:"disabled").attr("value","edge"===n?15:.7).attr("min","edge"===n?5:0).attr("max","edge"===n?999:1).attr("step","edge"===n?1:.01),e.select("#struct-thldtype").attr("disabled",["gls","rdmorgan","rdfmcs"].includes(t)?null:"disabled").property("value",["gls","rdfmcs"].includes(t)?void 0:"sim"),e.select("#struct-thldtype option.sim").attr("disabled",["gls","rdmorgan","rdfmcs"].includes(t)?null:"disabled"),e.select("#struct-thldtype option.edge").attr("disabled",["gls","rdfmcs"].includes(t)?null:"disabled"),e.select("#struct-options").selectAll(".gls").attr("disabled","gls"===t?null:"disabled"),e.select("#struct-options .fmcs").attr("disabled","rdfmcs"===t?null:"disabled")}).dispatch("change"),e.select("#struct-format").on("change",function(){e.select("#struct-qsrc").attr("disabled","dbid"===this.value?null:"disabled")}),e.select("#struct-preview").on("click",()=>{const t=x.value("#struct-format"),n={format:t,source:"dbid"===t?x.value("#struct-qsrc"):null,value:"molfile"===t?x.value("#struct-queryarea"):x.textareaLines("#struct-queryarea")[0]};return L.get("strprev",n).then(L.text).then(t=>e.select("#struct-image").html(t),L.error)}),e.select("#struct-submit").on("click",()=>{const t=x.value("#struct-method");e.select("#loading-circle").style("display","inline");const r=x.value("#struct-format"),s={type:x.value("#struct-method"),targets:x.checkboxValues("#struct-targets"),queryMol:{format:r,source:"dbid"===r?x.value("#struct-qsrc"):null,value:"molfile"===r?x.value("#struct-queryarea"):x.textareaLines("#struct-queryarea")[0]},params:{measure:x.value("#struct-thldtype"),threshold:x.valueFloat("#struct-thld"),ignoreHs:x.checked("#struct-ignoreh"),diameter:"gls"===t?x.valueInt("#struct-diam"):null,maxTreeSize:"gls"===t?x.valueInt("#struct-tree"):null,molSizeCutoff:"gls"===t?x.valueInt("#struct-skip"):null,timeout:"rdfmcs"===t?x.valueInt("#struct-timeout"):null}},l="exact"===s.type?"run":"async";return L.get(l,s).then(L.json).then(n,L.error)})},sdfDialog:function(t){e.select("#sdf-file").on("change",()=>{const t=new FileReader,n=document.getElementById("sdf-file").files[0];t.onload=(t=>{e.select("#sdf-cols").call(B.checkboxList,C.getSDFPropList(t.target.result),"fields",e=>e,e=>e)}),t.readAsText(n.slice(0,104857600))}),e.select("#sdf-selectall").on("change",()=>{e.select("#sdf-cols").selectAll("input").property("checked",x.checked("#sdf-selectall"))}),e.select("#sdf-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const n={fields:x.checkboxValues("#sdf-cols"),implh:x.checked("#sdf-implh"),recalc:x.checked("#sdf-recalc")},r=new FormData;return r.append("contents",x.firstFile("#sdf-file")),r.append("params",JSON.stringify(n)),L.post("sdfin",r).then(L.json).then(t,L.error)})},columnDialog:function(t,n){const r={fields:P.defaultFieldProperties([{key:"name",valueType:"text"},{key:"visible",valueType:"control"},{key:"sortType",valueType:"control"},{key:"digit",valueType:"control"}])},s=t.map((t,n)=>({key:t.key,name:t.name,visible:e=>e.classed("column-vis",!0).classed(`row${n}`,!0).append("input").attr("type","checkbox").attr("value",t.key).property("checked",t.visible),sortType:r=>r.classed("column-sort",!0).classed(`row${n}`,!0).append("select").call(B.selectOptions,"none"===t.sortType?["none"]:["numeric","text"],e=>e,e=>e).property("value",t.sortType).on("change",function(){e.select(`.column-digit.row${n} select`).attr("disabled","numeric"===this.value?null:"disabled")}),digit:e=>e.classed("column-digit",!0).classed(`row${n}`,!0).append("select").call(B.selectOptions,["raw","rounded","scientific","si"],e=>e,e=>e).property("value",t.digit).attr("disabled","numeric"===t.sortType?null:"disabled")}));e.select("#column-table").call(B.createTable,r).call(B.updateTableRecords,s,e=>e.key),e.select("#column-submit").on("click",()=>{const e={visibles:x.checkboxValues(".column-vis"),sortTypes:x.optionValues(".column-sort"),digits:x.optionValues(".column-digit")};return U.setFieldProperties(j.URLQuery().id,e).then(n)})},fieldFetchDialog:function(t,n,r,s){document.getElementById("join-search").addEventListener("keypress",e=>{13===e.keyCode&&e.preventDefault()});const l=n.map(e=>e.key),o=I.from(r.map(e=>e.fields)).extend().unique("key").filter(e=>"id"!==e.key);e.select("#join-keys").call(B.checkboxList,o,"keys",e=>e.key,e=>e.name).selectAll("li").each(function(t){e.select(this).selectAll("label").select("input").property("checked",l.includes(t.key)).attr("disabled",l.includes(t.key)?"disabled":null)}),e.select("#join-search").on("keyup",function(){const t=e=>E.partialMatch(x.value(this),e.name);e.select("#join-keys").selectAll("li").style("visibility",e=>t(e)?null:"hidden").style("position",e=>t(e)?null:"absolute")}),e.select("#join-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const n=x.checkboxValues("#join-keys"),r={type:"fieldfilter",targetFields:o.map(e=>e.key).filter(e=>!l.includes(e)).filter(e=>n.includes(e)),key:"compound_id",values:t};return L.get("run",r).then(L.json).then(e=>s(R.tableToMapping(e,"id")),L.error)})},fieldFileDialog:function(t){e.select("#importcol-file").on("change",()=>{const t=document.getElementById("importcol-file").files[0],n="csv"===t.name.split(".").pop();O.readFile(t).then(t=>{const r=n?R.csvToMapping(t):JSON.parse(t),s=R.mappingToTable(r);e.select("#importcol-preview").call(B.createTable,s).call(B.updateTableRecords,s.records.slice(0,5),e=>e[s.fields[0].key]),e.select("#importcol-preview").datum(r)})}),e.select("#importcol-submit").on("click",()=>{let n=e.select("#importcol-preview").datum();e.select("#importcol-preview").datum(null);const r=[];if(n.hasOwnProperty("field")&&(n=R.singleToMulti(n)),n.fields.forEach((e,t)=>{"plot"===e.valueType&&(n.fields[t].valueType="image",r.push(t))}),r.length>0){const e=[];Object.entries(n.mapping).forEach(t=>{r.forEach(r=>{const s=_.plotThumbnail(t[1][r]).then(e=>{n.mapping[t[0]][r]=e});e.push(s)})}),Promise.all(e).then(()=>t(n))}else t(n)})},graphDialog:function(t){U.getAppSetting("rdkit").then(t=>{e.select("#graph-measure").selectAll("option.rd").attr("disabled",t?null:"disabled")}),e.select("#graph-measure").on("change",function(){e.select("#graph-options").selectAll(".gls").attr("disabled","gls"===this.value?null:"disabled"),e.select("#graph-options").selectAll(".fmcs").attr("disabled","rdfmcs"===this.value?null:"disabled")}),e.select("#graph-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const n=x.value("#graph-measure"),r={measure:n,threshold:x.valueFloat("#graph-thld"),ignoreHs:x.checked("#graph-ignoreh"),diameter:"gls"===n?x.valueInt("#graph-diam"):null,maxTreeSize:"gls"===n?x.valueInt("#graph-tree"):null,molSizeCutoff:"gls"===n?x.valueInt("#graph-skip"):null,timeout:"rdfmcs"===n?x.valueInt("#graph-timeout"):null};t(r)})},graphConfigDialog:function(t,n,r){e.select("#graphconfig-thld").attr("value",t).attr("max",1).attr("min",n),e.select("#graphconfig-submit").on("click",()=>{const e=x.valueFloat("#graphconfig-thld");e<n||r(e)})},communityDialog:function(t){e.select("#community-name").attr("value","comm_"),e.select("#community-submit").on("click",()=>{const e={name:x.value("#community-name"),nulliso:x.checked("#community-nulliso")};t(e)})},importConfirmDialog:function(t){e.select("#importconfirm-overwrite").on("click",()=>t("overwrite")),e.select("#importconfirm-keepboth").on("click",()=>t("keepboth")),e.select("#importconfirm-cancel").on("click",()=>t("cancel"))}},M={interactiveInsert:function(e){return U.getTable(e.id).then(t=>t?e.revision==t.revision?Promise.reject(e.id):($("#importconfirm-dialog").modal("toggle"),new Promise(t=>{J.importConfirmDialog(n=>{"overwrite"===n&&t(e),"keepboth"===n&&(e.id=C.uuidv4(),t(e))})})):Promise.resolve(e)).then(e=>U.insertTable(e).then(()=>e.id),e=>e?Promise.resolve(e):Promise.reject())},fetchResults:function(e="update"){return U.getTable(j.URLQuery().id).then(e=>P.ongoing(e)?e:Promise.reject()).then(t=>{const n={id:t.id,command:e};return L.get("res",n).then(L.json).then(U.updateTable,L.error)},()=>Promise.resolve())},loader:function(){"serviceWorker"in navigator&&!k?navigator.serviceWorker.register("sw.js").then(e=>{console.info("ServiceWorker registration successful with scope: ",e.scope)}).catch(e=>{console.info("ServiceWorker registration failed: ",e)}):k?console.info("Off-line mode is disabled for debugging"):console.info("Off-line mode is not supported");const e=L.get("server").then(L.json).catch(()=>null),t=U.getAppSetting("serverInstance");return Promise.all([e,t]).then(e=>{const t=e[0],n=e[1];return t?t.instance===n?(console.info("Resource schema is already up to date"),Promise.resolve(t)):L.get("schema").then(L.json).then(e=>(console.info(`New resource schema version: ${t.instance}`),Promise.all([U.setResources(e.resources),U.setAppSetting("templates",e.templates),U.setAppSetting("compoundIDPlaceholder",e.compoundIDPlaceholder),U.setAppSetting("serverInstance",t.instance),U.setAppSetting("rdkit",t.rdkit)]).then(()=>Promise.resolve(t))),L.error):Promise.resolve(null)})}},V={renderStatus:function(t,n,r){e.select("#loading-circle").style("display","none"),e.select("title").text(t.name),e.select("#title").text(t.name),e.select("#refresh").style("display",P.ongoing(t)?"inline-block":"none"),e.select("#abort").style("display",P.ongoing(t)?"inline-block":"none");const s={nodes:"entries found",edges:"connections created"}[t.dataType];e.select("#progress").text(`(${t.status} - ${t.resultCount} ${s} in ${t.execTime} sec.)`),P.ongoing(t)&&e.select("#progress").append("div").append("progress").attr("max",100).attr("value",t.progress).text(`${t.progress}%`),e.select("#refresh").on("click",n),e.select("#abort").on("click",()=>{e.select("#confirm-message").text("Are you sure you want to abort this calculation job?"),e.select("#confirm-submit").classed("btn-primary",!1).classed("btn-warning",!0).on("click",r)}),console.info("Query"),console.info(t.query)},initializeWithData:function(){e.select("#new-data").style("display","none"),e.select("#loading-circle").style("display","none")},initialize:function(){e.select("#data-control").style("display","none"),e.select("#nodedata").style("display","none"),e.select("#refresh").style("display","none"),e.select("#abort").style("display","none"),e.select("#loading-circle").style("display","none"),e.select("#status").selectAll("li").style("display","none")}};const Q={numeric:120,text:200,none:200},W={numeric:40,text:40,none:200};var H={createDataGrid:function(e,t){e.select("div.dg-header").size()&&e.select("div.dg-header").remove(),e.append("div").classed("dg-header",!0),e.select("div.dg-viewport").size()&&e.select("div.dg-viewport").remove(),e.append("div").classed("dg-viewport",!0).append("div").classed("dg-body",!0);const n=t.fields.filter(e=>e.visible).map(e=>(e.width=Q[e.sortType],e.height=W[e.sortType],e)),r={height:n.reduce((e,t)=>e.height>t.height?e:t).height,width:n.reduce((e,t)=>({width:e.width+t.width})).width};e.style("width",`${r.width}px`),e.select(".dg-header").datum(r);const s=e.select(".dg-header").selectAll(".dg-hcell").data(n,e=>e.key);s.exit().remove(),s.enter().append("div").classed("dg-hcell",!0).style("display","inline-block").merge(s).style("width",e=>`${e.width}px`).text(e=>e.name)},dataGridRecords:g,addSort:function(t,n,r){t.select(".dg-header").selectAll(".dg-hcell").filter(e=>"none"!==e.sortType).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",s=>{const l="v"===e.select(`#sort-${s.key}`).text();e.select(`#sort-${s.key}`).text(l?"^":"v");const o="numeric"===s.sortType,i=l?o?E.numericAsc:E.textAsc:o?E.numericDesc:E.textDesc,a=n.sort((e,t)=>i(e[s.key],t[s.key]));g(t,a,r)})}};return{grid:H,render:b,run:function(){if(e.select("#import-json").on("click",()=>document.getElementById("select-file").click()),e.select("#select-file").on("change",()=>{const e=document.getElementById("select-file").files[0];O.loadJSON(e).then(v)}),j.URLQuery().hasOwnProperty("location")){const e=j.URLQuery().location;return O.fetchJSON(e).then(M.interactiveInsert).then(e=>{window.location=`datatable.html?id=${e}`})}return M.loader().then(t=>(t||e.selectAll(".online-command").style("color","#cccccc").classed("disabled",!0).on("click",()=>e.event.stopPropagation()),j.URLQuery().hasOwnProperty("id")?(V.initializeWithData(),M.fetchResults().then(b)):(V.initialize(),J.sdfDialog(v),t?U.getResources().then(e=>{const t=e.filter(e=>"chemical"===e.domain);J.pickDialog(t,v),J.structDialog(t,v),J.propDialog(t,v)}):Promise.resolve())))}}});
//# sourceMappingURL=kwdatatable.js.map
