// https://github.com/mojaie/kiwiii Version 0.13.0. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("Dexie"),require("d3"),require("lodash"),require("pako"),require("vega")):"function"==typeof define&&define.amd?define(["Dexie","d3","lodash","pako","vega"],t):e.kwdatagrid=t(e.Dexie,e.d3,e._,e.pako,e.vega)}(this,function(e,t,a,o,s){"use strict";function l(e,t,a){return new Promise((o,s)=>{const l=new FileReader,n=t?e.slice(0,t):e;l.onload=(e=>o(e.target.result)),l.onerror=(e=>s(e)),a?l.readAsArrayBuffer(n):l.readAsText(n)})}function n(e,t){const a=t?o.inflate(e,{to:"string"}):e;return JSON.parse(a)}function r(e,t){try{const a=window.URL.createObjectURL(new Blob([e])),o=document.createElement("a");o.download=t,o.href=a,o.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}function d(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}function i(e,t,a){e.text(z.formatNum(t[a.key],a.d3_format))}function c(e,t,a){e.text(t[a.key])}function p(e,t,a){e.html(t[a.key])}function u(e,t,a){e.append("a").attr("href",`profile.html?compound=${t[a.key]}`).attr("target","_blank").text(t[a.key])}function m(e,t,a){e.append("img").attr("width",180).attr("height",180).attr("src",t[a.key])}function f(e,t,a){e.append("input").attr("type","checkbox").property("checked",t[a.key]).property("disabled",!!a.disabled&&t[a.disabled]).on("click",function(){t[a.key]=this.checked})}function h(e,t,a){e.append("input").attr("type","text").style("width","90%").property("value",t[a.key]).on("change",function(){t[a.key]=this.value})}function y(e,t){e.call(t)}function b(e,a){e.select(".dg-body").style("height",`${a.bodyHeight}px`);const o=e.select(".dg-body").selectAll(".dg-row").data(a.recordsToShow(),a.keyFunc);o.exit().remove(),o.enter().append("div").attr("class","dg-row").style("position","absolute").style("width","100%").merge(o).style("height",`${a.rowHeight}px`).each(function(e,o){const s=a.viewportTop+o,l=s*a.rowHeight;t.select(this).style("transform",`translate(0px, ${l}px)`).classed("odd",s%2==0),t.select(this).selectAll(".dg-cell").remove(),t.select(this).call(a.rowFactory(),e,s)})}function g(e,a){e.select(".dg-header").selectAll(".dg-hcell").filter(e=>"none"!==z.sortType(e.format)).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",o=>{const s="v"===t.select(`#sort-${o.key}`).text();t.select(`#sort-${o.key}`).text(s?"^":"v"),a.setSortOrder(o.key,s?"desc":"asc"),e.call(Y.updateRows,a)}),a.updateContentsNotifier=(()=>{a.applyData(),e.call(Y.updateHeader,a).call(g,a)})}function x(e,t){const a=e.select(".dg-viewport").node().getBoundingClientRect().top;t.setViewportSize(window.innerHeight-a-5),e.call(Y.resizeViewport,t)}function v(e){const t=e.columns.map(e=>("numeric"===e.sort?e.format="numeric":"text"===e.sort?e.format="text":"none"===e.sort&&(e.format="raw"),e));return{id:e.id,name:e.name,dataType:ae[e.format],schemaVersion:.8,revision:0,status:te[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function k(e){return{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:e.query,progress:e.progress,execTime:e.execTime,created:e.created,reference:{}}}function w(e,t){e.classed("modal",!0).attr("tabindex",-1).attr("role","dialog").attr("aria-labelledby","").attr("aria-hidden",!0).attr("id",t),e.select(".modal-dialog").remove(),e.append("div").classed("modal-dialog",!0).attr("role","document").append("div").classed("modal-content",!0)}function B(e,t){const a=e.select("select").selectAll("option").data(t,e=>e.key);a.exit().remove(),a.enter().append("option").attr("value",e=>e.key).text(e=>e.name)}function S(e,t){e.select("select").property("value",t)}function T(e,t){const a=e.select("ul").selectAll("li").data(t,e=>e.key);a.exit().remove();const o=a.enter().append("li").attr("class","form-check").append("label").attr("class","form-check-label");o.append("input").attr("type","checkbox").attr("class","form-check-input").property("value",e=>e.key),o.append("span").text(e=>e.name)}function C(e,a){a&&e.selectAll("input").each(function(e){t.select(this).property("checked",a.includes(e.key))})}function D(e,t,a){const o=e.select("thead tr").selectAll("th").data(t);o.exit().remove(),o.enter().append("th").text(e=>e.name),a&&e.call(V,a,e=>e.key,function(e){return(t,a)=>{e.forEach(e=>{const o=a[e.key],s=t.append("td").classed("align-middle",!0);void 0!==o&&("d3_format"===e.format?s.text(z.formatNum(o,e.d3_format)):"plot"===e.format?s.text("[plot]"):"image"===e.format?s.text("[image]"):"control"===e.format?s.call(o):s.text(o))})}}(t))}function V(e,a,o,s){const l=e.select("tbody").selectAll("tr").data(a,o);l.exit().remove(),l.enter().append("tr").merge(l).each(function(e){t.select(this).selectAll("td").remove(),t.select(this).call(s,e)})}function L(e,t){e.append("td").classed("name",!0).text(t.name),e.append("td").classed("visible",!0).append("input").attr("type","checkbox").property("checked",t.visible);const a=["text","numeric","d3_format","raw","compound_id"],o=(a.includes(t.format)?a:[t.format]).map(e=>({key:e,name:e})),s=e.append("td").classed("format",!0),l=s.append("select");s.call(ne.selectBoxItems,o),l.property("disabled",!a.includes(t.format)).property("value",t.format),e.append("td").classed("d3format",!0).append("input").attr("size",10).property("disabled","d3_format"!==t.format||null).property("value",t.d3_format||null),l.on("change",function(){e.select(".d3format").select("input").property("disabled","d3_format"!==this.value)})}function O(e,t){e.select("input").property("value",t)}function F(e,t){e.select("textarea").property("value",t)}function I(e,t){e.select("input").property("checked",t)}function M(e,t){e.select("input").property("value",t)}function P(e){e.select(".format").on("change",function(){const a=ne.selectBoxValue(t.select(this));e.select(".source").select("select").property("disabled","dbid"!==a),e.select(".textquery").property("hidden","dbid"!==a),e.select(".areaquery").property("hidden","molfile"!==a)}).dispatch("change"),e.select(".preview").on("click",function(){const a=_(e);return H.get("strprev",a).then(H.text).then(e=>t.select("#previmg").html(e),H.error)})}function _(e){const t=ne.selectBoxValue(e.select(".format")),a=ne.selectBoxValue(e.select(".source")),o=pe.textBoxValue(e.select(".textquery")),s=pe.textareaBoxLines(e.select(".areaquery"));return{format:t,source:"dbid"===t?a:null,value:"molfile"===t?s:o}}function q(e){t.select("#loading-icon").style("display","none"),t.select("title").text(e.data.name);const a=t.select("#menubar");a.select(".saveview").on("click",function(){return e.data.storeID?j.updateItem(e.data.storeID,t=>{t.id=z.uuidv4(),t.name=e.data.name,t.fields=e.data.fields,t.records=e.data.records}).then(()=>console.info("Datagrid saved")):j.putItem(e.export()).then(e=>{window.location=`datagrid.html?id=${e}`})}),a.select(".exportjson").on("click",()=>{const t=e.export();delete t.storeID,G.downloadJSON(t,t.name)}),a.select(".exportexcel").on("click",()=>{const t=e.export(),a=new FormData;return a.append("contents",new Blob([JSON.stringify(t)])),H.post("xlsx",a).then(H.blob).then(e=>G.downloadDataFile(e,`${t.name}.xlsx`))}),a.select(".title").text(e.data.name),a.select(".status").text(`(${e.data.status} - ${e.data.records.length} records found in ${e.data.execTime} sec.)`),a.select(".progress").select("progress").attr("value",e.data.progress).text(`${e.data.progress}%`),a.select(".refresh").on("click",function(){return J.fetchProgress(e.data.storeID).then(()=>j.getItemByID(e.data.storeID)).then(t=>{e.data=t,e.updateContentsNotifier(),q(e)})}),e.serverStatus.instance||a.selectAll(".networkgend, .exportexcel").attr("data-target",null).classed("disabled",!0).on("click",null);const o=["running","ready"].includes(e.data.status);a.selectAll(".progress, .refresh, .abort").style("display",o?null:"none");const s=t.select("#dialogs");s.select(".fieldconfd").call(ce.updateBody,e).on("submit",function(){e.data.fields=ce.value(t.select(this)),e.updateContentsNotifier(),q(e)}),s.select(".fieldfetchd").call(ye.updateBody).on("submit",function(){const a=e.resourceSchema.resources.filter(e=>"activity"===e.domain).map(e=>e.id),o=e.data.records.map(e=>e.compound_id),s=ye.queries(t.select(this),a,o).map(e=>H.get(e.workflow,e).then(H.json).then(e=>U.tableToMapping(e,"compound_id",["index","assay_id"])));Promise.all(s).then(t=>{t.forEach(t=>e.joinFields(t)),e.updateContentsNotifier(),q(e)})}),s.select(".fieldfiled").on("submit",function(){return xe.readFile(t.select(this)).then(t=>{e.joinFields(t),e.updateContentsNotifier(),q(e)})}),s.select(".fieldinputd").on("submit",function(){const a=Be.value(t.select(this)),o=z.defaultFieldProperties([a.field])[0];e.data.fields.push(o),e.data.records.forEach(e=>{e[o.key]=a.default}),e.applyData(),e.updateContentsNotifier(),q(e)}),s.select(".netgend").on("submit",function(){const a=new FormData,o=De.queryParams(t.select(this));return a.append("params",JSON.stringify(o)),a.append("contents",new Blob([JSON.stringify(e.export())])),H.post(`${o.measure}net`,a).then(H.json).then(t=>(t.reference.nodes=e.data.storeID,t.fields=z.defaultFieldProperties(t.fields),t)).then(j.putItem).then(e=>{t.select("#loading-icon").style("display","none"),window.open(`network.html?id=${e}`,"_blank")})}),s.select(".renamed").call(Oe.updateBody,e).on("submit",function(){e.data.name=Oe.value(t.select(this)),q(e)}),s.select(".abortd").on("submit",function(){J.fetchProgress(e.data.storeID,"abort").then(()=>j.getItemByID(e.data.storeID)).then(t=>{e.data=t,e.updateContentsNotifier(),q(e)})})}function N(e){return H.json(e).then(e=>(e.fields=z.defaultFieldProperties(e.fields),e)).then(j.putItem).then(e=>{window.location=`datagrid.html?id=${e}`})}e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,a=a&&a.hasOwnProperty("default")?a.default:a,o=o&&o.hasOwnProperty("default")?o.default:o,s=s&&s.hasOwnProperty("default")?s.default:s;var z={defaultFieldProperties:function(e){return e.map(e=>(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),e))},sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id","assay_id","list"].includes(e)?"text":"none"},formatNum:function(e,a){return void 0===e||null===e||Number.isNaN(e)?"":e==parseFloat(e)?t.format(a)(e):e},partialMatch:function(e,t){return void 0!==t&&null!==t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},URLQuery:function(){const e=window.location.search.substring(1).split("&").map(e=>e.split("="));return a.fromPairs(e)},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const A={items:"storeID, dataType, created"};let R=new e("Store");R.version(1).stores(A);var j={getAllItems:function(){return R.items.orderBy("created").reverse().toArray()},getItemsByDataType:function(e){return R.items.where("dataType").equals(e).reverse().sortBy("created").catch(t=>{console.error(`IDBError: Unexpected dataType: ${e}`,t)})},getItemByID:function(e){return R.items.where("storeID").equals(e).first().catch(t=>{console.error(`IDBError: Unexpected table ID: ${e}`,t)})},deleteItem:function(e){return R.items.where("storeID").equals(e).delete()},putItem:function(e){return e.storeID||(e.storeID=z.uuidv4()),R.items.put(e)},updateItem:function(e,t){return R.items.where("storeID").equals(e).modify(t).catch(e=>{console.error("IDBError: Update failed",e)})},reset:function(){return R.delete().then(()=>{(R=new e("Store")).version(1).stores(A)})}};const E="";var H={get:function(e,t={}){const a=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${E}${e}${a}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},json:function(e){return e.json()},text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${E}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null}},J={fetchProgress:function(e,t="update"){return j.getItemByID(e).then(a=>{if(!a)return Promise.reject(`Store: ${e} is not available`);if(!["ready","running"].includes(a.status))return;const o={id:a.reference.workflow,command:t};return H.get("progress",o).then(H.json).then(t=>"failure"===t.status?j.updateItem(e,e=>{e.status="failure"}):j.updateItem(e,e=>{e.status=t.status,e.progress=t.progress,e.execTime=t.execTime,e.fields=z.defaultFieldProperties(t.fields),e.records=t.records}))})}},G={readFile:l,parseJSON:n,loadJSON:function(e){const t=e.name.endsWith("c")||e.name.endsWith(".gz");return l(e,!1,t).then(e=>n(e,t))},fetchJSON:function(e){const t=decodeURIComponent(e),a=t.endsWith("c")||t.endsWith(".gz");return fetch(t).then(e=>a?e.arrayBuffer():e.json()).then(e=>n(e,a))},downloadDataFile:r,downloadJSON:function(e,t,a=!0){const s=JSON.stringify(e),l=a?o.gzip(s):s,n=a?"c":"r";r(l,`${t}${e.hasOwnProperty("edges")?`.gf${n}`:`.nd${n}`}`)}},U={singleToMulti:d,mappingToTable:function(e){const t=e.hasOwnProperty("field")?d(e):e,a={key:t.key,format:"text"};return{fields:z.defaultFieldProperties([a].concat(t.fields)),records:Object.entries(t.mapping).map(e=>{const a={};return a[t.key]=e[0],t.fields.forEach((t,o)=>{a[t.key]=e[1][o]}),a})}},tableToMapping:function(e,t,a=["index"]){const o={created:(new Date).toString(),fields:z.defaultFieldProperties(e.fields.filter(e=>e.key!==t).filter(e=>!a.includes(e.key))),key:t,mapping:{}};return e.records.forEach(e=>{o.mapping[e[t]]=o.fields.map(t=>e[t.key])}),o},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),a=t.shift().split(","),o=a.shift(),s=new Date,l=[],n=[];a.forEach((e,t)=>{""!==e&&(l.push(t),n.push({key:e,format:"text"}))});const r={created:s.toString(),fields:z.defaultFieldProperties(n),key:o,mapping:{}};return t.forEach(e=>{const t=e.split(","),a=t.shift();r.mapping[a]=Array(l.length),l.forEach(e=>{r.mapping[a][e]=t[e]})}),r},apply:function(e,t){const o=t.hasOwnProperty("field")?d(t):t;e.records.filter(e=>o.mapping.hasOwnProperty(e[o.key])).forEach(e=>{o.fields.forEach((t,a)=>{e[t.key]=o.mapping[e[o.key]][a]})}),e.fields=a(e.fields).concat(z.defaultFieldProperties(o.fields)).uniqBy("key").value()}},Q={plotCell:function(e,t,a){new s.View(s.parse(t[a.key])).initialize(e.node()).run()},plotThumbnail:function(e){return new s.View(s.parse(e)).toImageURL("png")},binaryToDataURI:function(e){return new Promise(t=>{const a=new FileReader;a.onload=(e=>{t(e.target.result)}),a.readAsDataURL(e)})}};const K={numeric:c,text:c,raw:c,d3_format:i,compound_id:u,assay_id:c,list:c,plot:Q.plotCell,image:m,checkbox:f,text_field:h,control:y,svg:p,html:p};var W={d3Format:i,text:c,html:p,compound_id:u,image:m,checkbox:f,textField:h,call:y,rowFactory:function(e){return(t,a)=>{e.forEach(e=>{const o=t.append("div").classed("dg-cell",!0).classed("align-middle",!0).classed("text-truncate",!0).style("display","inline-block").style("width",`${e.width}%`);a.hasOwnProperty(e.key)&&o.call(K[e.format],a,e)})}}};class X{constructor(e){this.data=e,this.visibleFields=null,this.sortedRecords=null,this.filteredRecords=null;const t=this.data.snapshot||{sortOrder:[],filterText:null};this.sortOrder=t.sortOrder||[],this.filterText=t.filterText||null,this.defaultColumnHeight={numeric:40,text:40,none:200},this.scrollBarSpace=20,this.keyFunc=(e=>e.index),this.rowHeight=null,this.contentWidth=null,this.bodyHeight=null,this.viewportHeight=null,this.numViewportRows=null,this.previousNumViewportRows=null,this.viewportTop=null,this.previousVieportTop=null,this.viewportBottom=null,this.fixedViewportHeight=null,this.updateContentsNotifier=null,this.updateFilterNotifier=null,this.rowFactory=(()=>W.rowFactory(this.visibleFields)),this.applyData()}setViewportSize(e){this.viewportHeight=this.fixedViewportHeight||e,this.previousNumViewportRows=this.numViewportRows,this.numViewportRows=Math.ceil(this.viewportHeight/this.rowHeight)+1}setScrollPosition(e){this.previousViewportTop=this.viewportTop,this.viewportTop=e,this.viewportBottom=Math.min(this.viewportTop+this.numViewportRows,this.filteredRecords.length)}setSortOrder(e,t){const a=this.sortOrder.findIndex(e=>e.key),o={key:e,order:t};-1!==a&&this.sortOrder.splice(a,1),this.sortOrder.splice(0,0,o),this.applyOrder(e,t)}setFilterText(e){this.filterText=e,this.applyFilter()}joinFields(e){U.apply(this.data,e),this.applyData()}applyData(){this.visibleFields=this.data.fields.filter(e=>e.visible);const e=this.visibleFields.reduce((e,t)=>e+(t.widthf||1),0);this.visibleFields=this.visibleFields.map(t=>{const a={width:(t.widthf||1)/e*100,height:t.height||this.defaultColumnHeight[z.sortType(t.format)]};return Object.assign(a,t)}),this.rowHeight=this.visibleFields.reduce((e,t)=>e.height>t.height?e:t).height,this.applyOrder()}applyOrder(e,t){if(e)this.sortedRecords=a.orderBy(this.data.records.slice(),[e],[t]);else{const e=this.sortOrder.map(e=>e.key),t=this.sortOrder.map(e=>e.order);e&&(this.sortedRecords=a.orderBy(this.data.records.slice(),e,t))}this.applyFilter()}applyFilter(){if(null===this.filterText)this.filteredRecords=this.sortedRecords.slice();else{const e=this.visibleFields.filter(e=>"none"!==z.sortType(e.format)).map(e=>e.key);this.filteredRecords=this.sortedRecords.filter(t=>e.some(e=>z.partialMatch(this.filterText,t[e])))}this.bodyHeight=this.filteredRecords.length*this.rowHeight}recordsToShow(){return this.filteredRecords.slice(this.viewportTop,this.viewportBottom)}export(){return this.data.id=z.uuidv4(),this.data}}var Y={updateHeader:function(e,t){const a=e.select(".dg-header");a.selectAll(".dg-hcell").remove(),a.selectAll(".dg-hcell").data(t.visibleFields).enter().append("div").classed("dg-hcell",!0).style("display","inline-block").style("width",e=>`${e.width}%`).text(e=>e.name),e.style("width","100%").dispatch("resize");const o=e.select(".dg-viewport"),s=Math.floor(o.node().scrollTop/t.rowHeight);t.setScrollPosition(s),e.call(b,t)},updateRows:b,resizeViewport:function(e,t){e.select(".dg-viewport").style("height",`${t.viewportHeight}px`)}},Z={setSort:g},ee={resize:x,datagrid:function(e,t){e.selectAll("div").remove(),e.on("resize",()=>e.call(x,t)),e.append("div").classed("dg-header",!0),e.append("div").classed("dg-viewport",!0).style("overflow-y","auto").on("scroll",function(){const a=Math.floor(this.scrollTop/t.rowHeight);a!==t.previousViewportTop&&(t.setScrollPosition(a),e.call(Y.updateRows,t))}).append("div").classed("dg-body",!0).style("position","relative"),t.updateContentsNotifier=(()=>{t.applyData(),e.call(Y.updateHeader,t)}),t.updateFilterNotifier=(a=>{t.setFilterText(a),t.setScrollPosition(0),e.call(Y.updateRows,t),e.select(".dg-viewport").node().scrollTop=0}),t.updateContentsNotifier()}};const te={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},ae={datatable:"nodes",connection:"edges"};var oe={convertTable:function(e){let t=e;return t.hasOwnProperty("schemaVersion")||t.hasOwnProperty("$schema")||(t=v(t)),"0.8"==t.schemaVersion&&(t=k(t=function(e){return e.records.forEach((e,t)=>{e.index=t,e.structure=e._structure,delete e._index,delete e._structure}),e.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")}),e}(t))),t.hasOwnProperty("$schema")||(delete t.schemaVersion,delete t.revision,t.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),t.fields.filter(e=>"structure"===e.key).forEach(e=>{e.format="svg"}),t},convertNetwork:function(e){let a=e;return a.edges.hasOwnProperty("schemaVersion")||a.edges.hasOwnProperty("$schema")||(a.nodes=v(a.nodes),a.edges=function(e,t){const a={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(a.nodeColor.id=e.snapshot.nodeColor.id,a.nodeColor.scale=e.snapshot.nodeColor.scale,a.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):a.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(a.nodeSize.id=e.snapshot.nodeSize.id,a.nodeSize.scale=e.snapshot.nodeSize.scale,a.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):a.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(a.nodeLabel.id=e.snapshot.nodeLabel.id,a.nodeLabel.size=e.snapshot.nodeLabel.size,a.nodeLabel.text=e.snapshot.nodeLabel.text,a.nodeLabel.visible=e.snapshot.nodeLabel.visible,a.nodeLabel.scale=e.snapshot.nodeLabel.scale,a.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):a.nodeLabel={id:"label",size:12,text:"index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?a.nodeContent=e.snapshot.nodeContent:a.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?a.edge=e.snapshot.edge:a.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:ae[e.format],schemaVersion:.8,revision:0,reference:{nodes:e.nodeTableId},status:te[e.status],fields:z.defaultFieldProperties([{key:"source"},{key:"target"},{key:"weight"}]),records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:a}}(a.edges,a.nodes.fields)),"0.8"!=a.edges.schemaVersion&&.1!==a.edges.schemaVersion||((a=function(e){if(e.edges.hasOwnProperty("reference")||(e.edges.reference={nodes:e.edges.nodesID}),e.nodes.fields.find(e=>"_index"===e.key)){const t={};e.nodes.records.forEach((e,a)=>{e.index=a,e.structure=e._structure,t[e._index]=e.index,delete e._index,delete e._structure}),e.edges.records.forEach(e=>{e.source=t[e.source],e.target=t[e.target]}),e.nodes.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")})}return e}(a)).nodes=k(a.nodes),a.edges=function(e){const a={networkThreshold:e.networkThreshold};return a.nodeContentVisible=e.snapshot.nodeContent.structure.visible,a.nodeColor=e.snapshot.nodeColor.scale||{},a.nodeColor.field&&(a.nodeColor.field=e.snapshot.nodeColor.field.key,"_index"===a.nodeColor.field&&(a.nodeColor.field="index")),"ordinal"===a.nodeColor.scale&&(a.nodeColor.range=t.schemeCategory20),a.nodeSize=e.snapshot.nodeSize.scale||{},e.snapshot.nodeSize.field&&(a.nodeSize.field=e.snapshot.nodeSize.field.key,"_index"===a.nodeSize.field&&(a.nodeSize.field="index")),a.nodeLabel={},e.snapshot.nodeLabel.text&&(a.nodeLabel.text=e.snapshot.nodeLabel.text.key,"_index"===a.nodeLabel.text&&(a.nodeLabel.text="index")),a.nodeLabel.size=e.snapshot.nodeLabel.size,a.nodeLabel.visible=e.snapshot.nodeLabel.visible,a.nodeLabelColor=e.snapshot.nodeLabel.scale||{},e.snapshot.nodeLabel.field&&(a.nodeLabelColor.field=e.snapshot.nodeLabel.field.key,"_index"===a.nodeLabelColor.field&&(a.nodeLabelColor.field="index")),"ordinal"===a.nodeLabelColor.scale&&(a.nodeLabelColor.range=t.schemeCategory20),a.edgeVisible=e.snapshot.edge.visible,a.edgeWidth=e.snapshot.edge.scale||{},a.edgeLabel={},a.edgeLabel.size=e.snapshot.edge.label.size,a.edgeLabel.visible=e.snapshot.edge.label.visible,a.networkThreshold=e.networkThreshold||e.query.threshold,a.coords=e.snapshot.nodePositions,{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:{params:e.query},progress:e.progress,execTime:e.execTime,created:e.created,snapshot:a,reference:e.reference}}(a.edges)),a.edges.hasOwnProperty("$schema")||(delete a.nodes.schemaVersion,delete a.edges.schemaVersion,delete a.nodes.revision,delete a.edges.revision,a.nodes.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json",a.edges.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),a}},se={buttonBox:function(e,t,a,o){e.classed("form-group",!0).classed("mb-1",!0).append("button").classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).attr("id",t).text(a)},menuButton:function(e,t,a,o){e.classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("id",t).text(a)},menuButtonLink:function(e,t,a,o){e.classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("role","button").attr("href","#").attr("id",t).text(a)},menuModalLink:function(e,t,a,o,s){e.classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("id",t).attr("href","#").attr("role","button").attr("data-toggle","modal").attr("data-target",`#${s}`).text(a)},dropdownMenuButton:function(e,t,a,o){e.classed("btn-group",!0).classed("mr-1",!0).attr("id",t),e.append("button").classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown").text(a),e.append("div").classed("dropdown-menu",!0)},dropdownMenuItem:function(e,t,a){e.classed("dropdown-item",!0).attr("id",t).attr("href","#").text(a)},dropdownMenuModal:function(e,t,a,o){e.classed("dropdown-item",!0).attr("id",t).attr("href","#").attr("data-toggle","modal").attr("data-target",`#${o}`).text(a)},dropdownMenuFile:function(e,a,o,s){e.classed("dropdown-item",!0).attr("id",a).attr("href","#").text(o).on("click",function(){t.select(this).select("input").node().click()}).append("form").style("display","none").append("input").attr("type","file").attr("accept",s)},dropdownMenuFileValue:function(e){return e.select("input").node().files[0]}},le={confirmDialog:function(e,a,o){const s=e.call(w,a).select(".modal-content");s.append("div").classed("modal-body",!0).append("div").classed("message",!0).text(o);const l=s.append("div").classed("modal-footer",!0);l.append("button").classed("btn",!0).classed("btn-outline-secondary",!0).classed("cancel",!0).attr("type","button").attr("data-dismiss","modal").text("Cancel"),l.append("button").classed("btn",!0).classed("btn-warning",!0).classed("ok",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${a}-submit`).text("OK").on("click",()=>{t.select("#loading-icon").style("display","inline"),e.dispatch("submit")})},submitDialog:function(e,a,o){const s=e.call(w,a).select(".modal-content"),l=s.append("div").classed("modal-header",!0);l.append("h4").classed("modal-title",!0).text(o),l.append("button").attr("type","button").attr("data-dismiss","modal").attr("aria-label","Close").classed("close",!0).append("span").attr("aria-hidden",!0).html("&times;"),s.append("div").classed("modal-body",!0),s.append("div").classed("modal-footer",!0).append("button").classed("btn",!0).classed("btn-primary",!0).classed("submit",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${a}-submit`).text("Submit").on("click",()=>{t.select("#loading-icon").style("display","inline"),e.dispatch("submit")})}},ne={selectBox:function(e,t,a,o,s){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(a),e.append("select").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t),o&&(e.call(B,o),e.call(S,s))},selectBoxItems:B,updateSelectBox:S,selectBoxValue:function(e){return e.select("select").property("value")},checklistBox:function(e,t,a,o,s){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(a),e.append("ul").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t),o&&(e.call(T,o),e.call(C,s))},checklistBoxItems:T,updateChecklistBox:C,checklistBoxValue:function(e){return e.selectAll("input:checked").data().map(e=>e.key)}},re={render:function(e,t,a,o,s){e.classed("table",!0).classed("table-striped",!0).classed("table-hover",!0).attr("id",t),a&&e.append("caption").text(a),e.append("thead").append("tr"),e.append("tbody"),o&&e.call(D,o,s)},updateHeader:D,updateContents:V};const de="fieldconf-dialog",ie="Column setting";var ce={menuLink:function(e){e.call(se.dropdownMenuModal,"fieldconf",ie,de)},updateRowFunc:L,body:function(e){const t=z.defaultFieldProperties([{key:"name",format:"text"},{key:"visible",format:"control"},{key:"format",format:"control"},{key:"d3_format",format:"control"}]);e.call(le.submitDialog,de,ie).select(".modal-body").append("table").classed("field",!0).call(re.render,null,null,t)},updateBody:function(e,t){e.select(".field").call(re.updateContents,t.data.fields.slice(),e=>e.key,L)},value:function(e){const a=[];return e.select("tbody").selectAll("tr").each(function(e){const o=function(e){const t={};return t.visible=e.select(".visible").select("input").property("checked"),t.format=e.select(".format").select("select").property("value"),"d3_format"===t.format&&(t.d3_format=e.select(".d3format").select("input").property("value")),t}(t.select(this));o.key=e.key,o.name=e.name,a.push(o)}),a}},pe={textBox:function(e,t,a,o,s){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(a),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","text").attr("size",o),e.call(O,s)},updateTextBox:O,textBoxValue:function(e){return e.select("input").property("value")},readonlyBox:function(e,t,a,o){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(a),e.append("input").classed("form-control-plaintext",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","text").property("readonly",!0),e.call(O,o)},textareaBox:function(e,t,a,o,s,l){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(a),e.append("textarea").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("rows",o).attr("placeholder",s).attr("id",t),e.call(F,l)},updateTextareaBox:F,textareaBoxValue:function(e){const t=e.select("textarea").property("value");if(t)return t;const a=e.select("textarea").attr("placeholder");return a||""},textareaBoxLines:function(e){const t=e.select("textarea").property("value");if(t)return t.split("\n").filter(e=>e.length>0);const a=e.select("textarea").attr("placeholder");return a?a.split("\n").filter(e=>e.length>0):[]},checkBox:function(e,t,a,o){const s=e.classed("form-group",!0).classed("form-row",!0).classed("form-check",!0).append("label").classed("form-check-label",!0).classed("col-form-label-sm",!0);s.append("input").classed("form-check-input",!0).attr("type","checkbox").attr("id",t),s.append("span").text(a),e.call(I,o)},updateCheckBox:I,checkBoxValue:function(e){return e.select("input").property("checked")},numberBox:function(e,t,a,o,s,l,n){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(a),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","number").attr("min",o).attr("max",s).attr("step",l),e.call(M,n)},updateNumberBox:M,numberBoxValue:function(e){return e.select("input").property("value")},fileInputBox:function(e,t,a,o){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(a),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",o).attr("id",t)},fileInputBoxValue:function(e){return e.select("input").property("files")[0]}},ue={setFilter:function(e,t){const a=e.classed("row",!0).classed("justify-content-end",!0).append("div").classed("col-5",!0).call(pe.textBox,null,"Search",40,null);a.select("label").classed("text-right",!0),a.select("input").on("keyup",function(){t.updateFilterNotifier(pe.textBoxValue(a))})}};const me="fieldfetch-dialog",fe="Append assays";let he=null;var ye={menuLink:function(e){e.call(se.dropdownMenuModal,"fieldfetch",fe,me)},body:function(e,t){const o=t.resources.filter(e=>"assay"===e.domain),s=a(o.map(e=>e.data)).flatten().value(),l={fields:z.defaultFieldProperties([{key:"check",name:"Check",format:"checkbox",widthf:.5,height:40},{key:"assay_id",name:"Assay ID",format:"assay_id"},{key:"name",name:"Name",format:"text"},{key:"tags",name:"Tags",format:"list",widthf:2}]),records:s.map(e=>(e.check=!1,e))},n=e.call(le.submitDialog,me,fe);he=new X(l);const r=n.select(".modal-body"),d=r.append("div").classed("fetchd-filter",!0),i=r.append("div").classed("fetchd-dg",!0);i.call(ee.datagrid,he),d.call(ue.setFilter,he),he.fixedViewportHeight=200,i.call(Y.resizeViewport,he);const c=a(s.map(e=>e.value_types)).flatten().uniqBy("key").value();r.append("div").classed("my-3",!0).classed("vtype",!0).call(ne.checklistBox,null,"Value type",c,["IC50"])},updateBody:function(e){he.data.records.forEach(e=>{e.check=!1}),he.updateContentsNotifier()},queries:function(e,t,a){return he.data.records.filter(e=>e.check&&!e.check_d).map(o=>({workflow:"activity",targets:t,assay_id:o.assay_id,condition:{compounds:a,value_types:ne.checklistBoxValue(e.select(".vtype"))}}))}};const be="fieldfile-dialog",ge="Append JSON fields";var xe={menuLink:function(e){e.call(se.dropdownMenuModal,"fieldfile",ge,be)},body:function(e){const t=e.call(le.submitDialog,be,ge),a=t.select(".modal-body").append("div").classed("file",!0).call(pe.fileInputBox,"fieldfile-file","File",".json,.csv"),o=t.select(".modal-body").append("div").classed("preview",!0).call(re.render);a.on("change",()=>{const e=pe.fileInputBoxValue(a),t="csv"===e.name.split(".").pop();G.readFile(e).then(e=>{const a=t?U.csvToMapping(e):JSON.parse(e),s=U.mappingToTable(a);o.call(re.updateHeader,s.fields,s.records.slice(0,5))})})},readFile:function(e){const t=pe.fileInputBoxValue(e.select(".file")),a="csv"===t.name.split(".").pop();return G.readFile(t).then(e=>{let t=a?U.csvToMapping(e):JSON.parse(e);t.hasOwnProperty("field")&&(t=U.singleToMulti(t));const o=[];if(t.fields.forEach((e,a)=>{"plot"===e.format&&(t.fields[a].format="image",o.push(a))}),o.length>0){const e=[];return Object.entries(t.mapping).forEach(a=>{o.forEach(o=>{const s=Q.plotThumbnail(a[1][o]).then(e=>{t.mapping[a[0]][o]=e});e.push(s)})}),Promise.all(e).then(()=>t)}return t})}};const ve="fieldinput-dialog",ke="Append input field",we={checkbox:!1,text_field:""};var Be={menuLink:function(e){e.call(se.dropdownMenuModal,"fieldinput",ke,ve)},body:function(e){const t=e.call(le.submitDialog,ve,ke).select(".modal-body");t.append("div").classed("key",!0).call(pe.textBox,null,"Field key",40,null),t.append("div").classed("type",!0).call(ne.selectBox,null,"Type",[{key:"checkbox",name:"Checkbox"},{key:"text_field",name:"Text field"}],"checkbox")},updateBody:function(e){e.select(".key").call(pe.updateTextBox,null),e.select(".type").call(ne.updateSelectBox,"checkbox")},value:function(e){const t=pe.textBoxValue(e.select(".key")),a=ne.selectBoxValue(e.select(".type"));return{field:{key:t,name:t,format:a},default:we[a]}}},Se={queryMolGroup:function(e,t,a){e.classed("mb-3",!0),e.append("div").classed("format",!0).classed("mb-1",!0).call(ne.selectBox,`${t}-format`,"Format",[{key:"molfile",name:"MDL Molfile"},{key:"dbid",name:"Compound ID"}],"molfile");const o=a.map(e=>({key:e.id,name:e.name}));e.append("div").classed("source",!0).classed("mb-1",!0).call(ne.selectBox,`${t}-source`,"Source",o,null),e.append("div").classed("textquery",!0).classed("mb-1",!0).call(pe.textBox,`${t}-textquery`,"Query",null,""),e.append("div").classed("areaquery",!0).classed("mb-1",!0).call(pe.textareaBox,`${t}-areaquery`,"Query",6,null,""),$(function(){$('[data-toggle="popover"]').popover({html:!0,trigger:"focus"})}),e.append("div").classed("form-row",!0).classed("justify-content-end",!0).append("button").classed("preview",!0).attr("data-toggle","popover").attr("data-html","true").attr("data-content",'<div id="previmg"></div>').call(se.menuButton,`${t}-preview`,"Structure preview","primary"),e.call(P)},updateQueryMolGroup:P,queryMolGroupValue:_,simOptionGroup:function(e,t){e.classed("mb-3",!0).append("p").append("button").classed("btn",!0).classed("btn-sm",!0).classed("btn-outline-primary",!0).classed("dropdown-toggle",!0).attr("data-toggle","collapse").attr("data-target",`#${t}-collapse`).attr("aria-expanded","false").attr("aria-controls",`${t}-collapse`).text("Optional parameters");const a=e.append("div").classed("collapse",!0).attr("id",`${t}-collapse`).append("div").classed("card",!0).classed("card-body",!0);a.append("div").classed("ignoreh",!0).classed("mb-1",!0).call(pe.checkBox,`${t}-ignoreh`,"Ignore explicit hydrogens",!0),a.append("div").classed("timeout",!0).classed("mb-1",!0).call(pe.numberBox,`${t}-timeout`,"Timeout",1,999,1,2),a.append("div").classed("diam",!0).classed("mb-1",!0).call(pe.numberBox,`${t}-diam`,"Diameter (MCS-DR/GLS)",4,999,1,8),a.append("div").classed("tree",!0).classed("mb-1",!0).call(pe.numberBox,`${t}-tree`,"Max tree size (MCS-DR/GLS)",20,999,1,40),a.selectAll("label.col-form-label").classed("col-4",!1).classed("col-6",!0),a.selectAll("input.form-control").classed("col-8",!1).classed("col-6",!0)},simOptionGroupValue:function(e){const t=e.select(".timeout"),a=e.select(".diam"),o=e.select(".tree"),s={ignoreHs:pe.checkBoxValue(e.select(".ignoreh"))};return t.select("input").property("disabled")||(s.timeout=pe.numberBoxValue(t)),a.select("input").property("disabled")||(s.diameter=pe.numberBoxValue(a)),o.select("input").property("disabled")||(s.maxTreeSize=pe.numberBoxValue(o)),s}};const Te="networkgen-dialog",Ce="Generate similarity network";var De={menuLink:function(e){e.call(se.dropdownMenuModal,"fieldconf",Ce,Te)},body:function(e,a){const o=e.call(le.submitDialog,Te,Ce),s=[{key:"gls",name:"Graph-based local similarity(GLS)"}];a&&(s.push({key:"rdmorgan",name:"RDKit Morgan similarity"}),s.push({key:"rdfmcs",name:"RDKit FMCS"})),o.select(".modal-body").append("div").classed("measure",!0).call(ne.selectBox,"networkgen-measure","Measure",s,"gls"),o.select(".modal-body").append("div").classed("thld",!0).call(pe.numberBox,"networkgen-thld","Threshold",.5,1,.01,.5),o.select(".modal-body").append("div").classed("option",!0).call(Se.simOptionGroup,"networkgen"),o.select(".measure").on("change",function(){const e=ne.selectBoxValue(t.select(this));o.selectAll(".diam, .tree").select("input").property("disabled","gls"!==e),o.select(".timeout").select("input").property("disabled",!["gls","rdfmcs"].includes(e))}).dispatch("change")},queryParams:function(e){const t=e.select(".measure"),a=e.select(".thld"),o=Se.simOptionGroupValue(e.select(".option"));return t.select("select").property("disabled")||(o.measure=ne.selectBoxValue(t)),a.select("input").property("disabled")||(o.threshold=pe.numberBoxValue(a)),o}};const Ve="rename-dialog",Le="Rename";var Oe={menuLink:function(e){e.call(se.dropdownMenuModal,"rename",Le,Ve)},body:function(e,t){e.call(le.submitDialog,Ve,Le).select(".modal-body").append("div").classed("rename",!0).call(pe.textBox,"rename","New name",40,t)},updateBody:function(e,t){e.select(".rename").call(pe.updateTextBox,t.data.name)},value:function(e){return pe.textBoxValue(e.select(".rename"))}},Fe={setFilter:function(e,t){const a=e.classed("row",!0).classed("justify-content-end",!0).append("div").classed("col-5",!0).call(pe.textBox,null,"Search",40,null);a.select("label").classed("text-right",!0),a.select("input").on("keyup",function(){t.updateFilterNotifier(pe.textBoxValue(a))})}},Ie={app:function(e,a,o){const s=t.select("#menubar");s.selectAll("div,span,a").remove();const l=t.select("#dialogs");l.selectAll("div").remove();const n=new X(oe.convertTable(e));n.serverStatus=a,n.resourceSchema=o;const r=s.append("div").call(se.dropdownMenuButton,null,"View control","primary").select(".dropdown-menu");r.append("a").call(ce.menuLink),r.append("a").call(ye.menuLink),r.append("a").call(xe.menuLink),r.append("a").call(Be.menuLink),r.append("a").classed("networkgend",!0).call(De.menuLink),r.append("a").call(Oe.menuLink),r.append("a").classed("saveview",!0).call(se.dropdownMenuItem,null,"Save"),r.append("a").classed("exportjson",!0).call(se.dropdownMenuItem,null,"Download JSON"),r.append("a").classed("exportexcel",!0).call(se.dropdownMenuItem,null,"Download Excel"),s.append("a").call(se.menuButtonLink,null,"Control panel","outline-secondary").attr("href","control.html").attr("target","_blank"),s.append("a").classed("refresh",!0).call(se.menuButtonLink,null,"Refresh","outline-secondary"),s.append("a").classed("abort",!0).call(se.menuButtonLink,null,"Abort server job","warning").attr("data-toggle","modal").attr("data-target","#abort-dialog"),s.append("span").classed("progress",!0).append("progress").attr("max",100),s.append("span").classed("title",!0),s.append("span").classed("status",!0),l.append("div").classed("fieldconfd",!0).call(ce.body),l.append("div").classed("fieldfetchd",!0).call(ye.body,o,n.fetchedAssays),l.append("div").classed("fieldfiled",!0).call(xe.body),l.append("div").classed("fieldinputd",!0).call(Be.body),l.append("div").classed("netgend",!0).call(De.body,a.rdkit),l.append("div").classed("renamed",!0).call(Oe.body,n.data.name),l.append("div").classed("abortd",!0).call(le.confirmDialog,"abort-dialog","Are you sure you want to abort this calculation job?"),t.select("#datagrid").call(ee.datagrid,n).call(Z.setSort,n),t.select("#dg-search").call(Fe.setFilter,n),t.select("#datagrid").dispatch("resize"),window.onresize=(()=>t.select("#datagrid").dispatch("resize")),q(n)},updateApp:q};const Me="search-dialog",Pe="Search by compound ID";var _e={menuLink:function(e){e.call(se.dropdownMenuModal,"search",Pe,Me)},body:function(e,t){e.call(le.submitDialog,Me,Pe).select(".modal-body").append("div").classed("ids",!0).call(pe.textareaBox,"search-query","Query",20,t,"")},query:function(e,t){return{workflow:"search",targets:t,key:"compound_id",values:pe.textareaBoxLines(e.select(".ids"))}}};const $e="struct-dialog",qe="Search by structure";var Ne={menuLink:function(e){e.call(se.dropdownMenuModal,"struct",qe,$e)},body:function(e,a,o){const s=e.call(le.submitDialog,$e,qe);s.select(".modal-body").append("div").classed("qmol",!0).call(Se.queryMolGroup,"struct",a,null);const l=[{key:"exact",name:"Exact match"},{key:"substr",name:"Substructure"},{key:"supstr",name:"Superstructure"},{key:"gls",name:"MCS-DR/GLS"}];o&&(l.push({key:"rdmorgan",name:"RDKit Morgan similarity"}),l.push({key:"rdfmcs",name:"RDKit FMCS"})),s.select(".modal-body").append("div").classed("method",!0).call(ne.selectBox,"struct-method","Method",l,"exact"),s.select(".modal-body").append("div").classed("measure",!0).call(ne.selectBox,"struct-measure","Measure",[{key:"sim",name:"Similarity"},{key:"edge",name:"Edge count"}],"sim"),s.select(".modal-body").append("div").classed("thld",!0).call(pe.numberBox,"struct-thld","Threshold",.5,1,.01,.5),s.select(".modal-body").append("div").classed("option",!0).call(Se.simOptionGroup,"struct");const n=a.map(e=>({key:e.id,name:e.name}));s.select(".modal-body").append("div").classed("target",!0).call(ne.checklistBox,"struct-target","Target databases",n,null),s.select(".method").on("change",function(){const e=ne.selectBoxValue(t.select(this)),a=["gls","rdfmcs"].includes(e);s.select(".measure").select("select").property("value",a?void 0:"sim").property("disabled",!a),s.selectAll(".thld").select("input").property("disabled",["exact","substr","supstr"].includes(e)),s.selectAll(".diam, .tree").select("input").property("disabled","gls"!==e),s.select(".timeout").select("input").property("disabled",!a)}).dispatch("change")},query:function(e){const t=Se.simOptionGroupValue(e.select(".option")),a=e.select(".measure"),o=e.select(".thld");return a.select("select").property("disabled")||(t.measure=ne.selectBoxValue(a)),o.select("input").property("disabled")||(t.threshold=pe.numberBoxValue(o)),{workflow:ne.selectBoxValue(e.select(".method")),targets:ne.checklistBoxValue(e.select(".target")),queryMol:Se.queryMolGroupValue(e.select(".qmol")),params:t}}};const ze="filter-dialog",Ae="Search by properties";var Re={menuLink:function(e){e.call(se.dropdownMenuModal,"prop",Ae,ze)},body:function(e,t){const o=e.call(le.submitDialog,ze,Ae),s=a(t.map(e=>e.fields)).flatten().uniqBy("key").value().filter(e=>e.hasOwnProperty("d3_format")||["compound_id","numeric","text"].includes(e.format));o.select(".modal-body").append("div").classed("key",!0).call(ne.selectBox,"filter-field","Field",s,null),o.select(".modal-body").append("div").classed("operator",!0).call(ne.selectBox,"filter-op","Operator",[{key:"eq",name:"="},{key:"gt",name:">"},{key:"lt",name:"<"},{key:"ge",name:">="},{key:"le",name:">="},{key:"lk",name:"LIKE"}],"eq"),o.select(".modal-body").append("div").classed("value",!0).call(pe.textBox,"filter-value","Value",null,"");const l=t.map(e=>({key:e.id,name:e.name}));o.select(".modal-body").append("div").classed("target",!0).call(ne.checklistBox,"struct-target","Target databases",l,null)},query:function(e){return{workflow:"filter",targets:ne.checklistBoxValue(e.select(".target")),key:ne.selectBoxValue(e.select(".key")),value:pe.textBoxValue(e.select(".value")),operator:ne.selectBoxValue(e.select(".operator"))}}};const je="sdf-dialog",Ee="Import SDFile";var He={menuLink:function(e){e.call(se.dropdownMenuModal,"sdf",Ee,je)},body:function(e){const a=e.call(le.submitDialog,je,Ee);a.select(".modal-body").append("div").classed("file",!0).call(pe.fileInputBox,"sdf-file","File",".mol,.sdf"),a.select(".modal-body").append("div").classed("field",!0).call(ne.checklistBox,"sdf-fields","Fields",[],null),a.select(".modal-body").append("div").classed("implh",!0).call(pe.checkBox,"sdf-implh","Make hydrogens implicit",!0),a.select(".modal-body").append("div").classed("recalc",!0).call(pe.checkBox,"sdf-recalc","Recalculate 2D coords",!1),a.select(".file").on("change",function(){const e=pe.fileInputBoxValue(t.select(this));return G.readFile(e,104857600,!1).then(e=>{const t=function(e){const t=/>.*?<(\S+)>/g,a=new Set;let o;for(;null!==(o=t.exec(e));)a.add(o[1]);return Array.from(a)}(e).map(e=>({key:e,name:e}));a.select(".field").call(ne.checklistBoxItems,t)})})},queryFormData:function(e){const t={fields:ne.checklistBoxValue(e.select(".field")),implh:pe.checkBoxValue(e.select(".implh")),recalc:pe.checkBoxValue(e.select(".recalc"))},a=new FormData;return a.append("contents",pe.fileInputBoxValue(e.select(".file"))),a.append("params",JSON.stringify(t)),a}},Je={app:function(e,a){const o=t.select("#menubar");o.selectAll("div,span,a").remove();const s=t.select("#dialogs");s.selectAll("div").remove();const l=o.append("div").call(se.dropdownMenuButton,null,"+ New datagrid","primary").select(".dropdown-menu");l.append("a").classed("searchd",!0).call(_e.menuLink),l.append("a").classed("structd",!0).call(Ne.menuLink),l.append("a").classed("filterd",!0).call(Re.menuLink),l.append("a").classed("sdfd",!0).call(He.menuLink),l.append("a").classed("import",!0).call(se.dropdownMenuFile,"import","Import JSON",".ndc,.ndr,.json,.gz").on("change",function(){const o=se.dropdownMenuFileValue(t.select(this));G.loadJSON(o).then(t=>Ie.app(t,e,a))}),o.append("a").call(se.menuButtonLink,null,"Control panel","outline-secondary").attr("href","control.html").attr("target","_blank"),e.instance||l.selectAll(".searchd, .structd, .filterd, .sdfd").attr("data-target",null).classed("disabled",!0);const n=a.resources.filter(e=>"chemical"===e.domain);s.append("div").call(_e.body,a.compoundIDPlaceholder).on("submit",function(){const e=n.map(e=>e.id),a=_e.query(t.select(this),e);return H.get(a.workflow,a).then(N)}),s.append("div").call(Ne.body,n,e.rdkit).on("submit",function(){const e=Ne.query(t.select(this));return H.get(e.workflow,e).then(N)}),s.append("div").call(Re.body,n).on("submit",function(){const e=Re.query(t.select(this));return H.get(e.workflow,e).then(N)}),s.append("div").call(He.body,n).on("submit",function(){const e=He.queryFormData(t.select(this));return H.post("sdfin",e).then(N)})}};return{DatagridState:X,sort:Z,view:ee,run:function(){document.location.protocol,"onLine"in navigator&&navigator.onLine;const e={};return H.get("server").then(H.json).then(t=>{e.server=t}).then(()=>H.get("schema")).then(H.json).then(t=>{e.schema=t}).catch(()=>{console.info("Server did not respond"),e.server={},e.schema={resources:[],templates:[],compoundIDPlaceholder:null}}).then(()=>{console.info("Off-line mode is disabled for debugging");const t=z.URLQuery().id||null,a=z.URLQuery().location||null;t?J.fetchProgress(t,"update").then(()=>j.getItemByID(t)).then(t=>Ie.app(t,e.server,e.schema)):a?G.fetchJSON(a).then(t=>Ie.app(t,e.server,e.schema)):Je.app(e.server,e.schema)})}}});
//# sourceMappingURL=kwdatagrid.js.map
