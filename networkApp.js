// https://github.com/mojaie/kiwiii Version 0.14.0. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("lodash"),require("Dexie"),require("pako"),require("jLouvain")):"function"==typeof define&&define.amd?define(["d3","lodash","Dexie","pako","jLouvain"],t):e.networkApp=t(e.d3,e._,e.Dexie,e.pako,e.jLouvain)}(this,function(e,t,o,a,n){"use strict";const s=!1;e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,o=o&&o.hasOwnProperty("default")?o.default:o,a=a&&a.hasOwnProperty("default")?a.default:a,n=n&&n.hasOwnProperty("default")?n.default:n;var l={defaultFieldProperties:function(e){return e.map(e=>(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),e))},sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id","assay_id","list"].includes(e)?"text":"none"},formatNum:function(t,o){return null==t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(o)(t):t},partialMatch:function(e,t){return null!=t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},URLQuery:function(){const e=window.location.search.substring(1).split("&").map(e=>e.split("="));return t.fromPairs(e)},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const r={items:"storeID, dataType, created"};let c=new o("Store");c.version(1).stores(r);var d={getAllItems:function(){return c.items.orderBy("created").reverse().toArray()},getItemsByDataType:function(e){return c.items.where("dataType").equals(e).reverse().sortBy("created").catch(t=>{console.error(`IDBError: Unexpected dataType: ${e}`,t)})},getItemByID:function(e){return c.items.where("storeID").equals(e).first().catch(t=>{console.error(`IDBError: Unexpected table ID: ${e}`,t)})},deleteItem:function(e){return c.items.where("storeID").equals(e).delete()},putItem:function(e){return e.storeID||(e.storeID=l.uuidv4()),c.items.put(e)},updateItem:function(e,t){return c.items.where("storeID").equals(e).modify(t).catch(e=>{console.error("IDBError: Update failed",e)})},reset:function(){return c.delete().then(()=>{(c=new o("Store")).version(1).stores(r)})}};const i="";var u={get:function(e,t={}){const o=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${i}${e}${o}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},json:function(e){return e.json()},text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${i}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null}};var p={serverStatus:function(){const e={};return u.get("server").then(u.json).then(t=>{e.server=t}).then(()=>u.get("schema")).then(u.json).then(t=>{e.schema=t}).catch(()=>{console.info("Server did not respond"),e.server={},e.schema={resources:[],templates:[],compoundIDPlaceholder:null}}).then(()=>e)},fetchProgress:function(e,t="update"){return d.getItemByID(e).then(o=>{if(!o)return Promise.reject(`Store: ${e} is not available`);if(!["ready","running"].includes(o.status))return;const a={id:o.reference.workflow,command:t};return u.get("progress",a).then(u.json).then(t=>"failure"===t.status?d.updateItem(e,e=>{e.status="failure"}):d.updateItem(e,e=>{e.status=t.status,e.progress=t.progress,e.execTime=t.execTime,e.fields=l.defaultFieldProperties(t.fields),e.records=t.records}))})}};function f(e,t,o){return new Promise((a,n)=>{const s=new FileReader,l=t?e.slice(0,t):e;s.onload=(e=>a(e.target.result)),s.onerror=(e=>n(e)),o?s.readAsArrayBuffer(l):s.readAsText(l)})}function m(e,t){const o=t?a.inflate(e,{to:"string"}):e;return JSON.parse(o)}function h(e,t){try{const o=window.URL.createObjectURL(new Blob([e])),a=document.createElement("a");a.download=t,a.href=o,a.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}var g={readFile:f,parseJSON:m,loadJSON:function(e){const t=e.name.endsWith("c")||e.name.endsWith(".gz");return f(e,!1,t).then(e=>m(e,t))},fetchJSON:function(e){const t=decodeURIComponent(e),o=t.endsWith("c")||t.endsWith(".gz");return fetch(t).then(e=>o?e.arrayBuffer():e.json()).then(e=>m(e,o))},downloadDataFile:h,downloadJSON:function(e,t,o=!0){const n=JSON.stringify(e),s=o?"c":"r";h(o?a.gzip(n):n,`${t}${e.hasOwnProperty("edges")?`.gf${s}`:`.nd${s}`}`)}};function b(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}var y={singleToMulti:b,mappingToTable:function(e){const t=e.hasOwnProperty("field")?b(e):e,o={key:t.key,format:"text"};return{fields:l.defaultFieldProperties([o].concat(t.fields)),records:Object.entries(t.mapping).map(e=>{const o={};return o[t.key]=e[0],t.fields.forEach((t,a)=>{o[t.key]=e[1][a]}),o})}},tableToMapping:function(e,t,o=["index"]){const a={created:(new Date).toString(),fields:l.defaultFieldProperties(e.fields.filter(e=>e.key!==t).filter(e=>!o.includes(e.key))),key:t,mapping:{}};return e.records.forEach(e=>{a.mapping[e[t]]=a.fields.map(t=>e[t.key])}),a},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),o=t.shift().split(","),a=o.shift(),n=new Date,s=[],r=[];o.forEach((e,t)=>{""!==e&&(s.push(t),r.push({key:e,format:"text"}))});const c={created:n.toString(),fields:l.defaultFieldProperties(r),key:a,mapping:{}};return t.forEach(e=>{const t=e.split(","),o=t.shift();c.mapping[o]=Array(s.length),s.forEach(e=>{c.mapping[o][e]=t[e]})}),c},apply:function(e,o){const a=o.hasOwnProperty("field")?b(o):o;e.records.filter(e=>a.mapping.hasOwnProperty(e[a.key])).forEach(e=>{a.fields.forEach((t,o)=>{e[t.key]=a.mapping[e[a.key]][o]})}),e.fields=t(e.fields).concat(l.defaultFieldProperties(a.fields)).uniqBy("key").value()}};const x=[{key:"linear",name:"Linear",func:e.scaleLinear()},{key:"log",name:"Log",func:e.scaleLog()},{key:"quantize",name:"Quantize",func:e.scaleQuantize()},{key:"ordinal",name:"Ordinal",func:e.scaleOrdinal()}],v=[{key:"continuous",name:"Continuous",size:2},{key:"two-piece",name:"Two-piece",size:3},{key:"category10",name:"Category 10",size:10,range:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#bc80bd","#ccebc5"],unknown:"#f0f0f0"},{key:"cbsafe",name:"Colorblind safe",size:10,range:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],unknown:"#f0f0f0"},{key:"category20",name:"Category 20",size:20,range:e.schemePaired.concat(e.schemeSet2),unknown:"#f0f0f0"},{key:"category40",name:"Category 40",size:40,range:e.schemePaired.concat(e.schemePastel2,e.schemeSet2,e.schemeSet3),unknown:"#f0f0f0"}];var w={presets:[{key:"activity",name:"Activity",scale:"log",domain:[1e-4,1e-6]},{key:"percent",name:"Percent",scale:"linear",domain:[0,100]},{key:"tf",name:"True/False",scale:"quantize",domain:[1,0]},{key:"mw",name:"MW",scale:"linear",domain:[200,600]},{key:"logp",name:"LogP",scale:"linear",domain:[-2,8]}],types:x,colorPalettes:[{key:"aquamarine",name:"Aquamarine",range:["#778899","#7fffd4"],unknown:"#f0f0f0"},{key:"chartreuse",name:"Chartreuse",range:["#778899","#7fff00"],unknown:"#f0f0f0"},{key:"salmon",name:"Salmon",range:["#778899","#fa8072"],unknown:"#f0f0f0"},{key:"violet",name:"Violet",range:["#778899","#ee82ee"],unknown:"#f0f0f0"},{key:"temperature",name:"Temperature",range:["#87ceeb","#fff5ee","#fa8072"],unknown:"#f0f0f0"},{key:"spectrum",name:"Spectrum",range:["#6495ed","#ccff66","#ffa500"],unknown:"#f0f0f0"}],colorRangeTypes:v,scaleFunction:function(e){let t=x.find(t=>t.key==e.scale).func,o=e.domain;if(3==e.range.length){const t=(parseFloat(e.domain[0])+parseFloat(e.domain[1]))/2;o=[e.domain[0],t,e.domain[1]]}return"ordinal"!==e.scale&&(t=t.domain(o)),t=t.range(e.range),["linear","log"].includes(e.scale)&&(t=t.clamp(!0)),o=>{if(""===o||null==o)return e.unknown;if("ordinal"!==e.scale&&parseFloat(o)!=o)return e.unknown;if("log"===e.scale&&o<=0)return e.unknown;const a=t(o);return void 0===a?e.unknown:a}}};var k={registerServiceWorker:function(){"serviceWorker"in navigator?navigator.serviceWorker.register("sw.js").then(e=>{console.info("ServiceWorker registration successful with scope: ",e.scope)}).catch(e=>{console.info("ServiceWorker registration failed: ",e)}):console.info("Off-line mode is not supported")}};var B={buttonBox:function(e,t,o,a){e.classed("form-group",!0).classed("mb-1",!0).append("button").classed("btn",!0).classed(`btn-${a}`,!0).classed("btn-sm",!0).attr("id",t).text(o)},menuButton:function(e,t,o,a){e.classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("id",a).text(t)},menuButtonLink:function(e,t,o,a,n){e.classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("role","button").attr("href","#").attr("id",n),e.append("img").attr("src",a?`./assets/icon/${a}.svg`:null).style("width","1.25rem").style("height","1.25rem"),e.append("span").style("vertical-align","middle").text(t)},menuModalLink:function(e,t,o,a,n,s){e.classed("btn",!0).classed(`btn-${a}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("id",s).attr("href","#").attr("role","button").attr("data-toggle","modal").attr("data-target",`#${t}`),e.append("img").attr("src",n?`./assets/icon/${n}.svg`:null).style("width","1.25rem").style("height","1.25rem"),e.append("span").classed("label",!0).style("vertical-align","middle").text(o)},dropdownMenuButton:function(e,t,o,a,n){e.classed("btn-group",!0).classed("mr-1",!0).attr("id",n);const s=e.append("button").classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown");s.append("img").attr("src",a?`./assets/icon/${a}.svg`:null).style("width","1.25rem").style("height","1.25rem"),s.append("span").style("vertical-align","middle").text(t),e.append("div").classed("dropdown-menu",!0)},dropdownMenuItem:function(e,t,o,a){e.classed("dropdown-item",!0).attr("id",a).attr("href","#"),e.append("img").attr("src",o?`./assets/icon/${o}.svg`:null).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuModal:function(e,t,o,a,n){e.classed("dropdown-item",!0).attr("id",n).attr("href","#").attr("data-toggle","modal").attr("data-target",`#${o}`),e.append("img").attr("src",`./assets/icon/${a}.svg`).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuFile:function(t,o,a,n,s){t.classed("dropdown-item",!0).attr("id",s).attr("href","#").on("click",function(){e.select(this).select("input").node().click()}),t.append("form").style("display","none").append("input").attr("type","file").attr("accept",a),t.append("img").attr("src",`./assets/icon/${n}.svg`).classed("mr-1",!0).style("width","2rem").style("height","2rem"),t.append("span").text(o)},dropdownMenuFileValue:function(e){return e.select("input").node().files[0]}};function C(e,t){e.classed("modal",!0).attr("tabindex",-1).attr("role","dialog").attr("aria-labelledby","").attr("aria-hidden",!0).attr("id",t),e.select(".modal-dialog").remove(),e.append("div").classed("modal-dialog",!0).attr("role","document").append("div").classed("modal-content",!0)}var L={confirmDialog:function(t,o,a){const n=t.call(C,o).select(".modal-content");n.append("div").classed("modal-body",!0).append("div").classed("message",!0).text(a);const s=n.append("div").classed("modal-footer",!0);s.append("button").classed("btn",!0).classed("btn-outline-secondary",!0).classed("cancel",!0).attr("type","button").attr("data-dismiss","modal").text("Cancel"),s.append("button").classed("btn",!0).classed("btn-warning",!0).classed("ok",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${o}-submit`).text("OK").on("click",()=>{e.select("#loading-icon").style("display","inline"),t.dispatch("submit")})},submitDialog:function(t,o,a){const n=t.call(C,o).select(".modal-content"),s=n.append("div").classed("modal-header",!0);s.append("h4").classed("modal-title",!0).text(a),s.append("button").attr("type","button").attr("data-dismiss","modal").attr("aria-label","Close").classed("close",!0).append("span").attr("aria-hidden",!0).html("&times;"),n.append("div").classed("modal-body",!0),n.append("div").classed("modal-footer",!0).append("button").classed("btn",!0).classed("btn-primary",!0).classed("submit",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${o}-submit`).text("Submit").on("click",()=>{e.select("#loading-icon").style("display","inline"),t.dispatch("submit")})}};function z(e,t){e.select("input").property("value",t)}function S(e,t){e.select("textarea").property("value",t)}function N(e,t){e.select("input").property("checked",t)}function T(e,t){e.select("input").property("value",t)}function V(e,t){e.select("input").property("value",t)}var A={textBox:function(e,t,o,a,n){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","text").attr("size",a),e.call(z,n)},updateTextBox:z,textBoxValue:function(e){return e.select("input").property("value")},readonlyBox:function(e,t,o,a){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("input").classed("form-control-plaintext",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","text").property("readonly",!0),e.call(z,a)},textareaBox:function(e,t,o,a,n,s){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("textarea").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("rows",a).attr("placeholder",n).attr("id",t),e.call(S,s)},updateTextareaBox:S,textareaBoxValue:function(e){const t=e.select("textarea").property("value");if(t)return t;const o=e.select("textarea").attr("placeholder");return o||""},textareaBoxLines:function(e){const t=e.select("textarea").property("value");if(t)return t.split("\n").filter(e=>e.length>0);const o=e.select("textarea").attr("placeholder");return o?o.split("\n").filter(e=>e.length>0):[]},checkBox:function(e,t,o,a){const n=e.classed("form-group",!0).classed("form-row",!0).classed("form-check",!0).append("label").classed("form-check-label",!0).classed("col-form-label-sm",!0);n.append("input").classed("form-check-input",!0).attr("type","checkbox").attr("id",t),n.append("span").text(o),e.call(N,a)},updateCheckBox:N,checkBoxValue:function(e){return e.select("input").property("checked")},numberBox:function(e,t,o,a,n,s,l){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","number").attr("min",a).attr("max",n).attr("step",s),e.call(T,l)},updateNumberBox:T,numberBoxValue:function(e){return e.select("input").property("value")},colorBox:function(t,o,a){t.classed("form-row",!0).classed("align-items-center",!0),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).text(o),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).append("input").classed("form-control",!0).classed("form-control-sm",!0).attr("type","color"),t.call(V,a).on("change",()=>{e.event.stopPropagation()})},updateColorBox:V,colorBoxValue:function(e){return e.select("input").property("value")},fileInputBox:function(e,t,o,a){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",a).attr("id",t)},fileInputBoxValue:function(e){return e.select("input").property("files")[0]}};const O="community-dialog",P="Comunity detection";var I={menuLink:function(e){e.call(B.dropdownMenuModal,P,O,"painting")},body:function(e){const t=e.call(L.submitDialog,O,P);t.select(".modal-body").append("div").classed("name",!0).call(A.textBox,"comm-name","New name",40,"comm_"),t.select(".modal-body").append("div").classed("nulliso",!0).call(A.checkBox,"comm-nulliso","Assign null to isolated nodes",!0)},value:function(e){return{name:A.textBoxValue(e.select(".name")),nulliso:A.checkBoxValue(e.select(".nulliso"))}}};const E="rename-dialog",D="Rename";var R={menuLink:function(e){e.call(B.dropdownMenuModal,D,E,"edittext")},body:function(e,t){e.call(L.submitDialog,E,D).select(".modal-body").append("div").classed("rename",!0).call(A.textBox,"rename","New name",40,t)},updateBody:function(e,t){e.select(".rename").call(A.updateTextBox,t.data.name)},value:function(e){return A.textBoxValue(e.select(".rename"))}};const F={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},_={datatable:"nodes",connection:"edges"};function j(e){const t=e.columns.map(e=>("numeric"===e.sort?e.format="numeric":"text"===e.sort?e.format="text":"none"===e.sort&&(e.format="raw"),e));return{id:e.id,name:e.name,dataType:_[e.format],schemaVersion:.8,revision:0,status:F[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function M(e){return{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:e.query,progress:e.progress,execTime:e.execTime,created:e.created,reference:{}}}var W={convertTable:function(e){let t=e;return t.hasOwnProperty("schemaVersion")||t.hasOwnProperty("$schema")||(t=j(t)),"0.8"==t.schemaVersion&&(t=M(t=function(e){return e.records.forEach((e,t)=>{e.index=t,e.structure=e._structure,delete e._index,delete e._structure}),e.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")}),e}(t))),t.hasOwnProperty("$schema")||(delete t.schemaVersion,delete t.revision,t.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),t.fields.forEach(e=>{"structure"===e.key&&(e.format="svg"),delete e.width,delete e.height}),t},convertNetwork:function(t){let o=t;return o.edges.hasOwnProperty("schemaVersion")||o.edges.hasOwnProperty("$schema")||(o.nodes=j(o.nodes),o.edges=function(e,t){const o={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(o.nodeColor.id=e.snapshot.nodeColor.id,o.nodeColor.scale=e.snapshot.nodeColor.scale,o.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):o.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(o.nodeSize.id=e.snapshot.nodeSize.id,o.nodeSize.scale=e.snapshot.nodeSize.scale,o.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):o.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(o.nodeLabel.id=e.snapshot.nodeLabel.id,o.nodeLabel.size=e.snapshot.nodeLabel.size,o.nodeLabel.text=e.snapshot.nodeLabel.text,o.nodeLabel.visible=e.snapshot.nodeLabel.visible,o.nodeLabel.scale=e.snapshot.nodeLabel.scale,o.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):o.nodeLabel={id:"label",size:12,text:"index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?o.nodeContent=e.snapshot.nodeContent:o.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?o.edge=e.snapshot.edge:o.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:_[e.format],schemaVersion:.8,revision:0,reference:{nodes:e.nodeTableId},status:F[e.status],fields:l.defaultFieldProperties([{key:"source"},{key:"target"},{key:"weight"}]),records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:o}}(o.edges,o.nodes.fields)),"0.8"!=o.edges.schemaVersion&&.1!==o.edges.schemaVersion||((o=function(e){if(e.edges.hasOwnProperty("reference")||(e.edges.reference={nodes:e.edges.nodesID}),e.nodes.fields.find(e=>"_index"===e.key)){const t={};e.nodes.records.forEach((e,o)=>{e.index=o,e.structure=e._structure,t[e._index]=e.index,delete e._index,delete e._structure}),e.edges.records.forEach(e=>{e.source=t[e.source],e.target=t[e.target]}),e.nodes.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")})}return e}(o)).nodes=M(o.nodes),o.edges=function(t){const o={networkThreshold:t.networkThreshold};return o.nodeContentVisible=t.snapshot.nodeContent.structure.visible,o.nodeColor=t.snapshot.nodeColor.scale||{},o.nodeColor.field&&(o.nodeColor.field=t.snapshot.nodeColor.field.key,"_index"===o.nodeColor.field&&(o.nodeColor.field="index")),"ordinal"===o.nodeColor.scale&&(o.nodeColor.range=e.schemeCategory20),o.nodeSize=t.snapshot.nodeSize.scale||{},t.snapshot.nodeSize.field&&(o.nodeSize.field=t.snapshot.nodeSize.field.key,"_index"===o.nodeSize.field&&(o.nodeSize.field="index")),o.nodeLabel={},t.snapshot.nodeLabel.text&&(o.nodeLabel.text=t.snapshot.nodeLabel.text.key,"_index"===o.nodeLabel.text&&(o.nodeLabel.text="index")),o.nodeLabel.size=t.snapshot.nodeLabel.size,o.nodeLabel.visible=t.snapshot.nodeLabel.visible,o.nodeLabelColor=t.snapshot.nodeLabel.scale||{},t.snapshot.nodeLabel.field&&(o.nodeLabelColor.field=t.snapshot.nodeLabel.field.key,"_index"===o.nodeLabelColor.field&&(o.nodeLabelColor.field="index")),"ordinal"===o.nodeLabelColor.scale&&(o.nodeLabelColor.range=e.schemeCategory20),o.edgeVisible=t.snapshot.edge.visible,o.edgeWidth=t.snapshot.edge.scale||{},o.edgeLabel={},o.edgeLabel.size=t.snapshot.edge.label.size,o.edgeLabel.visible=t.snapshot.edge.label.visible,o.networkThreshold=t.networkThreshold||t.query.threshold,o.coords=t.snapshot.nodePositions,{id:t.id,name:t.name,dataType:t.dataType,schemaVersion:"0.10",revision:t.revision,status:t.status,fields:t.fields,records:t.records,query:{params:t.query},progress:t.progress,execTime:t.execTime,created:t.created,snapshot:o,reference:t.reference}}(o.edges)),o.edges.hasOwnProperty("$schema")||(delete o.nodes.schemaVersion,delete o.edges.schemaVersion,delete o.nodes.revision,delete o.edges.revision,o.nodes.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json",o.edges.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),o}};class q{constructor(e,t,o){this.focusedViewThreshold=100,this.enableFocusedView=!0,this.focusedView=!1,this.overlookViewThreshold=500,this.enableOverlookView=!0,this.overlookView=!1,this.data=W.convertNetwork(e),this.nodes=JSON.parse(JSON.stringify(this.data.nodes.records)),this.edges=JSON.parse(JSON.stringify(this.data.edges.records)),this.nodes.forEach(e=>{e.adjacency=[]}),this.edges.forEach((e,t)=>{e.num=t,this.nodes[e.source].adjacency.push([e.target,t]),this.nodes[e.target].adjacency.push([e.source,t])});const a=this.data.edges.snapshot||{nodeColor:{},nodeSize:{},nodeLabel:{},nodeLabelColor:{},edgeWidth:{},edgeLabel:{}};this.nodeColor={},this.nodeColor.field=a.nodeColor.field||null,this.nodeColor.scale=a.nodeColor.scale||"linear",this.nodeColor.domain=a.nodeColor.domain||[0,1],this.nodeColor.range=a.nodeColor.range||["#7fffd4","#7fffd4"],this.nodeColor.unknown=a.nodeColor.unknown||"#7fffd4",this.nodeSize={},this.nodeSize.field=a.nodeSize.field||null,this.nodeSize.scale=a.nodeSize.scale||"linear",this.nodeSize.domain=a.nodeSize.domain||[1,1],this.nodeSize.range=a.nodeSize.range||[40,40],this.nodeSize.unknown=a.nodeSize.unknown||40,this.nodeLabel={},this.nodeLabel.text=a.nodeLabel.text||null,this.nodeLabel.size=a.nodeLabel.size||12,this.nodeLabel.visible=a.nodeLabel.visible||!1,this.nodeLabelColor={},this.nodeLabelColor.field=a.nodeLabelColor.field||null,this.nodeLabelColor.scale=a.nodeLabelColor.scale||"linear",this.nodeLabelColor.domain=a.nodeLabelColor.domain||[1,1],this.nodeLabelColor.range=a.nodeLabelColor.range||["#cccccc","#cccccc"],this.nodeLabelColor.unknown=a.nodeLabelColor.unknown||"#cccccc",this.networkThresholdCutoff=e.edges.query.params.threshold,this.networkThreshold=a.networkThreshold||e.edges.query.params.threshold,this.edgeWidth={},this.edgeWidth.scale=a.edgeWidth.scale||"linear",this.edgeWidth.domain=a.edgeWidth.domain||[.5,1],this.edgeWidth.range=a.edgeWidth.range||[1,5],this.edgeWidth.unknown=a.edgeWidth.unknown||1,this.edgeLabel={},this.edgeLabel.size=a.edgeLabel.size||12,this.edgeLabel.visible=a.edgeLabel.visible||!1,this.transform=a.fieldTransform||{x:0,y:0,k:1},this.zoomListener=null,this.dragListener=null,this.updateComponentNotifier=null,this.updateNodeNotifier=null,this.updateEdgeNotifier=null,this.updateNodeAttrNotifier=null,this.updateEdgeAttrNotifier=null,this.snapShotNotifier=null,this.fitNotifier=null,this.setForceNotifier=null,this.stickNotifier=null,this.relaxNotifier=null,this.restartNotifier=null,this.tickCallback=(()=>{}),this.forceField={top:0,right:t,bottom:o,left:0},this.viewBox={top:0,right:t,bottom:o,left:0},this.focusArea={},this.boundary={},this.prevTransform={x:this.transform.x,y:this.transform.y,k:this.transform.k},a.coords?(this.simulationOnLoad=!1,this.setAllCoords(a.coords),this.setFocusArea(),this.setBoundary()):this.simulationOnLoad=!0}setBoundary(){const e=this.nodes.map(e=>e.x),t=this.nodes.map(e=>e.y);this.boundary.top=Math.min.apply(null,t),this.boundary.left=Math.min.apply(null,e),this.boundary.bottom=Math.max.apply(null,t),this.boundary.right=Math.max.apply(null,e)}setFocusArea(){const e=this.transform.x,t=this.transform.y,o=this.transform.k;this.focusArea.top=(this.viewBox.top-t)/o-50,this.focusArea.left=(this.viewBox.left-e)/o-50,this.focusArea.bottom=(this.viewBox.bottom-t)/o+50,this.focusArea.right=(this.viewBox.right-e)/o+50}setTransform(e,t,o){this.transform.x=e,this.transform.y=t,this.transform.k=o,this.setFocusArea()}setViewBox(e,t){this.viewBox.right=e,this.viewBox.bottom=t,this.setFocusArea()}setAllCoords(e){this.nodes.forEach(t=>{t.x=e[t.index].x,t.y=e[t.index].y,t.adjacency.forEach(o=>{const a=o[0],n=o[1];t.index<a?(this.edges[n].sx=e[t.index].x,this.edges[n].sy=e[t.index].y):(this.edges[n].tx=e[t.index].x,this.edges[n].ty=e[t.index].y)})}),this.setBoundary()}setCoords(e,t,o){this.nodes[e].x=t,this.nodes[e].y=o,this.nodes[e].adjacency.forEach(a=>{const n=a[0],s=a[1];e<n?(this.edges[s].sx=t,this.edges[s].sy=o):(this.edges[s].tx=t,this.edges[s].ty=o)}),this.setBoundary()}nodesToRender(){return this.nodes.filter(e=>e.y>this.focusArea.top&&e.x>this.focusArea.left&&e.y<this.focusArea.bottom&&e.x<this.focusArea.right)}edgesToRender(){return this.edges.filter(e=>e.weight>=this.networkThreshold&&this.focusArea.top<Math.max(e.sy,e.ty)&&this.focusArea.left<Math.max(e.sx,e.tx)&&this.focusArea.bottom>Math.min(e.sy,e.ty)&&this.focusArea.right>Math.min(e.sx,e.tx))}snapshot(){return{nodeColor:this.nodeColor,nodeSize:this.nodeSize,nodeLabel:this.nodeLabel,nodeLabelColor:this.nodeLabelColor,edgeWidth:this.edgeWidth,edgeLabel:this.edgeLabel,networkThreshold:this.networkThreshold,networkThresholdCutoff:this.networkThresholdCutoff,fieldTransform:this.transform,coords:this.nodes.map(e=>({x:e.x,y:e.y}))}}export(){return this.data.edges.id=l.uuidv4(),this.data.edges.snapshot=this.snapshot(),JSON.parse(JSON.stringify(this.data))}showTransform(){e.select("#debug-transform").text(JSON.stringify(this.transform))}showBoundary(){e.select("#debug-boundary").text(JSON.stringify(this.boundary))}showFocusArea(){e.select("#debug-focusarea").text(JSON.stringify(this.focusArea))}showViewBox(){e.select("#debug-viewbox").text(JSON.stringify(this.viewBox))}}var G={communityDetection:function(e,t,o){if(!t.length){const t={};return e.forEach(e=>{t[e]=o.nulliso?null:e}),t}const a={},s=n().nodes(e).edges(t)();return Object.entries(s).forEach(e=>{a.hasOwnProperty(e[1])||(a[e[1]]=[]),a[e[1]].push(e[0])}),Object.entries(a).sort((e,t)=>e[1].length<t[1].length).forEach((e,t)=>{1===e[1].length?s[e[1][0]]=o.nulliso?null:t:e[1].forEach(e=>{s[e]=t})}),s}};function J(e,t){const o=e.select("select").selectAll("option").data(t,e=>e.key);o.exit().remove(),o.enter().append("option").attr("value",e=>e.key).text(e=>e.name)}function U(e,t){e.select("select").property("value",t)}function Q(e,t){const o=e.select("ul").selectAll("li").data(t,e=>e.key);o.exit().remove();const a=o.enter().append("li").attr("class","form-check").append("label").attr("class","form-check-label");a.append("input").attr("type","checkbox").attr("class","form-check-input").property("value",e=>e.key),a.append("span").text(e=>e.name)}function H(t,o){o&&t.selectAll("input").each(function(t){e.select(this).property("checked",o.includes(t.key))})}var Y={selectBox:function(e,t,o,a,n){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("select").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t),a&&(e.call(J,a),e.call(U,n))},selectBoxItems:J,updateSelectBox:U,selectBoxValue:function(e){return e.select("select").property("value")},checklistBox:function(e,t,o,a,n){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(o),e.append("ul").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t),a&&(e.call(Q,a),e.call(H,n))},checklistBoxItems:Q,updateChecklistBox:H,checklistBoxValue:function(e){return e.selectAll("input:checked").data().map(e=>e.key)}};function K(e,t){e.select(".min").property("value",t[0]),e.select(".max").property("value",t[1])}function X(e,t){let o;o=2==t.length?[t[0],null,t[1]]:3==t.length?[t[0],t[1],t[2]]:[null,null,null],e.select(".min").property("value",o[0]).property("disabled",null===o[0]).style("opacity",null===o[0]?.3:null),e.select(".mid").attr("value",o[1]).property("disabled",null===o[1]).style("opacity",null===o[1]?.3:null),e.select(".max").property("value",o[2]).property("disabled",null===o[2]).style("opacity",null===o[2]?.3:null)}var Z={rangeBox:function(e,t,o,a){e.classed("form-row",!0).classed("align-items-center",!0).attr("id",t),e.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).text(o);const n=e.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0);n.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).attr("for",`${t}-from`).text("min"),n.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("min",!0).attr("type","text").attr("id",`${t}-from`);const s=e.append("div").classed("form-group",!0).classed("col-4",!0).classed("mb-1",!0);s.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).attr("for",`${t}-to`).text("max"),s.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("max",!0).attr("type","text").attr("id",`${t}-to`),e.call(K,a)},updateRangeBox:K,rangeBoxValue:function(e){return[parseFloat(e.select(".min").property("value")),parseFloat(e.select(".max").property("value"))]},colorScaleBox:function(t,o,a,n){t.classed("form-row",!0).classed("align-items-center",!0).attr("id",o),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-3",!0).classed("mb-1",!0).text(a);const s=t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-3",!0).classed("mb-1",!0);s.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).attr("for",`${o}-from`).text("min"),s.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("min",!0).attr("type","color").attr("id",`${o}-from`);const l=t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-3",!0).classed("mb-1",!0);l.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).attr("for",`${o}-mid`).text("mid"),l.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("mid",!0).attr("type","color").attr("id",`${o}-mid`);const r=t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-3",!0).classed("mb-1",!0);r.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).attr("for",`${o}-to`).text("max"),r.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("max",!0).attr("type","color").attr("id",`${o}-to`),t.call(X,n).on("change",()=>{e.event.stopPropagation()})},updateColorScaleBox:X,colorScaleBoxValue:function(e){const t=[];return e.select(".min").property("disabled")||t.push(e.select(".min").property("value")),e.select(".mid").property("disabled")||t.push(e.select(".mid").property("value")),e.select(".max").property("disabled")||t.push(e.select(".max").property("value")),t}};function ee(t,o,a){t.select(".palette").call(Y.updateSelectBox,w.colorRangeTypes.find(e=>e.size===o.length).key).on("change",function(){const o=Y.selectBoxValue(e.select(this)),a=w.colorPalettes.find(e=>e.key===o),n=w.colorRangeTypes.find(e=>e.size===a.range.length);t.select(".rangetype").call(Y.updateSelectBox,n.key),t.select(".range").call(Z.updateColorScaleBox,a.range)}),t.select(".rangetype").on("change",function(){const o=Y.selectBoxValue(e.select(this)),a=w.colorRangeTypes.find(e=>e.key===o).size;t.select(".range").select(".min").property("disabled",a>3).style("opacity",a<=3?null:.3),t.select(".range").select(".mid").property("disabled",3!==a).style("opacity",3===a?null:.3),t.select(".range").select(".max").property("disabled",a>3).style("opacity",a<=3?null:.3)}),t.select(".range").call(Z.updateColorScaleBox,o).on("focusin",()=>{t.dispatch("change")}),t.select(".unknown").call(A.updateColorBox,a).on("focusin",()=>{t.dispatch("change")})}function te(t,o,a){t.select(".preset").on("change",function(){const o=Y.selectBoxValue(e.select(this)),a=w.presets.find(e=>e.key==o);t.select(".scale").call(Y.updateSelectBox,a.scale),t.select(".domain").call(Z.updateRangeBox,a.domain)}),t.select(".scale").call(Y.updateSelectBox,o).on("change",()=>{t.select(".domain").dispatch("change")}),t.select(".domain").call(Z.updateRangeBox,a).on("change",function(){const o="log"===Y.selectBoxValue(t.select(".scale")),a=Z.rangeBoxValue(e.select(this)),n=e=>isNaN(e)||o&&e<=0;e.select(this).select(".min").style("background-color",n(a[0])?"#ffcccc":"#ffffff"),e.select(this).select(".max").style("background-color",n(a[1])?"#ffcccc":"#ffffff")})}var oe={colorRangeGroup:function(e,t,o,a,n,s){e.classed("mb-3",!0),e.append("div").classed("palette",!0).classed("mb-1",!0).call(Y.selectBox,`${t}-palette`,"Color palette",o,"hoge"),e.append("div").classed("rangetype",!0).classed("mb-1",!0).call(Y.selectBox,`${t}-rangetype`,"Range type",a,w.colorRangeTypes.find(e=>e.size===n.length).key),e.append("div").classed("range",!0).classed("mb-1",!0).call(Z.colorScaleBox,`${t}-range`,"Range",n),e.append("div").classed("unknown",!0).classed("mb-1",!0).call(A.colorBox,"Unknown",s),e.call(ee,n,s)},updateColorRangeGroup:ee,colorRangeGroupValue:function(e){const t=Y.selectBoxValue(e.select(".rangetype")),o=Z.colorScaleBoxValue(e.select(".range")),a=A.colorBoxValue(e.select(".unknown"));return{range:o.length?o:w.colorRangeTypes.find(e=>e.key===t).range,unknown:a}},scaleBoxGroup:function(e,t,o,a,n,s){e.classed("mb-3",!0),e.append("div").classed("preset",!0).classed("mb-1",!0).call(Y.selectBox,`${t}-preset`,"Scale preset",o,""),e.append("div").classed("scale",!0).classed("mb-1",!0).call(Y.selectBox,`${t}-scale`,"Scale type",a,n),e.append("div").classed("domain",!0).classed("mb-1",!0).call(Z.rangeBox,`${t}-domain`,"Domain",s),e.call(te,n,s)},updateScaleBoxGroup:te,scaleBoxGroupValue:function(e){return{scale:Y.selectBoxValue(e.select(".scale")),domain:Z.rangeBoxValue(e.select(".domain"))}}};function ae(e,t){e.append("div").classed("mb-3",!0).append("div").classed("fit",!0).call(B.buttonBox,"fit-to-screen","Fit to screen","primary");const o=e.append("div").classed("mb-3",!0);o.append("div").classed("focused",!0).classed("mb-1",!0).call(A.checkBox,"focused","Enable focused view",t.enableFocusedView),o.append("div").classed("overlook",!0).classed("mb-1",!0).call(A.checkBox,"overlook","Enable overlook view",t.enableOverlookView);const a=e.append("div").classed("mb-3",!0);a.append("div").classed("thld",!0).classed("mb-1",!0).call(A.numberBox,"thld","Network threshold",t.networkThresholdCutoff,1,.01,t.networkThreshold),a.append("div").classed("logd",!0).classed("mb-1",!0).call(A.readonlyBox,"logd","logD",null);const n=e.append("div").classed("form-group",!0).classed("form-row",!0);n.append("div").classed("col-6",!0).append("span").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("mb-1",!0).text("Temperature"),n.append("div").classed("col-12",!0).append("div").classed("temperature",!0).classed("progress",!0).append("div").classed("progress-bar",!0).classed("w-30",!0).attr("id","temperature").attr("role","progressbar").attr("aria-valuemin",0).attr("aria-valuemax",100),n.append("div").classed("col-12",!0).append("div").classed("stick",!0).classed("mb-1",!0).call(A.checkBox,"stick-nodes","Stick nodes",!t.simulationOnLoad),n.append("div").classed("col-12",!0).append("div").classed("restart",!0).classed("mb-1",!0).call(B.buttonBox,"restart-force","Activate","warning"),e.call(ne,t)}function ne(t,o){t.select(".snapshot").on("click",function(){o.snapshotNotifier()}),t.select(".fit").on("click",function(){o.fitNotifier()}),t.select(".focused").call(A.updateCheckBox,o.enableFocusedView).on("change",function(){o.enableFocusedView=A.checkBoxValue(e.select(this)),o.focusedView=A.checkBoxValue(e.select(this)),o.updateComponentNotifier()}),t.select(".overlook").call(A.updateCheckBox,o.enableOverlookView).on("change",function(){o.enableOverlookView=A.checkBoxValue(e.select(this)),o.overlookView=A.checkBoxValue(e.select(this)),o.updateComponentNotifier()}),t.select(".thld").call(A.updateNumberBox,o.networkThreshold).on("change",function(){const a=A.numberBoxValue(e.select(this));o.networkThreshold=a,o.updateComponentNotifier(),o.setForceNotifier();const n=o.edges.filter(e=>e.weight>=a).length,s=o.nodes.length,l=s*(s-1)/2,r=e.format(".2f")(Math.log10(n/l));t.select(".logd").call(A.updateTextBox,r)}).dispatch("change"),o.tickCallback=(e=>{const o=e.alpha(),a=o<=e.alphaMin(),n=parseInt(a?0:100*o);t.select(".temperature").select(".progress-bar").classed("bg-success",a).classed("bg-warning",!a).style("width",`${n}%`).attr("aria-valuenow",n)}),t.select(".stick").call(A.updateCheckBox,!o.simulationOnLoad).on("change",function(){const a=A.checkBoxValue(e.select(this));t.select(".temperature").style("background-color",a?"#a3e4d7":"#e9ecef").select(".progress-bar").style("width","0%").attr("aria-valuenow",0),a?o.stickNotifier():o.relaxNotifier()}),t.select(".restart").on("click",function(){t.select(".stick").call(A.updateCheckBox,!1).dispatch("change"),o.restartNotifier()})}function se(e,t){e.append("div").classed("field",!0).call(Y.selectBox,"color-field","Field",t.data.nodes.fields.filter(e=>"none"!==l.sortType(e.format)),t.nodeColor.field||""),e.append("div").classed("range",!0).call(oe.colorRangeGroup,"color",w.colorPalettes,w.colorRangeTypes,t.nodeColor.range,t.nodeColor.unknown),e.append("div").classed("scale",!0).call(oe.scaleBoxGroup,"color",w.presets,w.types.filter(e=>"ordinal"!==e.key),t.nodeColor.scale,t.nodeColor.domain),e.call(le,t)}function le(t,o){t.select(".field").call(Y.updateSelectBox,o.nodeColor.field).on("change",function(){o.nodeColor.field=Y.selectBoxValue(e.select(this)),o.updateNodeAttrNotifier()}),t.select(".range").call(oe.updateColorRangeGroup,o.nodeColor.range,o.nodeColor.unknown).on("change",function(){const a=oe.colorRangeGroupValue(e.select(this));o.nodeColor.range=a.range,o.nodeColor.unknown=a.unknown,a.range.length>3?(o.nodeColor.scale="ordinal",t.select(".scale").selectAll("select,input").property("disabled",!0).style("opacity",.3)):t.select(".scale").selectAll("select,input").property("disabled",!1).style("opacity",null),o.updateNodeAttrNotifier()}),t.select(".scale").call(oe.updateScaleBoxGroup,o.nodeColor.scale,o.nodeColor.domain).on("change",function(){const t=oe.scaleBoxGroupValue(e.select(this));o.nodeColor.scale=t.scale,o.nodeColor.domain=t.domain,o.updateNodeAttrNotifier()})}function re(e,t){e.append("div").classed("field",!0).call(Y.selectBox,"size-field","Field",t.data.nodes.fields.filter(e=>"numeric"===l.sortType(e.format)),t.nodeSize.field||""),e.append("div").classed("range",!0).classed("mb-3",!0).call(Z.rangeBox,"size-range","Range",t.nodeSize.range),e.append("div").classed("scale",!0).call(oe.scaleBoxGroup,"size",w.presets.filter(e=>"ordinal"!==e.scale),w.types.filter(e=>"ordinal"!==e.key),t.nodeSize.scale,t.nodeSize.domain),e.call(ce,t)}function ce(t,o){t.select(".field").call(Y.updateSelectBox,o.nodeSize.field).on("change",function(){o.nodeSize.field=Y.selectBoxValue(e.select(this)),o.updateNodeAttrNotifier()}),t.select(".range").call(Z.updateRangeBox,o.nodeSize.range).on("change",function(){o.nodeSize.range=Z.rangeBoxValue(e.select(this)),o.updateNodeAttrNotifier()}),t.select(".scale").call(oe.updateScaleBoxGroup,o.nodeSize.scale,o.nodeSize.domain).on("change",function(){const t=oe.scaleBoxGroupValue(e.select(this));o.nodeSize.scale=t.scale,o.nodeSize.domain=t.domain,o.updateNodeAttrNotifier()})}function de(e,t){e.append("div").append("div").classed("visible",!0).call(A.checkBox,"label-visible","Show node labels",t.nodeLabel.visible);const o=e.append("div").classed("mb-3",!0);o.append("div").classed("text",!0).classed("mb-1",!0).call(Y.selectBox,"label-text","Text field",t.data.nodes.fields.filter(e=>"none"!==l.sortType(e.format)),t.nodeLabel.text||""),o.append("div").classed("size",!0).classed("mb-1",!0).call(A.numberBox,"label-size","Font size",6,100,1,t.nodeLabel.size),e.append("div").classed("field",!0).call(Y.selectBox,"label-field","Color field",t.data.nodes.fields.filter(e=>"none"!==l.sortType(e.format)),t.nodeLabelColor.field||""),e.append("div").classed("range",!0).call(oe.colorRangeGroup,"label",w.colorPalettes,w.colorRangeTypes,t.nodeLabelColor.range,t.nodeColor.unknown),e.append("div").classed("scale",!0).call(oe.scaleBoxGroup,"label",w.presets,w.types.filter(e=>"ordinal"!==e.key),t.nodeLabelColor.scale,t.nodeLabelColor.domain),e.call(ie,t)}function ie(t,o){t.select(".visible").call(A.updateCheckBox,o.nodeLabel.visible).on("change",function(){o.nodeLabel.visible=A.checkBoxValue(e.select(this)),o.updateNodeAttrNotifier()}),t.select(".text").call(Y.updateSelectBox,o.nodeLabel.text).on("change",function(){o.nodeLabel.text=Y.selectBoxValue(e.select(this)),o.updateNodeAttrNotifier()}),t.select(".size").call(A.updateNumberBox,o.nodeLabel.size).on("change",function(){o.nodeLabel.size=A.numberBoxValue(e.select(this)),o.updateNodeAttrNotifier()}),t.select(".field").call(Y.updateSelectBox,o.nodeLabelColor.field).on("change",function(){o.nodeLabelColor.field=Y.selectBoxValue(e.select(this)),o.updateNodeAttrNotifier()}),t.select(".range").call(oe.updateColorRangeGroup,o.nodeLabelColor.range,o.nodeColor.unknown).on("change",function(){const a=oe.colorRangeGroupValue(e.select(this));o.nodeLabelColor.range=a.range,o.nodeLabelColor.unknown=a.unknown,a.range.length>3?(o.nodeLabelColor.scale="ordinal",t.select(".scale").selectAll("select,input").property("disabled",!0).style("opacity",.3)):(o.nodeLabelColor.scale=Y.selectBoxValue(t.select(".range")),t.select(".scale").selectAll("select,input").property("disabled",!1).style("opacity",null)),o.updateNodeAttrNotifier()}),t.select(".scale").call(oe.updateScaleBoxGroup,o.nodeLabelColor.scale,o.nodeLabelColor.domain).on("change",function(){const t=oe.scaleBoxGroupValue(e.select(this));o.nodeLabelColor.scale=t.scale,o.nodeLabelColor.domain=t.domain,o.updateNodeAttrNotifier()})}function ue(e,t){const o=e.append("div").classed("mb-3",!0);o.append("div").classed("label",!0).classed("mb-1",!0).call(A.checkBox,"edge-label-visible","Show edge weight label",t.edgeLabel.visible),o.append("div").classed("size",!0).classed("mb-1",!0).call(A.numberBox,"edge-label-size","Weight label font size",6,100,1,t.edgeLabel.size);const a=e.append("div").classed("mb-3",!0);a.append("div").classed("range",!0).classed("mb-3",!0).call(Z.rangeBox,"edge-width-range","Range",t.edgeWidth.range),a.append("div").classed("scale",!0).classed("mb-1",!0).call(Y.selectBox,"edge-width-scale","Scale type",w.types.filter(e=>"ordinal"!==e.key),t.edgeWidth.scale),a.append("div").classed("domain",!0).classed("mb-1",!0).call(Z.rangeBox,"edge-width-domain","Domain",t.edgeWidth.domain)}function pe(t,o){t.select(".label").call(A.updateCheckBox,o.edgeLabel.visible).on("change",function(){o.edgeLabel.visible=A.checkBoxValue(e.select(this)),o.updateEdgeAttrNotifier()}),t.select(".size").call(A.updateNumberBox,o.edgeLabel.size).on("change",function(){o.edgeLabel.size=A.numberBoxValue(e.select(this)),o.updateEdgeAttrNotifier()}),t.select(".range").call(Z.updateRangeBox,o.edgeWidth.range).on("change",function(){o.edgeWidth.range=Z.rangeBoxValue(e.select(this)),o.updateEdgeAttrNotifier()}),t.select(".scale").call(Y.updateSelectBox,o.edgeWidth.scale).on("change",function(){o.edgeWidth.scale=Y.selectBoxValue(e.select(this)),o.updateEdgeAttrNotifier()}),t.select(".domain").call(Z.updateRangeBox,o.edgeWidth.domain).on("change",function(){o.edgeWidth.domain=Z.rangeBoxValue(e.select(this)),o.updateEdgeAttrNotifier()})}function fe(e,t,o){e.append("nav").append("div").classed("nav",!0).classed("nav-tabs",!0).attr("id",t).attr("role","tablist"),e.append("div").classed("tab-content",!0).classed("p-2",!0).attr("id",o)}function me(e,t,o){e.classed("nav-item",!0).classed("nav-link",!0).classed("py-1",!0).attr("id",`${t}-tab`).attr("data-toggle","tab").attr("href",`#${t}`).attr("role","tab").attr("aria-controls",t).attr("aria-selected","false").text(o)}function he(e,t){e.classed("tab-pane",!0).classed("fade",!0).classed("container",!0).classed("px-0",!0).attr("id",t).attr("role","tabpanel").attr("aria-labelledby",`${t}-tab`)}function ge(e,t){e.select(".control-main").call(ne,t),e.select(".control-color").call(le,t),e.select(".control-size").call(ce,t),e.select(".control-label").call(ie,t),e.select(".control-edge").call(pe,t)}var be={controlBox:function(e,t){e.select("nav").remove(),e.select(".tab-content").remove(),e.call(fe,"control-frame-nav","control-frame-content");const o=e.select(".nav-tabs"),a=e.select(".tab-content");o.append("a").classed("active",!0).attr("aria-selected","true").call(me,"control-main","Main"),a.append("div").classed("show",!0).classed("active",!0).classed("control-main",!0).call(he,"control-main").call(ae,t),o.append("a").call(me,"control-color","Color"),a.append("div").classed("control-color",!0).call(he,"control-color").call(se,t),o.append("a").call(me,"control-size","Size"),a.append("div").classed("control-size",!0).call(he,"control-size").call(re,t),o.append("a").call(me,"control-label","Label"),a.append("div").classed("control-label",!0).call(he,"control-label").call(de,t),o.append("a").call(me,"control-edge","Edge"),a.append("div").classed("control-edge",!0).call(he,"control-edge").call(ue,t),e.call(ge,t)},updateControlBox:ge};const ye=180,xe=180;function ve(e,t,o){const a=e.selectAll(".node").data(t,e=>e.index);a.exit().remove();const n=a.enter().append("g").attr("class","node").call(Ce);n.append("circle").attr("class","node-symbol"),n.append("g").attr("class","node-content").attr("transform",`translate(${-ye/2},${-xe/2})`),n.append("text").attr("class","node-label").attr("x",0).attr("text-anchor","middle");const s=n.merge(a);o?s.select(".node-content").html(e=>e.structure):s.select(".node-content").select("svg").remove()}function we(e,t){const o=e.selectAll(".link").data(t,e=>`${e.source}_${e.target}`);o.exit().remove();const a=o.enter().append("g").attr("class","link");a.append("line").attr("class","edge-line").style("stroke","#999").style("stroke-opacity",.6),a.append("text").attr("class","edge-label").attr("text-anchor","middle").text(e=>e.weight),a.call(Le)}function ke(t,o){t.selectAll(".node").each(function(t){const a=w.scaleFunction(o.nodeColor)(t[o.nodeColor.field]),n=w.scaleFunction(o.nodeSize)(t[o.nodeSize.field]),s=w.scaleFunction(o.nodeLabelColor)(t[o.nodeLabelColor.field]);e.select(this).select(".node-symbol").attr("r",n).style("fill",a),e.select(this).select(".node-label").text(e=>{if(null===o.nodeLabel.text)return"";const t=o.data.nodes.fields.find(e=>e.key===o.nodeLabel.text);return"d3_format"===t.format?l.formatNum(e[o.nodeLabel.text],t.d3_format):e[o.nodeLabel.text]}).attr("font-size",o.nodeLabel.size).attr("y",parseFloat(n)+parseInt(o.nodeLabel.size)).attr("visibility",o.nodeLabel.visible?"inherit":"hidden").style("fill",s)})}function Be(e,t){e.selectAll(".link").select(".edge-line").style("stroke-width",e=>w.scaleFunction(t.edgeWidth)(e.weight)),e.selectAll(".link").select(".edge-label").attr("visibility",t.edgeLabel.visible?"inherit":"hidden").attr("font-size",t.edgeLabel.size)}function Ce(e){e.attr("transform",e=>`translate(${e.x}, ${e.y})`)}function Le(e){e.attr("transform",e=>`translate(${e.sx}, ${e.sy})`),e.select(".edge-line").attr("x1",0).attr("y1",0).attr("x2",e=>e.tx-e.sx).attr("y2",e=>e.ty-e.sy),e.select(".edge-label").attr("x",e=>(e.tx-e.sx)/2).attr("y",e=>(e.ty-e.sy)/2)}function ze(e,t){e.select(".nw-nodes").call(ke,t),e.select(".nw-edges").call(Be,t)}function Se(e,t,o){e.attr("transform",`translate(${t}, ${o})`)}function Ne(e,t,o,a,n){e.attr("transform",`translate(${t}, ${o})`),e.select(".edge-line").attr("x1",0).attr("y1",0).attr("x2",a-t).attr("y2",n-o),e.select(".edge-label").attr("x",(a-t)/2).attr("y",(n-o)/2)}var Te={updateNodes:ve,updateEdges:we,updateNodeCoords:Ce,updateEdgeCoords:Le,updateNodeAttrs:ke,updateEdgeAttrs:Be,updateAttrs:ze,updateComponents:function(e,t){const o=t.nodesToRender(),a=o.length;t.enableFocusedView&&(t.focusedView=a<t.focusedViewThreshold),t.enableOverlookView&&(t.overlookView=a>t.overlookViewThreshold);const n=t.overlookView?[]:t.edgesToRender();e.select(".nw-nodes").call(ve,o,t.focusedView),e.select(".nw-edges").call(we,n),e.call(ze,t),t.zoomListener&&e.call(t.zoomListener),t.dragListener&&e.select(".nw-nodes").selectAll(".node").call(t.dragListener)},move:function(t,o,a,n){const s=e.select(o).call(Se,a,n).datum();t.select(".nw-edges").selectAll(".link").filter(e=>s.adjacency.map(e=>e[1]).includes(e.num)).each(function(t){s.index===t.source.index||s.index===t.source?e.select(this).call(Ne,a,n,t.tx,t.ty):s.index!==t.target.index&&s.index!==t.target||e.select(this).call(Ne,t.sx,t.sy,a,n)})},transform:function(e,t,o,a){e.select(".nw-field").attr("transform",`translate(${t}, ${o}) scale(${a})`)},resizeViewBox:function(e,t,o){e.attr("viewBox",`0 0 ${t} ${o}`),e.select(".nw-view-boundary").attr("width",t).attr("height",o)}};function Ve(e,t){const o=e.node();t.setViewBox(o.offsetWidth,o.offsetHeight),e.select(".nw-view").call(Te.resizeViewBox,o.offsetWidth,o.offsetHeight)}var Ae={networkViewFrame:function(e,t){e.style("width","100%").style("height","100%"),e.select(".nw-view").remove(),e.append("svg").classed("nw-view",!0),e.call(Ve,t)},resize:Ve,networkView:function(e,t){e.attr("preserveAspectRatio","xMinYMin meet").attr("pointer-events","all").attr("viewBox",`0 0 ${t.viewBox.right} ${t.viewBox.bottom}`).style("width","100%").style("height","100%"),e.select(".nw-view-boundary").remove(),e.select(".nw-field").remove(),e.append("rect").classed("nw-view-boundary",!0).attr("x",0).attr("y",0).attr("width",t.viewBox.right).attr("height",t.viewBox.bottom).attr("fill","#ffffff").attr("stroke-width",1).attr("stroke","#cccccc");const o=e.append("g").classed("nw-field",!0).style("opacity",1e-6);o.transition().duration(1e3).style("opacity",1);const a=o.append("g").classed("nw-edges",!0),n=o.append("g").classed("nw-nodes",!0);t.updateComponentNotifier=(()=>{e.call(Te.updateComponents,t)}),t.updateNodeNotifier=(()=>{n.call(Te.updateNodes,t.nodesToRender())}),t.updateEdgeNotifier=(()=>{a.call(Te.updateEdges,t.edgesToRender())}),t.updateNodeAttrNotifier=(()=>{n.call(Te.updateNodeAttrs,t)}),t.updateEdgeAttrNotifier=(()=>{a.call(Te.updateEdgeAttrs,t)}),e.call(Te.updateComponents,t)}};function $e(t,o){return e.drag().on("drag",function(){t.call(Te.move,this,e.event.x,e.event.y)}).on("end",function(t){o.setCoords(t.index,e.event.x,e.event.y)})}function Oe(t,o){return e.zoom().on("zoom",function(){const a=e.event.transform;if(t.call(Te.transform,a.x,a.y,a.k),!o.focusedView){const e=o.prevTransform,n=a.x>e.x+20||a.x<e.x-20,s=a.y>e.y+20||a.y<e.y-20,l=a.k>e.k;(n||s&&!l)&&(o.setTransform(a.x,a.y,a.k),o.prevTransform={x:a.x,y:a.y,k:a.k},t.call(Te.updateComponents,o))}}).on("end",function(){const a=e.event.transform;o.setTransform(a.x,a.y,a.k),o.prevTransform={x:a.x,y:a.y,k:a.k},t.call(Te.updateComponents,o)})}function Pe(t,o){const a=t.select(".nw-view-boundary").node().getBBox(),n=a.width/a.height,s=o.boundary.bottom-o.boundary.top,l=o.boundary.right-o.boundary.left,r=n>=l/s?a.height/s:a.width/l,c=-o.boundary.left*r,d=-o.boundary.top*r;o.setTransform(c,d,r),t.call(Te.updateComponents,o).call(Te.transform,c,d,r).call(e.zoom().transform,e.zoomIdentity.translate(c,d).scale(r))}var Ie={dragListener:$e,zoomListener:Oe,setInteraction:function(t,o){o.zoomListener=Oe(t,o),o.dragListener=$e(t,o),t.call(o.zoomListener),t.select(".nw-nodes").selectAll(".node").call(o.dragListener),o.fitNotifier=(()=>{t.call(Pe,o)});const a=o.transform;t.call(Te.transform,a.x,a.y,a.k).call(e.zoom().transform,e.zoomIdentity.translate(a.x,a.y).scale(a.k))},fit:Pe};function Ee(e,t,o){const a=o.nodes.map(e=>({x:e.x,y:e.y}));o.setAllCoords(a),e.call(Te.updateComponents,o)}function De(e,t,o){t.alpha(0).stop(),e.select(".nw-nodes").selectAll(".node").each(e=>{e.fx=e.x,e.fy=e.y}),o.dragListener=Ie.dragListener(e,o),e.call(Ee,t,o)}function Re(t,o,a){t.select(".nw-nodes").selectAll(".node").each(e=>{e.fx=null,e.fy=null}),a.dragListener=function(t,o,a){return e.drag().on("start",()=>{e.event.active||t.call(Fe,o,a)}).on("drag",t=>{t.fx=e.event.x,t.fy=e.event.y}).on("end",t=>{e.event.active||o.alphaTarget(0),t.fx=null,t.fy=null})}(t,o,a);const n=a.nodes.map(e=>({x:e.x,y:e.y}));a.setAllCoords(n),t.call(Te.updateComponents,a)}function Fe(e,t,o){e.call(Re,t,o),t.alpha(.1).restart()}function _e(e,t,o){e.call(Re,t,o),t.alpha(1).restart()}function je(e,t,o){const a=o.edges.filter(e=>e.weight>=o.networkThreshold);t.nodes(o.nodes).force("link").links(a)}var Me={forceSimulation:function(t,o){return e.forceSimulation().force("link",e.forceLink().id(e=>e.index).distance(60).strength(1)).force("charge",e.forceManyBody().strength(-600).distanceMin(15).distanceMax(720)).force("collide",e.forceCollide().radius(90)).force("center",e.forceCenter(t/2,o/2)).force("x",e.forceX().strength(.002)).force("y",e.forceY().strength(.002)).stop()},activate:function(e,t,o){t.on("tick",()=>{e.select(".nw-nodes").selectAll(".node").call(Te.updateNodeCoords);const a=o.nodes.map(e=>({x:e.x,y:e.y}));o.setAllCoords(a),e.select(".nw-edges").selectAll(".link").call(Te.updateEdgeCoords),o.tickCallback(t)}).on("end",()=>{e.call(Ee,t,o),o.tickCallback(t)}),o.setForceNotifier=(()=>{e.call(je,t,o)}),o.stickNotifier=(()=>{e.call(De,t,o)}),o.relaxNotifier=(()=>{e.call(Fe,t,o)}),o.restartNotifier=(()=>{e.call(_e,t,o)}),o.setForceNotifier(),o.simulationOnLoad?e.call(_e,t,o):e.call(De,t,o)},stick:De,relax:Fe,restart:_e};function We(e){return d.getItemByID(e).then(e=>d.getItemByID(e.reference.nodes).then(t=>({edges:e,nodes:t})))}function qe(t){const o=new q(t,1200,1200),a=Me.forceSimulation(1200,1200);e.select("#nw-frame").call(Ae.networkViewFrame,o).select(".nw-view").call(Ae.networkView,o).call(Ie.setInteraction,o).call(Me.activate,a,o),e.select("#nw-control").call(be.controlBox,o),window.onresize=(()=>e.select("#nw-frame").call(Ae.resize,o));const n=e.select("#menubar");n.selectAll("div,span,a").remove();const s=n.append("div").call(B.dropdownMenuButton,"Network","primary","network-white").select(".dropdown-menu");s.append("a").call(I.menuLink),s.append("a").call(R.menuLink),s.append("a").call(B.dropdownMenuItem,"Save","save").on("click",function(){if(o.data.edges.storeID)return d.updateItem(o.data.edges.storeID,e=>{e.id=l.uuidv4(),e.name=o.data.edges.name,e.snapshot=o.snapshot()}).then(()=>console.info("Snapshot saved"));{const e=o.export();return d.putItem(e.nodes).then(t=>(e.edges.reference.nodes=t,d.putItem(e.edges))).then(e=>{window.location=`network.html?id=${e}`})}}),s.append("a").call(B.dropdownMenuItem,"Export to JSON","export").on("click",()=>{const e=o.export();delete e.nodes.storeID,delete e.edges.storeID,delete e.edges.reference.nodes,g.downloadJSON(e,e.edges.name)}),o.data.nodes.storeID&&n.append("a").call(B.menuButtonLink,"Nodes","outline-secondary","table-gray").attr("href",`datagrid.html?id=${o.data.nodes.storeID}`).attr("target","_blank"),n.append("a").call(B.menuButtonLink,"Dashboard","outline-secondary","db-gray").attr("href","dashboard.html").attr("target","_blank"),["running","ready"].includes(o.data.edges.status)&&(n.append("a").call(B.menuButtonLink,"Refresh","outline-secondary","refresh-gray").on("click",function(){p.fetchProgress(o.data.edges.storeID).then(()=>We(o.data.edges.storeID)).then(qe)}),n.append("a").call(B.menuButtonLink,"Abort server job","warning","delete-gray").attr("data-toggle","modal").attr("data-target","#abort-dialog"),n.append("span").classed("progress",!0).append("progress").attr("max",100).attr("value",o.data.edges.progress).text(`${o.data.edges.progress}%`)),n.append("span").classed("title",!0).text(o.data.edges.name),n.append("span").classed("status",!0).text(`(${o.data.edges.status} - ${o.data.edges.records.length} connections created in ${o.data.edges.execTime} sec.)`);const r=e.select("#dialogs");r.selectAll("div").remove(),r.append("div").classed("communityd",!0).call(I.body),r.append("div").classed("renamed",!0).call(R.body,o.data.edges.name),r.append("div").call(L.confirmDialog,"abort-dialog","Are you sure you want to abort this calculation job?").on("submit",function(){p.fetchProgress(o.data.edges.storeID,"abort").then(()=>We(o.data.edges.storeID)).then(qe)}),function t(o){e.select("title").text(o.data.edges.name);e.select("#menubar").select(".title").text(o.data.edges.name);const a=e.select("#dialogs");a.select(".renamed").call(R.updateBody,o).on("submit",function(){o.data.edges.name=R.value(e.select(this)),t(o)});a.select(".communityd").on("submit",function(){const t=I.value(e.select(this)),a=o.data.nodes.records.map(e=>e.index),n=o.data.edges.records.filter(e=>e.weight>=o.networkThreshold),s=G.communityDetection(a,n,{nulliso:t.nulliso}),r={key:"index",field:l.defaultFieldProperties([{key:t.name,format:"d3_format",d3_format:"d"}])[0],mapping:s};y.apply(o.data.nodes,r),o.nodeColor={field:t.name,scale:"ordinal",domain:null,range:w.colorRangeTypes[3].range,unknown:w.colorRangeTypes[3].unknown},$("#community-dialog").modal("hide"),e.select("#loading-icon").style("display","none"),qe(o.export())})}(o)}return{run:function(){document.location.protocol,"onLine"in navigator&&navigator.onLine,s?console.info("Off-line mode is disabled for debugging"):k.registerServiceWorker();const t=l.URLQuery().id||null,o=l.URLQuery().location||null;return t?p.fetchProgress(t,"update").then(()=>We(t)).then(qe):o?g.fetchJSON(o).then(qe):void e.select("#datagrid").style("color","red").text("ERROR: invalid URL")}}});
//# sourceMappingURL=networkApp.js.map
