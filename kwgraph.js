// https://github.com/mojaie/kiwiii Version 0.8.0. Copyright 2017 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("pako"),require("Dexie"),require("vega"),require("jLouvain")):"function"==typeof define&&define.amd?define(["d3","pako","Dexie","vega","jLouvain"],t):e.kwgraph=t(e.d3,e.pako,e.Dexie,e.vega,e.jLouvain)}(this,function(e,t,n,l,o){"use strict";function s(e){const t=e.columns.map(e=>(e.sortType=e.sort,e));return{id:e.id,name:e.name,dataType:re[e.format],schemaVersion:.8,revision:0,status:se[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function r(e,t){const n={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(n.nodeColor.id=e.snapshot.nodeColor.id,n.nodeColor.scale=e.snapshot.nodeColor.scale,n.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):n.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(n.nodeSize.id=e.snapshot.nodeSize.id,n.nodeSize.scale=e.snapshot.nodeSize.scale,n.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):n.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(n.nodeLabel.id=e.snapshot.nodeLabel.id,n.nodeLabel.size=e.snapshot.nodeLabel.size,n.nodeLabel.text=e.snapshot.nodeLabel.text,n.nodeLabel.visible=e.snapshot.nodeLabel.visible,n.nodeLabel.scale=e.snapshot.nodeLabel.scale,n.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):n.nodeLabel={id:"label",size:12,text:"_index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?n.nodeContent=e.snapshot.nodeContent:n.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?n.edge=e.snapshot.edge:n.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:re[e.format],schemaVersion:.8,revision:0,nodesID:e.nodeTableId,status:se[e.status],fields:oe.defaultFieldProperties([{key:"source"},{key:"target"},{key:"weight"}]),records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:n}}function a(e){if(e.hasOwnProperty("edges")){const t=s(e.nodes);return{nodes:t,edges:r(e.edges,t.fields)}}return s(e)}function i(e,t,n){return new Promise((l,o)=>{const s=new FileReader,r=t?e.slice(0,t):e;s.onload=(e=>l(e.target.result)),s.onerror=(e=>o(e)),n?s.readAsArrayBuffer(r):s.readAsText(r)})}function c(e,n){const l=n?t.inflate(e,{to:"string"}):e,o=JSON.parse(l);return o.hasOwnProperty("schemaVersion")?o:o.hasOwnProperty("edges")&&o.edges.hasOwnProperty("schemaVersion")?o:a(o)}function d(e,t){try{const n=window.URL.createObjectURL(new Blob([e])),l=document.createElement("a");l.download=t,l.href=n,l.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}function u(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}function p(e,t,n){return me.updateItem(e,e=>{e[t]=n,e.revision++}).catch(l=>{console.error(`Unexpected table ID: ${e}, key: ${t} or value: ${n}`),Promise.reject(l)})}function f(e,t){const n=parseFloat(e),l=parseFloat(t);return isNaN(n)||isNaN(l)?String(t).localeCompare(String(e)):l-n}function m(e,t){return String(t).localeCompare(String(e))}function h(t,n,l){const o=t.select("thead tr").selectAll("th").data(),s=t.select("tbody").selectAll("tr").data(n,l);s.exit().remove();const r=s.enter().append("tr");r.selectAll("td").data(e=>o.map(t=>e[t.key])).enter().append("td"),r.merge(s).selectAll("td").classed("align-middle",!0).html(function(e,t){if(void 0===e)return"";if("plot"===o[t].valueType)return"[plot]";if("image"===o[t].valueType)return"[image]";if("control"!==o[t].valueType)return"raw"!==o[t].digit?ge.formatNum(e,o[t].digit):e}).each((t,n,l)=>{"control"===o[n].valueType&&e.select(l[n]).call(t)})}function g(e){const t={id:e,field:V.optionData(`#${e}-col`)},n=V.optionData(`#${e}-preset`);if("ordinal"===n.scale.scale)return t.scale=n.scale,t;t.scale={scale:V.value(`#${e}-scaletype`),domain:[V.value(`#${e}-domain-from`),V.value(`#${e}-domain-to`)],unknown:"#696969"};const l=[V.value(`#${e}-range-from`)];return V.checked(`#${e}-range-enable-mid`)&&l.push(V.value(`#${e}-range-mid`)),l.push(V.value(`#${e}-range-to`)),t.scale.range=l,t}function y(){const e=g("label");return e.text=V.optionData("#label-text"),e.size=V.value("#label-size"),e.visible=V.checked("#label-visible"),e}function b(e){return{id:e,scale:{scale:V.value(`#${e}-scaletype`),domain:[V.value(`#${e}-domain-from`),V.value(`#${e}-domain-to`)],range:[V.value(`#${e}-range-from`),V.value(`#${e}-range-to`)],unknown:10}}}function v(){const e=b("size");return e.field=V.optionData("#size-col"),e}function k(){return{structure:{visible:V.checked("#show-struct")}}}function x(){const e=b("edge");return e.visible=V.checked("#edge-visible"),e.label={size:V.value("#edge-label-size"),visible:V.checked("#edge-label-visible")},e}function w(t){e.selectAll(".node").select(".node-symbol").style("fill",e=>ee.scaleFunction(t.scale)(t.field?e[t.field.key]:null))}function A(t){e.selectAll(".node").select(".node-symbol").attr("r",e=>ee.scaleFunction(t.scale)(t.field?e[t.field.key]:null))}function T(t){e.selectAll(".node").select(".node-label").attr("visibility",t?"inherit":"hidden")}function P(t){e.selectAll(".node").select(".node-label").text(e=>null===t.text?"":e.hasOwnProperty(t.text.key)?"raw"===t.text.digit?e[t.text.key]:ge.formatNum(e[t.text.key],t.text.digit):"").attr("font-size",t.size).attr("y",90).attr("visibility",t.visible?"inherit":"hidden").style("fill",e=>ee.scaleFunction(t.scale)(t.field?e[t.field.key]:null))}function C(t){e.selectAll(".node").select(".node-struct").attr("visibility",t.structure.visible?"inherit":"hidden").each((t,n,l)=>{const o=e.select(l[n]).select("svg").attr("width"),s=e.select(l[n]).select("svg").attr("height");e.select(l[n]).attr("transform",`translate(${-o/2},${-s/2})`)})}function z(t){e.selectAll(".link").select(".edge-line").attr("visibility",t?"inherit":"hidden")}function S(t){e.selectAll(".link").select(".edge-label").attr("visibility",t?"inherit":"hidden")}function O(t){e.selectAll(".link").select(".edge-line").style("stroke-width",e=>ee.scaleFunction(t.scale)(e.weight)),e.selectAll(".link").select(".edge-label").attr("font-size",t.label.size),z(t.visible),S(t.label.visible)}function D(t,n){2===t.length?(e.select(`#${n}-range-from`).property("value",t[0]),e.select(`#${n}-range-enable-mid`).attr("checked",null),e.select(`#${n}-range-mid`).attr("disabled","disabled"),e.select(`#${n}-range-to`).property("value",t[1]),e.selectAll(`#${n}-range input`).attr("disabled",null)):3===t.length?(e.select(`#${n}-range-from`).property("value",t[0]),e.select(`#${n}-range-enable-mid`).attr("checked","checked"),e.select(`#${n}-range-mid`).property("value",t[1]),e.select(`#${n}-range-to`).property("value",t[2]),e.selectAll(`#${n}-range input`).attr("disabled",null)):e.selectAll(`#${n}-range input`).attr("disabled","disabled")}function L(t,n){e.select(`#${n}-scaletype`).property("value",t.scale);const l=t.hasOwnProperty("domain");e.selectAll(`#${n}-domain input`).attr("disabled",l?null:"disabled"),l&&(e.select(`#${n}-domain-from`).property("value",t.domain[0]),e.select(`#${n}-domain-to`).property("value",t.domain[1])),D(t.range,n)}function I(t){const n=t.id;e.select(`#${n}-visible`).attr("checked",t.visible?"checked":null),e.select(`#${n}-size`).property("value",t.size),e.select(`#${n}-text`).property("value",t.text?t.text.key:null),e.select(`#${n}-col`).property("value",t.field?t.field.key:null),t.hasOwnProperty("label")&&(e.select(`#${n}-label-visible`).attr("checked",t.label.visible?"checked":null),e.select(`#${n}-label-size`).property("value",t.label.size)),L(t.scale,t.id)}function N(t,n){e.select(`#${n}-col`).call(be.selectOptions,t,e=>e.key,e=>e.name),e.select(`#${n}-preset`).call(be.selectOptions,ee.colorPresets,e=>e.name,e=>e.name).on("change",function(){L(V.optionData(this).scale,n),e.select(`.${n}-update`).dispatch("change")}),e.select(`#${n}-palette`).call(be.selectOptions,ee.colorPalette,e=>e.name,e=>e.name).on("change",function(){D(V.optionData(this).range,n),e.select(`.${n}-update`).dispatch("change")}),e.select(`#${n}-scaletype`).call(be.selectOptions,ee.scaleTypes,e=>e.name,e=>e.name)}function j(t,n){e.select(`#${n}-preset`).call(be.selectOptions,t,e=>e.name,e=>e.name).on("change",function(){L(V.optionData(this).scale,n),e.select(`.${n}-update`).dispatch("change")}),e.select(`#${n}-scaletype`).call(be.selectOptions,ee.sizeScaleTypes,e=>e.name,e=>e.name)}function F(){e.selectAll(".node").each(e=>{e.fx=null,e.fy=null}),e.select("#stick-nodes").property("checked",!1),e.select("#graph-contents").selectAll(".link").attr("visibility","hidden"),e.select("#graph-contents").selectAll(".node").call(Oe)}function q(){return{nodePositions:e.selectAll(".node").data().map(e=>({x:e.x,y:e.y})),fieldTransform:e.zoomTransform(e.select("#graph-field").node()),nodeContent:e.select("#main-control").datum(),nodeColor:e.select("#color-control").datum(),nodeSize:e.select("#size-control").datum(),nodeLabel:e.select("#label-control").datum(),edge:e.select("#edge-control").datum()}}function R(){return he.updateTableAttribute(ce.URLQuery().id,"snapshot",q()).then(()=>console.info("Snapshot saved"))}function E(t){e.select("#main-control").datum(t.nodeContent),e.select("#show-struct").property("checked",t.nodeContent.structure.visible),e.select("#color-control").datum(t.nodeColor),Ce.updateControl(t.nodeColor),e.select("#size-control").datum(t.nodeSize),Ce.updateControl(t.nodeSize),e.select("#label-control").datum(t.nodeLabel),Ce.updateControl(t.nodeLabel),e.select("#edge-control").datum(t.edge),Ce.updateControl(t.edge);const n=t.fieldTransform,l=e.zoomIdentity.translate(n.x,n.y).scale(n.k);e.select("#graph-contents").attr("transform",l),e.select("#graph-field").call(Le.zoom.transform,l),e.selectAll(".node").each((e,n)=>{e.x=t.nodePositions[n].x,e.y=t.nodePositions[n].y}),Ce.updateNodeImage(t)}function U(){return he.getTable(ce.URLQuery().id).then(e=>he.getTable(e.nodesID).then(t=>({edges:e,nodes:t})))}function B(){return U().then(t=>{Ae.renderStatus(t.edges,()=>we.fetchResults().then(_),()=>we.fetchResults("abort").then(_));const n=t.edges.records.filter(e=>e.weight>=t.edges.networkThreshold),l=e.format(".2f")(Math.log10(n.length/t.edges.taskCount));e.select("#edge-density").text(l),e.select("#network-thld").text(t.edges.networkThreshold),ze.graphEdges(e.select("#graph-contents"),n),ze.graphNodes(e.select("#graph-contents"),t.nodes.records),$e.setForce(t.nodes.records,n,$e.tick,()=>{$e.end(),R()}),t.edges.hasOwnProperty("snapshot")?(E(t.edges.snapshot),Le.stickNodes()):(e.select("#color-control").datum(Pe.defaultNodeColor),Ce.updateControl(Pe.defaultNodeColor),e.select("#size-control").datum(Pe.defaultNodeSize),Ce.updateControl(Pe.defaultNodeSize),e.select("#label-control").datum(Pe.defaultNodeLabel),Ce.updateControl(Pe.defaultNodeLabel),e.select("#main-control").datum(Pe.defaultNodeContent),e.select("#show-struct").property("checked",Pe.defaultNodeContent.structure.visible),e.select("#edge-control").datum(Pe.defaultEdge),Ce.updateControl(Pe.defaultEdge),Ce.updateNodeImage({nodeColor:Pe.defaultNodeColor,nodeSize:Pe.defaultNodeSize,nodeLabel:Pe.defaultNodeLabel,nodeContent:Pe.defaultNodeContent}),Ce.updateEdge(Pe.defaultEdge),Le.restart()),e.select("#graph-contents").style("opacity",1e-6).transition().duration(1e3).style("opacity",1)})}function _(){return U().then(t=>(t.nodes.records.forEach(e=>{delete e._mol}),xe.graphConfigDialog(t.edges.networkThreshold,t.edges.query.threshold,e=>he.updateTableAttribute(ce.URLQuery().id,"networkThreshold",e).then(R).then(B)),xe.communityDialog(e=>{const n=t.nodes.records.map(e=>e._index),l=t.edges.records.filter(e=>e.weight>=t.edges.networkThreshold),o=Ie.communityDetection(n,l,{nulliso:e.nulliso}),s={key:"_index",field:oe.defaultFieldProperties([{key:e.name,valueType:"numeric"}]),mapping:o};he.joinFields(t.nodes.id,s).then(()=>{const t=q();return t.nodeColor.field=e.name,t.nodeColor.scale=ee.colorPresets.find(e=>"Categories"===e.name).scale,he.updateTableAttribute(ce.URLQuery().id,"snapshot",t).then(()=>console.info("snapshot saved"))}).then(_)}),Ce.mainControlBox(),Ce.nodeColorControlBox(t.nodes.fields),Ce.nodeSizeControlBox(t.nodes.fields),Ce.nodeLabelControlBox(t.nodes.fields),Ce.edgeControlBox(),e.select("#stick-nodes").on("change",function(){!0===V.checked(this)?Le.stickNodes():Le.relax()}),e.select("#nodetable").attr("href",`datatable.html?id=${t.edges.nodesID}`),e.select("#rename").on("click",()=>{e.select("#prompt-title").text("Rename table"),e.select("#prompt-label").text("New name"),e.select("#prompt-input").attr("value",t.edges.name),e.select("#prompt-submit").on("click",()=>{const e=V.value("#prompt-input");return he.updateTableAttribute(ce.URLQuery().id,"name",e).then(()=>he.getTable(ce.URLQuery().id)).then(e=>Ae.renderStatus(e,()=>we.fetchResults().then(_),()=>we.fetchResults("abort").then(_)))})}),B()))}function M(e){return we.interactiveInsert(e.nodes).then(t=>(e.edges.nodesID=t,we.interactiveInsert(e.edges))).then(e=>{window.location=`graph.html?id=${e}`})}const Q=!1;e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n,l=l&&l.hasOwnProperty("default")?l.default:l,o=o&&o.hasOwnProperty("default")?o.default:o;var V={value:function(t){return e.select(t).node().value},valueInt:function(t){return parseInt(e.select(t).node().value)},valueFloat:function(t){return parseFloat(e.select(t).node().value)},checked:function(t){return e.select(t).node().checked},firstFile:function(t){return e.select(t).node().files[0]},checkboxValues:function(t){return e.selectAll(t).selectAll("input:checked").nodes().map(e=>e.value)},optionValues:function(t){return e.selectAll(t).selectAll("select").nodes().map(e=>e.value)},textareaLines:function(t){return e.select(t).node().value.split("\n").filter(e=>e.length>0)},optionData:function(t){const n=e.select(t).property("selectedIndex");return e.select(t).selectAll("option").data().find((e,t)=>t===n)},checkboxData:function(t){return e.selectAll(t).selectAll("input:checked").data()}};const W=e.schemeSet1.concat(e.schemeSet3,e.schemePastel2,e.schemeSet2),J=[20,80],H=[{name:"Activity",scale:{scale:"log",domain:[1e-4,1e-6],range:["#708090","#7fffd4"],unknown:"#696969"}},{name:"Percent",scale:{scale:"linear",domain:[0,100],range:["#708090","#7fffd4"],unknown:"#696969"}},{name:"True or False",scale:{scale:"quantize",domain:[1,0],range:["#708090","#7fffd4"],unknown:"#696969"}},{name:"LogP",scale:{scale:"linear",domain:[-2,8],range:["#6495ed","#ccff66","#ffa500"],unknown:"#696969"}},{name:"Categories",scale:{scale:"ordinal",range:e.schemeCategory20,unknown:"#dedede"}},{name:"ManyCategories",scale:{scale:"ordinal",range:W,unknown:"#dedede"}}],X=[{name:"Activity",scale:{scale:"log",domain:[1e-4,1e-6],range:J,unknown:J[0]}},{name:"Percent",scale:{scale:"linear",domain:[0,100],range:J,unknown:J[0]}},{name:"True or False",scale:{scale:"quantize",domain:[1,0],range:J,unknown:J[0]}},{name:"LogP",scale:{scale:"linear",domain:[-2,6],range:J,unknown:J[0]}}],Y=[{name:"Universal",scale:{scale:"linear",domain:[.3,1],range:[.5,5],unknown:1}},{name:"Thin",scale:{scale:"linear",domain:[.5,1],range:[.5,3],unknown:1}},{name:"Amplified",scale:{scale:"linear",domain:[.5,1],range:[1,10],unknown:1}}],G=[{name:"Aquamarine",range:["#778899","#7fffd4"],unknown:"#696969"},{name:"Chartreuse",range:["#778899","#7fff00"],unknown:"#696969"},{name:"Salmon",range:["#778899","#fa8072"],unknown:"#696969"},{name:"Violet",range:["#778899","#ee82ee"],unknown:"#696969"},{name:"blue-red",range:["#87ceeb","#fff5ee","#fa8072"],unknown:"#696969"},{name:"Spectrum",range:["#6495ed","#ccff66","#ffa500"],unknown:"#696969"}],K=[{name:"linear",func:e.scaleLinear()},{name:"log",func:e.scaleLog()},{name:"quantize",func:e.scaleQuantize()},{name:"ordinal",func:e.scaleOrdinal()}],Z=[{name:"linear",func:e.scaleLinear()},{name:"log",func:e.scaleLog()},{name:"quantize",func:e.scaleQuantize()}];var ee={colorPresets:H,sizePresets:X,edgeWidthPresets:Y,colorPalette:G,scaleTypes:K,sizeScaleTypes:Z,scaleFunction:function(e){let t=K.find(t=>t.name===e.scale).func,n=e.domain;if(3===e.range.length){const t=(parseFloat(e.domain[0])+parseFloat(e.domain[1]))/2;n=[e.domain[0],t,e.domain[1]]}return"ordinal"!==e.scale&&(t=t.domain(n)),t=t.range(e.range),["linear","log"].includes(e.scale)&&(t=t.clamp(!0)),n=>{if(""===n||void 0===n||null===n)return e.unknown;if("ordinal"!==e.scale&&parseFloat(n)!=n)return e.unknown;if("log"===e.scale&&n<=0)return e.unknown;const l=t(n);return void 0===l?e.unknown:l}}};const te=["_mw","_mw_wo_sw","_logp","_formula","_nonH"],ne={id:"text",compound_id:"text",assay_id:"text",svg:"none",json:"none",plot:"none",text:"text",ec50:"numeric","active%":"numeric","inhibition%":"numeric",filesize:"numeric",numeric:"numeric",count:"numeric",int:"numeric",flag:"numeric",bool:"numeric",timestamp:"none",image:"none",control:"none",undefined:"none"},le={id:"raw",compound_id:"raw",assay_id:"raw",svg:"raw",json:"raw",plot:"raw",text:"raw",ec50:"scientific","active%":"rounded","inhibition%":"rounded",filesize:"si",numeric:"rounded",count:"raw",int:"raw",flag:"raw",bool:"raw",timestamp:"raw",image:"raw",control:"raw",undefined:"raw"};var oe={defaultHiddenFields:te,defaultFieldProperties:function(e){return e.map(e=>(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!te.includes(e.key)),e.hasOwnProperty("sortType")||(e.sortType=ne[e.valueType]),e.hasOwnProperty("digit")||(e.digit=le[e.valueType]),e))},ongoing:function(e){return["running","ready"].includes(e.status)}};const se={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},re={datatable:"nodes",connection:"edges"};var ae={readFile:i,parseJSON:c,loadJSON:function(e){const t=e.name.endsWith("c")||e.name.endsWith(".gz");return i(e,!1,t).then(e=>c(e,t))},fetchJSON:function(e){const t=decodeURIComponent(e),n=t.endsWith("c")||t.endsWith(".gz");return fetch(t).then(e=>n?e.arrayBuffer():e.json()).then(e=>c(e,n))},downloadDataFile:d,downloadJSON:function(e,n,l=!0){const o=JSON.stringify(e),s=l?t.gzip(o):o,r=l?"c":"r";d(s,`${n}${e.hasOwnProperty("edges")?`.gf${r}`:`.nd${r}`}`)}};class ie extends Array{unique(e){return this.reduce((t,n)=>(void 0===t.find(t=>t[e]===n[e])&&t.push(n),t),new ie)}extend(){return this.reduce((e,t)=>(Array.prototype.push.apply(e,t),e),new ie)}extendAsync(){return Promise.all(this).then(e=>e.reduce((e,t)=>(Array.prototype.push.apply(e,t),e),new ie))}toArray(){return new Array(this)}toObject(){const e={};return this.forEach(t=>{e[t[0]]=t[1]}),e}}var ce={URLQuery:function(){return ie.from(window.location.search.substring(1).split("&")).map(e=>e.split("=")).toObject()}},de={getSDFPropList:function(e){const t=/>.*?<(\S+)>/g,n=new Set;let l;for(;null!==(l=t.exec(e));)n.add(l[1]);return Array.from(n)},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}},ue={singleToMulti:u,mappingToTable:function(e){const t=e.hasOwnProperty("field")?u(e):e,n={key:t.key,valueType:"text"};return{fields:oe.defaultFieldProperties([n].concat(t.fields)),records:Object.entries(t.mapping).map(e=>{const n={};return n[t.key]=e[0],t.fields.forEach((t,l)=>{n[t.key]=e[1][l]}),n})}},tableToMapping:function(e,t,n=["_index"]){const l={created:(new Date).toString(),fields:oe.defaultFieldProperties(e.fields.filter(e=>e.key!==t).filter(e=>!n.includes(e.key))),key:t,mapping:{}};return e.records.forEach(e=>{l.mapping[e[t]]=l.fields.map(t=>e[t.key])}),l},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),n=t.shift().split(","),l=n.shift(),o=new Date,s=[],r=[];n.forEach((e,t)=>{""!==e&&(s.push(t),r.push({key:e,valueType:"text"}))});const a={created:o.toString(),fields:oe.defaultFieldProperties(r),key:l,mapping:{}};return t.forEach(e=>{const t=e.split(","),n=t.shift();a.mapping[n]=Array(s.length),s.forEach(e=>{a.mapping[n][e]=t[e]})}),a},apply:function(e,t){const n=t.hasOwnProperty("field")?u(t):t;e.records.filter(e=>n.mapping.hasOwnProperty(e[n.key])).forEach(e=>{n.fields.forEach((t,l)=>{e[t.key]=n.mapping[e[n.key]][l]})}),e.fields=oe.defaultFieldProperties(ie.from(e.fields).concat(n.fields).unique("key"))}};const pe={app:"key",items:"id, dataType, created",resources:"id"};let fe=new n("Store");fe.version(1).stores(pe);var me={getAppSetting:function(e){return fe.app.where("key").equals(e).first().then(e=>{if(void 0!==e)return e.value})},putAppSetting:function(e,t){return fe.app.put({key:e,value:t})},getResources:function(){return fe.resources.toArray()},putResources:function(e){return fe.resources.bulkPut(e)},getAllItems:function(){return fe.items.orderBy("created").reverse().toArray()},getItemsByDataType:function(e){return fe.items.where("dataType").equals(e).reverse().sortBy("created")},getItemById:function(e){return fe.items.where("id").equals(e).first()},updateItem:function(e,t){return fe.items.where("id").equals(e).modify(t)},deleteItem:function(e){return fe.items.where("id").equals(e).delete()},putItem:function(e){return fe.items.put(e)},reset:function(){return fe.delete().then(()=>{(fe=new n("Store")).version(1).stores(pe)})}},he={getAppSetting:function(e){return me.getAppSetting(e).catch(t=>{console.error(`Unexpected key: ${e}`),Promise.reject(t)})},setAppSetting:function(e,t){return me.putAppSetting(e,t).catch(n=>{console.error(`Unexpected key: ${e} or value: ${t}`),Promise.reject(n)})},getResources:function(){return me.getResources()},setResources:function(e){return me.putResources(e).catch(t=>{console.error(`Unexpected resources: ${e}`),Promise.reject(t)})},getAllTables:function(){return me.getAllItems()},getTablesByDataType:function(e){return me.getItemsByDataType(e).catch(t=>{console.error(`Unexpected dataType: ${e}`),Promise.reject(t)})},getTable:function(e){return me.getItemById(e).catch(t=>{console.error(`Unexpected table ID: ${e}`),Promise.reject(t)})},setFieldProperties:function(e,t){return me.updateItem(e,e=>{e.fields.forEach((e,n)=>{e.visible=t.visibles.includes(e.key),e.sortType=t.sortTypes[n],e.digit=t.digits[n]}),e.revision++}).catch(n=>{console.error(`Unexpected table ID: ${e} or updates: ${t}`),Promise.reject(n)})},joinFields:function(e,t){return me.updateItem(e,e=>{ue.apply(e,t),e.revision++}).catch(n=>{console.error(`Unexpected table ID: ${e} or mapping: ${t}`),Promise.reject(n)})},updateTableAttribute:p,insertTable:function(e){return e.fields=oe.defaultFieldProperties(e.fields),me.putItem(e).catch(t=>{console.error(`Unexpected data: ${e}`),Promise.reject(t)})},updateTable:function(e){return"failure"===e.status?p(e.id,"status","failure"):me.updateItem(e.id,t=>{e.fields=oe.defaultFieldProperties(e.fields),Object.assign(t,e),t.revision++})},deleteTable:function(e){return me.deleteItem(e).catch(t=>{console.error(`Unexpected table ID: ${e}`),Promise.reject(t)})},reset:function(){return me.reset()}},ge={formatNum:function(t,n){const l={scientific:".3e",si:".3s",rounded:".3r"};return"raw"===n?t:void 0===t||null===t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(l[n])(t):t},partialMatch:function(e,t){return void 0!==t&&null!==t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},numericAsc:f,numericDesc:function(e,t){return f(t,e)},textAsc:m,textDesc:function(e,t){return m(t,e)}},ye={showPlot:function(e,t){new l.View(l.parse(e)).initialize(t).run()},plotThumbnail:function(e){return new l.View(l.parse(e)).toImageURL("png")}},be={selectOptions:function(e,t,n,l){const o=e.selectAll("option").data(t,n);o.exit().remove(),o.enter().append("option").merge(o).attr("value",n).text(l)},checkboxList:function(e,t,n,l,o){const s=e.selectAll("li").data(t,l);s.exit().remove();const r=s.enter().append("li").attr("class","form-check").append("label");r.append("input"),r.append("span");const a=r.merge(s.select("label")).attr("class","form-check-label");a.select("input").attr("type","checkbox").attr("class","form-check-input").attr("name",n).attr("value",l),a.select("span").text(o)},checkboxListT:function(e,t,n,l,o){const s=e.selectAll("li").data(t,l);s.exit().remove();const r=s.enter().append("li").attr("class","form-check").append("label");r.append("input"),r.append("a");const a=r.merge(s.select("label")).attr("class","form-check-label");a.select("input").attr("type","checkbox").attr("class","form-check-input").attr("name",n).attr("value",l),a.select("a").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",e=>e.description||"No").text(o)},createTable:function(e,t){e.select("thead").size()&&e.select("thead").remove(),e.append("thead").append("tr"),e.select("tbody").size()&&e.select("tbody").remove(),e.append("tbody");const n=t.fields.filter(e=>e.visible),l=e.select("thead tr").selectAll("th").data(n,e=>e.key);l.exit().remove(),l.enter().append("th").merge(l).text(e=>e.name)},updateTableRecords:h,appendTableRows:function(e,t,n){const l=e.select("tbody").selectAll("tr").data();Array.prototype.push.apply(l,t),h(e,l,n)},addSort:function(t){t.select("thead tr").selectAll("th").filter(e=>"none"!==e.sortType).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",n=>{const l="v"===e.select(`#sort-${n.key}`).text(),o="numeric"===n.sortType,s=l?o?ge.numericAsc:ge.textAsc:o?ge.numericDesc:ge.textDesc;t.select("tbody").selectAll("tr").sort((e,t)=>s(e[n.key],t[n.key])),e.select(`#sort-${n.key}`).text(l?"^":"v")})},formatNumbers:function(e){e.select("thead tr").selectAll("th").each((t,n)=>{"raw"!==t.digit&&e.select("tbody").selectAll("tr").selectAll("td").filter((e,t)=>t===n).text(e=>ge.formatNum(e,t.digit))})}};const ve="";var ke={get:function(e,t={}){const n=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${ve}${e}${n}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},json:function(e){return e.json()},text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${ve}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null}},xe={pickDialog:function(t,n){he.getAppSetting("compoundIDPlaceholder").then(t=>{e.select("#pick-queryarea").text(t)}),e.select("#pick-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const l={type:"chemsearch",targets:t.filter(e=>"chemical"===e.domain).map(e=>e.id),key:"compound_id",values:V.textareaLines("#pick-queryarea")};return ke.get("run",l).then(ke.json).then(n,ke.error)})},propDialog:function(t,n){e.select("#prop-targets").call(be.checkboxList,t,"targets",e=>e.id,e=>e.name).on("change",function(){const t=ie.from(V.checkboxData("#prop-targets")).map(e=>e.fields).extend().unique("key");e.select("#prop-key").call(be.selectOptions,t,e=>e.key,e=>e.name)}),e.select("#prop-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t={type:"chemprop",targets:V.checkboxValues("#prop-targets"),key:V.optionData("#prop-key").key,values:V.textareaLines("#prop-queryarea"),operator:V.value("#prop-operator")};return ke.get("async",t).then(ke.json).then(n,ke.error)})},structDialog:function(t,n){e.select("#struct-qsrc").call(be.selectOptions,t,e=>e.id,e=>e.name),e.select("#struct-targets").call(be.checkboxList,t,"targets",e=>e.id,e=>e.name),he.getAppSetting("rdkit").then(t=>{e.select("#struct-method").selectAll("option.rd").attr("disabled",t?null:"disabled")}),e.selectAll("#struct-method,#struct-thldtype").on("change",function(){const t=V.value("#struct-method"),n=V.value("#struct-thldtype");e.select("#struct-thld").attr("disabled",["gls","rdmorgan","rdfmcs"].includes(t)?null:"disabled").attr("value","edge"===n?15:.7).attr("min","edge"===n?5:0).attr("max","edge"===n?999:1).attr("step","edge"===n?1:.01),e.select("#struct-thldtype").attr("disabled",["gls","rdmorgan","rdfmcs"].includes(t)?null:"disabled").property("value",["gls","rdfmcs"].includes(t)?void 0:"sim"),e.select("#struct-thldtype option.sim").attr("disabled",["gls","rdmorgan","rdfmcs"].includes(t)?null:"disabled"),e.select("#struct-thldtype option.edge").attr("disabled",["gls","rdfmcs"].includes(t)?null:"disabled"),e.select("#struct-options").selectAll(".gls").attr("disabled","gls"===t?null:"disabled"),e.select("#struct-options .fmcs").attr("disabled","rdfmcs"===t?null:"disabled")}).dispatch("change"),e.select("#struct-format").on("change",function(){e.select("#struct-qsrc").attr("disabled","dbid"===this.value?null:"disabled")}),e.select("#struct-preview").on("click",()=>{const t=V.value("#struct-format"),n={format:t,source:"dbid"===t?V.value("#struct-qsrc"):null,value:"molfile"===t?V.value("#struct-queryarea"):V.textareaLines("#struct-queryarea")[0]};return ke.get("strprev",n).then(ke.text).then(t=>e.select("#struct-image").html(t),ke.error)}),e.select("#struct-submit").on("click",()=>{const t=V.value("#struct-method");e.select("#loading-circle").style("display","inline");const l=V.value("#struct-format"),o={type:V.value("#struct-method"),targets:V.checkboxValues("#struct-targets"),queryMol:{format:l,source:"dbid"===l?V.value("#struct-qsrc"):null,value:"molfile"===l?V.value("#struct-queryarea"):V.textareaLines("#struct-queryarea")[0]},params:{measure:V.value("#struct-thldtype"),threshold:V.valueFloat("#struct-thld"),ignoreHs:V.checked("#struct-ignoreh"),diameter:"gls"===t?V.valueInt("#struct-diam"):null,maxTreeSize:"gls"===t?V.valueInt("#struct-tree"):null,molSizeCutoff:"gls"===t?V.valueInt("#struct-skip"):null,timeout:"rdfmcs"===t?V.valueInt("#struct-timeout"):null}},s="exact"===o.type?"run":"async";return ke.get(s,o).then(ke.json).then(n,ke.error)})},sdfDialog:function(t){e.select("#sdf-file").on("change",()=>{const t=new FileReader,n=document.getElementById("sdf-file").files[0];t.onload=(t=>{e.select("#sdf-cols").call(be.checkboxList,de.getSDFPropList(t.target.result),"fields",e=>e,e=>e)}),t.readAsText(n.slice(0,104857600))}),e.select("#sdf-selectall").on("change",()=>{e.select("#sdf-cols").selectAll("input").property("checked",V.checked("#sdf-selectall"))}),e.select("#sdf-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const n={fields:V.checkboxValues("#sdf-cols"),implh:V.checked("#sdf-implh"),recalc:V.checked("#sdf-recalc")},l=new FormData;return l.append("contents",V.firstFile("#sdf-file")),l.append("params",JSON.stringify(n)),ke.post("sdfin",l).then(ke.json).then(t,ke.error)})},columnDialog:function(t,n){const l={fields:oe.defaultFieldProperties([{key:"name",valueType:"text"},{key:"visible",valueType:"control"},{key:"sortType",valueType:"control"},{key:"digit",valueType:"control"}])},o=t.map((t,n)=>({key:t.key,name:t.name,visible:e=>e.classed("column-vis",!0).classed(`row${n}`,!0).append("input").attr("type","checkbox").attr("value",t.key).property("checked",t.visible),sortType:l=>l.classed("column-sort",!0).classed(`row${n}`,!0).append("select").call(be.selectOptions,"none"===t.sortType?["none"]:["numeric","text"],e=>e,e=>e).property("value",t.sortType).on("change",function(){e.select(`.column-digit.row${n} select`).attr("disabled","numeric"===this.value?null:"disabled")}),digit:e=>e.classed("column-digit",!0).classed(`row${n}`,!0).append("select").call(be.selectOptions,["raw","rounded","scientific","si"],e=>e,e=>e).property("value",t.digit).attr("disabled","numeric"===t.sortType?null:"disabled")}));e.select("#column-table").call(be.createTable,l).call(be.updateTableRecords,o,e=>e.key),e.select("#column-submit").on("click",()=>{const e={visibles:V.checkboxValues(".column-vis"),sortTypes:V.optionValues(".column-sort"),digits:V.optionValues(".column-digit")};return he.setFieldProperties(ce.URLQuery().id,e).then(n)})},fieldFetchDialog:function(t,n,l,o){document.getElementById("join-search").addEventListener("keypress",e=>{13===e.keyCode&&e.preventDefault()});const s=n.map(e=>e.key),r=ie.from(l.map(e=>e.fields)).extend().unique("key").filter(e=>"id"!==e.key);e.select("#join-keys").call(be.checkboxList,r,"keys",e=>e.key,e=>e.name).selectAll("li").each(function(t){e.select(this).selectAll("label").select("input").property("checked",s.includes(t.key)).attr("disabled",s.includes(t.key)?"disabled":null)}),e.select("#join-search").on("keyup",function(){const t=e=>ge.partialMatch(V.value(this),e.name);e.select("#join-keys").selectAll("li").style("visibility",e=>t(e)?null:"hidden").style("position",e=>t(e)?null:"absolute")}),e.select("#join-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const n=V.checkboxValues("#join-keys"),l={type:"fieldfilter",targetFields:r.map(e=>e.key).filter(e=>!s.includes(e)).filter(e=>n.includes(e)),key:"compound_id",values:t};return ke.get("run",l).then(ke.json).then(e=>o(ue.tableToMapping(e,"id")),ke.error)})},fieldFileDialog:function(t){e.select("#importcol-file").on("change",()=>{const t=document.getElementById("importcol-file").files[0],n="csv"===t.name.split(".").pop();ae.readFile(t).then(t=>{const l=n?ue.csvToMapping(t):JSON.parse(t),o=ue.mappingToTable(l);e.select("#importcol-preview").call(be.createTable,o).call(be.updateTableRecords,o.records.slice(0,5),e=>e[o.fields[0].key]),e.select("#importcol-preview").datum(l)})}),e.select("#importcol-submit").on("click",()=>{let n=e.select("#importcol-preview").datum();e.select("#importcol-preview").datum(null);const l=[];if(n.hasOwnProperty("field")&&(n=ue.singleToMulti(n)),n.fields.forEach((e,t)=>{"plot"===e.valueType&&(n.fields[t].valueType="image",l.push(t))}),l.length>0){const e=[];Object.entries(n.mapping).forEach(t=>{l.forEach(l=>{const o=ye.plotThumbnail(t[1][l]).then(e=>{n.mapping[t[0]][l]=e});e.push(o)})}),Promise.all(e).then(()=>t(n))}else t(n)})},graphDialog:function(t){he.getAppSetting("rdkit").then(t=>{e.select("#graph-measure").selectAll("option.rd").attr("disabled",t?null:"disabled")}),e.select("#graph-measure").on("change",function(){e.select("#graph-options").selectAll(".gls").attr("disabled","gls"===this.value?null:"disabled"),e.select("#graph-options").selectAll(".fmcs").attr("disabled","rdfmcs"===this.value?null:"disabled")}),e.select("#graph-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const n=V.value("#graph-measure"),l={measure:n,threshold:V.valueFloat("#graph-thld"),ignoreHs:V.checked("#graph-ignoreh"),diameter:"gls"===n?V.valueInt("#graph-diam"):null,maxTreeSize:"gls"===n?V.valueInt("#graph-tree"):null,molSizeCutoff:"gls"===n?V.valueInt("#graph-skip"):null,timeout:"rdfmcs"===n?V.valueInt("#graph-timeout"):null};t(l)})},graphConfigDialog:function(t,n,l){e.select("#graphconfig-thld").attr("value",t).attr("max",1).attr("min",n),e.select("#graphconfig-submit").on("click",()=>{const e=V.valueFloat("#graphconfig-thld");e<n||l(e)})},communityDialog:function(t){e.select("#community-name").attr("value","comm_"),e.select("#community-submit").on("click",()=>{const e={name:V.value("#community-name"),nulliso:V.checked("#community-nulliso")};t(e)})},importConfirmDialog:function(t){e.select("#importconfirm-overwrite").on("click",()=>t("overwrite")),e.select("#importconfirm-keepboth").on("click",()=>t("keepboth")),e.select("#importconfirm-cancel").on("click",()=>t("cancel"))}},we={interactiveInsert:function(e){return he.getTable(e.id).then(t=>t?e.revision==t.revision?Promise.reject(e.id):($("#importconfirm-dialog").modal("toggle"),new Promise(t=>{xe.importConfirmDialog(n=>{"overwrite"===n&&t(e),"keepboth"===n&&(e.id=de.uuidv4(),t(e))})})):Promise.resolve(e)).then(e=>he.insertTable(e).then(()=>e.id),e=>e?Promise.resolve(e):Promise.reject())},fetchResults:function(e="update"){return he.getTable(ce.URLQuery().id).then(e=>oe.ongoing(e)?e:Promise.reject()).then(t=>{const n={id:t.id,command:e};return ke.get("res",n).then(ke.json).then(he.updateTable,ke.error)},()=>Promise.resolve())},loader:function(){"serviceWorker"in navigator&&!Q?navigator.serviceWorker.register("sw.js").then(e=>{console.info("ServiceWorker registration successful with scope: ",e.scope)}).catch(e=>{console.info("ServiceWorker registration failed: ",e)}):Q?console.info("Off-line mode is disabled for debugging"):console.info("Off-line mode is not supported");const e=ke.get("server").then(ke.json).catch(()=>null),t=he.getAppSetting("serverInstance");return Promise.all([e,t]).then(e=>{const t=e[0],n=e[1];return t?t.instance===n?(console.info("Resource schema is already up to date"),Promise.resolve(t)):ke.get("schema").then(ke.json).then(e=>(console.info(`New resource schema version: ${t.instance}`),Promise.all([he.setResources(e.resources),he.setAppSetting("templates",e.templates),he.setAppSetting("compoundIDPlaceholder",e.compoundIDPlaceholder),he.setAppSetting("serverInstance",t.instance),he.setAppSetting("rdkit",t.rdkit)]).then(()=>Promise.resolve(t))),ke.error):Promise.resolve(null)})}},Ae={renderStatus:function(t,n,l){e.select("#loading-circle").style("display","none"),e.select("title").text(t.name),e.select("#title").text(t.name),e.select("#refresh").style("display",oe.ongoing(t)?"inline-block":"none"),e.select("#abort").style("display",oe.ongoing(t)?"inline-block":"none");const o={nodes:"entries found",edges:"connections created"}[t.dataType];e.select("#progress").text(`(${t.status} - ${t.resultCount} ${o} in ${t.execTime} sec.)`),oe.ongoing(t)&&e.select("#progress").append("div").append("progress").attr("max",100).attr("value",t.progress).text(`${t.progress}%`),e.select("#refresh").on("click",n),e.select("#abort").on("click",()=>{e.select("#confirm-message").text("Are you sure you want to abort this calculation job?"),e.select("#confirm-submit").classed("btn-primary",!1).classed("btn-warning",!0).on("click",l)}),console.info("Query"),console.info(t.query)},initializeWithData:function(){e.select("#new-data").style("display","none"),e.select("#loading-circle").style("display","none")},initialize:function(){e.select("#data-control").style("display","none"),e.select("#nodedata").style("display","none"),e.select("#refresh").style("display","none"),e.select("#abort").style("display","none"),e.select("#loading-circle").style("display","none"),e.select("#status").selectAll("li").style("display","none")}};const Te=e.forceSimulation().force("link",e.forceLink().id(e=>e._index).distance(60).strength(1)).force("charge",e.forceManyBody().strength(-600).distanceMin(15).distanceMax(720)).force("collide",e.forceCollide().radius(90)).force("center",e.forceCenter(600,600)).force("x",e.forceX().strength(.002)).force("y",e.forceY().strength(.002)).stop();var $e={fieldWidth:1200,fieldHeight:1200,simulation:Te,setForce:function(e,t,n,l){Te.nodes(e).force("link").links(t),Te.on("tick",n).on("end",l)},tick:function(){e.select("#graph-contents").selectAll(".node").attr("transform",e=>`translate(${e.x}, ${e.y})`);const t=Te.alpha(),n=t<=Te.alphaMin();e.select("#temperature").classed("progress-success",n).classed("progress-warning",!n).attr("value",n?1:1-t).text(n?1:1-t)},end:function(){e.select("#graph-contents").selectAll(".link").attr("transform",e=>`translate(${e.source.x}, ${e.source.y})`).attr("visibility","visible"),e.select("#graph-contents").selectAll(".edge-line").attr("x1",0).attr("y1",0).attr("x2",e=>e.target.x-e.source.x).attr("y2",e=>e.target.y-e.source.y),e.select("#graph-contents").selectAll(".edge-label").attr("x",e=>(e.target.x-e.source.x)/2).attr("y",e=>(e.target.y-e.source.y)/2)}},Pe={defaultNodeColor:{id:"color",field:null,scale:{domain:[0,1],range:["#7fffd4","#7fffd4"],scale:"linear",unknown:"#7fffd4"}},defaultNodeSize:{id:"size",field:null,scale:{domain:[0,1],range:[40,40],scale:"linear",unknown:40}},defaultNodeLabel:{id:"label",text:null,size:12,visible:!1,field:null,scale:{domain:[0,1],range:["#000000","#000000"],scale:"linear",unknown:"#000000"}},defaultNodeContent:{structure:{visible:!1}},defaultEdge:{id:"edge",visible:!0,label:{size:10,visible:!1},scale:{domain:[0,1],range:[5,5],scale:"linear",unknown:5}}},Ce={updateNodeStructure:C,updateNodeImage:function(e){A(e.nodeSize),w(e.nodeColor),P(e.nodeLabel),C(e.nodeContent)},updateEdge:O,updateControl:I,mainControlBox:function(){e.select("#show-struct").on("change",function(){const t=k();e.select("#main-control").datum(t),C(t)}).dispatch("change")},nodeColorControlBox:function(t){N(t.filter(e=>"none"!==e.sortType),"color"),e.selectAll(".color-update").on("change",()=>{const t=g("color");e.select("#color-control").datum(t),I(t),w(t)}),e.select(".color-update").dispatch("change")},nodeLabelControlBox:function(t){const n=t.filter(e=>"none"!==e.sortType);e.select("#label-text").call(be.selectOptions,n,e=>e.key,e=>e.name),N(n,"label"),e.select("#label-visible").on("change",function(){T(V.checked(this),"label"),e.select(`.label-update`).dispatch("change")}),e.selectAll(".label-update").on("change",()=>{const t=y();e.select("#label-control").datum(t),I(t),P(t)}),e.select(`.label-update`).dispatch("change")},nodeSizeControlBox:function(t){const n=t.filter(e=>"numeric"===e.sortType);e.select(`#size-col`).call(be.selectOptions,n,e=>e.key,e=>e.name),j(ee.sizePresets,"size"),e.selectAll(".size-update").on("change",()=>{const t=v("size");e.select("#size-control").datum(t),I(t),A(t)}),e.select(`.size-update`).dispatch("change")},edgeControlBox:function(){j(ee.edgeWidthPresets,"edge"),e.select("#edge-visible").on("change",function(){z(V.checked(this)),S(V.checked(this)),e.select(`.edge-update`).dispatch("change")}),e.select("#edge-label-visible").on("change",function(){S(V.checked(this)),e.select(`.edge-update`).dispatch("change")}),e.selectAll(".edge-update").on("change",()=>{const t=x("edge");e.select("#edge-control").datum(t),I(t),O(t)}),e.select(`.edge-update`).dispatch("change")}},ze={graphNodes:function(e,t){const n=e.selectAll(".node").data(t,e=>e.key);n.exit().remove();const l=n.enter().append("g").attr("class","node");l.append("circle").attr("class","node-symbol"),l.append("g").attr("class","node-struct"),l.append("text").attr("class","node-label");const o=l.merge(n);o.select(".node-struct").html(e=>e._structure),o.select(".node-label").attr("x",0).attr("text-anchor","middle")},graphEdges:function(e,t){const n=e.selectAll(".link").data(t,e=>`${e.source}_${e.target}`);n.exit().remove();const l=n.enter().append("g").attr("class","link");l.append("line").attr("class","edge-line"),l.append("text").attr("class","edge-label");const o=l.merge(n);o.select(".edge-line").style("stroke","#999").style("stroke-opacity",.6),o.select(".edge-label").attr("text-anchor","middle").text(e=>e.weight)}};const Se=e.zoom().on("zoom",()=>{e.select("#graph-contents").attr("transform",e.event.transform)}),Oe=e.drag().on("start",()=>{e.select("#graph-contents").selectAll(".link").attr("visibility","hidden"),e.event.active||$e.simulation.alphaTarget(.1).restart()}).on("drag",t=>{t.fx=e.event.x,t.fy=e.event.y}).on("end",t=>{e.event.active||$e.simulation.alphaTarget(0),t.fx=null,t.fy=null}),De=e.drag().on("drag",function(t){e.select(this).attr("transform",()=>`translate(${e.event.x}, ${e.event.y})`),t.x=e.event.x,t.y=e.event.y;const n=e.select("#graph-contents").selectAll(".link").filter(e=>[e.source.index,e.target.index].includes(this.__data__.index));n.attr("transform",e=>`translate(${e.source.x}, ${e.source.y})`).attr("visibility","visible"),n.select(".edge-line").attr("x1",0).attr("y1",0).attr("x2",e=>e.target.x-e.source.x).attr("y2",e=>e.target.y-e.source.y),n.select(".edge-label").attr("x",e=>(e.target.x-e.source.x)/2).attr("y",e=>(e.target.y-e.source.y)/2)}).on("end",()=>{$e.end()});var Le={zoom:Se,dragWithForce:Oe,dragNoForce:De,stickNodes:function(){$e.simulation.alpha(0).stop(),e.selectAll(".node").each(e=>{e.fx=e.x,e.fy=e.y}),$e.tick(),$e.end(),e.select("#stick-nodes").property("checked",!0),e.select("#graph-contents").selectAll(".link").attr("visibility","visible"),e.select("#graph-contents").selectAll(".node").call(De)},unstickNodes:F,relax:function(){F(),$e.simulation.alpha(.1).restart()},restart:function(){F(),$e.simulation.alpha(1).restart()},fitToScreen:function(){e.select("#graph-field").call(Se.transform,e.zoomIdentity)}},Ie={communityDetection:function(e,t,n){const l=o().nodes(e).edges(t)();if(n.nulliso){const e={};Object.entries(l).forEach(t=>{e.hasOwnProperty(t[1])||(e[t[1]]=[]),e[t[1]].push(t[0])}),Object.entries(e).forEach(e=>{1===e[1].length&&(l[e[1][0]]=null)})}return l}};return{force:$e,control:Ce,component:ze,interaction:Le,community:Ie,run:function(){return e.select("#export").on("click",()=>U().then(e=>ae.downloadJSON(e,e.edges.name))),e.select("#graph-field").attr("viewBox",`0 0 ${$e.fieldWidth} ${$e.fieldHeight}`).call(Le.zoom),e.select("#snapshot").on("click",R),e.select("#restart").on("click",Le.restart),e.select("#import-json").on("click",()=>document.getElementById("select-file").click()),e.select("#select-file").on("change",()=>{const e=document.getElementById("select-file").files[0];ae.loadJSON(e).then(M)}),ce.URLQuery().hasOwnProperty("location")?ae.fetchJSON(ce.URLQuery().location).then(e=>we.interactiveInsert(e.nodes).then(t=>(e.edges.nodesID=t,we.interactiveInsert(e.edges))).then(e=>{window.location=`graph.html?id=${e}`})):we.loader().then(()=>ce.URLQuery().hasOwnProperty("id")?(Ae.initializeWithData(),we.fetchResults("update").then(_)):(Ae.initialize(),Promise.resolve()))}}});
//# sourceMappingURL=kwgraph.js.map
