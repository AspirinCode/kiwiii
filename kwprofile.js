// https://github.com/mojaie/kiwiii Version 0.8.3. Copyright 2017 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("Dexie"),require("pako"),require("vega")):"function"==typeof define&&define.amd?define(["d3","Dexie","pako","vega"],t):e.kwprofile=t(e.d3,e.Dexie,e.pako,e.vega)}(this,function(e,t,r,n){"use strict";function o(e,t){const r=parseFloat(e),n=parseFloat(t);return isNaN(r)||isNaN(n)?String(t).localeCompare(String(e)):n-r}function s(e,t){return String(t).localeCompare(String(e))}function l(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}function a(e,t,r){return S.updateItem(e,e=>{e[t]=r,e.revision++}).catch(n=>{console.error(`Unexpected table ID: ${e}, key: ${t} or value: ${r}`),Promise.reject(n)})}function i(e){const t=e.columns.map(e=>(e.format="raw",e));return{id:e.id,name:e.name,dataType:I[e.format],schemaVersion:.8,revision:0,status:_[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function c(e){if(e.hasOwnProperty("edges")){const t=i(e.nodes);return{nodes:t,edges:function(e,t){const r={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(r.nodeColor.id=e.snapshot.nodeColor.id,r.nodeColor.scale=e.snapshot.nodeColor.scale,r.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):r.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(r.nodeSize.id=e.snapshot.nodeSize.id,r.nodeSize.scale=e.snapshot.nodeSize.scale,r.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):r.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(r.nodeLabel.id=e.snapshot.nodeLabel.id,r.nodeLabel.size=e.snapshot.nodeLabel.size,r.nodeLabel.text=e.snapshot.nodeLabel.text,r.nodeLabel.visible=e.snapshot.nodeLabel.visible,r.nodeLabel.scale=e.snapshot.nodeLabel.scale,r.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):r.nodeLabel={id:"label",size:12,text:"index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?r.nodeContent=e.snapshot.nodeContent:r.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?r.edge=e.snapshot.edge:r.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:I[e.format],schemaVersion:.8,revision:0,reference:{nodes:e.nodeTableId},status:_[e.status],fields:g.defaultFieldProperties([{key:"source"},{key:"target"},{key:"weight"}]),records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:r}}(e.edges,t.fields)}}return i(e)}function d(e,t,r){return new Promise((n,o)=>{const s=new FileReader,l=t?e.slice(0,t):e;s.onload=(e=>n(e.target.result)),s.onerror=(e=>o(e)),r?s.readAsArrayBuffer(l):s.readAsText(l)})}function u(e,t){const n=t?r.inflate(e,{to:"string"}):e,o=JSON.parse(n);if(o.hasOwnProperty("schemaVersion"))return o;if(o.hasOwnProperty("edges")&&o.edges.hasOwnProperty("schemaVersion")){if(!o.edges.hasOwnProperty("reference")){o.edges.reference={nodes:o.edges.nodesID};const e={};o.nodes.records.forEach((t,r)=>{t.index=r,t.structure=t._structure,e[t._index]=t.index,delete t._index,delete t._structure}),o.edges.records.forEach(t=>{t.source=e[t.source],t.target=e[t.target]}),o.nodes.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure")}),o.edges.snapshot.nodeColor.field.key="index",o.edges.snapshot.nodeLabel.field.key="index",o.edges.snapshot.nodeSize.field.key="index"}return o}return c(o)}function p(e,t){try{const r=window.URL.createObjectURL(new Blob([e])),n=document.createElement("a");n.download=t,n.href=r,n.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}function f(t,r,n){const o=t.select("thead tr").selectAll("th").data(),s=t.select("tbody").selectAll("tr").data(r,n);s.exit().remove();const l=s.enter().append("tr");l.selectAll("td").data(e=>o.map(t=>e[t.key])).enter().append("td"),l.merge(s).selectAll("td").classed("align-middle",!0).html(function(e,t){if(void 0===e)return"";if("d3_format"===o[t].format)return y.formatNum(e,o[t].d3_format);if("plot"===o[t].format)return"[plot]";if("image"===o[t].format)return"[image]";if("control"!==o[t].format)return e}).each((t,r,n)=>{"control"===o[r].format&&e.select(n[r]).call(t)})}function m(){"serviceWorker"in navigator?navigator.serviceWorker.register("sw.js").then(e=>{console.info("ServiceWorker registration successful with scope: ",e.scope)}).catch(e=>{console.info("ServiceWorker registration failed: ",e)}):console.info("Off-line mode is not supported")}e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n;var h={value:function(t){return e.select(t).node().value},valueInt:function(t){return parseInt(e.select(t).node().value)},valueFloat:function(t){return parseFloat(e.select(t).node().value)},checked:function(t){return e.select(t).node().checked},firstFile:function(t){return e.select(t).node().files[0]},inputValues:function(t){return e.selectAll(t).selectAll("input").nodes().map(e=>e.value)},checkboxValues:function(t){return e.selectAll(t).selectAll("input:checked").nodes().map(e=>e.value)},optionValues:function(t){return e.selectAll(t).selectAll("select").nodes().map(e=>e.value)},textareaLines:function(t){return e.select(t).node().value.split("\n").filter(e=>e.length>0)},optionData:function(t){const r=e.select(t).property("selectedIndex");return e.select(t).selectAll("option").data().find((e,t)=>t===r)},checkboxData:function(t){return e.selectAll(t).selectAll("input:checked").data()}},g={defaultFieldProperties:function(e){return e.map(e=>(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),e))},sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id"].includes(e)?"text":"none"},ongoing:function(e){return["running","ready"].includes(e.status)}},y={formatNum:function(t,r){return void 0===t||null===t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(r)(t):t},partialMatch:function(e,t){return void 0!==t&&null!==t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},numericAsc:o,numericDesc:function(e,t){return o(t,e)},textAsc:s,textDesc:function(e,t){return s(t,e)}};class b extends Array{unique(e){return this.reduce((t,r)=>(void 0===t.find(t=>t[e]===r[e])&&t.push(r),t),new b)}extend(){return this.reduce((e,t)=>(Array.prototype.push.apply(e,t),e),new b)}extendAsync(){return Promise.all(this).then(e=>e.reduce((e,t)=>(Array.prototype.push.apply(e,t),e),new b))}toArray(){return new Array(this)}toObject(){const e={};return this.forEach(t=>{e[t[0]]=t[1]}),e}}var k={URLQuery:function(){return b.from(window.location.search.substring(1).split("&")).map(e=>e.split("=")).toObject()}};const v="";var x={get:function(e,t={}){const r=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${v}${e}${r}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},json:function(e){return e.json()},text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${v}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null}},w={getSDFPropList:function(e){const t=/>.*?<(\S+)>/g,r=new Set;let n;for(;null!==(n=t.exec(e));)r.add(n[1]);return Array.from(r)},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}},P={singleToMulti:l,mappingToTable:function(e){const t=e.hasOwnProperty("field")?l(e):e,r={key:t.key,format:"text"};return{fields:g.defaultFieldProperties([r].concat(t.fields)),records:Object.entries(t.mapping).map(e=>{const r={};return r[t.key]=e[0],t.fields.forEach((t,n)=>{r[t.key]=e[1][n]}),r})}},tableToMapping:function(e,t,r=["index"]){const n={created:(new Date).toString(),fields:g.defaultFieldProperties(e.fields.filter(e=>e.key!==t).filter(e=>!r.includes(e.key))),key:t,mapping:{}};return e.records.forEach(e=>{n.mapping[e[t]]=n.fields.map(t=>e[t.key])}),n},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),r=t.shift().split(","),n=r.shift(),o=new Date,s=[],l=[];r.forEach((e,t)=>{""!==e&&(s.push(t),l.push({key:e,format:"text"}))});const a={created:o.toString(),fields:g.defaultFieldProperties(l),key:n,mapping:{}};return t.forEach(e=>{const t=e.split(","),r=t.shift();a.mapping[r]=Array(s.length),s.forEach(e=>{a.mapping[r][e]=t[e]})}),a},apply:function(e,t){const r=t.hasOwnProperty("field")?l(t):t;e.records.filter(e=>r.mapping.hasOwnProperty(e[r.key])).forEach(e=>{r.fields.forEach((t,n)=>{e[t.key]=r.mapping[e[r.key]][n]})}),e.fields=g.defaultFieldProperties(b.from(e.fields).concat(r.fields).unique("key"))}};const A={app:"key",items:"id, dataType, created",resources:"id"};let T=new t("Store");T.version(1).stores(A);var S={getAppSetting:function(e){return T.app.where("key").equals(e).first().then(e=>{if(void 0!==e)return e.value})},putAppSetting:function(e,t){return T.app.put({key:e,value:t})},getResources:function(){return T.resources.toArray()},putResources:function(e){return T.resources.bulkPut(e)},getAllItems:function(){return T.items.orderBy("created").reverse().toArray()},getItemsByDataType:function(e){return T.items.where("dataType").equals(e).reverse().sortBy("created")},getItemById:function(e){return T.items.where("id").equals(e).first()},updateItem:function(e,t){return T.items.where("id").equals(e).modify(t)},deleteItem:function(e){return T.items.where("id").equals(e).delete()},putItem:function(e){return T.items.put(e)},reset:function(){return T.delete().then(()=>{(T=new t("Store")).version(1).stores(A)})}},D={getAppSetting:function(e){return S.getAppSetting(e).catch(t=>{console.error(`Unexpected key: ${e}`),Promise.reject(t)})},setAppSetting:function(e,t){return S.putAppSetting(e,t).catch(r=>{console.error(`Unexpected key: ${e} or value: ${t}`),Promise.reject(r)})},getResources:function(){return S.getResources()},setResources:function(e){return S.putResources(e).catch(t=>{console.error(`Unexpected resources: ${e}`),Promise.reject(t)})},getAllTables:function(){return S.getAllItems()},getTablesByDataType:function(e){return S.getItemsByDataType(e).catch(t=>{console.error(`Unexpected dataType: ${e}`),Promise.reject(t)})},getTable:function(e){return S.getItemById(e).catch(t=>{console.error(`Unexpected table ID: ${e}`),Promise.reject(t)})},setFieldProperties:function(e,t){return S.updateItem(e,e=>{e.fields.forEach((e,r)=>{e.visible=t.visibles.includes(e.key),e.format=t.formats[r],t.d3_formats[r]&&(e.d3_format=t.d3_formats[r])}),e.revision++}).catch(r=>{console.error(`Unexpected table ID: ${e} or updates: ${t}`),Promise.reject(r)})},joinFields:function(e,t){return S.updateItem(e,e=>{P.apply(e,t),e.revision++}).catch(r=>{console.error(`Unexpected table ID: ${e} or mapping: ${t}`),Promise.reject(r)})},updateTableAttribute:a,insertTable:function(e){return e.fields=g.defaultFieldProperties(e.fields),S.putItem(e).catch(t=>{console.error(`Unexpected data: ${e}`),Promise.reject(t)})},updateTable:function(e){return"failure"===e.status?a(e.id,"status","failure"):S.updateItem(e.id,t=>{e.fields=g.defaultFieldProperties(e.fields),Object.assign(t,e),t.revision++})},deleteTable:function(e){return S.deleteItem(e).catch(t=>{console.error(`Unexpected table ID: ${e}`),Promise.reject(t)})},reset:function(){return S.reset()}};const _={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},I={datatable:"nodes",connection:"edges"};var O={readFile:d,parseJSON:u,loadJSON:function(e){const t=e.name.endsWith("c")||e.name.endsWith(".gz");return d(e,!1,t).then(e=>u(e,t))},fetchJSON:function(e){const t=decodeURIComponent(e),r=t.endsWith("c")||t.endsWith(".gz");return fetch(t).then(e=>r?e.arrayBuffer():e.json()).then(e=>u(e,r))},downloadDataFile:p,downloadJSON:function(e,t,n=!0){const o=JSON.stringify(e),s=n?r.gzip(o):o,l=n?"c":"r";p(s,`${t}${e.hasOwnProperty("edges")?`.gf${l}`:`.nd${l}`}`)}},j={showPlot:function(e,t){new n.View(n.parse(e)).initialize(t).run()},plotThumbnail:function(e){return new n.View(n.parse(e)).toImageURL("png")}},C={selectOptions:function(e,t,r,n){const o=e.selectAll("option").data(t,r);o.exit().remove(),o.enter().append("option").merge(o).attr("value",r).text(n)},checkboxList:function(e,t,r,n,o){const s=e.selectAll("li").data(t,n);s.exit().remove();const l=s.enter().append("li").attr("class","form-check").append("label");l.append("input"),l.append("span");const a=l.merge(s.select("label")).attr("class","form-check-label");a.select("input").attr("type","checkbox").attr("class","form-check-input").attr("name",r).attr("value",n),a.select("span").text(o)},checkboxListT:function(e,t,r,n,o){const s=e.selectAll("li").data(t,n);s.exit().remove();const l=s.enter().append("li").attr("class","form-check").append("label");l.append("input"),l.append("a");const a=l.merge(s.select("label")).attr("class","form-check-label");a.select("input").attr("type","checkbox").attr("class","form-check-input").attr("name",r).attr("value",n),a.select("a").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",e=>e.description||"No").text(o)},createTable:function(e,t){e.select("thead").size()&&e.select("thead").remove(),e.append("thead").append("tr"),e.select("tbody").size()&&e.select("tbody").remove(),e.append("tbody");const r=t.fields.filter(e=>e.visible),n=e.select("thead tr").selectAll("th").data(r,e=>e.key);n.exit().remove(),n.enter().append("th").merge(n).text(e=>e.name)},updateTableRecords:f,appendTableRows:function(e,t,r){const n=e.select("tbody").selectAll("tr").data();Array.prototype.push.apply(n,t),f(e,n,r)},addSort:function(t){t.select("thead tr").selectAll("th").filter(e=>"none"!==g.sortType(e.format)).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",r=>{const n="v"===e.select(`#sort-${r.key}`).text(),o="numeric"===g.sortType(r.format),s=n?o?y.numericAsc:y.textAsc:o?y.numericDesc:y.textDesc;t.select("tbody").selectAll("tr").sort((e,t)=>s(e[r.key],t[r.key])),e.select(`#sort-${r.key}`).text(n?"^":"v")})},formatNumbers:function(e){e.select("thead tr").selectAll("th").each((t,r)=>{"raw"!==t.digit&&e.select("tbody").selectAll("tr").selectAll("td").filter((e,t)=>t===r).text(e=>y.formatNum(e,t.digit))})}},L={pickDialog:function(t,r){D.getAppSetting("compoundIDPlaceholder").then(t=>{e.select("#pick-queryarea").text(t)}),e.select("#pick-submit").on("click",()=>{e.select("#loading-icon").style("display","inline");const n={type:"chemsearch",targets:t.filter(e=>"chemical"===e.domain).map(e=>e.id),key:"compound_id",values:h.textareaLines("#pick-queryarea")};return x.get("run",n).then(x.json).then(r,x.error)})},propDialog:function(t,r){e.select("#prop-targets").call(C.checkboxList,t,"targets",e=>e.id,e=>e.name).on("change",function(){const t=b.from(h.checkboxData("#prop-targets")).map(e=>e.fields).extend().unique("key");e.select("#prop-key").call(C.selectOptions,t,e=>e.key,e=>e.name)}),e.select("#prop-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t={type:"chemprop",targets:h.checkboxValues("#prop-targets"),key:h.optionData("#prop-key").key,values:h.textareaLines("#prop-queryarea"),operator:h.value("#prop-operator")};return x.get("async",t).then(x.json).then(r,x.error)})},structDialog:function(t,r){e.select("#struct-qsrc").call(C.selectOptions,t,e=>e.id,e=>e.name),e.select("#struct-targets").call(C.checkboxList,t,"targets",e=>e.id,e=>e.name),D.getAppSetting("rdkit").then(t=>{e.select("#struct-method").selectAll("option.rd").attr("disabled",t?null:"disabled")}),e.selectAll("#struct-method,#struct-thldtype").on("change",function(){const t=h.value("#struct-method"),r=h.value("#struct-thldtype");e.select("#struct-thld").attr("disabled",["gls","rdmorgan","rdfmcs"].includes(t)?null:"disabled").attr("value","edge"===r?15:.7).attr("min","edge"===r?5:0).attr("max","edge"===r?999:1).attr("step","edge"===r?1:.01),e.select("#struct-thldtype").attr("disabled",["gls","rdmorgan","rdfmcs"].includes(t)?null:"disabled").property("value",["gls","rdfmcs"].includes(t)?void 0:"sim"),e.select("#struct-thldtype option.sim").attr("disabled",["gls","rdmorgan","rdfmcs"].includes(t)?null:"disabled"),e.select("#struct-thldtype option.edge").attr("disabled",["gls","rdfmcs"].includes(t)?null:"disabled"),e.select("#struct-options").selectAll(".gls").attr("disabled","gls"===t?null:"disabled"),e.select("#struct-options .fmcs").attr("disabled","rdfmcs"===t?null:"disabled")}).dispatch("change"),e.select("#struct-format").on("change",function(){e.select("#struct-qsrc").attr("disabled","dbid"===this.value?null:"disabled")}),e.select("#struct-preview").on("click",()=>{const t=h.value("#struct-format"),r={format:t,source:"dbid"===t?h.value("#struct-qsrc"):null,value:"molfile"===t?h.value("#struct-queryarea"):h.textareaLines("#struct-queryarea")[0]};return x.get("strprev",r).then(x.text).then(t=>e.select("#struct-image").html(t),x.error)}),e.select("#struct-submit").on("click",()=>{const t=h.value("#struct-method");e.select("#loading-circle").style("display","inline");const n=h.value("#struct-format"),o={type:h.value("#struct-method"),targets:h.checkboxValues("#struct-targets"),queryMol:{format:n,source:"dbid"===n?h.value("#struct-qsrc"):null,value:"molfile"===n?h.value("#struct-queryarea"):h.textareaLines("#struct-queryarea")[0]},params:{measure:h.value("#struct-thldtype"),threshold:h.valueFloat("#struct-thld"),ignoreHs:h.checked("#struct-ignoreh"),diameter:"gls"===t?h.valueInt("#struct-diam"):null,maxTreeSize:"gls"===t?h.valueInt("#struct-tree"):null,molSizeCutoff:"gls"===t?h.valueInt("#struct-skip"):null,timeout:"rdfmcs"===t?h.valueInt("#struct-timeout"):null}},s="exact"===o.type?"run":"async";return x.get(s,o).then(x.json).then(r,x.error)})},sdfDialog:function(t){e.select("#sdf-file").on("change",()=>{const t=new FileReader,r=document.getElementById("sdf-file").files[0];t.onload=(t=>{e.select("#sdf-cols").call(C.checkboxList,w.getSDFPropList(t.target.result),"fields",e=>e,e=>e)}),t.readAsText(r.slice(0,104857600))}),e.select("#sdf-selectall").on("change",()=>{e.select("#sdf-cols").selectAll("input").property("checked",h.checked("#sdf-selectall"))}),e.select("#sdf-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const r={fields:h.checkboxValues("#sdf-cols"),implh:h.checked("#sdf-implh"),recalc:h.checked("#sdf-recalc")},n=new FormData;return n.append("contents",h.firstFile("#sdf-file")),n.append("params",JSON.stringify(r)),x.post("sdfin",n).then(x.json).then(t,x.error)})},columnDialog:function(t,r){const n={fields:g.defaultFieldProperties([{key:"name",format:"text"},{key:"visible",format:"control"},{key:"format",format:"control"},{key:"d3_format",format:"control"}])},o=t.map(t=>{const r={},n=["text","numeric","d3_format","raw","compound_id"];return r.name=t.name,r.visible=(e=>e.classed("column-vis",!0).classed(`row-${t.key}`,!0).append("input").attr("type","checkbox").attr("value",t.key).property("checked",t.visible)),r.format=(r=>r.classed("column-format",!0).classed(`row-${t.key}`,!0).append("select").call(C.selectOptions,n.includes(t.format)?n:[t.format],e=>e,e=>e).attr("disabled",n.includes(t.format)?null:"disabled").property("value",t.format).on("change",function(){e.select(`.column-d3f.row-${t.key} input`).attr("disabled","d3_format"===this.value?null:"disabled")})),r.d3_format=(e=>e.classed("column-d3f",!0).classed(`row-${t.key}`,!0).append("input").attr("size",10).attr("disabled","d3_format"===t.format?null:"disabled").property("value",t.d3_format)),r});e.select("#column-table").call(C.createTable,n).call(C.updateTableRecords,o,e=>e.key),e.select("#column-submit").on("click",()=>{const e={visibles:h.checkboxValues(".column-vis"),formats:h.optionValues(".column-format"),d3_formats:h.inputValues(".column-d3f")};return D.setFieldProperties(k.URLQuery().id,e).then(r)})},fieldFetchDialog:function(t,r,n,o){document.getElementById("join-search").addEventListener("keypress",e=>{13===e.keyCode&&e.preventDefault()});const s=r.map(e=>e.key),l=b.from(n.map(e=>e.fields)).extend().unique("key").filter(e=>"id"!==e.key);e.select("#join-keys").call(C.checkboxList,l,"keys",e=>e.key,e=>e.name).selectAll("li").each(function(t){e.select(this).selectAll("label").select("input").property("checked",s.includes(t.key)).attr("disabled",s.includes(t.key)?"disabled":null)}),e.select("#join-search").on("keyup",function(){const t=e=>y.partialMatch(h.value(this),e.name);e.select("#join-keys").selectAll("li").style("visibility",e=>t(e)?null:"hidden").style("position",e=>t(e)?null:"absolute")}),e.select("#join-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const r=h.checkboxValues("#join-keys"),n={type:"fieldfilter",targetFields:l.map(e=>e.key).filter(e=>!s.includes(e)).filter(e=>r.includes(e)),key:"compound_id",values:t};return x.get("run",n).then(x.json).then(e=>o(P.tableToMapping(e,"id")),x.error)})},fieldFileDialog:function(t){e.select("#importcol-file").on("change",()=>{const t=document.getElementById("importcol-file").files[0],r="csv"===t.name.split(".").pop();O.readFile(t).then(t=>{const n=r?P.csvToMapping(t):JSON.parse(t),o=P.mappingToTable(n);e.select("#importcol-preview").call(C.createTable,o).call(C.updateTableRecords,o.records.slice(0,5),e=>e[o.fields[0].key]),e.select("#importcol-preview").datum(n)})}),e.select("#importcol-submit").on("click",()=>{let r=e.select("#importcol-preview").datum();e.select("#importcol-preview").datum(null);const n=[];if(r.hasOwnProperty("field")&&(r=P.singleToMulti(r)),r.fields.forEach((e,t)=>{"plot"===e.format&&(r.fields[t].format="image",n.push(t))}),n.length>0){const e=[];Object.entries(r.mapping).forEach(t=>{n.forEach(n=>{const o=j.plotThumbnail(t[1][n]).then(e=>{r.mapping[t[0]][n]=e});e.push(o)})}),Promise.all(e).then(()=>t(r))}else t(r)})},graphDialog:function(t){D.getAppSetting("rdkit").then(t=>{e.select("#graph-measure").selectAll("option.rd").attr("disabled",t?null:"disabled")}),e.select("#graph-measure").on("change",function(){e.select("#graph-options").selectAll(".gls").attr("disabled","gls"===this.value?null:"disabled"),e.select("#graph-options").selectAll(".fmcs").attr("disabled","rdfmcs"===this.value?null:"disabled")}),e.select("#graph-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const r=h.value("#graph-measure"),n={measure:r,threshold:h.valueFloat("#graph-thld"),ignoreHs:h.checked("#graph-ignoreh"),diameter:"gls"===r?h.valueInt("#graph-diam"):null,maxTreeSize:"gls"===r?h.valueInt("#graph-tree"):null,molSizeCutoff:"gls"===r?h.valueInt("#graph-skip"):null,timeout:"rdfmcs"===r?h.valueInt("#graph-timeout"):null};t(n)})},graphConfigDialog:function(t,r,n){e.select("#graphconfig-thld").attr("value",t).attr("max",1).attr("min",r),e.select("#graphconfig-submit").on("click",()=>{const e=h.valueFloat("#graphconfig-thld");e<r||n(e)})},communityDialog:function(t){e.select("#community-name").attr("value","comm_"),e.select("#community-submit").on("click",()=>{const e={name:h.value("#community-name"),nulliso:h.checked("#community-nulliso")};t(e)})},importConfirmDialog:function(t){e.select("#importconfirm-overwrite").on("click",()=>t("overwrite")),e.select("#importconfirm-keepboth").on("click",()=>t("keepboth")),e.select("#importconfirm-cancel").on("click",()=>t("cancel"))}},F={interactiveInsert:function(e){return D.getTable(e.id).then(t=>t?e.revision==t.revision?Promise.reject(e.id):($("#importconfirm-dialog").modal("toggle"),new Promise(t=>{L.importConfirmDialog(r=>{"overwrite"===r&&t(e),"keepboth"===r&&(e.id=w.uuidv4(),t(e))})})):Promise.resolve(e)).then(e=>D.insertTable(e).then(()=>e.id),e=>e?Promise.resolve(e):Promise.reject())},fetchResults:function(e="update"){return D.getTable(k.URLQuery().id).then(e=>g.ongoing(e)?e:Promise.reject()).then(t=>{const r={id:t.id,command:e};return x.get("res",r).then(x.json).then(D.updateTable,x.error)},()=>Promise.resolve())},registerServiceWorker:m,loader:function(){const e=x.get("server").then(x.json).catch(()=>null),t=D.getAppSetting("serverInstance");return Promise.all([e,t]).then(e=>{const t=e[0],r=e[1];return t?(t.debugMode?console.info("Off-line mode is disabled for debugging"):m(),t.instance===r?(console.info("Resource schema is already up to date"),Promise.resolve(t)):x.get("schema").then(x.json).then(e=>(console.info(`New resource schema version: ${t.instance}`),Promise.all([D.setResources(e.resources),D.setAppSetting("templates",e.templates),D.setAppSetting("compoundIDPlaceholder",e.compoundIDPlaceholder),D.setAppSetting("defaultDataType",e.defaultDataType),D.setAppSetting("serverInstance",t.instance),D.setAppSetting("rdkit",t.rdkit)]).then(()=>Promise.resolve(t))),x.error)):Promise.resolve(null)})}};return{run:function(){return F.loader().then(()=>D.getResources()).then(t=>Promise.all([function(t){const r=k.URLQuery().compound;e.select("title").text(r);const n={type:"chemsearch",targets:t.filter(e=>"chemical"===e.domain).map(e=>e.id),key:"compound_id",values:[r]};return x.get("run",n).then(x.json).then(r=>{const n=r.records[0];e.select("#compoundid").html(n.compound_id),e.select("#compounddb").html(t.find(e=>e.id===n.__source).name),e.select("#structure").html(n.structure);const o=r.fields.filter(e=>!["structure","index","compound_id"].includes(e.key)).map(e=>({key:e.name,value:n[e.key]})),s={fields:g.defaultFieldProperties([{key:"key"},{key:"value"}])};return e.select("#properties").call(C.createTable,s).call(C.updateTableRecords,o,e=>e.key),n},x.error)}(t).then(r=>(function(t,r){const n={type:"exact",targets:t.filter(e=>"chemical"===e.domain).map(e=>e.id),queryMol:{format:"dbid",source:r.__source,value:r.compound_id},params:{ignoreHs:!0}};return x.get("run",n).then(x.json).then(n=>{const o=n.records.filter(e=>e.compound_id!==r.compound_id||e.__source!==r.__source).map(e=>({compound_id:`<a href="profile.html?compound=${e.compound_id}" target="_blank">${e.compound_id}</a>`,database:t.find(t=>t.id===e.__source).name})),s={fields:g.defaultFieldProperties([{key:"compound_id"},{key:"database"}])};e.select("#aliases").call(C.createTable,s).call(C.updateTableRecords,o,e=>e.compound_id)},x.error)})(t,r)),function(){const t=k.URLQuery().compound;document.getElementById("search").addEventListener("keypress",e=>{13===e.keyCode&&e.preventDefault()}),e.select("#search").on("keyup",function(){const t=e=>Object.values(e).some(e=>y.partialMatch(h.value(this),e));e.select("#results tbody").selectAll("tr").style("visibility",e=>t(e)?null:"hidden").style("position",e=>t(e)?null:"absolute")});const r={type:"profile",compound_id:t};return x.get("run",r).then(x.json).then(t=>{const r={fields:g.defaultFieldProperties([{key:"assay_id",name:"Assay ID",format:"text"},{key:"value_type",name:"Value type",format:"text"},{key:"value",name:"Value",format:"numeric"}])};e.select("#results").call(C.createTable,r).call(C.updateTableRecords,t.records,e=>e.index).call(C.addSort)},x.error)}()]))}}});
//# sourceMappingURL=kwprofile.js.map
