// https://github.com/mojaie/kiwiii Version 0.8.3. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("Dexie"),require("d3"),require("pako"),require("vega")):"function"==typeof define&&define.amd?define(["Dexie","d3","pako","vega"],t):e.kwdatagrid=t(e.Dexie,e.d3,e.pako,e.vega)}(this,function(e,t,o,a){"use strict";function s(e,t,o){return new Promise((a,s)=>{const n=new FileReader,l=t?e.slice(0,t):e;n.onload=(e=>a(e.target.result)),n.onerror=(e=>s(e)),o?n.readAsArrayBuffer(l):n.readAsText(l)})}function n(e,t){const a=t?o.inflate(e,{to:"string"}):e;return JSON.parse(a)}function l(e,t){try{const o=window.URL.createObjectURL(new Blob([e])),a=document.createElement("a");a.download=t,a.href=o,a.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}function r(e,o){const a=o.visibleFields,s=e.select(".dg-body").selectAll(".dg-row").data(o.recordsToShow(),o.keyFunc).style("height",`${o.rowHeight}px`);s.exit().remove();const n=s.enter().append("div").attr("class","dg-row").style("position","absolute");n.selectAll(".dg-cell").data(a.map(e=>e.width)).enter().append("div").classed("dg-cell",!0).classed("align-middle",!0).style("display","inline-block").style("width",e=>`${e}px`),n.merge(s).order().each(function(e,s){const n=(o.viewportTop+s)*o.rowHeight;t.select(this).style("transform",`translate(0px, ${n}px)`).classed("odd",(o.viewportTop+s)%2==0).selectAll(".dg-cell").html(function(o,n){t.select(this).attr("id",`c${s}-${n}`);const l=e[a[n].key];return void 0===l?"":"d3_format"===a[n].format?O.formatNum(l,a[n].d3_format):"plot"===a[n].format?"":"compound_id"===a[n].format?`<a href="profile.html?compound=${l}" target="_blank">${l}</a>`:"image"===a[n].format?`<img src="${l}" width="180" height="180"/>`:l}).each(function(t,o){if("plot"!==a[o].format)return;if(!e.hasOwnProperty(a[o].key))return;const n=e[a[o].key];j.showPlot(n,`#c${s}-${o}`)})})}function d(e,t){const o=e.select(".dg-viewport").node().getBoundingClientRect().top;t.viewportHeight=window.innerHeight-o-5,t.previousNumViewportRows=t.numViewportRows,t.numViewportRows=Math.ceil(t.viewportHeight/t.rowHeight)+1,e.call(E.resizeViewport,t)}function i(e,t){const o=parseFloat(e),a=parseFloat(t);return isNaN(o)||isNaN(a)?String(t).localeCompare(String(e)):a-o}function c(e,t){return String(t).localeCompare(String(e))}function p(e,t){e.classed("modal",!0).attr("tabindex",-1).attr("role","dialog").attr("aria-labelledby","").attr("aria-hidden",!0).attr("id",t),e.select(".modal-dialog").remove(),e.append("div").classed("modal-dialog",!0).attr("role","document").append("div").classed("modal-content",!0)}function u(e,t){const o=e.select("select").selectAll("option").data(t,e=>e.key);o.exit().remove(),o.enter().append("option").attr("value",e=>e.key).text(e=>e.name)}function m(e,t){e.select("select").property("value",t)}function f(e,t){const o=e.select("ul").selectAll("li").data(t,e=>e.key);o.exit().remove();const a=o.enter().append("li").attr("class","form-check").append("label").attr("class","form-check-label");a.append("input").attr("type","checkbox").attr("class","form-check-input").property("value",e=>e.key),a.append("span").text(e=>e.name)}function h(e,o){o&&e.selectAll("input").each(function(e){t.select(this).property("checked",o.includes(e.key))})}function y(e,t,o){const a=e.select("thead tr").selectAll("th").data(t);a.exit().remove(),a.enter().append("th").text(e=>e.name),o&&e.call(b,o,e=>e.key,function(e){return(t,o)=>{e.forEach(e=>{const a=o[e.key],s=t.append("td").classed("align-middle",!0);void 0!==a&&("d3_format"===e.format?s.text(O.formatNum(a,e.d3_format)):"plot"===e.format?s.text("[plot]"):"image"===e.format?s.text("[image]"):"control"===e.format?s.call(a):s.text(a))})}}(t))}function b(e,o,a,s){const n=e.select("tbody").selectAll("tr").data(o,a);n.exit().remove(),n.enter().append("tr").merge(n).each(function(e){t.select(this).selectAll("td").remove(),t.select(this).call(s,e)})}function g(e,t){e.append("td").classed("name",!0).text(t.name),e.append("td").classed("visible",!0).append("input").attr("type","checkbox").property("checked",t.visible);const o=["text","numeric","d3_format","raw","compound_id"],a=(o.includes(t.format)?o:[t.format]).map(e=>({key:e,name:e})),s=e.append("td").classed("format",!0),n=s.append("select");s.call(U.selectBoxItems,a),n.property("disabled",!o.includes(t.format)).property("value",t.format),e.append("td").classed("d3format",!0).append("input").attr("size",10).property("disabled","d3_format"!==t.format||null).property("value",t.d3_format||null),n.on("change",function(){e.select(".d3format").select("input").property("disabled","d3_format"!==this.value)})}function x(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}function v(e,t){e.select("input").property("value",t)}function w(e,t){e.select("textarea").property("value",t)}function k(e,t){e.select("input").property("checked",t)}function B(e,t){e.select("input").property("value",t)}function S(e){e.select(".format").on("change",function(){const o=U.selectBoxValue(t.select(this));e.select(".source").select("select").property("disabled","dbid"!==o),e.select(".textquery").property("hidden","dbid"!==o),e.select(".areaquery").property("hidden","molfile"!==o)}).dispatch("change"),e.select(".preview").on("click",function(){const o=L(e);return A.get("strprev",o).then(A.text).then(e=>t.select("#previmg").html(e),A.error)})}function L(e){const t=U.selectBoxValue(e.select(".format")),o=U.selectBoxValue(e.select(".source")),a=Z.textBoxValue(e.select(".textquery")),s=Z.textareaBoxLines(e.select(".areaquery"));return{format:t,source:"dbid"===t?o:null,value:"molfile"===t?s:a}}function T(e){const t=e.columns.map(e=>("numeric"===e.sort?e.format="numeric":"text"===e.sort?e.format="text":"none"===e.sort&&(e.format="raw"),e));return{id:e.id,name:e.name,dataType:pe[e.format],schemaVersion:.8,revision:0,status:ce[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function V(e){return{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:e.query,progress:e.progress,execTime:e.execTime,created:e.created,reference:{}}}function C(e,o){const a=new me(e);a.serverStatus=o,t.select("#datagrid").call(R.datagrid,a).call(H.setSort,a),window.onresize=(()=>t.select("#datagrid").call(R.resize,a));const s=t.select("#menubar");s.selectAll("div,span,a").remove();const n=s.append("div").call(G.dropdownMenuButton,null,"View control","primary").select(".dropdown-menu");n.append("a").call(X.menuLink),n.append("a").call(oe.menuLink),n.append("a").call(le.menuLink),n.append("a").call(ie.menuLink),n.append("a").classed("saveview",!0).call(G.dropdownMenuItem,null,"Save to local storage").on("click",function(){return a.data.storeID?q.updateItem(a.data.storeID,e=>{e.id=O.uuidv4(),e.name=a.data.name,e.fields=a.data.fields,e.records=a.data.records}).then(()=>console.info("Datagrid saved")):q.putItem(a.export()).then(e=>{window.location=`datagrid.html?id=${e}`})}),n.append("a").classed("exportjson",!0).call(G.dropdownMenuItem,null,"Export to JSON").on("click",()=>{const e=a.export();N.downloadJSON(e,e.name)}),n.append("a").classed("exportexcel",!0).call(G.dropdownMenuItem,null,"Export to Excel worksheet").on("click",()=>{const e=a.export(),t=new FormData;return t.append("contents",new Blob([JSON.stringify(e)])),A.post("xlsx",t).then(A.blob).then(t=>N.downloadDataFile(t,`${e.name}.xlsx`))}),s.append("a").call(G.menuButtonLink,null,"Control panel","outline-secondary").attr("href","control.html").attr("target","_blank");["running","ready"].includes(a.data.status)&&(s.append("a").classed("refresh",!0).call(G.menuButtonLink,null,"Refresh","outline-secondary").on("click",function(){return z.fetchProgress(a.data.storeID).then(()=>q.getItemByID(a.data.storeID)).then(e=>C(e,a.serverStatus))}),s.append("a").call(G.menuButtonLink,null,"Abort server job","warning").attr("data-toggle","modal").attr("data-target","#abort-dialog"),s.append("span").classed("progress",!0).append("progress").attr("max",100).attr("value",a.data.progress).text(`${a.data.progress}%`)),s.append("span").classed("title",!0).text(a.data.name),s.append("span").classed("status",!0).text(`(${a.data.status} - ${a.data.records.length} records found in ${a.data.execTime} sec.)`);const l=t.select("#dialogs");l.selectAll("div").remove(),l.append("div").classed("fieldconfd",!0).call(X.body),l.append("div").classed("fieldfiled",!0).call(oe.body),l.append("div").classed("netgend",!0).call(le.body,o.rdkit),l.append("div").classed("renamed",!0).call(ie.body,a.data.name),l.append("div").classed("abortd",!0).call(J.confirmDialog,"abort-dialog","Are you sure you want to abort this calculation job?"),D(a)}function D(e){t.select("#loading-icon").style("display","none"),t.select("title").text(e.data.name),t.select("#menubar").select(".title").text(e.data.name);const o=t.select("#dialogs");o.select(".fieldconfd").call(X.updateBody,e).on("submit",function(){e.setFields(X.value(t.select(this))),e.updateHeaderNotifier(),D(e)}),o.select(".fieldfiled").on("submit",function(){return oe.readFile(t.select(this)).then(t=>{e.joinFields(t),e.updateHeaderNotifier(),D(e)})}),o.select(".netgend").on("submit",function(){const o=new FormData,a=le.queryParams(t.select(this));return o.append("params",JSON.stringify(a)),o.append("contents",new Blob([JSON.stringify(e.export())])),A.post(`${a.measure}net`,o).then(A.json).then(t=>(t.reference.nodes=e.data.storeID,t.fields=O.defaultFieldProperties(t.fields),t)).then(q.putItem).then(e=>{t.select("#loading-icon").style("display","none"),window.open(`network.html?id=${e}`,"_blank")})}),o.select(".renamed").call(ie.updateBody,e).on("submit",function(){e.data.name=ie.value(t.select(this)),D(e)}),o.select(".abortd").on("submit",function(){z.fetchProgress(e.data.storeID,"abort").then(()=>q.getItemByID(e.data.storeID)).then(t=>C(t,e.serverStatus))})}function I(e){return A.json(e).then(e=>(e.fields=O.defaultFieldProperties(e.fields),e)).then(q.putItem).then(e=>{window.location=`datagrid.html?id=${e}`})}e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,o=o&&o.hasOwnProperty("default")?o.default:o,a=a&&a.hasOwnProperty("default")?a.default:a;class M extends Array{unique(e){return this.reduce((t,o)=>(void 0===t.find(t=>t[e]===o[e])&&t.push(o),t),new M)}extend(){return this.reduce((e,t)=>(Array.prototype.push.apply(e,t),e),new M)}extendAsync(){return Promise.all(this).then(e=>e.reduce((e,t)=>(Array.prototype.push.apply(e,t),e),new M))}toArray(){return Array.from(this)}toObject(){const e={};return this.forEach(t=>{e[t[0]]=t[1]}),e}}var O={defaultFieldProperties:function(e){return e.map(e=>(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),e))},sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id"].includes(e)?"text":"none"},formatNum:function(e,o){return void 0===e||null===e||Number.isNaN(e)?"":e==parseFloat(e)?t.format(o)(e):e},partialMatch:function(e,t){return void 0!==t&&null!==t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},URLQuery:function(){return M.from(window.location.search.substring(1).split("&")).map(e=>e.split("=")).toObject()},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const P={items:"storeID, dataType, created"};let F=new e("Store");F.version(1).stores(P);var q={getAllItems:function(){return F.items.orderBy("created").reverse().toArray()},getItemsByDataType:function(e){return F.items.where("dataType").equals(e).reverse().sortBy("created").catch(t=>{console.error(`IDBError: Unexpected dataType: ${e}`,t)})},getItemByID:function(e){return F.items.where("storeID").equals(e).first().catch(t=>{console.error(`IDBError: Unexpected table ID: ${e}`,t)})},deleteItem:function(e){return F.items.where("storeID").equals(e).delete()},putItem:function(e){return e.storeID||(e.storeID=O.uuidv4()),F.items.put(e)},updateItem:function(e,t){return F.items.where("storeID").equals(e).modify(t).catch(e=>{console.error("IDBError: Update failed",e)})},reset:function(){return F.delete().then(()=>{(F=new e("Store")).version(1).stores(P)})}};const _="";var A={get:function(e,t={}){const o=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${_}${e}${o}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},json:function(e){return e.json()},text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${_}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null}},z={fetchProgress:function(e,t="update"){return q.getItemByID(e).then(o=>{if(!o)return Promise.reject(`Store: ${e} is not available`);if(!["ready","running"].includes(o.status))return;const a={id:o.reference.workflow,command:t};return A.get("progress",a).then(A.json).then(t=>"failure"===t.status?q.updateItem(e,e=>{e.status="failure"}):q.updateItem(e,e=>{e.status=t.status,e.progress=t.progress,e.execTime=t.execTime,e.fields=O.defaultFieldProperties(t.fields),e.records=t.records}))})}},N={readFile:s,parseJSON:n,loadJSON:function(e){const t=e.name.endsWith("c")||e.name.endsWith(".gz");return s(e,!1,t).then(e=>n(e,t))},fetchJSON:function(e){const t=decodeURIComponent(e),o=t.endsWith("c")||t.endsWith(".gz");return fetch(t).then(e=>o?e.arrayBuffer():e.json()).then(e=>n(e,o))},downloadDataFile:l,downloadJSON:function(e,t,a=!0){const s=JSON.stringify(e),n=a?o.gzip(s):s,r=a?"c":"r";l(n,`${t}${e.hasOwnProperty("edges")?`.gf${r}`:`.nd${r}`}`)}},j={showPlot:function(e,t){new a.View(a.parse(e)).initialize(t).run()},plotThumbnail:function(e){return new a.View(a.parse(e)).toImageURL("png")}},E={updateHeader:function(e,t){e.style("width",`${t.contentWidth}px`);const o=e.select(".dg-header").selectAll(".dg-hcell").data(t.visibleFields,e=>e.key);o.exit().remove(),o.enter().append("div").classed("dg-hcell",!0).style("display","inline-block").merge(o).style("width",e=>`${e.width}px`).text(e=>e.name)},updateViewport:function(e,o){e.select(".dg-body").style("height",`${o.bodyHeight}px`).style("position","relative"),e.select(".dg-viewport").style("overflow-y","auto").on("scroll",function(){const a=t.select(this).node().scrollTop,s=Math.floor(a/o.rowHeight);s!==o.previousViewportTop&&(o.setScrollPosition(s),e.call(r,o))}).dispatch("scroll")},updateRows:r,resizeViewport:function(e,t){e.select(".dg-viewport").style("height",`${t.viewportHeight}px`)}},R={resize:d,datagrid:function(e,t){e.selectAll("div").size()&&e.selectAll("div").remove(),e.append("div").classed("dg-header",!0),e.append("div").classed("dg-viewport",!0).append("div").classed("dg-body",!0),e.call(d,t),t.updateHeaderNotifier=(()=>{e.call(E.updateHeader,t),e.call(E.updateViewport,t)}),e.call(E.updateHeader,t),e.call(E.updateViewport,t)}},H={setSort:function(e,o){e.select(".dg-header").selectAll(".dg-hcell").filter(e=>"none"!==O.sortType(e.format)).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",a=>{const s="v"===t.select(`#sort-${a.key}`).text();t.select(`#sort-${a.key}`).text(s?"^":"v");const n="numeric"===O.sortType(a.format),l=s?n?i:c:n?function(e,t){return i(t,e)}:function(e,t){return c(t,e)};o.records=o.records.sort((e,t)=>l(e[a.key],t[a.key])),e.call(E.updateRows,o)})}},G={buttonBox:function(e,t,o,a){e.classed("form-group",!0).classed("mb-1",!0).append("button").classed("btn",!0).classed(`btn-${a}`,!0).classed("btn-sm",!0).attr("id",t).text(o)},menuButton:function(e,t,o,a){e.classed("btn",!0).classed(`btn-${a}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("id",t).text(o)},menuButtonLink:function(e,t,o,a){e.classed("btn",!0).classed(`btn-${a}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("role","button").attr("href","#").attr("id",t).text(o)},menuModalLink:function(e,t,o,a,s){e.classed("btn",!0).classed(`btn-${a}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("role","button").attr("data-toggle","modal").attr("data-target",`#${s}`).attr("id",t).text(o)},dropdownMenuButton:function(e,t,o,a){e.classed("btn-group",!0).classed("mr-1",!0).attr("id",t),e.append("button").classed("btn",!0).classed(`btn-${a}`,!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown").text(o),e.append("div").classed("dropdown-menu",!0)},dropdownMenuItem:function(e,t,o){e.classed("dropdown-item",!0).attr("id",t).text(o)},dropdownMenuModal:function(e,t,o,a){e.classed("dropdown-item",!0).attr("id",t).attr("data-toggle","modal").attr("data-target",`#${a}`).text(o)},dropdownMenuFile:function(e,o,a,s){e.classed("dropdown-item",!0).attr("id",o).text(a).on("click",function(){t.select(this).select("input").node().click()}).append("form").style("display","none").append("input").attr("type","file").attr("accept",s)},dropdownMenuFileValue:function(e){return e.select("input").node().files[0]}},J={confirmDialog:function(e,o,a){const s=e.call(p,o).select(".modal-content");s.append("div").classed("modal-body",!0).append("div").classed("message",!0).text(a);const n=s.append("div").classed("modal-footer",!0);n.append("button").classed("btn",!0).classed("btn-outline-secondary",!0).classed("cancel",!0).attr("type","button").attr("data-dismiss","modal").text("Cancel"),n.append("button").classed("btn",!0).classed("btn-warning",!0).classed("ok",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${o}-submit`).text("OK").on("click",()=>{t.select("#loading-icon").style("display","inline"),e.dispatch("submit")})},submitDialog:function(e,o,a){const s=e.call(p,o).select(".modal-content"),n=s.append("div").classed("modal-header",!0);n.append("h4").classed("modal-title",!0).text(a),n.append("button").attr("type","button").attr("data-dismiss","modal").attr("aria-label","Close").classed("close",!0).append("span").attr("aria-hidden",!0).html("&times;"),s.append("div").classed("modal-body",!0),s.append("div").classed("modal-footer",!0).append("button").classed("btn",!0).classed("btn-primary",!0).classed("submit",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${o}-submit`).text("Submit").on("click",()=>{t.select("#loading-icon").style("display","inline"),e.dispatch("submit")})}},U={selectBox:function(e,t,o,a,s){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("select").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t),a&&(e.call(u,a),e.call(m,s))},selectBoxItems:u,updateSelectBox:m,selectBoxValue:function(e){return e.select("select").property("value")},checklistBox:function(e,t,o,a,s){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(o),e.append("ul").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t),a&&(e.call(f,a),e.call(h,s))},checklistBoxItems:f,updateChecklistBox:h,checklistBoxValue:function(e){return e.selectAll("input:checked").data().map(e=>e.key)}},W={render:function(e,t,o,a,s){e.classed("table",!0).classed("table-striped",!0).classed("table-hover",!0).attr("id",t),o&&e.append("caption").text(o),e.append("thead").append("tr"),e.append("tbody"),a&&e.call(y,a,s)},updateHeader:y,updateContents:b};const Q="fieldconf-dialog",K="Field Setting";var X={menuLink:function(e){e.call(G.dropdownMenuModal,"fieldconf",K,Q)},updateRowFunc:g,body:function(e){const t=O.defaultFieldProperties([{key:"name",format:"text"},{key:"visible",format:"control"},{key:"format",format:"control"},{key:"d3_format",format:"control"}]);e.call(J.submitDialog,Q,K).select(".modal-body").append("table").classed("field",!0).call(W.render,null,null,t)},updateBody:function(e,t){e.select(".field").call(W.updateContents,t.fields,e=>e.key,g)},value:function(e){const o=[];return e.select("tbody").selectAll("tr").each(function(e){const a=function(e){const t={};return t.visible=e.select(".visible").select("input").property("checked"),t.format=e.select(".format").select("select").property("value"),"d3_format"===t.format&&(t.d3_format=e.select(".d3format").select("input").property("value")),t}(t.select(this));a.key=e.key,a.name=e.name,o.push(a)}),o}},Y={singleToMulti:x,mappingToTable:function(e){const t=e.hasOwnProperty("field")?x(e):e,o={key:t.key,format:"text"};return{fields:O.defaultFieldProperties([o].concat(t.fields)),records:Object.entries(t.mapping).map(e=>{const o={};return o[t.key]=e[0],t.fields.forEach((t,a)=>{o[t.key]=e[1][a]}),o})}},tableToMapping:function(e,t,o=["index"]){const a={created:(new Date).toString(),fields:O.defaultFieldProperties(e.fields.filter(e=>e.key!==t).filter(e=>!o.includes(e.key))),key:t,mapping:{}};return e.records.forEach(e=>{a.mapping[e[t]]=a.fields.map(t=>e[t.key])}),a},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),o=t.shift().split(","),a=o.shift(),s=new Date,n=[],l=[];o.forEach((e,t)=>{""!==e&&(n.push(t),l.push({key:e,format:"text"}))});const r={created:s.toString(),fields:O.defaultFieldProperties(l),key:a,mapping:{}};return t.forEach(e=>{const t=e.split(","),o=t.shift();r.mapping[o]=Array(n.length),n.forEach(e=>{r.mapping[o][e]=t[e]})}),r},apply:function(e,t){const o=t.hasOwnProperty("field")?x(t):t;e.records.filter(e=>o.mapping.hasOwnProperty(e[o.key])).forEach(e=>{o.fields.forEach((t,a)=>{e[t.key]=o.mapping[e[o.key]][a]})}),e.fields=M.from(e.fields).concat(O.defaultFieldProperties(o.fields)).unique("key").toArray()}},Z={textBox:function(e,t,o,a,s){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","text").attr("size",a),e.call(v,s)},updateTextBox:v,textBoxValue:function(e){return e.select("input").property("value")},readonlyBox:function(e,t,o,a){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("input").classed("form-control-plaintext",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","text").property("readonly",!0),e.call(v,a)},textareaBox:function(e,t,o,a,s,n){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("textarea").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("rows",a).attr("placeholder",s).attr("id",t),e.call(w,n)},updateTextareaBox:w,textareaBoxValue:function(e){const t=e.select("textarea").property("value");if(t)return t;const o=e.select("textarea").attr("placeholder");return o||""},textareaBoxLines:function(e){const t=e.select("textarea").property("value");if(t)return t.split("\n").filter(e=>e.length>0);const o=e.select("textarea").attr("placeholder");return o?o.split("\n").filter(e=>e.length>0):[]},checkBox:function(e,t,o,a){const s=e.classed("form-group",!0).classed("form-row",!0).classed("form-check",!0).append("label").classed("form-check-label",!0).classed("col-form-label-sm",!0);s.append("input").classed("form-check-input",!0).attr("type","checkbox").attr("id",t),s.append("span").text(o),e.call(k,a)},updateCheckBox:k,checkBoxValue:function(e){return e.select("input").property("checked")},numberBox:function(e,t,o,a,s,n,l){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","number").attr("min",a).attr("max",s).attr("step",n),e.call(B,l)},updateNumberBox:B,numberBoxValue:function(e){return e.select("input").property("value")},fileInputBox:function(e,t,o,a){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(o),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",a).attr("id",t)},fileInputBoxValue:function(e){return e.select("input").property("files")[0]}};const ee="fieldfile-dialog",te="Import fields from file";var oe={menuLink:function(e){e.call(G.dropdownMenuModal,"fieldfile",te,ee)},body:function(e){const t=e.call(J.submitDialog,ee,te),o=t.select(".modal-body").append("div").classed("file",!0).call(Z.fileInputBox,"fieldfile-file","File",".json,.csv"),a=t.select(".modal-body").append("div").classed("preview",!0).call(W.render);o.on("change",()=>{const e=Z.fileInputBoxValue(o),t="csv"===e.name.split(".").pop();N.readFile(e).then(e=>{const o=t?Y.csvToMapping(e):JSON.parse(e),s=Y.mappingToTable(o);a.call(W.updateHeader,s.fields,s.records.slice(0,5))})})},readFile:function(e){const t=Z.fileInputBoxValue(e.select(".file")),o="csv"===t.name.split(".").pop();return N.readFile(t).then(e=>{let t=o?Y.csvToMapping(e):JSON.parse(e);t.hasOwnProperty("field")&&(t=Y.singleToMulti(t));const a=[];if(t.fields.forEach((e,o)=>{"plot"===e.format&&(t.fields[o].format="image",a.push(o))}),a.length>0){const e=[];return Object.entries(t.mapping).forEach(o=>{a.forEach(a=>{const s=j.plotThumbnail(o[1][a]).then(e=>{t.mapping[o[0]][a]=e});e.push(s)})}),Promise.all(e).then(()=>t)}return t})}},ae={queryMolGroup:function(e,t,o){e.classed("mb-3",!0),e.append("div").classed("format",!0).classed("mb-1",!0).call(U.selectBox,`${t}-format`,"Format",[{key:"molfile",name:"MDL Molfile"},{key:"dbid",name:"Compound ID"}],"molfile");const a=o.map(e=>({key:e.id,name:e.name}));e.append("div").classed("source",!0).classed("mb-1",!0).call(U.selectBox,`${t}-source`,"Source",a,null),e.append("div").classed("textquery",!0).classed("mb-1",!0).call(Z.textBox,`${t}-textquery`,"Query",null,""),e.append("div").classed("areaquery",!0).classed("mb-1",!0).call(Z.textareaBox,`${t}-areaquery`,"Query",6,null,""),$(function(){$('[data-toggle="popover"]').popover({html:!0,trigger:"focus"})}),e.append("div").classed("form-row",!0).classed("justify-content-end",!0).append("button").classed("preview",!0).attr("data-toggle","popover").attr("data-html","true").attr("data-content",'<div id="previmg"></div>').call(G.menuButton,`${t}-preview`,"Structure preview","primary"),e.call(S)},updateQueryMolGroup:S,queryMolGroupValue:L,simOptionGroup:function(e,t){e.classed("mb-3",!0).append("p").append("button").classed("btn",!0).classed("btn-sm",!0).classed("btn-outline-primary",!0).classed("dropdown-toggle",!0).attr("data-toggle","collapse").attr("data-target",`#${t}-collapse`).attr("aria-expanded","false").attr("aria-controls",`${t}-collapse`).text("Optional parameters");const o=e.append("div").classed("collapse",!0).attr("id",`${t}-collapse`).append("div").classed("card",!0).classed("card-body",!0);o.append("div").classed("ignoreh",!0).classed("mb-1",!0).call(Z.checkBox,`${t}-ignoreh`,"Ignore explicit hydrogens",!0),o.append("div").classed("timeout",!0).classed("mb-1",!0).call(Z.numberBox,`${t}-timeout`,"Timeout (RDKit FMCS)",1,999,1,2),o.append("div").classed("diam",!0).classed("mb-1",!0).call(Z.numberBox,`${t}-diam`,"Diameter (MCS-DR/GLS)",4,999,1,8),o.append("div").classed("tree",!0).classed("mb-1",!0).call(Z.numberBox,`${t}-tree`,"Max tree size (MCS-DR/GLS)",20,999,1,40),o.append("div").classed("skip",!0).classed("mb-1",!0).call(Z.numberBox,`${t}-skip`,"Mol size cutoff (MCS-DR/GLS)",20,999,1,500),o.selectAll("label.col-form-label").classed("col-4",!1).classed("col-6",!0),o.selectAll("input.form-control").classed("col-8",!1).classed("col-6",!0)},simOptionGroupValue:function(e){const t=e.select(".timeout"),o=e.select(".diam"),a=e.select(".tree"),s=e.select(".skip"),n={ignoreHs:Z.checkBoxValue(e.select(".ignoreh"))};return t.select("input").property("disabled")||(n.timeout=Z.numberBoxValue(t)),o.select("input").property("disabled")||(n.diameter=Z.numberBoxValue(o)),a.select("input").property("disabled")||(n.maxTreeSize=Z.numberBoxValue(a)),s.select("input").property("disabled")||(n.molSizeCutoff=Z.numberBoxValue(s)),n}};const se="networkgen-dialog",ne="Generate similarity network";var le={menuLink:function(e){e.call(G.dropdownMenuModal,"fieldconf",ne,se)},body:function(e,o){const a=e.call(J.submitDialog,se,ne),s=[{key:"gls",name:"Graph-based local similarity(GLS)"}];o&&(s.push({key:"rdmorgan",name:"RDKit Morgan similarity"}),s.push({key:"rdfmcs",name:"RDKit FMCS"})),a.select(".modal-body").append("div").classed("measure",!0).call(U.selectBox,"networkgen-measure","Measure",s,"gls"),a.select(".modal-body").append("div").classed("thld",!0).call(Z.numberBox,"networkgen-thld","Threshold",.5,1,.01,.5),a.select(".modal-body").append("div").classed("option",!0).call(ae.simOptionGroup,"networkgen"),a.select(".measure").on("change",function(){const e=U.selectBoxValue(t.select(this));a.selectAll(".diam, .tree, .skip").select("input").property("disabled","gls"!==e),a.select(".timeout").select("input").property("disabled","rdfmcs"!==e)}).dispatch("change")},queryParams:function(e){const t=e.select(".measure"),o=e.select(".thld"),a=ae.simOptionGroupValue(e.select(".option"));return t.select("select").property("disabled")||(a.measure=U.selectBoxValue(t)),o.select("input").property("disabled")||(a.threshold=Z.numberBoxValue(o)),a}};const re="rename-dialog",de="Rename view";var ie={menuLink:function(e){e.call(G.dropdownMenuModal,"rename",de,re)},body:function(e,t){e.call(J.submitDialog,re,de).select(".modal-body").append("div").classed("rename",!0).call(Z.textBox,"rename","New name",40,t)},updateBody:function(e,t){e.select(".rename").call(Z.updateTextBox,t.data.name)},value:function(e){return Z.textBoxValue(e.select(".rename"))}};const ce={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},pe={datatable:"nodes",connection:"edges"};var ue={convertTable:function(e){let t=e;return t.hasOwnProperty("schemaVersion")||t.hasOwnProperty("$schema")||(t=T(t)),"0.8"==t.schemaVersion&&(t=V(t=function(e){return e.records.forEach((e,t)=>{e.index=t,e.structure=e._structure,delete e._index,delete e._structure}),e.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")}),e}(t))),t.hasOwnProperty("$schema")||(delete t.schemaVersion,delete t.revision,t.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),t},convertNetwork:function(e){let o=e;return o.edges.hasOwnProperty("schemaVersion")||o.edges.hasOwnProperty("$schema")||(o.nodes=T(o.nodes),o.edges=function(e,t){const o={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(o.nodeColor.id=e.snapshot.nodeColor.id,o.nodeColor.scale=e.snapshot.nodeColor.scale,o.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):o.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(o.nodeSize.id=e.snapshot.nodeSize.id,o.nodeSize.scale=e.snapshot.nodeSize.scale,o.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):o.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(o.nodeLabel.id=e.snapshot.nodeLabel.id,o.nodeLabel.size=e.snapshot.nodeLabel.size,o.nodeLabel.text=e.snapshot.nodeLabel.text,o.nodeLabel.visible=e.snapshot.nodeLabel.visible,o.nodeLabel.scale=e.snapshot.nodeLabel.scale,o.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):o.nodeLabel={id:"label",size:12,text:"index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?o.nodeContent=e.snapshot.nodeContent:o.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?o.edge=e.snapshot.edge:o.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:pe[e.format],schemaVersion:.8,revision:0,reference:{nodes:e.nodeTableId},status:ce[e.status],fields:O.defaultFieldProperties([{key:"source"},{key:"target"},{key:"weight"}]),records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:o}}(o.edges,o.nodes.fields)),"0.8"!=o.edges.schemaVersion&&.1!==o.edges.schemaVersion||((o=function(e){if(e.edges.hasOwnProperty("reference")||(e.edges.reference={nodes:e.edges.nodesID}),e.nodes.fields.find(e=>"_index"===e.key)){const t={};e.nodes.records.forEach((e,o)=>{e.index=o,e.structure=e._structure,t[e._index]=e.index,delete e._index,delete e._structure}),e.edges.records.forEach(e=>{e.source=t[e.source],e.target=t[e.target]}),e.nodes.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")})}return e}(o)).nodes=V(o.nodes),o.edges=function(e){const o={networkThreshold:e.networkThreshold};return o.nodeContentVisible=e.snapshot.nodeContent.structure.visible,o.nodeColor=e.snapshot.nodeColor.scale||{},o.nodeColor.field&&(o.nodeColor.field=e.snapshot.nodeColor.field.key,"_index"===o.nodeColor.field&&(o.nodeColor.field="index")),"ordinal"===o.nodeColor.scale&&(o.nodeColor.range=t.schemeCategory20),o.nodeSize=e.snapshot.nodeSize.scale||{},e.snapshot.nodeSize.field&&(o.nodeSize.field=e.snapshot.nodeSize.field.key,"_index"===o.nodeSize.field&&(o.nodeSize.field="index")),o.nodeLabel={},e.snapshot.nodeLabel.text&&(o.nodeLabel.text=e.snapshot.nodeLabel.text.key,"_index"===o.nodeLabel.text&&(o.nodeLabel.text="index")),o.nodeLabel.size=e.snapshot.nodeLabel.size,o.nodeLabel.visible=e.snapshot.nodeLabel.visible,o.nodeLabelColor=e.snapshot.nodeLabel.scale||{},e.snapshot.nodeLabel.field&&(o.nodeLabelColor.field=e.snapshot.nodeLabel.field.key,"_index"===o.nodeLabelColor.field&&(o.nodeLabelColor.field="index")),"ordinal"===o.nodeLabelColor.scale&&(o.nodeLabelColor.range=t.schemeCategory20),o.edgeVisible=e.snapshot.edge.visible,o.edgeWidth=e.snapshot.edge.scale||{},o.edgeLabel={},o.edgeLabel.size=e.snapshot.edge.label.size,o.edgeLabel.visible=e.snapshot.edge.label.visible,o.networkThreshold=e.networkThreshold||e.query.threshold,o.coords=e.snapshot.nodePositions,{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:{params:e.query},progress:e.progress,execTime:e.execTime,created:e.created,snapshot:o,reference:e.reference}}(o.edges)),o.edges.hasOwnProperty("$schema")||(delete o.nodes.schemaVersion,delete o.edges.schemaVersion,delete o.nodes.revision,delete o.edges.revision,o.nodes.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json",o.edges.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),o}};class me{constructor(e){this.data=ue.convertTable(e),this.fields=null,this.defaultColumnWidth={numeric:120,text:200,none:200},this.defaultColumnHeight={numeric:40,text:40,none:200},this.scrollBarSpace=20,this.keyFunc=(e=>e.index),this.visibleFields=null,this.rowHeight=null,this.contentWidth=null,this.bodyHeight=null,this.vieportTop=null,this.previousVieportTop=null,this.vieportBottom=null,this.numViewportRows=null,this.previousNumViewportRows=null,this.updateHeaderNotifier=null,this.setFields(this.data.fields)}setScrollPosition(e){this.previousVieportTop=this.viewportTop,this.viewportTop=e,this.viewportBottom=Math.min(this.viewportTop+this.numViewportRows,this.data.records.length)}recordsToShow(){return this.data.records.slice(this.viewportTop,this.viewportBottom)}setFields(e){this.fields=e.map(e=>(e.width=this.defaultColumnWidth[O.sortType(e.format)],e.height=this.defaultColumnHeight[O.sortType(e.format)],e)),this.visibleFields=this.fields.filter(e=>e.visible),this.rowHeight=this.visibleFields.reduce((e,t)=>e.height>t.height?e:t).height,this.contentWidth=this.visibleFields.reduce((e,t)=>({width:e.width+t.width})).width+this.scrollBarSpace,this.bodyHeight=this.data.records.length*this.rowHeight}joinFields(e){Y.apply(this.data,e),this.setFields(this.data.fields)}export(){return this.data.id=O.uuidv4(),this.data}}var fe={app:C,updateApp:D};const he="search-dialog",ye="Search by compound ID";var be={menuLink:function(e){e.call(G.dropdownMenuModal,"search",ye,he)},body:function(e,t){e.call(J.submitDialog,he,ye).select(".modal-body").append("div").classed("ids",!0).call(Z.textareaBox,"search-query","Query",20,t,"")},query:function(e,t){return{workflow:"search",targets:t,key:"compound_id",values:Z.textareaBoxLines(e.select(".ids"))}}};const ge="struct-dialog",xe="Search by structure";var ve={menuLink:function(e){e.call(G.dropdownMenuModal,"struct",xe,ge)},body:function(e,o,a){const s=e.call(J.submitDialog,ge,xe);s.select(".modal-body").append("div").classed("qmol",!0).call(ae.queryMolGroup,"struct",o,null);const n=[{key:"exact",name:"Exact match"},{key:"substr",name:"Substructure"},{key:"supstr",name:"Superstructure"},{key:"gls",name:"MCS-DR/GLS"}];a&&(n.push({key:"rdmorgan",name:"RDKit Morgan similarity"}),n.push({key:"rdfmcs",name:"RDKit FMCS"})),s.select(".modal-body").append("div").classed("method",!0).call(U.selectBox,"struct-method","Method",n,"exact"),s.select(".modal-body").append("div").classed("measure",!0).call(U.selectBox,"struct-measure","Measure",[{key:"sim",name:"Similarity"},{key:"edge",name:"Edge count"}],"sim"),s.select(".modal-body").append("div").classed("thld",!0).call(Z.numberBox,"struct-thld","Threshold",.5,1,.01,.5),s.select(".modal-body").append("div").classed("option",!0).call(ae.simOptionGroup,"struct");const l=o.map(e=>({key:e.id,name:e.name}));s.select(".modal-body").append("div").classed("target",!0).call(U.checklistBox,"struct-target","Target databases",l,null),s.select(".method").on("change",function(){const e=U.selectBoxValue(t.select(this)),o=["gls","rdfmcs"].includes(e);s.select(".measure").select("select").property("value",o?void 0:"sim").property("disabled",!o),s.selectAll(".thld").select("input").property("disabled",["exact","substr","supstr"].includes(e)),s.selectAll(".diam, .tree, .skip").select("input").property("disabled","gls"!==e),s.select(".timeout").select("input").property("disabled","rdfmcs"!==e)}).dispatch("change")},query:function(e){const t=ae.simOptionGroupValue(e.select(".option")),o=e.select(".measure"),a=e.select(".thld");return o.select("select").property("disabled")||(t.measure=U.selectBoxValue(o)),a.select("input").property("disabled")||(t.threshold=Z.numberBoxValue(a)),{workflow:U.selectBoxValue(e.select(".method")),targets:U.checklistBoxValue(e.select(".target")),queryMol:ae.queryMolGroupValue(e.select(".qmol")),params:t}}};const we="filter-dialog",ke="Search by properties";var Be={menuLink:function(e){e.call(G.dropdownMenuModal,"prop",ke,we)},body:function(e,t){const o=e.call(J.submitDialog,we,ke),a=M.from(t.map(e=>e.fields)).extend().unique("key").toArray().filter(e=>e.hasOwnProperty("d3_format")||["compound_id","numeric","text"].includes(e.format));o.select(".modal-body").append("div").classed("key",!0).call(U.selectBox,"filter-field","Field",a,null),o.select(".modal-body").append("div").classed("operator",!0).call(U.selectBox,"filter-op","Operator",[{key:"eq",name:"="},{key:"gt",name:">"},{key:"lt",name:"<"},{key:"ge",name:">="},{key:"le",name:">="},{key:"lk",name:"LIKE"}],"eq"),o.select(".modal-body").append("div").classed("value",!0).call(Z.textBox,"filter-value","Value",null,"");const s=t.map(e=>({key:e.id,name:e.name}));o.select(".modal-body").append("div").classed("target",!0).call(U.checklistBox,"struct-target","Target databases",s,null)},query:function(e){return{workflow:"filter",targets:U.checklistBoxValue(e.select(".target")),key:U.selectBoxValue(e.select(".key")),value:Z.textBoxValue(e.select(".value")),operator:U.selectBoxValue(e.select(".operator"))}}};const Se="sdf-dialog",Le="Import SDFile";var Te={menuLink:function(e){e.call(G.dropdownMenuModal,"sdf",Le,Se)},body:function(e){const o=e.call(J.submitDialog,Se,Le);o.select(".modal-body").append("div").classed("file",!0).call(Z.fileInputBox,"sdf-file","File",".mol,.sdf"),o.select(".modal-body").append("div").classed("field",!0).call(U.checklistBox,"sdf-fields","Fields",[],null),o.select(".modal-body").append("div").classed("implh",!0).call(Z.checkBox,"sdf-implh","Make hydrogens implicit",!0),o.select(".modal-body").append("div").classed("recalc",!0).call(Z.checkBox,"sdf-recalc","Recalculate 2D coords",!1),o.select(".file").on("change",function(){const e=Z.fileInputBoxValue(t.select(this));return N.readFile(e,104857600,!1).then(e=>{const t=function(e){const t=/>.*?<(\S+)>/g,o=new Set;let a;for(;null!==(a=t.exec(e));)o.add(a[1]);return Array.from(o)}(e).map(e=>({key:e,name:e}));o.select(".field").call(U.checklistBoxItems,t)})})},queryFormData:function(e){const t={fields:U.checklistBoxValue(e.select(".field")),implh:Z.checkBoxValue(e.select(".implh")),recalc:Z.checkBoxValue(e.select(".recalc"))},o=new FormData;return o.append("contents",Z.fileInputBoxValue(e.select(".file"))),o.append("params",JSON.stringify(t)),o}},Ve={app:function(e,o){const a=t.select("#menubar");a.selectAll("div,span,a").remove();const s=a.append("div").call(G.dropdownMenuButton,null,"+ New datagrid","primary").select(".dropdown-menu");s.append("a").classed("searchd",!0).call(be.menuLink),s.append("a").classed("structd",!0).call(ve.menuLink),s.append("a").classed("filterd",!0).call(Be.menuLink),s.append("a").classed("sdfd",!0).call(Te.menuLink),s.append("a").classed("import",!0).call(G.dropdownMenuFile,"import","Import view",".ndc,.ndr,.json,.gz").on("change",function(){const a=G.dropdownMenuFileValue(t.select(this));N.loadJSON(a).then(t=>fe.app(t,e,o))}),a.append("a").call(G.menuButtonLink,null,"Control panel","outline-secondary").attr("href","control.html").attr("target","_blank");const n=t.select("#dialogs");if(n.selectAll("div").remove(),!o)return void s.selectAll(".searchd, .structd, .filterd, .sdfd").property("disabled",!0);const l=o.resources.filter(e=>"chemical"===e.domain);n.append("div").call(be.body,o.compoundIDPlaceholder).on("submit",function(){const e=l.map(e=>e.id),o=be.query(t.select(this),e);return A.get(o.workflow,o).then(I)}),n.append("div").call(ve.body,l,e.rdkit).on("submit",function(){const e=ve.query(t.select(this));return A.get(e.workflow,e).then(I)}),n.append("div").call(Be.body,l).on("submit",function(){const e=Be.query(t.select(this));return A.get(e.workflow,e).then(I)}),n.append("div").call(Te.body,l).on("submit",function(){const e=Te.queryFormData(t.select(this));return A.post("sdfin",e).then(I)})}};return{run:function(){document.location.protocol,"onLine"in navigator&&navigator.onLine;const e={};return A.get("server").then(A.json).then(t=>{e.server=t}).then(()=>A.get("schema")).then(A.json).then(t=>{e.schema=t}).catch(()=>{e.server={},e.schema={}}).then(()=>{console.info("Off-line mode is disabled for debugging");const t=O.URLQuery().id||null,o=O.URLQuery().location||null,a=O.URLQuery().err||null;a&&console.error(decodeURI(a)),t?z.fetchProgress(t,"update").then(()=>q.getItemByID(t)).then(t=>fe.app(t,e.server)).catch(e=>{window.location=`datagrid.html?err=${e}`}):o?N.fetchJSON(o).then(t=>fe.app(t,e.server)):Ve.app(e.server,e.schema)})},view:R,sort:H}});
//# sourceMappingURL=kwdatagrid.js.map
