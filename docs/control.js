// https://github.com/mojaie/kiwiii-client Version 0.7.0. Copyright 2017 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("d3"),require("Dexie")):"function"==typeof define&&define.amd?define(["d3","Dexie"],t):t(e.d3,e.Dexie)}(this,function(e,t){"use strict";function r(e){return["In progress","Queued","Aborting"].includes(e.status)}function s(e){return j[e]}function n(e,t){j[e]=t}function o(){return E.get("chemical")}function a(){return Array.from(E.values())}function i(e){return P.putResources(e)}function l(){return P.getAllItems()}function c(e){return P.getItemsByFormat(e)}function u(e,t,r){return P.updateItem(e,e=>{e[t]=r})}function d(e){return void 0===e?Promise.resolve():"Failure"===e.status?u(e.id,"status","Failure"):P.updateItem(e.id,t=>{const r={responseDate:e.responseDate,records:e.records,columns:e.columns,recordCount:e.recordCount,searchDoneCount:e.searchDoneCount,execTime:e.execTime,progress:e.progress,status:e.status};e.hasOwnProperty("lastUpdated")&&(r.lastUpdated=e.lastUpdated),Object.assign(t,r)})}function m(e){return P.deleteItem(e)}function h(){return P.reset()}function p(){"serviceWorker"in navigator&&!C?navigator.serviceWorker.register("sw.js").then(e=>{console.info("ServiceWorker registration successful with scope: ",e.scope)}).catch(e=>{console.info("ServiceWorker registration failed: ",e)}):C?console.info("Off-line mode is disabled for debugging"):console.info("Off-line mode is not supported");const e=L.templates().then(e=>{n("templates",e.templates)}),t=L.status().then(e=>{n("server",e)}),r=a().map(e=>e.getResources()).extendAsync().then(e=>i(e.map((e,t)=>(e.idx=t,e))));return Promise.all([e,t,r])}function f(){return"file:"===document.location.protocol?(console.info("Off-line mode (local file)"),n("onLine",!1),Promise.resolve()):"onLine"in navigator&&!navigator.onLine?(console.info("Off-line mode (no internet connection)"),n("onLine",!1),Promise.resolve()):fetch(`${L.baseURL}favicon.ico`).then(()=>(n("onLine",!0),p())).catch(()=>(console.info("Off-line mode (server not responding)"),n("onLine",!1),Promise.resolve()))}function y(t,r){const s={scientific:".3e",si:".3s",rounded:".3r"};return"raw"===r?t:void 0===t||null===t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(s[r])(t):t}function g(e,t){e.select("thead").size()||e.append("thead").append("tr"),e.select("tbody").size()||e.append("tbody");const r=t.columns.filter(e=>!e.hasOwnProperty("visible")||!1!==e.visible),s=e.select("thead tr").selectAll("th").data(r,e=>e.key);s.exit().remove(),s.enter().append("th").merge(s).text(e=>e.hasOwnProperty("name")?e.name:e.key)}function w(e,t,r){const s=e.select("thead tr").selectAll("th").data(),n=e.select("tbody").selectAll("tr").data(t,r);n.exit().remove();const o=n.enter().append("tr");o.selectAll("td").data(e=>s.map(t=>e[t.key])).enter().append("td"),o.merge(n).selectAll("td").classed("align-middle",!0).html((e,t)=>void 0===e?"":"plot"===s[t].valueType?"[plot]":"image"===s[t].valueType?"[image]":s[t].hasOwnProperty("digit")&&"raw"!==s[t].digit?y(e,s[t].digit):e)}function I(t,s){s.records.forEach(e=>{e.action=`<a role="button" class="btn btn-secondary btn-sm" href="${s.app}?id=${e.id}" target="_blank">Open</a>`,r(s)?e.action+=`<button type="button" class="btn btn-warning btn-sm" disabled>Running</button>`:e.action+=`<button type="button" class="btn btn-warning btn-sm delete-item" data-toggle="modal" data-target="#confirm-dialog" data-tblid="${e.id}" data-tblname="${e.name}">Delete</button>`}),e.select(t).call(g,s).call(w,s.records,e=>e.id),e.selectAll("tr button.delete-item").on("click",function(){const t=e.select(this).attr("data-tblid"),r=e.select(this).attr("data-tblname");e.select("#confirm-message").text(`Are you sure you want to delete ${r} ?`),e.select("#confirm-submit").on("click",()=>m(t).then(R))})}function b(e){const t={app:"datatable.html",columns:[{key:"name"},{key:"responseDate"},{key:"status"},{key:"records"},{key:"action"}]};t.records=e.map(e=>(e.hasOwnProperty("status")||(e.status="Completed"),{id:e.id,name:e.name,responseDate:e.responseDate,status:e.status,records:e.records.length})),I("#local-tables",t)}function v(e){const t={app:"graph.html",columns:[{key:"name"},{key:"responseDate"},{key:"nodeTableId"},{key:"status"},{key:"edges"},{key:"action"}]};t.records=e.map(e=>(e.hasOwnProperty("status")||(e.status="Completed"),{id:e.id,name:e.name,responseDate:e.responseDate,nodeTableId:e.nodeTableId,status:e.status,edges:e.records.length})),I("#local-graphs",t)}function q(t){e.select("#server-calc").call(g,t.calc).call(w,t.calc.records,e=>e._index);const r={columns:[{key:"key"},{key:"value"}],records:[]};Object.entries(t).filter(e=>"calc"!==e[0]).forEach(e=>r.records.push({key:e[0],value:e[1]})),e.select("#server-status").call(g,r).call(w,r.records,e=>e._index)}function R(){return s("onLine")&&q(s("server")),Promise.all([c("datatable").then(b),c("connection").then(v)])}const C=!1;e=e&&e.hasOwnProperty("default")?e.default:e;const D={app:"key",items:"id, format, responseDate",resources:"idx, id"};let x=new(t=t&&t.hasOwnProperty("default")?t.default:t)("Store");x.version(1).stores(D);var P={getAppSetting:function(e){return x.app.where("key").equals(e).first().then(e=>{if(void 0!==e)return e.value})},putAppSetting:function(e,t){return x.app.put({key:e,value:t})},getResources:function(){return x.resources.orderBy("idx").toArray()},putResources:function(e){return x.resources.bulkPut(e)},getAllItems:function(){return x.items.orderBy("responseDate").reverse().toArray()},getItemsByFormat:function(e){return x.items.where("format").equals(e).reverse().sortBy("responseDate")},getItemById:function(e){return x.items.where("id").equals(e).first()},updateItem:function(e,t){return x.items.where("id").equals(e).modify(t)},deleteItem:function(e){return x.items.where("id").equals(e).delete()},putItem:function(e){return x.items.put(e)},reset:function(){return x.delete().then(()=>{(x=new t("Store")).version(1).stores(D)})}};class k{constructor(){this.baseURL="",this.available=!1}xhrRequest(e,t=null,r={}){return new Promise((s,n)=>{const o=new XMLHttpRequest;o.open("method"in r?r.method:"POST",e),o.responseType="responseType"in r?r.responseType:"json",o.withCredentials="withCredentials"in r&&r.withCredentials,o.onload=(()=>{200!==o.status?n(o):s(o.response)}),o.send(t)})}now(){return(new Date).toString()}getResources(){}formatResult(e,t){return t.lastUpdated=this.now(),t}getRecords(){}getRecordsByCompound(){}getMapping(){}getGraphEdges(){}}class O extends k{constructor(){super(),this.baseURL="./",this.domain="activity",this.entities=[]}serializedRequest(e,t={}){const r=new FormData;return r.set("query",JSON.stringify(t)),fetch(`${this.baseURL}${e}`,{method:"post",body:r,credentials:"include"})}request(e,t={}){const r=new FormData;return new Map(Object.entries(t)).forEach((e,t)=>{Array.isArray(e)?e.forEach(e=>r.append(t,e)):r.set(t,e)}),fetch(`${this.baseURL}${e}`,{method:"post",body:r,credentials:"include"})}getResources(){return this.request("schema",{domain:this.domain}).then(e=>e.json()).then(e=>(e.resources.forEach(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.hasOwnProperty("method")||(e.method="sql"),e.visible=!0}),this.entities.push(e.entity)}),this.available=!0,e.resources))}getRecords(e){return this.serializedRequest("sql",e).then(e=>e.json()).then(e=>(e.domain=this.domain,e))}getRecordsByCompound(e){const t={method:"sql",targets:this.entities,key:"ID",values:[e],operator:"eq"};return this.getRecords(t)}getMapping(e,t){const r={method:"sql",targets:[t.entity],key:"ID",values:e,operator:"fm"};return this.serializedRequest("sql",r).then(e=>e.json()).then(e=>{const s={};return e.records.filter(e=>e.hasOwnProperty(t.dataColumn)).forEach(e=>{s[e.ID]=e[t.dataColumn]}),{key:r.key,column:t,mapping:s,lastUpdated:this.now()}})}status(){return this.request("server").then(e=>e.json())}templates(){return this.request("templates").then(e=>e.json())}strprev(e){return this.serializedRequest("strprev",e).then(e=>e.text())}exportExcel(e){return this.request("xlsx",e).then(e=>e.blob())}exportSDFile(e){return this.request("exportsdf",e).then(e=>e.text())}reportPreview(e){return this.request("reportprev",e).then(e=>e.json())}report(e){return this.request("report",e).then(e=>e.blob())}}class A extends O{constructor(){super(),this.domain="chemical",this.hiddenColumns=["_mw","_mw_wo_sw","_formula","_logp","_nonH"]}formatResult(e,t){return 0===e.length?(t.columns.forEach(e=>{e.visible=!this.hiddenColumns.includes(e.key)}),t):(Array.prototype.push.apply(t.columns,e),t.hasOwnProperty("extraColumns")&&(Array.prototype.push.apply(t.columns,t.extraColumns),delete t.extraColumns),t.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.key===t.query.key?e.visible=!0:e.visible=!this.hiddenColumns.includes(e.key)}),t.lastUpdated=this.now(),t)}getResources(){return this.request("schema",{domain:this.domain}).then(e=>e.json()).then(e=>(e.resources.forEach(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.hasOwnProperty("method")||(e.method="chemsql"),e.visible=!0})}),this.available=!0,e.resources))}getRecords(e){let t;return t=e.hasOwnProperty("command")?"rows":e.hasOwnProperty("nodeTableId")?"graph":["chemsql","sql"].includes(e.method)?"sql":"compute",this.serializedRequest(t,e).then(e=>e.json()).then(e=>(e.domain=this.domain,e))}importSDF(e){return this.request("sdf",e).then(e=>e.json()).then(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.visible=!this.hiddenColumns.includes(e.key)});const t=new Date;return e.lastUpdated=t.toString(),e})}}class $ extends k{constructor(){super(),this.resourceFile="screener_fitting.yaml",this.domain=null,this.baseURL=null}getResources(){const e=new FormData;return e.set("filename",this.resourceFile),fetch("source",{method:"post",body:e,credentials:"include"}).then(e=>e.json()).then(e=>{if(!e.hasOwnProperty("enabled")||!1!==e.enabled)return this.available=!0,this.domain=e.domain,this.baseURL=e.url,e.resources.map(t=>(t.domain=e.domain,t.entity=`${t.qcsRefId}:${t.layerIndex}`,delete t.qcsRefId,delete t.layerIndex,t.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.visible=!0}),t))})}request(e){return fetch(`${this.baseURL}${e}`,{method:"GET",credentials:"include"}).then(e=>e.json())}requestRecords(e){return this.request(e).then(e=>({records:e.compounds.map(e=>({ID:e.compoundId,qcsRefId:e.qcsRefId,layerIndex:e.layerIndex,drcPlot:e.fitting.drcPlot,AC50:e.fitting.linearAC50,hill:Math.round(100*e.fitting.hillCoefficient)/100}))}))}getRecords(e){const t=`/compounds?qcsRefIds=${e.qcsRefIds.join("%2C")}&layerIndices=${e.layerIndex-1}&fields=compoundId%2Cfitting.drcPlot%2Cfitting.linearAC50%2Cfitting.hillCoefficient`;return this.requestRecords(t)}getRecordsByCompound(e){const t=`/compounds?q=compoundId%3A${e}&fields=compoundId%2CqcsRefId%2ClayerIndex%2Cfitting.drcPlot%2Cfitting.linearAC50%2Cfitting.hillCoefficient`;return this.requestRecords(t)}getMapping(e,t){const r=t.entity.split(":"),s={qcsRefId:r[0],layerIndex:parseInt(r[1])};return this.getRecords(s).then(r=>{const s={};return r.records.filter(t=>e.includes(t.ID)).forEach(e=>{s[e.ID]=e[t.dataColumn]}),{key:"ID",column:t,mapping:s,lastUpdated:this.now()}})}getDrcPlot(e,t,r=-20,s=120){const n=`/${t}?width=180&height=180&title=compoundId&activityRangeMin=${r}&activityRangeMax=${s}`;return this.request(n)}getQcsInfo(e){const t=`/qcSessions?q=${e.map(e=>`qcsRefId:${e}`).join(" OR ")}`;return this.request(t).then(e=>e.qcSessions)}}class _ extends ${constructor(){super(),this.resourceFile="screener_rawvalue.yaml"}getResources(){const e=new FormData;return e.set("filename",this.resourceFile),fetch("source",{method:"post",body:e,credentials:"include"}).then(e=>e.json()).then(e=>{if(!e.hasOwnProperty("enabled")||!1!==e.enabled)return this.available=!0,this.domain=e.domain,this.baseURL=e.url,e.resources.map(t=>(t.domain=e.domain,t.entity=`${t.qcsRefId}:${t.layerIndex}`,delete t.qcsRefId,delete t.layerIndex,t.columns.forEach(e=>{e.key="rawValue",e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.visible=!0}),t))})}requestRecords(e,t){return this.request(e).then(e=>({records:e.plates.filter(e=>e.wells.hasOwnProperty("compoundIds")).map(e=>e.wells.compoundIds.map((t,r)=>({ID:t,qcsRefId:e.qcsRefId,layerIndex:e.layerIndex,rawValue:e.wells.rawValues[r]})).filter(t)).extend()}))}getRecords(e){const t=`/plates?qcsRefIds=${e.qcsRefIds.join("%2C")}&layerIndices=${e.layerIndex-1}&limit=200&fields=wells.rawValues%2Cwells.compoundIds`;return this.requestRecords(t,e=>null!==e.ID)}getRecordsByCompound(e){const t=`/plates?q=wells.compoundIds%3A${e}&fields=wells.rawValues%2Cwells.compoundIds`;return this.requestRecords(t,t=>t.ID===e)}}class S extends ${constructor(){super(),this.resourceFile="screener_fitting_stub.yaml"}fittingStub(e){if("string"!=typeof e.qcsRefId)throw`${e.qcsRefId} is not a string`;if("number"!=typeof e.layerIndex)throw`${e.layerIndex} is not a number`;return[{ID:"DB00189",drcPlot:"dummy1",AC50:21e-7,hill:1.1,source:"target1_validation"},{ID:"DB00193",drcPlot:"dummy2",AC50:42e-7,hill:null,source:"target1_validation"},{ID:"DB00203",drcPlot:"dummy3",AC50:1e-5,hill:.9,source:"target1_validation"},{ID:"DB00865",drcPlot:"dummy4",AC50:8.8e-8,hill:2.1,source:"target1_validation"},{ID:"DB01143",drcPlot:"dummy5",AC50:"n.d.",hill:null,source:"target1_validation"},{ID:"DB01240",drcPlot:"dummy6",AC50:null,hill:null,source:"target1_validation"}]}getRecords(e){return Promise.resolve({records:this.fittingStub(e)})}getRecordsByCompound(e){const t=this.fittingStub({qcsRefId:"QCS-YYYY",layerIndex:1}).filter(t=>t.ID===e);return Promise.resolve({records:t})}qcsInfoStub(e){if(!Array.isArray(e))throw`${e} is not a string`;const t=[{layerIndex:0,name:"Activity%"},{layerIndex:1,name:"Background%"},{layerIndex:2,name:"Correction"}];return[{qcsRefId:"QCS-XXX0",name:"hoge",layers:t},{qcsRefId:"QCS-XXX1",name:"fuga",layers:t},{qcsRefId:"QCS-XXX2",name:"piyo",layers:t}]}getQcsInfo(e){return Promise.resolve(this.qcsInfoStub(e))}}class B extends _{constructor(){super(),this.resourceFile="screener_rawvalue_stub.yaml"}rawValueStub(e){if("string"!=typeof e.qcsRefId)throw`${e.qcsRefId} is not a string`;if("number"!=typeof e.layerIndex)throw`${e.layerIndex} is not a number`;return[{ID:"DB00189",rawValue:12.7,source:"target1_screen"},{ID:"DB00193",rawValue:43.6,source:"target1_screen"},{ID:"DB00203",rawValue:102.6,source:"target1_screen"},{ID:"DB00865",rawValue:-.6,source:"target1_screen"},{ID:"DB01143",rawValue:50,source:"target1_screen"},{ID:"DB01240",rawValue:null,source:"target1_screen"}]}getRecords(e){return Promise.resolve({records:this.rawValueStub(e)})}getRecordsByCompound(e){const t=this.rawValueStub({qcsRefId:"QCS-XXXX",layerIndex:1}).filter(t=>t.ID===e);return Promise.resolve({records:t})}}const j={onLine:!0,server:{},templates:{},urlQuery:{}};window.location.search.substring(1).split("&").map(e=>e.split("=")).forEach(e=>{j.urlQuery[e[0]]=e[1]});const E=new Map(Object.entries({chemical:new A,activity:new O,screenerrawvalue:new _,screenerfitting:new $,screenerrawvaluestub:new B,screenerfittingstub:new S})),L=o(),F=o();e.select("#refresh-all").on("click",()=>l().then(e=>{const t=e.map(e=>{if(!r(e))return Promise.resolve();const t={id:e.id,command:"fetch"};return F.getRecords(t).then(d)});return Promise.all(t)}).then(R)),e.select("#reset-local").on("click",()=>{e.select("#confirm-message").text("Are you sure you want to delete all local tables and reset the datastore ?"),e.select("#confirm-submit").on("click",()=>h().then(R))}),f().then(R)});
//# sourceMappingURL=control.js.map
