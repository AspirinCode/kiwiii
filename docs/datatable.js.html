<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: datatable.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: datatable.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
/** @module datatable */

import d3 from 'd3';

import {default as d3form} from './helper/d3Form.js';
import {default as hfile} from './helper/file.js';
import {default as win} from './helper/window.js';
import {default as fetcher} from './fetcher.js';
import {default as common} from './common.js';
import {default as store} from './store/StoreConnection.js';
import {default as dialog} from './component/Dialog.js';
import {default as header} from './component/Header.js';
import {default as grid} from './component/DataGrid.js';


function render() {
  return store.getTable(win.URLQuery().id)
    .then(data => {
      dialog.columnDialog(data.fields, render);
      dialog.fieldFileDialog(mapping => {
        return store.joinFields(win.URLQuery().id, mapping).then(render);
      });
      header.renderStatus(
        data, () => common.fetchResults().then(render),
        () => common.fetchResults('abort').then(render));
      d3.select('#rename')
        .on('click', () => {
          d3.select('#prompt-title').text('Rename table');
          d3.select('#prompt-label').text('New name');
          d3.select('#prompt-input').attr('value', data.name);
          d3.select('#prompt-submit')
            .on('click', () => {
              const name = d3form.value('#prompt-input');
              return store.updateTableAttribute(data.id, 'name', name)
                .then(() => store.getTable(win.URLQuery().id)) // updateTableAttribute returns 1
                .then(t => header.renderStatus(
                  t, () => common.fetchResults().then(render),
                  () => common.fetchResults('abort').then(render))
                );
            });
        });
      // Following operations use data.records
      d3.select('#datatable')
        .call(grid.createDataGrid, data)
        .call(grid.dataGridRecords, data.records, d => d.index)
        .call(grid.addSort, data.records, d => d.index);
      store.getResources().then(rsrc => {
        const actres = rsrc.filter(e => e.domain === 'activity');
        const compoundIDs = data.records.map(e => e.id);
        dialog.fieldFetchDialog(compoundIDs, data.fields, actres, mapping => {
          return store.joinFields(win.URLQuery().id, mapping).then(render);
        });
      });
      dialog.graphDialog(params => {
        const formData = new FormData();
        formData.append('contents', new Blob([JSON.stringify(data)]));
        formData.append('params', JSON.stringify(params));
        return fetcher.post('simnet', formData)
          .then(fetcher.json)
          .then(json => {
            json.networkThreshold = json.query.threshold;
            return common.interactiveInsert(json)
              .then(id => {
                d3.select('#loading-circle').style('display', 'none');
                window.open(`graph.html?id=${id}`, '_blank');
              });
          }, fetcher.error);
      });
      d3.select('#export')
        .on('click', () => hfile.downloadJSON(data, data.name, true));
      d3.select('#excel')
        .on('click', () => {
          const formData = new FormData();
          formData.append('contents', new Blob([JSON.stringify(data)]));
          return fetcher.post('xlsx', formData)
            .then(fetcher.blob)
            .then(blob => hfile.downloadDataFile(blob, `${data.name}.xlsx`),
                  fetcher.error);
        });
      d3.select('#sdfile')
        .on('click', () => {
          const formData = new FormData();
          formData.append('contents', new Blob([JSON.stringify(data)]));
          return fetcher.post('sdfout', formData)
            .then(fetcher.text)
            .then(text => hfile.downloadDataFile(text, `${data.name}.sdf`),
                  fetcher.error);
        });
    });
}


function loadNewTable(data) {
  return common.interactiveInsert(data)
    .then(id => {
      // window.open(`datatable.html?id=${id}`);
      window.location = `datatable.html?id=${id}`;
    });
}


function run() {
  d3.select('#import-json')
    .on('click', () => document.getElementById('select-file').click());
  d3.select('#select-file')
    .on('change', () => {
      const file = document.getElementById('select-file').files[0];
      hfile.loadJSON(file).then(loadNewTable);
    });
  // location parameter enables direct access to datatable JSON via HTTP
  if (win.URLQuery().hasOwnProperty('location')) {
    const url = win.URLQuery().location;
    return hfile.fetchJSON(url)
      .then(common.interactiveInsert)
      .then(id => {
        window.location = `datatable.html?id=${id}`;
      });
  }
  return common.loader().then(serverStatus => {
    if (!serverStatus) {
      // Disable offline comannds
      d3.selectAll('.online-command')
        .style('color', '#cccccc')
        .classed('disabled', true)
        .on('click', () => d3.event.stopPropagation());
    }
    // Loading tables
    if (win.URLQuery().hasOwnProperty('id')) {
      header.initializeWithData();
      return common.fetchResults().then(render);
    } else {
      header.initialize();
      dialog.sdfDialog(loadNewTable);
      if (!serverStatus) return Promise.resolve();
      return store.getResources().then(rsrc => {
        const chemres = rsrc.filter(e => e.domain === 'chemical');
        dialog.pickDialog(chemres, loadNewTable);
        dialog.structDialog(chemres, loadNewTable);
        dialog.propDialog(chemres, loadNewTable);
      });
    }
  });
}


export default {
  grid, render, run
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-component_Component.html">component/Component</a></li><li><a href="module-component_DataGrid.html">component/DataGrid</a></li><li><a href="module-component_Dialog.html">component/Dialog</a></li><li><a href="module-component_Header.html">component/Header</a></li><li><a href="module-datatable.html">datatable</a></li><li><a href="module-graph.html">graph</a></li><li><a href="module-graph_GraphForce.html">graph/GraphForce</a></li><li><a href="module-helper_d3Form.html">helper/d3Form</a></li><li><a href="module-helper_d3Scale.html">helper/d3Scale</a></li><li><a href="module-helper_dataStructure.html">helper/dataStructure</a></li><li><a href="module-helper_definition.html">helper/definition</a></li><li><a href="module-helper_file.html">helper/file</a></li><li><a href="module-helper_formatValue.html">helper/formatValue</a></li><li><a href="module-helper_image.html">helper/image</a></li><li><a href="module-helper_parser.html">helper/parser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Dec 06 2017 19:01:33 GMT+0900 (JST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
