// https://github.com/mojaie/kiwiii-client Version 0.7.0. Copyright 2017 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("d3"),require("pako"),require("Dexie"),require("vega")):"function"==typeof define&&define.amd?define(["d3","pako","Dexie","vega"],t):t(e.d3,e.pako,e.Dexie,e.vega)}(this,function(e,t,n,s){"use strict";function r(t){return e.select(t).node().value}function l(t){return parseInt(e.select(t).node().value)}function o(t){return parseFloat(e.select(t).node().value)}function i(t){return e.select(t).node().checked}function c(t){return e.select(t).node().files[0]}function a(t){return e.selectAll(t).selectAll("input:checked").nodes().map(e=>e.value)}function d(t){return e.selectAll(t).selectAll("select").nodes().map(e=>e.value)}function u(t){return e.select(t).node().value.split("\n").filter(e=>e.length>0)}function p(t){const n=e.select(t).property("selectedIndex");return e.select(t).selectAll("option").data().find((e,t)=>t===n)}function h(t){return e.selectAll(t).selectAll("input:checked").data()}function m(e){return["In progress","Queued","Aborting"].includes(e.status)}function f(e){return["In progress","Queued"].includes(e.status)}function y(e,t,n){return[e,t,n].map(e=>e.capitalize()).join("")}function g(e,t,n){return new Promise((s,r)=>{const l=new FileReader,o=t?e.slice(0,t):e;l.onload=(e=>s(e.target.result)),l.onerror=(e=>r(e)),n?l.readAsArrayBuffer(o):l.readAsText(o)})}function w(e,n){const s=n?t.inflate(e,{to:"string"}):e;return JSON.parse(s)}function b(e){const t=e.name.endsWith(".gz");return g(e,!1,t).then(e=>w(e,t))}function v(e){const t=decodeURIComponent(e),n=t.endsWith(".gz");return fetch(t).then(e=>n?e.arrayBuffer():e.json()).then(e=>w(e,n))}function k(e,t){try{const n=window.URL.createObjectURL(new Blob([e])),s=document.createElement("a");s.download=t,s.href=n,s.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}function x(e,n,s=!0){const r=JSON.stringify(e);k(s?t.gzip(r):r,`${n}.json${s?".gz":""}`)}function I(e){return Ue[e]}function q(e,t){Ue[e]=t}function R(){return Te.get("chemical")}function P(e){return Te.get(e)}function A(){return Array.from(Te.values())}function C(){const e=[];return Te.forEach((t,n)=>{"chemical"!==n&&e.push(n)}),e}function O(e){return De.getResources().then(t=>t.filter(t=>e.includes(t.domain)))}function D(e){return De.putResources(e)}function $(e){return O(e).then(e=>e.map(e=>e.columns.map(t=>(t.domain=e.domain,t.key=y(e.domain,e.id,t.key),t.entity=e.entity,t.hasOwnProperty("tags")||(t.tags=e.tags),t))).extend())}function S(e,t){return De.getResources([e]).then(e=>t.map(t=>e.find(e=>e.id===t).columns).extend())}function E(){const e=I("urlQuery");return e.hasOwnProperty("id")?De.getItemById(e.id):Promise.resolve()}function j(){return E().then(e=>e.records)}function B(e){return De.updateItem(I("urlQuery").id,t=>{t.columns.forEach((t,n)=>{t.visible=e.visibles.includes(t.key),t.sort=e.sorts[n],t.digit=e.digits[n]})})}function _(e,t=Ue.urlQuery.id){const n=e.hasOwnProperty("column")?e.column:e.columns;return De.updateItem(t,t=>{t.records.filter(t=>e.mapping.hasOwnProperty(t[e.key])).forEach(t=>{e.hasOwnProperty("column")?t[e.column.key]=e.mapping[t[e.key]]:e.columns.forEach((n,s)=>{t[n.key]=e.mapping[t[e.key]][s]})}),t.columns=t.columns.concat(n).unique("key"),t.lastUpdated=e.lastUpdated})}function L(e,t,n){return De.updateItem(e,e=>{e[t]=n})}function U(e){return De.putItem(e)}function T(e){return void 0===e?Promise.resolve():"Failure"===e.status?L(e.id,"status","Failure"):De.updateItem(e.id,t=>{const n={responseDate:e.responseDate,records:e.records,columns:e.columns,recordCount:e.recordCount,searchDoneCount:e.searchDoneCount,execTime:e.execTime,progress:e.progress,status:e.status};e.hasOwnProperty("lastUpdated")&&(n.lastUpdated=e.lastUpdated),Object.assign(t,n)})}function F(){"serviceWorker"in navigator&&!Ae?navigator.serviceWorker.register("sw.js").then(e=>{console.info("ServiceWorker registration successful with scope: ",e.scope)}).catch(e=>{console.info("ServiceWorker registration failed: ",e)}):Ae?console.info("Off-line mode is disabled for debugging"):console.info("Off-line mode is not supported");const e=Fe.templates().then(e=>{q("templates",e.templates)}),t=Fe.status().then(e=>{q("server",e)}),n=A().map(e=>e.getResources()).extendAsync().then(e=>D(e.map((e,t)=>(e.idx=t,e))));return Promise.all([e,t,n])}function z(){return"file:"===document.location.protocol?(console.info("Off-line mode (local file)"),q("onLine",!1),Promise.resolve()):"onLine"in navigator&&!navigator.onLine?(console.info("Off-line mode (no internet connection)"),q("onLine",!1),Promise.resolve()):fetch(`${Fe.baseURL}favicon.ico`).then(()=>(q("onLine",!0),F())).catch(()=>(console.info("Off-line mode (server not responding)"),q("onLine",!1),Promise.resolve()))}function Q(e){const t={key:e.key,name:e.key,sort:"text",visible:!0},n=e.hasOwnProperty("column")?e.column:e.columns;return{columns:[t].concat(n),records:Object.entries(e.mapping).map(t=>{const n={};if(n[e.key]=t[0],e.hasOwnProperty("column"))n[e.column.key]=t[1];else{const s=e.columns.map(e=>e.key);t[1].forEach((e,t)=>{n[s[t]]=e})}return n})}}function M(e){const t=e.split(/\n|\r|\r\n/),n=t.shift().split(","),s=n.shift(),r={created:(new Date).toString(),columns:[],key:s,mapping:{}},l=[];return n.forEach((e,t)=>{""!==e&&(l.push(t),r.columns.push({key:e,name:e,sort:"text",visible:!0}))}),t.forEach(e=>{const t=e.split(","),n=t.shift();r.mapping[n]=Array(l.length),l.forEach(e=>{r.mapping[n][e]=t[e]})}),r}function N(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,columns:[e.column],key:e.key,mapping:t}}function V(t,n){const s={scientific:".3e",si:".3s",rounded:".3r"};return"raw"===n?t:void 0===t||null===t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(s[n])(t):t}function X(e,t){return void 0!==t&&null!==t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())}function J(e,t){const n=parseFloat(e),s=parseFloat(t);return isNaN(n)||isNaN(s)?String(t).localeCompare(String(e)):s-n}function W(e,t){return J(t,e)}function H(e,t){return String(t).localeCompare(String(e))}function Y(e,t){return H(t,e)}function G(e){const t=/>.*?<(\S+)>/g,n=new Set;let s;for(;null!==(s=t.exec(e));)n.add(s[1]);return Array.from(n)}function K(e,t){new s.View(s.parse(e)).initialize(t).run()}function Z(e){return new s.View(s.parse(e)).toImageURL("png")}function ee(e,t,n,s){const r=e.selectAll("option").data(t,n);r.exit().remove(),r.enter().append("option").merge(r).attr("value",n).text(s)}function te(e,t,n,s,r){const l=e.selectAll("li").data(t,s);l.exit().remove();const o=l.enter().append("li").attr("class","form-check").append("label");o.append("input"),o.append("span");const i=o.merge(l.select("label")).attr("class","form-check-label");i.select("input").attr("type","checkbox").attr("class","form-check-input").attr("name",n).attr("value",s),i.select("span").text(r)}function ne(e,t){e.select("thead").size()||e.append("thead").append("tr"),e.select("tbody").size()||e.append("tbody");const n=t.columns.filter(e=>!e.hasOwnProperty("visible")||!1!==e.visible),s=e.select("thead tr").selectAll("th").data(n,e=>e.key);s.exit().remove(),s.enter().append("th").merge(s).text(e=>e.hasOwnProperty("name")?e.name:e.key)}function se(e,t,n){const s=e.select("thead tr").selectAll("th").data(),r=e.select("tbody").selectAll("tr").data(t,n);r.exit().remove();const l=r.enter().append("tr");l.selectAll("td").data(e=>s.map(t=>e[t.key])).enter().append("td"),l.merge(r).selectAll("td").classed("align-middle",!0).html((e,t)=>void 0===e?"":"plot"===s[t].valueType?"[plot]":"image"===s[t].valueType?"[image]":s[t].hasOwnProperty("digit")&&"raw"!==s[t].digit?V(e,s[t].digit):e)}function re(e){return S(e.domain,e.dataSource).then(t=>P(e.domain).formatResult(t,e))}function le(t,n){e.select("#pick-target").call(ee,t,e=>e.entity,e=>e.name).on("change",function(){const t=p(this);e.select("#pick-queryarea").text(t.placeholders.ID)}),e.select("#pick-queryarea").text(t[0].placeholders.ID),e.select("#pick-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t={method:"chemsql",targets:[r("#pick-target")],key:"ID",values:u("#pick-queryarea"),operator:"fm"};return ze.getRecords(t).then(re).then(n)})}function oe(t,n){e.select("#prop-targets").call(te,t,"targets",e=>e.entity,e=>e.name).on("change",function(){const t=h("#prop-targets").map(e=>e.columns).extend().unique("key");e.select("#prop-key").call(ee,t,e=>e.key,e=>e.name)}),e.select("#prop-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t=p("#prop-key"),s={method:t.method,targets:a("#prop-targets"),key:t.key,values:u("#prop-queryarea"),operator:r("#prop-operator")};return ze.getRecords(s).then(re).then(n)})}function ie(t,n){e.select("#struct-qsrc").call(ee,t,e=>e.entity,e=>e.name),e.select("#struct-targets").call(te,t,"targets",e=>e.entity,e=>e.name),e.select("#struct-method").selectAll("option.rd").attr("disabled",!0===I("rdk")?null:"disabled"),e.select("#struct-method").on("change",function(){const t=e.select(this.selectedOptions[0]);e.select("#struct-thldtype").attr("disabled",t.classed("thld")?null:"disabled").property("value",t.classed("edge")?"edge":"sim"),e.select("#struct-thld").attr("disabled",t.classed("thld")?null:"disabled"),e.select("#struct-thldtype option.sim").attr("disabled",t.classed("sim")?null:"disabled"),e.select("#struct-thldtype option.edge").attr("disabled",t.classed("edge")?null:"disabled"),e.select("#struct-options").selectAll(".gls").attr("disabled",t.classed("gls")?null:"disabled"),e.select("#struct-options").selectAll(".fmcs").attr("disabled","rdfmcs"===this.value?null:"disabled"),e.select("#struct-thld").attr("value","edge"===r("#struct-thldtype")?15:.7).attr("min","edge"===r("#struct-thldtype")?5:0).attr("max","edge"===r("#struct-thldtype")?999:1).attr("step","edge"===r("#struct-thldtype")?1:.01)}),e.select("#struct-thldtype").on("change",function(){e.select("#struct-thld").attr("value","edge"===this.value?15:.7).attr("min","edge"===this.value?5:0).attr("max","edge"===this.value?999:1).attr("step","edge"===this.value?1:.01)}),e.select("#struct-format").on("change",function(){e.select("#struct-qsrc").attr("disabled","dbid"===this.value?null:"disabled")}),e.select("#struct-preview").on("click",()=>{const t=r("#struct-format"),n={format:t,querySource:"dbid"===t?r("#struct-qsrc"):null,value:"molfile"===t?r("#struct-queryarea"):u("#struct-queryarea")[0]};return ze.strprev(n).then(t=>e.select("#struct-image").html(t))}),e.select("#struct-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t=e.select(e.select("#struct-method").node().selectedOptions[0]),s=r("#struct-format"),c={method:r("#struct-method"),targets:a("#struct-targets"),format:s,querySource:"dbid"===s?r("#struct-qsrc"):null,value:"molfile"===s?r("#struct-queryarea"):u("#struct-queryarea")[0],thresholdType:r("#struct-thldtype"),threshold:o("#struct-thld"),ignoreHs:i("#struct-ignoreh"),diameter:t.classed("gls")?l("#struct-diam"):null,maxTreeSize:t.classed("gls")?l("#struct-tree"):null,molSizeCutoff:t.classed("gls")?l("#struct-skip"):null,timeout:t.classed("rd")?l("#struct-timeout"):null};return ze.getRecords(c).then(re).then(n)})}function ce(t){e.select("#sdf-file").on("change",()=>{const t=new FileReader,n=document.getElementById("sdf-file").files[0];t.onload=(t=>{e.select("#sdf-cols").call(te,G(t.target.result),"columns",e=>e,e=>e)}),t.readAsText(n.slice(0,104857600))}),e.select("#sdf-selectall").on("change",()=>{e.select("#sdf-cols").selectAll("input").property("checked",i("#sdf-selectall"))}),e.select("#sdf-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const n={contents:c("#sdf-file"),query:JSON.stringify({columns:a("#sdf-cols"),implh:i("#sdf-implh"),recalc:i("#sdf-recalc")})};return ze.importSDF(n).then(t)})}function ae(t,n){const s={columns:[{key:"name",sort:"text",visible:!0},{key:"visible",sort:"text",visible:!0},{key:"sort",sort:"text",visible:!0},{key:"digit",sort:"numeric",visible:!0}]};e.select("#column-table thead").remove(),e.select("#column-table tbody").remove(),e.select("#column-table").call(ne,s).select("tbody").selectAll("tr").data(t.columns).enter().append("tr").each(function(t){e.select(this).selectAll("td").data(e=>s.columns.map(t=>e[t.key])).enter().append("td").each(function(n,s){0===s?e.select(this).text(e=>e):1===s?e.select(this).classed("column-vis-select",!0).append("input").attr("type","checkbox").attr("value",t.key).property("checked",e=>e):2===s?e.select(this).classed("column-sort-select",!0).append("select").call(ee,"none"===n?["none"]:["numeric","text"],null,e=>e).each(function(t){e.select(this).selectAll("option").property("selected",e=>e===t)}):3===s&&(e.select(this).classed("column-digit-select",!0).append("select").call(ee,["raw","rounded","scientific","si"],null,e=>e).each(function(t){e.select(this).selectAll("option").property("selected",e=>e===t)}),"numeric"!==t.sort&&e.select(this).select("select").attr("disabled","disabled"))})}),e.select("#column-table tbody").selectAll("tr").on("change",function(){const t=e.select(this).select(".column-sort-select select").node().value;e.select(this).select(".column-digit-select select").attr("disabled","numeric"===t?null:"disabled")}),e.select("#column-submit").on("click",()=>B({visibles:a(".column-vis-select"),sorts:d(".column-sort-select"),digits:d(".column-digit-select")}).then(n))}function de(t,n,s){const l=C();return document.getElementById("join-search").addEventListener("keypress",e=>{13===e.keyCode&&e.preventDefault()}),$(l).then(l=>{const o=t.columns.map(e=>e.key);e.select("#join-keys").call(te,l.unique("key"),"keys",e=>e.key,e=>e.name).selectAll("li").each(function(t){const n=o.includes(t.key);e.select(this).selectAll("label").select("input").property("checked",n).attr("disabled",n?"disabled":null)}),e.select("#join-search").on("keyup",function(){const t=e=>X(r(this),e.name);e.select("#join-keys").selectAll("li").style("visibility",e=>t(e)?null:"hidden").style("position",e=>t(e)?null:"absolute")}),e.select("#join-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t=a("#join-keys"),r=l.filter(e=>!o.includes(e.key)).filter(e=>t.includes(e.key)).map(e=>{const t=n.map(e=>e.ID);return P(e.domain).getMapping(t,e)});return Promise.all(r).then(e=>{s(e)})})})}function ue(t,n){e.select("#importcol-file").on("change",()=>{const t=document.getElementById("importcol-file").files[0],n="csv"===t.name.split(".").pop();g(t).then(t=>{const s=n?M(t):JSON.parse(t),r=Q(s);e.select("#importcol-preview").call(ne,r).call(se,r.records.slice(0,5),e=>e[r.columns[0].key]),e.select("#importcol-preview").datum(s)})}),e.select("#importcol-submit").on("click",()=>{let t=e.select("#importcol-preview").datum();e.select("#importcol-preview").datum(null);const s=[];if(t.hasOwnProperty("column")&&(t=N(t)),t.columns.forEach((e,n)=>{"plot"===e.valueType&&(t.columns[n].valueType="image",s.push(n))}),s.length>0){const e=[];Object.entries(t.mapping).forEach(n=>{s.forEach(s=>{const r=Z(n[1][s]).then(e=>{t.mapping[n[0]][s]=e});e.push(r)})}),Promise.all(e).then(()=>n([t]))}else n([t])})}function pe(t,n,s){e.select("#graph-measure").selectAll("option.rd").attr("disabled",!0===I("rdk")?null:"disabled"),e.select("#graph-measure").on("change",function(){e.select("#graph-options").selectAll(".gls").attr("disabled","gls"===this.value?null:"disabled"),e.select("#graph-options").selectAll(".fmcs").attr("disabled","rdfmcs"===this.value?null:"disabled")}),e.select("#graph-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const c=e.select(e.select("#graph-measure").node().selectedOptions[0]),a={measure:r("#graph-measure"),indices:[],molecules:[],nodeTableId:t.id,threshold:o("#graph-thld"),ignoreHs:i("#graph-ignoreh"),diameter:"gls"===c.node().value?l("#graph-diam"):null,maxTreeSize:"gls"===c.node().value?l("#graph-tree"):null,molSizeCutoff:"gls"===c.node().value?l("#graph-skip"):null,timeout:c.classed("rd")?l("#graph-timeout"):null};return n.forEach(e=>{a.molecules.push(e._mol),a.indices.push(e._index)}),ze.getRecords(a).then(s)})}function he(t,n,s){e.select("#loading-circle").style("display","none"),t.hasOwnProperty("status")||(t.status="Completed"),e.select("title").text(t.name),e.select("#title").text(t.name),e.select("#refresh").text("Aborting"===t.status?"Abort requested":"Refresh").style("display",m(t)?"inline-block":"none"),e.select("#abort").style("display",f(t)?"inline-block":"none");const r={datatable:"entries found",connection:"connections created"}[t.format];e.select("#progress").text(`(${t.status} - ${t.recordCount} ${r} in ${t.execTime} sec.)`),"In progress"===t.status&&e.select("#progress").append("div").append("progress").attr("max",100).attr("value",t.progress).text(`${t.progress}%`),e.select("#refresh").on("click",n),e.select("#abort").on("click",()=>{e.select("#confirm-message").text("Are you sure you want to abort this calculation job?"),e.select("#confirm-submit").classed("btn-primary",!1).classed("btn-warning",!0).on("click",()=>{s()})}),console.info("Query"),console.info(t.query)}function me(){e.select("#new-data").style("display","none"),e.select("#loading-circle").style("display","none")}function fe(){e.select("#data-control").style("display","none"),e.select("#nodedata").style("display","none"),e.select("#refresh").style("display","none"),e.select("#abort").style("display","none"),e.select("#loading-circle").style("display","none"),e.select("#status").selectAll("li").style("display","none")}function ye(e,t){e.select("div.dg-header").size()||e.append("div").classed("dg-header",!0),e.select("div.dg-viewport").size()||e.append("div").classed("dg-viewport",!0).append("div").classed("dg-body",!0);const n=t.columns.filter(e=>!e.hasOwnProperty("visible")||!1!==e.visible).map(e=>(e.width=Qe[e.sort||"numeric"],e.height=Me[e.sort||"numeric"],e)),s={height:n.reduce((e,t)=>e.height>t.height?e:t).height,width:n.reduce((e,t)=>({width:e.width+t.width})).width};e.style("width",`${s.width}px`),e.select(".dg-header").datum(s);const r=e.select(".dg-header").selectAll(".dg-hcell").data(n,e=>e.key);r.exit().remove(),r.enter().append("div").classed("dg-hcell",!0).style("display","inline-block").merge(r).style("width",e=>`${e.width}px`).text(e=>e.hasOwnProperty("name")?e.name:e.key)}function ge(t,n,s,r,l){const o=t.select(".dg-header").datum(),i=t.select(".dg-header").selectAll(".dg-hcell").data(),c=Math.min(r,Math.max(0,n.length-l+1)),a=c+l,d=n.slice(c,Math.min(a,n.length)),u=t.select(".dg-body").selectAll(".dg-row").data(d,s).style("height",`${o.height}px`);u.exit().remove();const p=u.enter().append("div").attr("class","dg-row").style("position","absolute");p.selectAll(".dg-cell").data(i.map(e=>e.width)).enter().append("div").classed("dg-cell",!0).classed("align-middle",!0).style("display","inline-block").style("width",e=>`${e}px`),p.merge(u).order().each(function(t,n){const s=(r+n)*o.height;e.select(this).style("transform",`translate(0px, ${s}px)`).classed("odd",(r+n)%2==0).selectAll(".dg-cell").html(function(s,r){e.select(this).attr("id",`c${n}-${r}`);const l=t[i[r].key];return void 0===l?"":"plot"===i[r].valueType?"":"image"===i[r].valueType?`<img src="${l}" width="180" height="180"/>`:i[r].hasOwnProperty("digit")&&"raw"!==i[r].digit?V(l,i[r].digit):l}).each(function(e,s){"plot"===i[s].valueType&&t.hasOwnProperty(i[s].key)&&K(t[i[s].key],`#c${n}-${s}`)})})}function we(t,n,s){const r=t.select(".dg-header").datum(),l=n.length*r.height;let o,i;t.select(".dg-body").style("height",`${l}px`).style("position","relative"),t.select(".dg-viewport").style("overflow-y","auto").on("scroll",function(){const l=e.select(this).node().scrollTop,c=Math.min(Math.floor(l/r.height),n.length);c!==o&&ge(t,n,s,o=c,i)}),e.select(window).on("resize",function(){const e=t.select(".dg-viewport"),n=e.node().getBoundingClientRect().top,s=window.innerHeight-n-5;e.style("height",`${s}px`);const l=Math.ceil(s/r.height)+1;l!==i&&(i=l,e.dispatch("scroll"))}).dispatch("resize")}function be(t,n,s){t.select(".dg-header").selectAll(".dg-hcell").filter(e=>"none"!==e.sort).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",r=>{const l="v"===e.select(`#sort-${r.key}`).text();e.select(`#sort-${r.key}`).text(l?"^":"v");const o=!r.hasOwnProperty("sort")||"numeric"===r.sort,i=l?o?J:H:o?W:Y,c=n.sort((e,t)=>i(e[r.key],t[r.key]));we(t,c,s)})}function ve(e,t){e.filter(e=>e.hasOwnProperty(t)).forEach(e=>{e[t]=`<a href="profile.html?compound=${e[t]}" target="_blank">${e[t]}</a>`})}function ke(t){return j().then(n=>{const s=JSON.parse(JSON.stringify(n));if(ve(s,"ID"),e.select("#datatable").call(ye,t).call(we,s,e=>e._index).call(be,s,e=>e._index),!I("onLine"))return Promise.resolve();pe(t,n,t=>(t.networkThreshold=t.query.threshold,U(t).then(()=>{e.select("#loading-circle").style("display","none"),window.open(`graph.html?id=${t.id}`,"_blank")}))),de(t,n,e=>Promise.all(e.map(e=>_(e))).then(xe))})}function xe(){return E().then(t=>(ae(t,xe),ue(t,e=>{const t=e.map(e=>_(e));return Promise.all(t).then(xe)}),he(t,Re,Pe),e.select("#rename").on("click",()=>{e.select("#prompt-title").text("Rename table"),e.select("#prompt-label").text("New name"),e.select("#prompt-input").attr("value",t.name),e.select("#prompt-submit").on("click",()=>{const e=r("#prompt-input");return L(t.id,"name",e).then(E).then(e=>he(e,Re,Pe))})}),e.select("#export").on("click",()=>x(t,t.name,!0)),I("onLine")&&(e.select("#excel").on("click",()=>{const e={json:new Blob([JSON.stringify(t)])};return Ne.exportExcel(e).then(e=>k(e,`${t.name}.xlsx`))}),e.select("#sdfile").on("click",()=>{const e={json:new Blob([JSON.stringify(t)])};return Ne.exportSDFile(e).then(e=>k(e,`${t.name}.sdf`))})),ke(t)))}function Ie(e){return U(e).then(()=>{window.location=`datatable.html?id=${e.id}`})}function qe(e){return E().then(t=>{if(!m(t))return;const n={id:t.id,command:e};return Ne.getRecords(n).then(e=>S(e.domain,e.dataSource).then(t=>P(e.domain).formatResult(t,e))).then(T)})}function Re(){return I("onLine")?qe("update").then(e=>{if(void 0!==e)return xe()}):Promise.resolve()}function Pe(){return qe("abort").then(e=>{if(void 0!==e)return xe()})}const Ae=!1;e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n,s=s&&s.hasOwnProperty("default")?s.default:s;const Ce={app:"key",items:"id, format, responseDate",resources:"idx, id"};let Oe=new n("Store");Oe.version(1).stores(Ce);var De={getAppSetting:function(e){return Oe.app.where("key").equals(e).first().then(e=>{if(void 0!==e)return e.value})},putAppSetting:function(e,t){return Oe.app.put({key:e,value:t})},getResources:function(){return Oe.resources.orderBy("idx").toArray()},putResources:function(e){return Oe.resources.bulkPut(e)},getAllItems:function(){return Oe.items.orderBy("responseDate").reverse().toArray()},getItemsByFormat:function(e){return Oe.items.where("format").equals(e).reverse().sortBy("responseDate")},getItemById:function(e){return Oe.items.where("id").equals(e).first()},updateItem:function(e,t){return Oe.items.where("id").equals(e).modify(t)},deleteItem:function(e){return Oe.items.where("id").equals(e).delete()},putItem:function(e){return Oe.items.put(e)},reset:function(){return Oe.delete().then(()=>{(Oe=new n("Store")).version(1).stores(Ce)})}};class $e{constructor(){this.baseURL="",this.available=!1}xhrRequest(e,t=null,n={}){return new Promise((s,r)=>{const l=new XMLHttpRequest;l.open("method"in n?n.method:"POST",e),l.responseType="responseType"in n?n.responseType:"json",l.withCredentials="withCredentials"in n&&n.withCredentials,l.onload=(()=>{200!==l.status?r(l):s(l.response)}),l.send(t)})}now(){return(new Date).toString()}getResources(){}formatResult(e,t){return t.lastUpdated=this.now(),t}getRecords(){}getRecordsByCompound(){}getMapping(){}getGraphEdges(){}}class Se extends $e{constructor(){super(),this.baseURL="./",this.domain="activity",this.entities=[]}serializedRequest(e,t={}){const n=new FormData;return n.set("query",JSON.stringify(t)),fetch(`${this.baseURL}${e}`,{method:"post",body:n,credentials:"include"})}request(e,t={}){const n=new FormData;return new Map(Object.entries(t)).forEach((e,t)=>{Array.isArray(e)?e.forEach(e=>n.append(t,e)):n.set(t,e)}),fetch(`${this.baseURL}${e}`,{method:"post",body:n,credentials:"include"})}getResources(){return this.request("schema",{domain:this.domain}).then(e=>e.json()).then(e=>(e.resources.forEach(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.hasOwnProperty("method")||(e.method="sql"),e.visible=!0}),this.entities.push(e.entity)}),this.available=!0,e.resources))}getRecords(e){return this.serializedRequest("sql",e).then(e=>e.json()).then(e=>(e.domain=this.domain,e))}getRecordsByCompound(e){const t={method:"sql",targets:this.entities,key:"ID",values:[e],operator:"eq"};return this.getRecords(t)}getMapping(e,t){const n={method:"sql",targets:[t.entity],key:"ID",values:e,operator:"fm"};return this.serializedRequest("sql",n).then(e=>e.json()).then(e=>{const s={};return e.records.filter(e=>e.hasOwnProperty(t.dataColumn)).forEach(e=>{s[e.ID]=e[t.dataColumn]}),{key:n.key,column:t,mapping:s,lastUpdated:this.now()}})}status(){return this.request("server").then(e=>e.json())}templates(){return this.request("templates").then(e=>e.json())}strprev(e){return this.serializedRequest("strprev",e).then(e=>e.text())}exportExcel(e){return this.request("xlsx",e).then(e=>e.blob())}exportSDFile(e){return this.request("exportsdf",e).then(e=>e.text())}reportPreview(e){return this.request("reportprev",e).then(e=>e.json())}report(e){return this.request("report",e).then(e=>e.blob())}}class Ee extends Se{constructor(){super(),this.domain="chemical",this.hiddenColumns=["_mw","_mw_wo_sw","_formula","_logp","_nonH"]}formatResult(e,t){return 0===e.length?(t.columns.forEach(e=>{e.visible=!this.hiddenColumns.includes(e.key)}),t):(Array.prototype.push.apply(t.columns,e),t.hasOwnProperty("extraColumns")&&(Array.prototype.push.apply(t.columns,t.extraColumns),delete t.extraColumns),t.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.key===t.query.key?e.visible=!0:e.visible=!this.hiddenColumns.includes(e.key)}),t.lastUpdated=this.now(),t)}getResources(){return this.request("schema",{domain:this.domain}).then(e=>e.json()).then(e=>(e.resources.forEach(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.hasOwnProperty("method")||(e.method="chemsql"),e.visible=!0})}),this.available=!0,e.resources))}getRecords(e){let t;return t=e.hasOwnProperty("command")?"rows":e.hasOwnProperty("nodeTableId")?"graph":["chemsql","sql"].includes(e.method)?"sql":"compute",this.serializedRequest(t,e).then(e=>e.json()).then(e=>(e.domain=this.domain,e))}importSDF(e){return this.request("sdf",e).then(e=>e.json()).then(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.visible=!this.hiddenColumns.includes(e.key)});const t=new Date;return e.lastUpdated=t.toString(),e})}}class je extends $e{constructor(){super(),this.resourceFile="screener_fitting.yaml",this.domain=null,this.baseURL=null}getResources(){const e=new FormData;return e.set("filename",this.resourceFile),fetch("source",{method:"post",body:e,credentials:"include"}).then(e=>e.json()).then(e=>{if(!e.hasOwnProperty("enabled")||!1!==e.enabled)return this.available=!0,this.domain=e.domain,this.baseURL=e.url,e.resources.map(t=>(t.domain=e.domain,t.entity=`${t.qcsRefId}:${t.layerIndex}`,delete t.qcsRefId,delete t.layerIndex,t.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.visible=!0}),t))})}request(e){return fetch(`${this.baseURL}${e}`,{method:"GET",credentials:"include"}).then(e=>e.json())}requestRecords(e){return this.request(e).then(e=>({records:e.compounds.map(e=>({ID:e.compoundId,qcsRefId:e.qcsRefId,layerIndex:e.layerIndex,drcPlot:e.fitting.drcPlot,AC50:e.fitting.linearAC50,hill:Math.round(100*e.fitting.hillCoefficient)/100}))}))}getRecords(e){const t=`/compounds?qcsRefIds=${e.qcsRefIds.join("%2C")}&layerIndices=${e.layerIndex-1}&fields=compoundId%2Cfitting.drcPlot%2Cfitting.linearAC50%2Cfitting.hillCoefficient`;return this.requestRecords(t)}getRecordsByCompound(e){const t=`/compounds?q=compoundId%3A${e}&fields=compoundId%2CqcsRefId%2ClayerIndex%2Cfitting.drcPlot%2Cfitting.linearAC50%2Cfitting.hillCoefficient`;return this.requestRecords(t)}getMapping(e,t){const n=t.entity.split(":"),s={qcsRefId:n[0],layerIndex:parseInt(n[1])};return this.getRecords(s).then(n=>{const s={};return n.records.filter(t=>e.includes(t.ID)).forEach(e=>{s[e.ID]=e[t.dataColumn]}),{key:"ID",column:t,mapping:s,lastUpdated:this.now()}})}getDrcPlot(e,t,n=-20,s=120){const r=`/${t}?width=180&height=180&title=compoundId&activityRangeMin=${n}&activityRangeMax=${s}`;return this.request(r)}getQcsInfo(e){const t=`/qcSessions?q=${e.map(e=>`qcsRefId:${e}`).join(" OR ")}`;return this.request(t).then(e=>e.qcSessions)}}class Be extends je{constructor(){super(),this.resourceFile="screener_rawvalue.yaml"}getResources(){const e=new FormData;return e.set("filename",this.resourceFile),fetch("source",{method:"post",body:e,credentials:"include"}).then(e=>e.json()).then(e=>{if(!e.hasOwnProperty("enabled")||!1!==e.enabled)return this.available=!0,this.domain=e.domain,this.baseURL=e.url,e.resources.map(t=>(t.domain=e.domain,t.entity=`${t.qcsRefId}:${t.layerIndex}`,delete t.qcsRefId,delete t.layerIndex,t.columns.forEach(e=>{e.key="rawValue",e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.visible=!0}),t))})}requestRecords(e,t){return this.request(e).then(e=>({records:e.plates.filter(e=>e.wells.hasOwnProperty("compoundIds")).map(e=>e.wells.compoundIds.map((t,n)=>({ID:t,qcsRefId:e.qcsRefId,layerIndex:e.layerIndex,rawValue:e.wells.rawValues[n]})).filter(t)).extend()}))}getRecords(e){const t=`/plates?qcsRefIds=${e.qcsRefIds.join("%2C")}&layerIndices=${e.layerIndex-1}&limit=200&fields=wells.rawValues%2Cwells.compoundIds`;return this.requestRecords(t,e=>null!==e.ID)}getRecordsByCompound(e){const t=`/plates?q=wells.compoundIds%3A${e}&fields=wells.rawValues%2Cwells.compoundIds`;return this.requestRecords(t,t=>t.ID===e)}}class _e extends je{constructor(){super(),this.resourceFile="screener_fitting_stub.yaml"}fittingStub(e){if("string"!=typeof e.qcsRefId)throw`${e.qcsRefId} is not a string`;if("number"!=typeof e.layerIndex)throw`${e.layerIndex} is not a number`;return[{ID:"DB00189",drcPlot:"dummy1",AC50:21e-7,hill:1.1,source:"target1_validation"},{ID:"DB00193",drcPlot:"dummy2",AC50:42e-7,hill:null,source:"target1_validation"},{ID:"DB00203",drcPlot:"dummy3",AC50:1e-5,hill:.9,source:"target1_validation"},{ID:"DB00865",drcPlot:"dummy4",AC50:8.8e-8,hill:2.1,source:"target1_validation"},{ID:"DB01143",drcPlot:"dummy5",AC50:"n.d.",hill:null,source:"target1_validation"},{ID:"DB01240",drcPlot:"dummy6",AC50:null,hill:null,source:"target1_validation"}]}getRecords(e){return Promise.resolve({records:this.fittingStub(e)})}getRecordsByCompound(e){const t=this.fittingStub({qcsRefId:"QCS-YYYY",layerIndex:1}).filter(t=>t.ID===e);return Promise.resolve({records:t})}qcsInfoStub(e){if(!Array.isArray(e))throw`${e} is not a string`;const t=[{layerIndex:0,name:"Activity%"},{layerIndex:1,name:"Background%"},{layerIndex:2,name:"Correction"}];return[{qcsRefId:"QCS-XXX0",name:"hoge",layers:t},{qcsRefId:"QCS-XXX1",name:"fuga",layers:t},{qcsRefId:"QCS-XXX2",name:"piyo",layers:t}]}getQcsInfo(e){return Promise.resolve(this.qcsInfoStub(e))}}class Le extends Be{constructor(){super(),this.resourceFile="screener_rawvalue_stub.yaml"}rawValueStub(e){if("string"!=typeof e.qcsRefId)throw`${e.qcsRefId} is not a string`;if("number"!=typeof e.layerIndex)throw`${e.layerIndex} is not a number`;return[{ID:"DB00189",rawValue:12.7,source:"target1_screen"},{ID:"DB00193",rawValue:43.6,source:"target1_screen"},{ID:"DB00203",rawValue:102.6,source:"target1_screen"},{ID:"DB00865",rawValue:-.6,source:"target1_screen"},{ID:"DB01143",rawValue:50,source:"target1_screen"},{ID:"DB01240",rawValue:null,source:"target1_screen"}]}getRecords(e){return Promise.resolve({records:this.rawValueStub(e)})}getRecordsByCompound(e){const t=this.rawValueStub({qcsRefId:"QCS-XXXX",layerIndex:1}).filter(t=>t.ID===e);return Promise.resolve({records:t})}}const Ue={onLine:!0,server:{},templates:{},urlQuery:{}};window.location.search.substring(1).split("&").map(e=>e.split("=")).forEach(e=>{Ue.urlQuery[e[0]]=e[1]});const Te=new Map(Object.entries({chemical:new Ee,activity:new Se,screenerrawvalue:new Be,screenerfitting:new je,screenerrawvaluestub:new Le,screenerfittingstub:new _e})),Fe=R(),ze=R(),Qe={numeric:120,text:200,none:200},Me={numeric:40,text:40,none:200},Ne=R();e.select("#import-json").on("click",()=>document.getElementById("select-file").click()),e.select("#select-file").on("change",()=>{b(document.getElementById("select-file").files[0]).then(Ie)}),I("urlQuery").hasOwnProperty("location")?v(I("urlQuery").location).then(e=>U(e).then(()=>e.id)).then(e=>{window.location=`datatable.html?id=${e}`}):z().then(()=>(I("onLine")||e.selectAll(".online-command").style("color","#cccccc").classed("disabled",!0).on("click",()=>e.event.stopPropagation()),I("urlQuery").hasOwnProperty("id")?(me(),qe("update").then(xe)):(fe(),ce(Ie),I("onLine")?O("chemical").then(e=>{le(e,Ie),ie(e,Ie),oe(e,Ie)}):Promise.resolve())))});
//# sourceMappingURL=datatable.js.map
