// https://github.com/mojaie/kiwiii-client Version 0.7.0. Copyright 2017 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("d3"),require("pako"),require("Dexie"),require("vega")):"function"==typeof define&&define.amd?define(["d3","pako","Dexie","vega"],t):t(e.d3,e.pako,e.Dexie,e.vega)}(this,function(e,t,n,s){"use strict";function r(e,t,n){return new Promise((s,r)=>{const l=new FileReader,o=t?e.slice(0,t):e;l.onload=(e=>s(e.target.result)),l.onerror=(e=>r(e)),n?l.readAsArrayBuffer(o):l.readAsText(o)})}function l(e,n){const s=n?t.inflate(e,{to:"string"}):e;return JSON.parse(s)}function o(e,t){try{const n=window.URL.createObjectURL(new Blob([e])),s=document.createElement("a");s.download=t,s.href=n,s.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}function a(e){return _[e]}function i(e){return S.getResources().then(t=>t.filter(t=>e.includes(t.domain)))}function c(){const e=a("urlQuery");return e.hasOwnProperty("id")?S.getItemById(e.id):Promise.resolve()}function u(e,t,n){return S.updateItem(e,e=>{e[t]=n})}function d(){"serviceWorker"in navigator&&!R?navigator.serviceWorker.register("sw.js").then(e=>{console.info("ServiceWorker registration successful with scope: ",e.scope)}).catch(e=>{console.info("ServiceWorker registration failed: ",e)}):R?console.info("Off-line mode is disabled for debugging"):console.info("Off-line mode is not supported");const e=z.templates().then(e=>{M.setGlobalConfig("templates",e.templates)}),t=z.status().then(e=>{M.setGlobalConfig("server",e)}),n=M.fetcherInstances().map(e=>e.getResources()).extendAsync().then(e=>{const t=e.map((e,t)=>(e.idx=t,e));return M.setResources(t)});return Promise.all([e,t,n])}function p(e,t){const n=parseFloat(e),s=parseFloat(t);return isNaN(n)||isNaN(s)?String(t).localeCompare(String(e)):s-n}function h(e,t){return String(t).localeCompare(String(e))}function m(e,t,n){const s=e.select("thead tr").selectAll("th").data(),r=e.select("tbody").selectAll("tr").data(t,n);r.exit().remove();const l=r.enter().append("tr");l.selectAll("td").data(e=>s.map(t=>e[t.key])).enter().append("td"),l.merge(r).selectAll("td").classed("align-middle",!0).html((e,t)=>void 0===e?"":"plot"===s[t].valueType?"[plot]":"image"===s[t].valueType?"[image]":s[t].hasOwnProperty("digit")&&"raw"!==s[t].digit?G.formatNum(e,s[t].digit):e)}function f(e){return M.getDataSourceColumns(e.domain,e.dataSource).then(t=>M.getFetcher(e.domain).formatResult(t,e))}function g(t,n,s,r,l){const o=t.select(".dg-header").datum(),a=t.select(".dg-header").selectAll(".dg-hcell").data(),i=Math.min(r,Math.max(0,n.length-l+1)),c=i+l,u=n.slice(i,Math.min(c,n.length)),d=t.select(".dg-body").selectAll(".dg-row").data(u,s).style("height",`${o.height}px`);d.exit().remove();const p=d.enter().append("div").attr("class","dg-row").style("position","absolute");p.selectAll(".dg-cell").data(a.map(e=>e.width)).enter().append("div").classed("dg-cell",!0).classed("align-middle",!0).style("display","inline-block").style("width",e=>`${e}px`),p.merge(d).order().each(function(t,n){const s=(r+n)*o.height;e.select(this).style("transform",`translate(0px, ${s}px)`).classed("odd",(r+n)%2==0).selectAll(".dg-cell").html(function(s,r){e.select(this).attr("id",`c${n}-${r}`);const l=t[a[r].key];return void 0===l?"":"plot"===a[r].valueType?"":"image"===a[r].valueType?`<img src="${l}" width="180" height="180"/>`:a[r].hasOwnProperty("digit")&&"raw"!==a[r].digit?G.formatNum(l,a[r].digit):l}).each(function(e,s){if("plot"!==a[s].valueType)return;if(!t.hasOwnProperty(a[s].key))return;const r=t[a[s].key];J.showPlot(r,`#c${n}-${s}`)})})}function y(t,n,s){const r=t.select(".dg-header").datum(),l=n.length*r.height;let o,a;t.select(".dg-body").style("height",`${l}px`).style("position","relative"),t.select(".dg-viewport").style("overflow-y","auto").on("scroll",function(){const l=e.select(this).node().scrollTop,i=Math.min(Math.floor(l/r.height),n.length);i!==o&&g(t,n,s,o=i,a)}),e.select(window).on("resize",function(){const e=t.select(".dg-viewport"),n=e.node().getBoundingClientRect().top,s=window.innerHeight-n-5;e.style("height",`${s}px`);const l=Math.ceil(s/r.height)+1;l!==a&&(a=l,e.dispatch("scroll"))}).dispatch("resize")}function b(e,t){e.filter(e=>e.hasOwnProperty(t)).forEach(e=>{e[t]=`<a href="profile.html?compound=${e[t]}" target="_blank">${e[t]}</a>`})}function v(t){return M.getCurrentRecords().then(n=>{const s=JSON.parse(JSON.stringify(n));if(b(s,"ID"),e.select("#datatable").call(ee.createDataGrid,t).call(ee.dataGridRecords,s,e=>e._index).call(ee.addSort,s,e=>e._index),!M.getGlobalConfig("onLine"))return Promise.resolve();H.graphDialog(t,n,t=>(t.networkThreshold=t.query.threshold,M.insertTable(t).then(()=>{e.select("#loading-circle").style("display","none"),window.open(`graph.html?id=${t.id}`,"_blank")}))),H.joinDialog(t,n,e=>Promise.all(e.map(e=>M.joinColumn(e))).then(w))})}function w(){return M.getCurrentTable().then(t=>(H.columnDialog(t,w),H.importColDialog(t,e=>{const t=e.map(e=>M.joinColumn(e));return Promise.all(t).then(w)}),Y.renderStatus(t,I,C),e.select("#rename").on("click",()=>{e.select("#prompt-title").text("Rename table"),e.select("#prompt-label").text("New name"),e.select("#prompt-input").attr("value",t.name),e.select("#prompt-submit").on("click",()=>{const e=D.value("#prompt-input");return M.updateTableAttribute(t.id,"name",e).then(M.getCurrentTable).then(e=>Y.renderStatus(e,I,C))})}),e.select("#export").on("click",()=>A.downloadJSON(t,t.name,!0)),M.getGlobalConfig("onLine")&&(e.select("#excel").on("click",()=>{const e={json:new Blob([JSON.stringify(t)])};return te.exportExcel(e).then(e=>A.downloadDataFile(e,`${t.name}.xlsx`))}),e.select("#sdfile").on("click",()=>{const e={json:new Blob([JSON.stringify(t)])};return te.exportSDFile(e).then(e=>A.downloadDataFile(e,`${t.name}.sdf`))})),v(t)))}function k(e){return M.insertTable(e).then(()=>{window.location=`datatable.html?id=${e.id}`})}function x(e){return M.getCurrentTable().then(t=>{if(!q.fetchable(t))return;const n={id:t.id,command:e};return te.getRecords(n).then(e=>M.getDataSourceColumns(e.domain,e.dataSource).then(t=>M.getFetcher(e.domain).formatResult(t,e))).then(M.updateTable)})}function I(){return M.getGlobalConfig("onLine")?x("update").then(e=>{if(void 0!==e)return w()}):Promise.resolve()}function C(){return x("abort").then(e=>{if(void 0!==e)return w()})}const R=!1;e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n,s=s&&s.hasOwnProperty("default")?s.default:s;var D={value:function(t){return e.select(t).node().value},valueInt:function(t){return parseInt(e.select(t).node().value)},valueFloat:function(t){return parseFloat(e.select(t).node().value)},checked:function(t){return e.select(t).node().checked},firstFile:function(t){return e.select(t).node().files[0]},checkboxValues:function(t){return e.selectAll(t).selectAll("input:checked").nodes().map(e=>e.value)},optionValues:function(t){return e.selectAll(t).selectAll("select").nodes().map(e=>e.value)},textareaLines:function(t){return e.select(t).node().value.split("\n").filter(e=>e.length>0)},optionData:function(t){const n=e.select(t).property("selectedIndex");return e.select(t).selectAll("option").data().find((e,t)=>t===n)},checkboxData:function(t){return e.selectAll(t).selectAll("input:checked").data()}},q={fetchable:function(e){return["In progress","Queued","Aborting"].includes(e.status)},abortRequestable:function(e){return["In progress","Queued"].includes(e.status)},conclike:function(e){return e.hasOwnProperty("valueType")&&["AC50","IC50","ED50"].includes(e.valueType)},dataSourceId:function(e,t,n){return[e,t,n].map(e=>e.capitalize()).join("")}},A={readFile:r,parseJSON:l,loadJSON:function(e){const t=e.name.endsWith(".gz");return r(e,!1,t).then(e=>l(e,t))},fetchJSON:function(e){const t=decodeURIComponent(e),n=t.endsWith(".gz");return fetch(t).then(e=>n?e.arrayBuffer():e.json()).then(e=>l(e,n))},downloadDataFile:o,downloadJSON:function(e,n,s=!0){const r=JSON.stringify(e);o(s?t.gzip(r):r,`${n}.json${s?".gz":""}`)}};const O={app:"key",items:"id, format, responseDate",resources:"idx, id"};let P=new n("Store");P.version(1).stores(O);var S={getAppSetting:function(e){return P.app.where("key").equals(e).first().then(e=>{if(void 0!==e)return e.value})},putAppSetting:function(e,t){return P.app.put({key:e,value:t})},getResources:function(){return P.resources.orderBy("idx").toArray()},putResources:function(e){return P.resources.bulkPut(e)},getAllItems:function(){return P.items.orderBy("responseDate").reverse().toArray()},getItemsByFormat:function(e){return P.items.where("format").equals(e).reverse().sortBy("responseDate")},getItemById:function(e){return P.items.where("id").equals(e).first()},updateItem:function(e,t){return P.items.where("id").equals(e).modify(t)},deleteItem:function(e){return P.items.where("id").equals(e).delete()},putItem:function(e){return P.items.put(e)},reset:function(){return P.delete().then(()=>{(P=new n("Store")).version(1).stores(O)})}};class T{constructor(){this.baseURL="",this.available=!1}xhrRequest(e,t=null,n={}){return new Promise((s,r)=>{const l=new XMLHttpRequest;l.open("method"in n?n.method:"POST",e),l.responseType="responseType"in n?n.responseType:"json",l.withCredentials="withCredentials"in n&&n.withCredentials,l.onload=(()=>{200!==l.status?r(l):s(l.response)}),l.send(t)})}now(){return(new Date).toString()}getResources(){}formatResult(e,t){return t.lastUpdated=this.now(),t}getRecords(){}getRecordsByCompound(){}getMapping(){}getGraphEdges(){}}class $ extends T{constructor(){super(),this.baseURL="./",this.domain="activity",this.entities=[]}serializedRequest(e,t={}){const n=new FormData;return n.set("query",JSON.stringify(t)),fetch(`${this.baseURL}${e}`,{method:"post",body:n,credentials:"include"})}request(e,t={}){const n=new FormData;return new Map(Object.entries(t)).forEach((e,t)=>{Array.isArray(e)?e.forEach(e=>n.append(t,e)):n.set(t,e)}),fetch(`${this.baseURL}${e}`,{method:"post",body:n,credentials:"include"})}getResources(){return this.request("schema",{domain:this.domain}).then(e=>e.json()).then(e=>(e.resources.forEach(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.hasOwnProperty("method")||(e.method="sql"),e.visible=!0}),this.entities.push(e.entity)}),this.available=!0,e.resources))}getRecords(e){return this.serializedRequest("sql",e).then(e=>e.json()).then(e=>(e.domain=this.domain,e))}getRecordsByCompound(e){const t={method:"sql",targets:this.entities,key:"ID",values:[e],operator:"eq"};return this.getRecords(t)}getMapping(e,t){const n={method:"sql",targets:[t.entity],key:"ID",values:e,operator:"fm"};return this.serializedRequest("sql",n).then(e=>e.json()).then(e=>{const s={};return e.records.filter(e=>e.hasOwnProperty(t.dataColumn)).forEach(e=>{s[e.ID]=e[t.dataColumn]}),{key:n.key,column:t,mapping:s,lastUpdated:this.now()}})}status(){return this.request("server").then(e=>e.json())}templates(){return this.request("templates").then(e=>e.json())}strprev(e){return this.serializedRequest("strprev",e).then(e=>e.text())}exportExcel(e){return this.request("xlsx",e).then(e=>e.blob())}exportSDFile(e){return this.request("exportsdf",e).then(e=>e.text())}reportPreview(e){return this.request("reportprev",e).then(e=>e.json())}report(e){return this.request("report",e).then(e=>e.blob())}}class F extends ${constructor(){super(),this.domain="chemical",this.hiddenColumns=["_mw","_mw_wo_sw","_formula","_logp","_nonH"]}formatResult(e,t){return 0===e.length?(t.columns.forEach(e=>{e.visible=!this.hiddenColumns.includes(e.key)}),t):(Array.prototype.push.apply(t.columns,e),t.hasOwnProperty("extraColumns")&&(Array.prototype.push.apply(t.columns,t.extraColumns),delete t.extraColumns),t.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.key===t.query.key?e.visible=!0:e.visible=!this.hiddenColumns.includes(e.key)}),t.lastUpdated=this.now(),t)}getResources(){return this.request("schema",{domain:this.domain}).then(e=>e.json()).then(e=>(e.resources.forEach(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.hasOwnProperty("method")||(e.method="chemsql"),e.visible=!0})}),this.available=!0,e.resources))}getRecords(e){let t;return t=e.hasOwnProperty("command")?"rows":e.hasOwnProperty("nodeTableId")?"graph":["chemsql","sql"].includes(e.method)?"sql":"compute",this.serializedRequest(t,e).then(e=>e.json()).then(e=>(e.domain=this.domain,e))}importSDF(e){return this.request("sdf",e).then(e=>e.json()).then(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.visible=!this.hiddenColumns.includes(e.key)});const t=new Date;return e.lastUpdated=t.toString(),e})}}class j extends T{constructor(){super(),this.resourceFile="screener_fitting.yaml",this.domain=null,this.baseURL=null}getResources(){const e=new FormData;return e.set("filename",this.resourceFile),fetch("source",{method:"post",body:e,credentials:"include"}).then(e=>e.json()).then(e=>{if(!e.hasOwnProperty("enabled")||!1!==e.enabled)return this.available=!0,this.domain=e.domain,this.baseURL=e.url,e.resources.map(t=>(t.domain=e.domain,t.entity=`${t.qcsRefId}:${t.layerIndex}`,delete t.qcsRefId,delete t.layerIndex,t.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.visible=!0}),t))})}request(e){return fetch(`${this.baseURL}${e}`,{method:"GET",credentials:"include"}).then(e=>e.json())}requestRecords(e){return this.request(e).then(e=>({records:e.compounds.map(e=>({ID:e.compoundId,qcsRefId:e.qcsRefId,layerIndex:e.layerIndex,drcPlot:e.fitting.drcPlot,AC50:e.fitting.linearAC50,hill:Math.round(100*e.fitting.hillCoefficient)/100}))}))}getRecords(e){const t=`/compounds?qcsRefIds=${e.qcsRefIds.join("%2C")}&layerIndices=${e.layerIndex-1}&fields=compoundId%2Cfitting.drcPlot%2Cfitting.linearAC50%2Cfitting.hillCoefficient`;return this.requestRecords(t)}getRecordsByCompound(e){const t=`/compounds?q=compoundId%3A${e}&fields=compoundId%2CqcsRefId%2ClayerIndex%2Cfitting.drcPlot%2Cfitting.linearAC50%2Cfitting.hillCoefficient`;return this.requestRecords(t)}getMapping(e,t){const n=t.entity.split(":"),s={qcsRefId:n[0],layerIndex:parseInt(n[1])};return this.getRecords(s).then(n=>{const s={};return n.records.filter(t=>e.includes(t.ID)).forEach(e=>{s[e.ID]=e[t.dataColumn]}),{key:"ID",column:t,mapping:s,lastUpdated:this.now()}})}getDrcPlot(e,t,n=-20,s=120){const r=`/${t}?width=180&height=180&title=compoundId&activityRangeMin=${n}&activityRangeMax=${s}`;return this.request(r)}getQcsInfo(e){const t=`/qcSessions?q=${e.map(e=>`qcsRefId:${e}`).join(" OR ")}`;return this.request(t).then(e=>e.qcSessions)}}class E extends j{constructor(){super(),this.resourceFile="screener_rawvalue.yaml"}getResources(){const e=new FormData;return e.set("filename",this.resourceFile),fetch("source",{method:"post",body:e,credentials:"include"}).then(e=>e.json()).then(e=>{if(!e.hasOwnProperty("enabled")||!1!==e.enabled)return this.available=!0,this.domain=e.domain,this.baseURL=e.url,e.resources.map(t=>(t.domain=e.domain,t.entity=`${t.qcsRefId}:${t.layerIndex}`,delete t.qcsRefId,delete t.layerIndex,t.columns.forEach(e=>{e.key="rawValue",e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.visible=!0}),t))})}requestRecords(e,t){return this.request(e).then(e=>({records:e.plates.filter(e=>e.wells.hasOwnProperty("compoundIds")).map(e=>e.wells.compoundIds.map((t,n)=>({ID:t,qcsRefId:e.qcsRefId,layerIndex:e.layerIndex,rawValue:e.wells.rawValues[n]})).filter(t)).extend()}))}getRecords(e){const t=`/plates?qcsRefIds=${e.qcsRefIds.join("%2C")}&layerIndices=${e.layerIndex-1}&limit=200&fields=wells.rawValues%2Cwells.compoundIds`;return this.requestRecords(t,e=>null!==e.ID)}getRecordsByCompound(e){const t=`/plates?q=wells.compoundIds%3A${e}&fields=wells.rawValues%2Cwells.compoundIds`;return this.requestRecords(t,t=>t.ID===e)}}class B extends j{constructor(){super(),this.resourceFile="screener_fitting_stub.yaml"}fittingStub(e){if("string"!=typeof e.qcsRefId)throw`${e.qcsRefId} is not a string`;if("number"!=typeof e.layerIndex)throw`${e.layerIndex} is not a number`;return[{ID:"DB00189",drcPlot:"dummy1",AC50:21e-7,hill:1.1,source:"target1_validation"},{ID:"DB00193",drcPlot:"dummy2",AC50:42e-7,hill:null,source:"target1_validation"},{ID:"DB00203",drcPlot:"dummy3",AC50:1e-5,hill:.9,source:"target1_validation"},{ID:"DB00865",drcPlot:"dummy4",AC50:8.8e-8,hill:2.1,source:"target1_validation"},{ID:"DB01143",drcPlot:"dummy5",AC50:"n.d.",hill:null,source:"target1_validation"},{ID:"DB01240",drcPlot:"dummy6",AC50:null,hill:null,source:"target1_validation"}]}getRecords(e){return Promise.resolve({records:this.fittingStub(e)})}getRecordsByCompound(e){const t=this.fittingStub({qcsRefId:"QCS-YYYY",layerIndex:1}).filter(t=>t.ID===e);return Promise.resolve({records:t})}qcsInfoStub(e){if(!Array.isArray(e))throw`${e} is not a string`;const t=[{layerIndex:0,name:"Activity%"},{layerIndex:1,name:"Background%"},{layerIndex:2,name:"Correction"}];return[{qcsRefId:"QCS-XXX0",name:"hoge",layers:t},{qcsRefId:"QCS-XXX1",name:"fuga",layers:t},{qcsRefId:"QCS-XXX2",name:"piyo",layers:t}]}getQcsInfo(e){return Promise.resolve(this.qcsInfoStub(e))}}class L extends E{constructor(){super(),this.resourceFile="screener_rawvalue_stub.yaml"}rawValueStub(e){if("string"!=typeof e.qcsRefId)throw`${e.qcsRefId} is not a string`;if("number"!=typeof e.layerIndex)throw`${e.layerIndex} is not a number`;return[{ID:"DB00189",rawValue:12.7,source:"target1_screen"},{ID:"DB00193",rawValue:43.6,source:"target1_screen"},{ID:"DB00203",rawValue:102.6,source:"target1_screen"},{ID:"DB00865",rawValue:-.6,source:"target1_screen"},{ID:"DB01143",rawValue:50,source:"target1_screen"},{ID:"DB01240",rawValue:null,source:"target1_screen"}]}getRecords(e){return Promise.resolve({records:this.rawValueStub(e)})}getRecordsByCompound(e){const t=this.rawValueStub({qcsRefId:"QCS-XXXX",layerIndex:1}).filter(t=>t.ID===e);return Promise.resolve({records:t})}}const _={onLine:!0,server:{},templates:{},urlQuery:{}};window.location.search.substring(1).split("&").map(e=>e.split("=")).forEach(e=>{_.urlQuery[e[0]]=e[1]});const N=new Map(Object.entries({chemical:new F,activity:new $,screenerrawvalue:new E,screenerfitting:new j,screenerrawvaluestub:new L,screenerfittingstub:new B}));var M={getGlobalConfig:a,setGlobalConfig:function(e,t){_[e]=t},localChemInstance:function(){return N.get("chemical")},getFetcher:function(e){return N.get(e)},fetcherInstances:function(){return Array.from(N.values())},dataFetcherInstances:function(){const e=[];return N.forEach((t,n)=>{"chemical"!==n&&e.push(t)}),e},dataFetcherDomains:function(){const e=[];return N.forEach((t,n)=>{"chemical"!==n&&e.push(n)}),e},getResources:i,setResources:function(e){return S.putResources(e)},getResourceColumns:function(e){return i(e).then(e=>e.map(e=>e.columns.map(t=>(t.domain=e.domain,t.key=q.dataSourceId(e.domain,e.id,t.key),t.entity=e.entity,t.hasOwnProperty("tags")||(t.tags=e.tags),t))).extend())},getDataSourceColumns:function(e,t){return S.getResources([e]).then(e=>t.map(t=>e.find(e=>e.id===t).columns).extend())},getAllTables:function(){return S.getAllItems()},getTablesByFormat:function(e){return S.getItemsByFormat(e)},getTable:function(e){return S.getItemById(e)},getRecords:function(e){return S.getItemById(e).then(e=>e.records)},getCurrentTable:c,getCurrentRecords:function(){return c().then(e=>e.records)},setColumnsToShow:function(e){return S.updateItem(a("urlQuery").id,t=>{t.columns.forEach((t,n)=>{t.visible=e.visibles.includes(t.key),t.sort=e.sorts[n],t.digit=e.digits[n]})})},joinColumn:function(e,t=_.urlQuery.id){const n=e.hasOwnProperty("column")?e.column:e.columns;return S.updateItem(t,t=>{t.records.filter(t=>e.mapping.hasOwnProperty(t[e.key])).forEach(t=>{e.hasOwnProperty("column")?t[e.column.key]=e.mapping[t[e.key]]:e.columns.forEach((n,s)=>{t[n.key]=e.mapping[t[e.key]][s]})}),t.columns=t.columns.concat(n).unique("key"),t.lastUpdated=e.lastUpdated})},updateTableAttribute:u,insertTable:function(e){return S.putItem(e)},updateTable:function(e){return void 0===e?Promise.resolve():"Failure"===e.status?u(e.id,"status","Failure"):S.updateItem(e.id,t=>{const n={responseDate:e.responseDate,records:e.records,columns:e.columns,recordCount:e.recordCount,searchDoneCount:e.searchDoneCount,execTime:e.execTime,progress:e.progress,status:e.status};e.hasOwnProperty("lastUpdated")&&(n.lastUpdated=e.lastUpdated),Object.assign(t,n)})},deleteTable:function(e){return S.deleteItem(e)},reset:function(){return S.reset()}};const z=M.localChemInstance();var U={loader:function(){return"file:"===document.location.protocol?(console.info("Off-line mode (local file)"),M.setGlobalConfig("onLine",!1),Promise.resolve()):"onLine"in navigator&&!navigator.onLine?(console.info("Off-line mode (no internet connection)"),M.setGlobalConfig("onLine",!1),Promise.resolve()):fetch(`${z.baseURL}favicon.ico`).then(()=>(M.setGlobalConfig("onLine",!0),d())).catch(()=>(console.info("Off-line mode (server not responding)"),M.setGlobalConfig("onLine",!1),Promise.resolve()))}},V={columnMappingToTable:function(e){const t={key:e.key,name:e.key,sort:"text",visible:!0},n=e.hasOwnProperty("column")?e.column:e.columns;return{columns:[t].concat(n),records:Object.entries(e.mapping).map(t=>{const n={};if(n[e.key]=t[0],e.hasOwnProperty("column"))n[e.column.key]=t[1];else{const s=e.columns.map(e=>e.key);t[1].forEach((e,t)=>{n[s[t]]=e})}return n})}},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),n=t.shift().split(","),s=n.shift(),r={created:(new Date).toString(),columns:[],key:s,mapping:{}},l=[];return n.forEach((e,t)=>{""!==e&&(l.push(t),r.columns.push({key:e,name:e,sort:"text",visible:!0}))}),t.forEach(e=>{const t=e.split(","),n=t.shift();r.mapping[n]=Array(l.length),l.forEach(e=>{r.mapping[n][e]=t[e]})}),r},singleToMultiMapping:function(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,columns:[e.column],key:e.key,mapping:t}}},G={formatNum:function(t,n){const s={scientific:".3e",si:".3s",rounded:".3r"};return"raw"===n?t:void 0===t||null===t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(s[n])(t):t},partialMatch:function(e,t){return void 0!==t&&null!==t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},numericAsc:p,numericDesc:function(e,t){return p(t,e)},textAsc:h,textDesc:function(e,t){return h(t,e)}},Q={getSDFPropList:function(e){const t=/>.*?<(\S+)>/g,n=new Set;let s;for(;null!==(s=t.exec(e));)n.add(s[1]);return Array.from(n)}},J={showPlot:function(e,t){new s.View(s.parse(e)).initialize(t).run()},plotThumbnail:function(e){return new s.View(s.parse(e)).toImageURL("png")}},X={selectOptions:function(e,t,n,s){const r=e.selectAll("option").data(t,n);r.exit().remove(),r.enter().append("option").merge(r).attr("value",n).text(s)},checkboxList:function(e,t,n,s,r){const l=e.selectAll("li").data(t,s);l.exit().remove();const o=l.enter().append("li").attr("class","form-check").append("label");o.append("input"),o.append("span");const a=o.merge(l.select("label")).attr("class","form-check-label");a.select("input").attr("type","checkbox").attr("class","form-check-input").attr("name",n).attr("value",s),a.select("span").text(r)},createTable:function(e,t){e.select("thead").size()||e.append("thead").append("tr"),e.select("tbody").size()||e.append("tbody");const n=t.columns.filter(e=>!e.hasOwnProperty("visible")||!1!==e.visible),s=e.select("thead tr").selectAll("th").data(n,e=>e.key);s.exit().remove(),s.enter().append("th").merge(s).text(e=>e.hasOwnProperty("name")?e.name:e.key)},updateTableRecords:m,appendTableRows:function(e,t,n){const s=e.select("tbody").selectAll("tr").data();Array.prototype.push.apply(s,t),m(e,s,n)},addSort:function(t){t.select("thead tr").selectAll("th").filter(e=>"none"!==e.sort).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",n=>{const s="v"===e.select(`#sort-${n.key}`).text(),r=!n.hasOwnProperty("sort")||"numeric"===n.sort,l=s?r?G.numericAsc:G.textAsc:r?G.numericDesc:G.textDesc;t.select("tbody").selectAll("tr").sort((e,t)=>l(e[n.key],t[n.key])),e.select(`#sort-${n.key}`).text(s?"^":"v")})},formatNumbers:function(e){e.select("thead tr").selectAll("th").each((t,n)=>{t.hasOwnProperty("digit")&&"raw"!==t.digit&&e.select("tbody").selectAll("tr").selectAll("td").filter((e,t)=>t===n).text(e=>G.formatNum(e,t.digit))})}};const W=M.localChemInstance();var H={pickDialog:function(t,n){e.select("#pick-target").call(X.selectOptions,t,e=>e.entity,e=>e.name).on("change",function(){const t=D.optionData(this);e.select("#pick-queryarea").text(t.placeholders.ID)}),e.select("#pick-queryarea").text(t[0].placeholders.ID),e.select("#pick-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t={method:"chemsql",targets:[D.value("#pick-target")],key:"ID",values:D.textareaLines("#pick-queryarea"),operator:"fm"};return W.getRecords(t).then(f).then(n)})},propDialog:function(t,n){e.select("#prop-targets").call(X.checkboxList,t,"targets",e=>e.entity,e=>e.name).on("change",function(){const t=D.checkboxData("#prop-targets").map(e=>e.columns).extend().unique("key");e.select("#prop-key").call(X.selectOptions,t,e=>e.key,e=>e.name)}),e.select("#prop-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t=D.optionData("#prop-key"),s={method:t.method,targets:D.checkboxValues("#prop-targets"),key:t.key,values:D.textareaLines("#prop-queryarea"),operator:D.value("#prop-operator")};return W.getRecords(s).then(f).then(n)})},structDialog:function(t,n){e.select("#struct-qsrc").call(X.selectOptions,t,e=>e.entity,e=>e.name),e.select("#struct-targets").call(X.checkboxList,t,"targets",e=>e.entity,e=>e.name),e.select("#struct-method").selectAll("option.rd").attr("disabled",!0===M.getGlobalConfig("rdk")?null:"disabled"),e.select("#struct-method").on("change",function(){const t=e.select(this.selectedOptions[0]);e.select("#struct-thldtype").attr("disabled",t.classed("thld")?null:"disabled").property("value",t.classed("edge")?"edge":"sim"),e.select("#struct-thld").attr("disabled",t.classed("thld")?null:"disabled"),e.select("#struct-thldtype option.sim").attr("disabled",t.classed("sim")?null:"disabled"),e.select("#struct-thldtype option.edge").attr("disabled",t.classed("edge")?null:"disabled"),e.select("#struct-options").selectAll(".gls").attr("disabled",t.classed("gls")?null:"disabled"),e.select("#struct-options").selectAll(".fmcs").attr("disabled","rdfmcs"===this.value?null:"disabled"),e.select("#struct-thld").attr("value","edge"===D.value("#struct-thldtype")?15:.7).attr("min","edge"===D.value("#struct-thldtype")?5:0).attr("max","edge"===D.value("#struct-thldtype")?999:1).attr("step","edge"===D.value("#struct-thldtype")?1:.01)}),e.select("#struct-thldtype").on("change",function(){e.select("#struct-thld").attr("value","edge"===this.value?15:.7).attr("min","edge"===this.value?5:0).attr("max","edge"===this.value?999:1).attr("step","edge"===this.value?1:.01)}),e.select("#struct-format").on("change",function(){e.select("#struct-qsrc").attr("disabled","dbid"===this.value?null:"disabled")}),e.select("#struct-preview").on("click",()=>{const t=D.value("#struct-format"),n={format:t,querySource:"dbid"===t?D.value("#struct-qsrc"):null,value:"molfile"===t?D.value("#struct-queryarea"):D.textareaLines("#struct-queryarea")[0]};return W.strprev(n).then(t=>e.select("#struct-image").html(t))}),e.select("#struct-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t=e.select(e.select("#struct-method").node().selectedOptions[0]),s=D.value("#struct-format"),r={method:D.value("#struct-method"),targets:D.checkboxValues("#struct-targets"),format:s,querySource:"dbid"===s?D.value("#struct-qsrc"):null,value:"molfile"===s?D.value("#struct-queryarea"):D.textareaLines("#struct-queryarea")[0],thresholdType:D.value("#struct-thldtype"),threshold:D.valueFloat("#struct-thld"),ignoreHs:D.checked("#struct-ignoreh"),diameter:t.classed("gls")?D.valueInt("#struct-diam"):null,maxTreeSize:t.classed("gls")?D.valueInt("#struct-tree"):null,molSizeCutoff:t.classed("gls")?D.valueInt("#struct-skip"):null,timeout:t.classed("rd")?D.valueInt("#struct-timeout"):null};return W.getRecords(r).then(f).then(n)})},sdfDialog:function(t){e.select("#sdf-file").on("change",()=>{const t=new FileReader,n=document.getElementById("sdf-file").files[0];t.onload=(t=>{e.select("#sdf-cols").call(X.checkboxList,Q.getSDFPropList(t.target.result),"columns",e=>e,e=>e)}),t.readAsText(n.slice(0,104857600))}),e.select("#sdf-selectall").on("change",()=>{e.select("#sdf-cols").selectAll("input").property("checked",D.checked("#sdf-selectall"))}),e.select("#sdf-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const n={contents:D.firstFile("#sdf-file"),query:JSON.stringify({columns:D.checkboxValues("#sdf-cols"),implh:D.checked("#sdf-implh"),recalc:D.checked("#sdf-recalc")})};return W.importSDF(n).then(t)})},columnDialog:function(t,n){const s={columns:[{key:"name",sort:"text",visible:!0},{key:"visible",sort:"text",visible:!0},{key:"sort",sort:"text",visible:!0},{key:"digit",sort:"numeric",visible:!0}]};e.select("#column-table thead").remove(),e.select("#column-table tbody").remove(),e.select("#column-table").call(X.createTable,s).select("tbody").selectAll("tr").data(t.columns).enter().append("tr").each(function(t){e.select(this).selectAll("td").data(e=>s.columns.map(t=>e[t.key])).enter().append("td").each(function(n,s){0===s?e.select(this).text(e=>e):1===s?e.select(this).classed("column-vis-select",!0).append("input").attr("type","checkbox").attr("value",t.key).property("checked",e=>e):2===s?e.select(this).classed("column-sort-select",!0).append("select").call(X.selectOptions,"none"===n?["none"]:["numeric","text"],null,e=>e).each(function(t){e.select(this).selectAll("option").property("selected",e=>e===t)}):3===s&&(e.select(this).classed("column-digit-select",!0).append("select").call(X.selectOptions,["raw","rounded","scientific","si"],null,e=>e).each(function(t){e.select(this).selectAll("option").property("selected",e=>e===t)}),"numeric"!==t.sort&&e.select(this).select("select").attr("disabled","disabled"))})}),e.select("#column-table tbody").selectAll("tr").on("change",function(){const t=e.select(this).select(".column-sort-select select").node().value;e.select(this).select(".column-digit-select select").attr("disabled","numeric"===t?null:"disabled")}),e.select("#column-submit").on("click",()=>{const e={visibles:D.checkboxValues(".column-vis-select"),sorts:D.optionValues(".column-sort-select"),digits:D.optionValues(".column-digit-select")};return M.setColumnsToShow(e).then(n)})},joinDialog:function(t,n,s){const r=M.dataFetcherDomains();return document.getElementById("join-search").addEventListener("keypress",e=>{13===e.keyCode&&e.preventDefault()}),M.getResourceColumns(r).then(r=>{const l=t.columns.map(e=>e.key);e.select("#join-keys").call(X.checkboxList,r.unique("key"),"keys",e=>e.key,e=>e.name).selectAll("li").each(function(t){const n=l.includes(t.key);e.select(this).selectAll("label").select("input").property("checked",n).attr("disabled",n?"disabled":null)}),e.select("#join-search").on("keyup",function(){const t=e=>G.partialMatch(D.value(this),e.name);e.select("#join-keys").selectAll("li").style("visibility",e=>t(e)?null:"hidden").style("position",e=>t(e)?null:"absolute")}),e.select("#join-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t=D.checkboxValues("#join-keys"),o=r.filter(e=>!l.includes(e.key)).filter(e=>t.includes(e.key)).map(e=>{const t=n.map(e=>e.ID);return M.getFetcher(e.domain).getMapping(t,e)});return Promise.all(o).then(e=>{s(e)})})})},importColDialog:function(t,n){e.select("#importcol-file").on("change",()=>{const t=document.getElementById("importcol-file").files[0],n="csv"===t.name.split(".").pop();A.readFile(t).then(t=>{const s=n?V.csvToMapping(t):JSON.parse(t),r=V.columnMappingToTable(s);e.select("#importcol-preview").call(X.createTable,r).call(X.updateTableRecords,r.records.slice(0,5),e=>e[r.columns[0].key]),e.select("#importcol-preview").datum(s)})}),e.select("#importcol-submit").on("click",()=>{let t=e.select("#importcol-preview").datum();e.select("#importcol-preview").datum(null);const s=[];if(t.hasOwnProperty("column")&&(t=V.singleToMultiMapping(t)),t.columns.forEach((e,n)=>{"plot"===e.valueType&&(t.columns[n].valueType="image",s.push(n))}),s.length>0){const e=[];Object.entries(t.mapping).forEach(n=>{s.forEach(s=>{const r=J.plotThumbnail(n[1][s]).then(e=>{t.mapping[n[0]][s]=e});e.push(r)})}),Promise.all(e).then(()=>n([t]))}else n([t])})},graphDialog:function(t,n,s){e.select("#graph-measure").selectAll("option.rd").attr("disabled",!0===M.getGlobalConfig("rdk")?null:"disabled"),e.select("#graph-measure").on("change",function(){e.select("#graph-options").selectAll(".gls").attr("disabled","gls"===this.value?null:"disabled"),e.select("#graph-options").selectAll(".fmcs").attr("disabled","rdfmcs"===this.value?null:"disabled")}),e.select("#graph-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const r=e.select(e.select("#graph-measure").node().selectedOptions[0]),l={measure:D.value("#graph-measure"),indices:[],molecules:[],nodeTableId:t.id,threshold:D.valueFloat("#graph-thld"),ignoreHs:D.checked("#graph-ignoreh"),diameter:"gls"===r.node().value?D.valueInt("#graph-diam"):null,maxTreeSize:"gls"===r.node().value?D.valueInt("#graph-tree"):null,molSizeCutoff:"gls"===r.node().value?D.valueInt("#graph-skip"):null,timeout:r.classed("rd")?D.valueInt("#graph-timeout"):null};return n.forEach(e=>{l.molecules.push(e._mol),l.indices.push(e._index)}),W.getRecords(l).then(s)})},graphConfigDialog:function(t,n){e.select("#graphconfig-thld").attr("value",t.networkThreshold).attr("max",1).attr("min",t.query.threshold),e.select("#graphconfig-submit").on("click",()=>{const e=D.valueFloat("#graphconfig-thld");e<t.query.threshold||n(e)})},communityDialog:function(t){e.select("#community-name").attr("value","comm_"),e.select("#community-submit").on("click",()=>{const e={name:D.value("#community-name"),nulliso:D.checked("#community-nulliso")};t(e)})}},Y={renderStatus:function(t,n,s){e.select("#loading-circle").style("display","none"),t.hasOwnProperty("status")||(t.status="Completed"),e.select("title").text(t.name),e.select("#title").text(t.name),e.select("#refresh").text("Aborting"===t.status?"Abort requested":"Refresh").style("display",q.fetchable(t)?"inline-block":"none"),e.select("#abort").style("display",q.abortRequestable(t)?"inline-block":"none");const r={datatable:"entries found",connection:"connections created"}[t.format];e.select("#progress").text(`(${t.status} - ${t.recordCount} ${r} in ${t.execTime} sec.)`),"In progress"===t.status&&e.select("#progress").append("div").append("progress").attr("max",100).attr("value",t.progress).text(`${t.progress}%`),e.select("#refresh").on("click",n),e.select("#abort").on("click",()=>{e.select("#confirm-message").text("Are you sure you want to abort this calculation job?"),e.select("#confirm-submit").classed("btn-primary",!1).classed("btn-warning",!0).on("click",()=>{s()})}),console.info("Query"),console.info(t.query)},initializeWithData:function(){e.select("#new-data").style("display","none"),e.select("#loading-circle").style("display","none")},initialize:function(){e.select("#data-control").style("display","none"),e.select("#nodedata").style("display","none"),e.select("#refresh").style("display","none"),e.select("#abort").style("display","none"),e.select("#loading-circle").style("display","none"),e.select("#status").selectAll("li").style("display","none")}};const K={numeric:120,text:200,none:200},Z={numeric:40,text:40,none:200};var ee={createDataGrid:function(e,t){e.select("div.dg-header").size()||e.append("div").classed("dg-header",!0),e.select("div.dg-viewport").size()||e.append("div").classed("dg-viewport",!0).append("div").classed("dg-body",!0);const n=t.columns.filter(e=>!e.hasOwnProperty("visible")||!1!==e.visible).map(e=>(e.width=K[e.sort||"numeric"],e.height=Z[e.sort||"numeric"],e)),s={height:n.reduce((e,t)=>e.height>t.height?e:t).height,width:n.reduce((e,t)=>({width:e.width+t.width})).width};e.style("width",`${s.width}px`),e.select(".dg-header").datum(s);const r=e.select(".dg-header").selectAll(".dg-hcell").data(n,e=>e.key);r.exit().remove(),r.enter().append("div").classed("dg-hcell",!0).style("display","inline-block").merge(r).style("width",e=>`${e.width}px`).text(e=>e.hasOwnProperty("name")?e.name:e.key)},dataGridRecords:y,addSort:function(t,n,s){t.select(".dg-header").selectAll(".dg-hcell").filter(e=>"none"!==e.sort).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",r=>{const l="v"===e.select(`#sort-${r.key}`).text();e.select(`#sort-${r.key}`).text(l?"^":"v");const o=!r.hasOwnProperty("sort")||"numeric"===r.sort,a=l?o?G.numericAsc:G.textAsc:o?G.numericDesc:G.textDesc,i=n.sort((e,t)=>a(e[r.key],t[r.key]));y(t,i,s)})}};const te=M.localChemInstance();e.select("#import-json").on("click",()=>document.getElementById("select-file").click()),e.select("#select-file").on("change",()=>{const e=document.getElementById("select-file").files[0];A.loadJSON(e).then(k)}),function(){if(M.getGlobalConfig("urlQuery").hasOwnProperty("location")){const e=M.getGlobalConfig("urlQuery").location;return A.fetchJSON(e).then(e=>M.insertTable(e).then(()=>e.id)).then(e=>{window.location=`datatable.html?id=${e}`})}U.loader().then(()=>(M.getGlobalConfig("onLine")||e.selectAll(".online-command").style("color","#cccccc").classed("disabled",!0).on("click",()=>e.event.stopPropagation()),M.getGlobalConfig("urlQuery").hasOwnProperty("id")?(Y.initializeWithData(),x("update").then(w)):(Y.initialize(),H.sdfDialog(k),M.getGlobalConfig("onLine")?M.getResources("chemical").then(e=>{H.pickDialog(e,k),H.structDialog(e,k),H.propDialog(e,k)}):Promise.resolve())))}()});
//# sourceMappingURL=kwdatatable.js.map
