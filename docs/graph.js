// https://github.com/mojaie/kiwiii-client Version 0.7.0. Copyright 2017 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("d3"),require("pako"),require("Dexie"),require("vega"),require("jLouvain")):"function"==typeof define&&define.amd?define(["d3","pako","Dexie","vega","jLouvain"],t):t(e.d3,e.pako,e.Dexie,e.vega,e.jLouvain)}(this,function(e,t,n,s,r){"use strict";function o(t){return e.select(t).node().value}function l(t){return parseFloat(e.select(t).node().value)}function a(t){return e.select(t).node().checked}function i(t){const n=e.select(t).property("selectedIndex");return e.select(t).selectAll("option").data().find((e,t)=>t===n)}function c(e){let t=Be.find(t=>t.name===e.scale).func,n=e.domain;if(3===e.range.length){const t=(parseFloat(e.domain[0])+parseFloat(e.domain[1]))/2;n=[e.domain[0],t,e.domain[1]]}return"ordinal"!==e.scale&&(t=t.domain(n)),t=t.range(e.range),["linear","log"].includes(e.scale)&&(t=t.clamp(!0)),n=>{if(""===n||void 0===n||null===n)return e.unknown;if("ordinal"!==e.scale&&parseFloat(n)!=n)return e.unknown;if("log"===e.scale&&n<=0)return e.unknown;const s=t(n);return void 0===s?e.unknown:s}}function d(e){return["In progress","Queued","Aborting"].includes(e.status)}function u(e){return["In progress","Queued"].includes(e.status)}function h(e,t,n){return new Promise((s,r)=>{const o=new FileReader,l=t?e.slice(0,t):e;o.onload=(e=>s(e.target.result)),o.onerror=(e=>r(e)),n?o.readAsArrayBuffer(l):o.readAsText(l)})}function m(e,n){const s=n?t.inflate(e,{to:"string"}):e;return JSON.parse(s)}function p(e){const t=e.name.endsWith(".gz");return h(e,!1,t).then(e=>m(e,t))}function f(e){const t=e.endsWith(".gz");return fetch(e).then(e=>t?e.arrayBuffer():e.json()).then(e=>m(e,t))}function g(e,t){try{const n=window.URL.createObjectURL(new Blob([e])),s=document.createElement("a");s.download=t,s.href=n,s.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}function y(e,n,s=!0){const r=JSON.stringify(e);g(s?t.gzip(r):r,`${n}.json${s?".gz":""}`)}function b(e){return Ye[e]}function w(e,t){Ye[e]=t}function v(){return Je.get("chemical")}function x(){return Array.from(Je.values())}function k(e){return Fe.putResources(e)}function I(e){return Fe.getItemById(e)}function $(){const e=b("urlQuery");return e.hasOwnProperty("id")?Fe.getItemById(e.id):Promise.resolve()}function q(e,t=Ye.urlQuery.id){const n=e.hasOwnProperty("column")?e.column:e.columns;return Fe.updateItem(t,t=>{t.records.filter(t=>e.mapping.hasOwnProperty(t[e.key])).forEach(t=>{e.hasOwnProperty("column")?t[e.column.key]=e.mapping[t[e.key]]:e.columns.forEach((n,s)=>{t[n.key]=e.mapping[t[e.key]][s]})}),t.columns=t.columns.concat(n).unique("key"),t.lastUpdated=e.lastUpdated})}function C(e,t,n){return Fe.updateItem(e,e=>{e[t]=n})}function P(e){return Fe.putItem(e)}function R(e){return void 0===e?Promise.resolve():"Failure"===e.status?C(e.id,"status","Failure"):Fe.updateItem(e.id,t=>{const n={responseDate:e.responseDate,records:e.records,columns:e.columns,recordCount:e.recordCount,searchDoneCount:e.searchDoneCount,execTime:e.execTime,progress:e.progress,status:e.status};e.hasOwnProperty("lastUpdated")&&(n.lastUpdated=e.lastUpdated),Object.assign(t,n)})}function A(){"serviceWorker"in navigator&&!Ae?navigator.serviceWorker.register("sw.js").then(e=>{console.info("ServiceWorker registration successful with scope: ",e.scope)}).catch(e=>{console.info("ServiceWorker registration failed: ",e)}):Ae?console.info("Off-line mode is disabled for debugging"):console.info("Off-line mode is not supported");const e=Ge.templates().then(e=>{w("templates",e.templates)}),t=Ge.status().then(e=>{w("server",e)}),n=x().map(e=>e.getResources()).extendAsync().then(e=>k(e.map((e,t)=>(e.idx=t,e))));return Promise.all([e,t,n])}function O(){return"file:"===document.location.protocol?(console.info("Off-line mode (local file)"),w("onLine",!1),Promise.resolve()):"onLine"in navigator&&!navigator.onLine?(console.info("Off-line mode (no internet connection)"),w("onLine",!1),Promise.resolve()):fetch(`${Ge.baseURL}favicon.ico`).then(()=>(w("onLine",!0),A())).catch(()=>(console.info("Off-line mode (server not responding)"),w("onLine",!1),Promise.resolve()))}function D(t,n,s){e.select("#loading-circle").style("display","none"),t.hasOwnProperty("status")||(t.status="Completed"),e.select("title").text(t.name),e.select("#title").text(t.name),e.select("#refresh").text("Aborting"===t.status?"Abort requested":"Refresh").style("display",d(t)?"inline-block":"none"),e.select("#abort").style("display",u(t)?"inline-block":"none");const r={datatable:"entries found",connection:"connections created"}[t.format];e.select("#progress").text(`(${t.status} - ${t.recordCount} ${r} in ${t.execTime} sec.)`),"In progress"===t.status&&e.select("#progress").append("div").append("progress").attr("max",100).attr("value",t.progress).text(`${t.progress}%`),e.select("#refresh").on("click",n),e.select("#abort").on("click",()=>{e.select("#confirm-message").text("Are you sure you want to abort this calculation job?"),e.select("#confirm-submit").classed("btn-primary",!1).classed("btn-warning",!0).on("click",()=>{s()})}),console.info("Query"),console.info(t.query)}function z(){e.select("#new-data").style("display","none"),e.select("#loading-circle").style("display","none")}function S(){e.select("#data-control").style("display","none"),e.select("#nodedata").style("display","none"),e.select("#refresh").style("display","none"),e.select("#abort").style("display","none"),e.select("#loading-circle").style("display","none"),e.select("#status").selectAll("li").style("display","none")}function _(t,n){const s={scientific:".3e",si:".3s",rounded:".3r"};return"raw"===n?t:void 0===t||null===t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(s[n])(t):t}function L(e,t,n,s){const r=e.selectAll("option").data(t,n);r.exit().remove(),r.enter().append("option").merge(r).attr("value",n).text(s)}function B(t,n){e.select("#graphconfig-thld").attr("value",t.networkThreshold).attr("max",1).attr("min",t.query.threshold),e.select("#graphconfig-submit").on("click",()=>{const e=l("#graphconfig-thld");e<t.query.threshold||n(e)})}function j(t){e.select("#community-name").attr("value","comm_"),e.select("#community-submit").on("click",()=>{const e={name:o("#community-name"),nulliso:a("#community-nulliso")};t(e)})}function E(e,t,n,s){He.nodes(e).force("link").links(t),He.on("tick",n).on("end",s)}function T(){e.select("#graph-contents").selectAll(".node").attr("transform",e=>`translate(${e.x}, ${e.y})`);const t=He.alpha(),n=t<=He.alphaMin();e.select("#temperature").classed("progress-success",n).classed("progress-warning",!n).attr("value",n?1:1-t).text(n?1:1-t)}function F(){e.select("#graph-contents").selectAll(".link").attr("transform",e=>`translate(${e.source.x}, ${e.source.y})`).attr("visibility","visible"),e.select("#graph-contents").selectAll(".edge-line").attr("x1",0).attr("y1",0).attr("x2",e=>e.target.x-e.source.x).attr("y2",e=>e.target.y-e.source.y),e.select("#graph-contents").selectAll(".edge-label").attr("x",e=>(e.target.x-e.source.x)/2).attr("y",e=>(e.target.y-e.source.y)/2)}function U(e){const t={id:e,column:o(`#${e}-col`)},n=i(`#${e}-preset`);if("ordinal"===n.scale.scale)return t.scale=n.scale,t;t.scale={scale:o(`#${e}-scaletype`),domain:[o(`#${e}-domain-from`),o(`#${e}-domain-to`)],unknown:"#696969"};const s=[o(`#${e}-range-from`)];return a(`#${e}-range-enable-mid`)&&s.push(o(`#${e}-range-mid`)),s.push(o(`#${e}-range-to`)),t.scale.range=s,t}function Q(){const e=U("label");return e.text=o("#label-text"),e.size=o("#label-size"),e.visible=a("#label-visible"),e}function M(e){return{id:e,scale:{scale:o(`#${e}-scaletype`),domain:[o(`#${e}-domain-from`),o(`#${e}-domain-to`)],range:[o(`#${e}-range-from`),o(`#${e}-range-to`)],unknown:10}}}function V(){const e=M("size");return e.column=o("#size-col"),e}function X(){return{structure:{visible:a("#show-struct")}}}function N(){const e=M("edge");return e.visible=a("#edge-visible"),e.label={size:o("#edge-label-size"),visible:a("#edge-label-visible")},e}function W(t){e.selectAll(".node").select(".node-symbol").style("fill",e=>c(t.scale)(e[t.column]))}function Y(t){e.selectAll(".node").select(".node-symbol").attr("r",e=>c(t.scale)(e[t.column]))}function J(t){e.selectAll(".node").select(".node-label").attr("visibility",t?"inherit":"hidden")}function G(t){const n=i("#label-col");e.selectAll(".node").select(".node-label").text(e=>e.hasOwnProperty(t.text)?n.hasOwnProperty("digit")&&"raw"!==n.digit?_(e[t.text],n.digit):e[t.text]:"").attr("font-size",t.size).attr("visibility",t.visible?"inherit":"hidden").style("fill",e=>c(t.scale)(e[t.column]))}function H(t){e.selectAll(".node").select(".node-struct").attr("visibility",t.structure.visible?"inherit":"hidden").each((t,n,s)=>{const r=e.select(s[n]).select("svg").attr("width"),o=e.select(s[n]).select("svg").attr("height");e.select(s[n]).attr("transform",`translate(${-r/2},${-o/2})`)})}function K(e){Y(e.nodeSize),W(e.nodeColor),G(e.nodeLabel),H(e.nodeContent)}function Z(t){e.selectAll(".link").select(".edge-line").attr("visibility",t?"inherit":"hidden")}function ee(t){e.selectAll(".link").select(".edge-label").attr("visibility",t?"inherit":"hidden")}function te(t){e.selectAll(".link").select(".edge-line").style("stroke-width",e=>c(t.scale)(e.weight)),e.selectAll(".link").select(".edge-label").attr("font-size",t.label.size),Z(t.visible),ee(t.label.visible)}function ne(t,n){2===t.length?(e.select(`#${n}-range-from`).property("value",t[0]),e.select(`#${n}-range-enable-mid`).attr("checked",null),e.select(`#${n}-range-mid`).attr("disabled","disabled"),e.select(`#${n}-range-to`).property("value",t[1]),e.selectAll(`#${n}-range input`).attr("disabled",null)):3===t.length?(e.select(`#${n}-range-from`).property("value",t[0]),e.select(`#${n}-range-enable-mid`).attr("checked","checked"),e.select(`#${n}-range-mid`).property("value",t[1]),e.select(`#${n}-range-to`).property("value",t[2]),e.selectAll(`#${n}-range input`).attr("disabled",null)):e.selectAll(`#${n}-range input`).attr("disabled","disabled")}function se(t,n){e.select(`#${n}-scaletype`).property("value",t.scale);const s=t.hasOwnProperty("domain");e.selectAll(`#${n}-domain input`).attr("disabled",s?null:"disabled"),s&&(e.select(`#${n}-domain-from`).property("value",t.domain[0]),e.select(`#${n}-domain-to`).property("value",t.domain[1])),ne(t.range,n)}function re(t){const n=t.id;e.select(`#${n}-visible`).attr("checked",t.visible?"checked":null),e.select(`#${n}-text`).property("value",t.text),e.select(`#${n}-size`).property("value",t.size),e.select(`#${n}-col`).property("value",t.column),t.hasOwnProperty("label")&&(e.select(`#${n}-label-visible`).attr("checked",t.label.visible?"checked":null),e.select(`#${n}-label-size`).property("value",t.label.size)),se(t.scale,t.id)}function oe(){e.select("#show-struct").on("change",function(){const t=X();e.select("#main-control").datum(t),H(t)}).dispatch("change")}function le(t,n){e.select(`#${n}-col`).call(L,t,e=>e.key,e=>e.name),e.select(`#${n}-preset`).call(L,ze,e=>e.name,e=>e.name).on("change",function(){se(i(this).scale,n),e.select(`.${n}-update`).dispatch("change")}),e.select(`#${n}-palette`).call(L,Le,e=>e.name,e=>e.name).on("change",function(){ne(i(this).range,n),e.select(`.${n}-update`).dispatch("change")}),e.select(`#${n}-scaletype`).call(L,Be,e=>e.name,e=>e.name)}function ae(t){le(t.filter(e=>"none"!==e.sort),"color"),e.selectAll(".color-update").on("change",()=>{const t=U("color");e.select("#color-control").datum(t),re(t),W(t)}).dispatch("change")}function ie(t){const n=t.filter(e=>"none"!==e.sort);e.select("#label-text").call(L,n,e=>e.key,e=>e.name),le(n,"label"),e.select("#label-visible").on("change",function(){J(a(this),"label"),e.select(`.label-update`).dispatch("change")}),e.selectAll(".label-update").on("change",()=>{const t=Q();e.select("#label-control").datum(t),re(t),G(t)}).dispatch("change")}function ce(t,n){e.select(`#${n}-preset`).call(L,t,e=>e.name,e=>e.name).on("change",function(){se(i(this).scale,n),e.select(`.${n}-update`).dispatch("change")}),e.select(`#${n}-scaletype`).call(L,je,e=>e.name,e=>e.name)}function de(t){const n=t.filter(e=>"numeric"===e.sort);e.select(`#size-col`).call(L,n,e=>e.key,e=>e.name),ce(Se,"size"),e.selectAll(".size-update").on("change",()=>{const t=V("size");e.select("#size-control").datum(t),re(t),Y(t)}).dispatch("change")}function ue(){ce(_e,"edge"),e.select("#edge-visible").on("change",function(){Z(a(this)),ee(a(this)),e.select(`.edge-update`).dispatch("change")}),e.select("#edge-label-visible").on("change",function(){ee(a(this)),e.select(`.edge-update`).dispatch("change")}),e.selectAll(".edge-update").on("change",()=>{const t=N("edge");e.select("#edge-control").datum(t),re(t),te(t)}).dispatch("change")}function he(e,t){const n=e.selectAll(".node").data(t,e=>e.key);n.exit().remove();const s=n.enter().append("g").attr("class","node");s.append("circle").attr("class","node-symbol"),s.append("g").attr("class","node-struct"),s.append("text").attr("class","node-label");const r=s.merge(n);r.select(".node-symbol").attr("r",20).style("fill","#6c6"),r.select(".node-struct").attr("visibility","hidden").html(e=>e._structure),r.select(".node-label").attr("visibility","hidden").attr("x",0).attr("y",30).attr("font-size",16).attr("text-anchor","middle")}function me(e,t){const n=e.selectAll(".link").data(t,e=>`${e.source}_${e.target}`);n.exit().remove();const s=n.enter().append("g").attr("class","link");s.append("line").attr("class","edge-line"),s.append("text").attr("class","edge-label");const r=s.merge(n);r.select(".edge-line").style("stroke","#999").style("stroke-opacity",.6),r.select(".edge-label").attr("font-size",16).attr("text-anchor","middle").attr("visibility","hidden").text(e=>e.weight)}function pe(){He.alpha(0).stop(),e.selectAll(".node").each(e=>{e.fx=e.x,e.fy=e.y}),T(),F(),e.select("#stick-nodes").property("checked",!0),e.select("#graph-contents").selectAll(".link").attr("visibility","visible"),e.select("#graph-contents").selectAll(".node").call(et)}function fe(){e.selectAll(".node").each(e=>{e.fx=null,e.fy=null}),e.select("#stick-nodes").property("checked",!1),e.select("#graph-contents").selectAll(".link").attr("visibility","hidden"),e.select("#graph-contents").selectAll(".node").call(Ze)}function ge(){fe(),He.alpha(.1).restart()}function ye(){fe(),He.alpha(1).restart()}function be(e,t,n){const s=r().nodes(e).edges(t)();if(n.nulliso){const e={};Object.entries(s).forEach(t=>{e.hasOwnProperty(t[1])||(e[t[1]]=[]),e[t[1]].push(t[0])}),Object.entries(e).forEach(e=>{1===e[1].length&&(s[e[1][0]]=null)})}return s}function we(){return{nodePositions:e.selectAll(".node").data().map(e=>({x:e.x,y:e.y})),fieldTransform:e.zoomTransform(e.select("#graph-field").node()),nodeContent:e.select("#main-control").datum(),nodeColor:e.select("#color-control").datum(),nodeSize:e.select("#size-control").datum(),nodeLabel:e.select("#label-control").datum(),edge:e.select("#edge-control").datum()}}function ve(){return C(b("urlQuery").id,"snapshot",we()).then(()=>console.info("Snapshot saved"))}function xe(t){if(t.hasOwnProperty("nodeContent")&&(e.select("#main-control").datum(t.nodeContent),e.select("#show-struct").property("checked",!!t.nodeContent.structure.visible)),t.hasOwnProperty("nodeColor")&&(e.select("#color-control").datum(t.nodeColor),re(t.nodeColor)),t.hasOwnProperty("nodeSize")&&(e.select("#size-control").datum(t.nodeSize),re(t.nodeSize)),t.hasOwnProperty("nodeLabel")&&(e.select("#label-control").datum(t.nodeLabel),re(t.nodeLabel)),t.hasOwnProperty("edge")&&(e.select("#edge-control").datum(t.edge),re(t.edge)),t.hasOwnProperty("fieldTransform")){const n=t.fieldTransform,s=e.zoomIdentity.translate(n.x,n.y).scale(n.k);e.select("#graph-contents").attr("transform",s),e.select("#graph-field").call(Ke.transform,s)}t.hasOwnProperty("nodePositions")&&e.selectAll(".node").each((e,n)=>{e.x=t.nodePositions[n].x,e.y=t.nodePositions[n].y}),K(t)}function ke(){return $().then(e=>I(e.nodeTableId).then(t=>({edges:e,nodes:t})))}function Ie(){return ke().then(t=>{D(t.edges,Ce,Pe);const n=t.edges.records.filter(e=>e.weight>=t.edges.networkThreshold),s=e.format(".3e")(n.length/t.edges.searchCount);e.select("#edge-density").text(s),e.select("#network-thld").text(t.edges.networkThreshold),me(e.select("#graph-contents"),n),he(e.select("#graph-contents"),t.nodes.records),e.select("#show-struct").property("checked",!1),E(t.nodes.records,n,T,()=>{F(),ve()}),t.edges.hasOwnProperty("snapshot")?(xe(t.edges.snapshot),pe()):ye(),e.select("#graph-contents").style("opacity",1e-6).transition().duration(1e3).style("opacity",1)})}function $e(){return ke().then(t=>(t.nodes.records.forEach(e=>{delete e._mol}),B(t.edges,e=>C(t.edges.id,"networkThreshold",e).then(ve).then(Ie)),j(e=>{const n=be(t.nodes.records.map(e=>e._index),t.edges.records.filter(e=>e.weight>=t.edges.networkThreshold),{nulliso:e.nulliso});q({key:"_index",column:{key:e.name,name:e.name,sort:"numeric",visible:!0},mapping:n},t.nodes.id).then(()=>{const t=we();return t.nodeColor.column=e.name,t.nodeColor.scale=ze.find(e=>"Categories"===e.name).scale,C(b("urlQuery").id,"snapshot",t).then(()=>console.info("snapshot saved"))}).then($e)}),oe(),ae(t.nodes.columns),de(t.nodes.columns),ie(t.nodes.columns),ue(),e.select("#stick-nodes").on("change",function(){!0===a(this)?pe():ge()}),e.select("#nodetable").attr("href",`datatable.html?id=${t.edges.nodeTableId}`),e.select("#rename").on("click",()=>{e.select("#prompt-title").text("Rename table"),e.select("#prompt-label").text("New name"),e.select("#prompt-input").attr("value",t.edges.name),e.select("#prompt-submit").on("click",()=>{const e=o("#prompt-input");return C(t.edges.id,"name",e).then($).then(e=>D(e,Ce,Pe))})}),Ie()))}function qe(e){return $().then(t=>{if(!d(t))return;const n={id:t.id,command:e};return tt.getRecords(n).then(R)})}function Ce(){return qe("update").then(e=>{if(void 0!==e)return Ie()})}function Pe(){return qe("abort").then(e=>{if(void 0!==e)return Ie()})}function Re(e){return Promise.all([P(e.nodes),P(e.edges)]).then(()=>{window.location=`graph.html?id=${e.edges.id}`})}const Ae=!1;e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n,s=s&&s.hasOwnProperty("default")?s.default:s,r=r&&r.hasOwnProperty("default")?r.default:r;const Oe=e.schemeSet1.concat(e.schemeSet3,e.schemePastel2,e.schemeSet2),De=[20,80],ze=[{name:"Activity",scale:{scale:"log",domain:[1e-4,1e-6],range:["#708090","#7fffd4"],unknown:"#696969"}},{name:"Percent",scale:{scale:"linear",domain:[0,100],range:["#708090","#7fffd4"],unknown:"#696969"}},{name:"True or False",scale:{scale:"quantize",domain:[1,0],range:["#708090","#7fffd4"],unknown:"#696969"}},{name:"LogP",scale:{scale:"linear",domain:[-2,8],range:["#6495ed","#ccff66","#ffa500"],unknown:"#696969"}},{name:"Categories",scale:{scale:"ordinal",range:e.schemeCategory20,unknown:"#dedede"}},{name:"ManyCategories",scale:{scale:"ordinal",range:Oe,unknown:"#dedede"}}],Se=[{name:"Activity",scale:{scale:"log",domain:[1e-4,1e-6],range:De,unknown:De[0]}},{name:"Percent",scale:{scale:"linear",domain:[0,100],range:De,unknown:De[0]}},{name:"True or False",scale:{scale:"quantize",domain:[1,0],range:De,unknown:De[0]}},{name:"LogP",scale:{scale:"linear",domain:[-2,6],range:De,unknown:De[0]}}],_e=[{name:"Universal",scale:{scale:"linear",domain:[.3,1],range:[.5,5],unknown:1}},{name:"Thin",scale:{scale:"linear",domain:[.5,1],range:[.5,3],unknown:1}},{name:"Amplified",scale:{scale:"linear",domain:[.5,1],range:[1,10],unknown:1}}],Le=[{name:"Aquamarine",range:["#778899","#7fffd4"],unknown:"#696969"},{name:"Chartreuse",range:["#778899","#7fff00"],unknown:"#696969"},{name:"Salmon",range:["#778899","#fa8072"],unknown:"#696969"},{name:"Violet",range:["#778899","#ee82ee"],unknown:"#696969"},{name:"blue-red",range:["#87ceeb","#fff5ee","#fa8072"],unknown:"#696969"},{name:"Spectrum",range:["#6495ed","#ccff66","#ffa500"],unknown:"#696969"}],Be=[{name:"linear",func:e.scaleLinear()},{name:"log",func:e.scaleLog()},{name:"quantize",func:e.scaleQuantize()},{name:"ordinal",func:e.scaleOrdinal()}],je=[{name:"linear",func:e.scaleLinear()},{name:"log",func:e.scaleLog()},{name:"quantize",func:e.scaleQuantize()}],Ee={app:"key",items:"id, format, responseDate",resources:"idx, id"};let Te=new n("Store");Te.version(1).stores(Ee);var Fe={getAppSetting:function(e){return Te.app.where("key").equals(e).first().then(e=>{if(void 0!==e)return e.value})},putAppSetting:function(e,t){return Te.app.put({key:e,value:t})},getResources:function(){return Te.resources.orderBy("idx").toArray()},putResources:function(e){return Te.resources.bulkPut(e)},getAllItems:function(){return Te.items.orderBy("responseDate").reverse().toArray()},getItemsByFormat:function(e){return Te.items.where("format").equals(e).reverse().sortBy("responseDate")},getItemById:function(e){return Te.items.where("id").equals(e).first()},updateItem:function(e,t){return Te.items.where("id").equals(e).modify(t)},deleteItem:function(e){return Te.items.where("id").equals(e).delete()},putItem:function(e){return Te.items.put(e)},reset:function(){return Te.delete().then(()=>{(Te=new n("Store")).version(1).stores(Ee)})}};class Ue{constructor(){this.baseURL="",this.available=!1}xhrRequest(e,t=null,n={}){return new Promise((s,r)=>{const o=new XMLHttpRequest;o.open("method"in n?n.method:"POST",e),o.responseType="responseType"in n?n.responseType:"json",o.withCredentials="withCredentials"in n&&n.withCredentials,o.onload=(()=>{200!==o.status?r(o):s(o.response)}),o.send(t)})}now(){return(new Date).toString()}getResources(){}formatResult(e,t){return t.lastUpdated=this.now(),t}getRecords(){}getRecordsByCompound(){}getMapping(){}getGraphEdges(){}}class Qe extends Ue{constructor(){super(),this.baseURL="./",this.domain="activity",this.entities=[]}serializedRequest(e,t={}){const n=new FormData;return n.set("query",JSON.stringify(t)),fetch(`${this.baseURL}${e}`,{method:"post",body:n,credentials:"include"})}request(e,t={}){const n=new FormData;return new Map(Object.entries(t)).forEach((e,t)=>{Array.isArray(e)?e.forEach(e=>n.append(t,e)):n.set(t,e)}),fetch(`${this.baseURL}${e}`,{method:"post",body:n,credentials:"include"})}getResources(){return this.request("schema",{domain:this.domain}).then(e=>e.json()).then(e=>(e.resources.forEach(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.hasOwnProperty("method")||(e.method="sql"),e.visible=!0}),this.entities.push(e.entity)}),this.available=!0,e.resources))}getRecords(e){return this.serializedRequest("sql",e).then(e=>e.json()).then(e=>(e.domain=this.domain,e))}getRecordsByCompound(e){const t={method:"sql",targets:this.entities,key:"ID",values:[e],operator:"eq"};return this.getRecords(t)}getMapping(e,t){const n={method:"sql",targets:[t.entity],key:"ID",values:e,operator:"fm"};return this.serializedRequest("sql",n).then(e=>e.json()).then(e=>{const s={};return e.records.filter(e=>e.hasOwnProperty(t.dataColumn)).forEach(e=>{s[e.ID]=e[t.dataColumn]}),{key:n.key,column:t,mapping:s,lastUpdated:this.now()}})}status(){return this.request("server").then(e=>e.json())}templates(){return this.request("templates").then(e=>e.json())}strprev(e){return this.serializedRequest("strprev",e).then(e=>e.text())}exportExcel(e){return this.request("xlsx",e).then(e=>e.blob())}exportSDFile(e){return this.request("exportsdf",e).then(e=>e.text())}reportPreview(e){return this.request("reportprev",e).then(e=>e.json())}report(e){return this.request("report",e).then(e=>e.blob())}}class Me extends Qe{constructor(){super(),this.domain="chemical",this.hiddenColumns=["_mw","_mw_wo_sw","_formula","_logp","_nonH"]}formatResult(e,t){return 0===e.length?(t.columns.forEach(e=>{e.visible=!this.hiddenColumns.includes(e.key)}),t):(Array.prototype.push.apply(t.columns,e),t.hasOwnProperty("extraColumns")&&(Array.prototype.push.apply(t.columns,t.extraColumns),delete t.extraColumns),t.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.key===t.query.key?e.visible=!0:e.visible=!this.hiddenColumns.includes(e.key)}),t.lastUpdated=this.now(),t)}getResources(){return this.request("schema",{domain:this.domain}).then(e=>e.json()).then(e=>(e.resources.forEach(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.hasOwnProperty("method")||(e.method="chemsql"),e.visible=!0})}),this.available=!0,e.resources))}getRecords(e){let t;return t=e.hasOwnProperty("command")?"rows":e.hasOwnProperty("nodeTableId")?"graph":["chemsql","sql"].includes(e.method)?"sql":"compute",this.serializedRequest(t,e).then(e=>e.json()).then(e=>(e.domain=this.domain,e))}importSDF(e){return this.request("sdf",e).then(e=>e.json()).then(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.visible=!this.hiddenColumns.includes(e.key)});const t=new Date;return e.lastUpdated=t.toString(),e})}}class Ve extends Ue{constructor(){super(),this.resourceFile="screener_fitting.yaml",this.domain=null,this.baseURL=null}getResources(){const e=new FormData;return e.set("filename",this.resourceFile),fetch("source",{method:"post",body:e,credentials:"include"}).then(e=>e.json()).then(e=>{if(!e.hasOwnProperty("enabled")||!1!==e.enabled)return this.available=!0,this.domain=e.domain,this.baseURL=e.url,e.resources.map(t=>(t.domain=e.domain,t.entity=`${t.qcsRefId}:${t.layerIndex}`,delete t.qcsRefId,delete t.layerIndex,t.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.visible=!0}),t))})}request(e){return fetch(`${this.baseURL}${e}`,{method:"GET",credentials:"include"}).then(e=>e.json())}requestRecords(e){return this.request(e).then(e=>({records:e.compounds.map(e=>({ID:e.compoundId,qcsRefId:e.qcsRefId,layerIndex:e.layerIndex,drcPlot:e.fitting.drcPlot,AC50:e.fitting.linearAC50,hill:Math.round(100*e.fitting.hillCoefficient)/100}))}))}getRecords(e){const t=`/compounds?qcsRefIds=${e.qcsRefIds.join("%2C")}&layerIndices=${e.layerIndex-1}&fields=compoundId%2Cfitting.drcPlot%2Cfitting.linearAC50%2Cfitting.hillCoefficient`;return this.requestRecords(t)}getRecordsByCompound(e){const t=`/compounds?q=compoundId%3A${e}&fields=compoundId%2CqcsRefId%2ClayerIndex%2Cfitting.drcPlot%2Cfitting.linearAC50%2Cfitting.hillCoefficient`;return this.requestRecords(t)}getMapping(e,t){const n=t.entity.split(":"),s={qcsRefId:n[0],layerIndex:parseInt(n[1])};return this.getRecords(s).then(n=>{const s={};return n.records.filter(t=>e.includes(t.ID)).forEach(e=>{s[e.ID]=e[t.dataColumn]}),{key:"ID",column:t,mapping:s,lastUpdated:this.now()}})}getDrcPlot(e,t,n=-20,s=120){const r=`/${t}?width=180&height=180&title=compoundId&activityRangeMin=${n}&activityRangeMax=${s}`;return this.request(r)}getQcsInfo(e){const t=`/qcSessions?q=${e.map(e=>`qcsRefId:${e}`).join(" OR ")}`;return this.request(t).then(e=>e.qcSessions)}}class Xe extends Ve{constructor(){super(),this.resourceFile="screener_rawvalue.yaml"}getResources(){const e=new FormData;return e.set("filename",this.resourceFile),fetch("source",{method:"post",body:e,credentials:"include"}).then(e=>e.json()).then(e=>{if(!e.hasOwnProperty("enabled")||!1!==e.enabled)return this.available=!0,this.domain=e.domain,this.baseURL=e.url,e.resources.map(t=>(t.domain=e.domain,t.entity=`${t.qcsRefId}:${t.layerIndex}`,delete t.qcsRefId,delete t.layerIndex,t.columns.forEach(e=>{e.key="rawValue",e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.visible=!0}),t))})}requestRecords(e,t){return this.request(e).then(e=>({records:e.plates.filter(e=>e.wells.hasOwnProperty("compoundIds")).map(e=>e.wells.compoundIds.map((t,n)=>({ID:t,qcsRefId:e.qcsRefId,layerIndex:e.layerIndex,rawValue:e.wells.rawValues[n]})).filter(t)).extend()}))}getRecords(e){const t=`/plates?qcsRefIds=${e.qcsRefIds.join("%2C")}&layerIndices=${e.layerIndex-1}&limit=200&fields=wells.rawValues%2Cwells.compoundIds`;return this.requestRecords(t,e=>null!==e.ID)}getRecordsByCompound(e){const t=`/plates?q=wells.compoundIds%3A${e}&fields=wells.rawValues%2Cwells.compoundIds`;return this.requestRecords(t,t=>t.ID===e)}}class Ne extends Ve{constructor(){super(),this.resourceFile="screener_fitting_stub.yaml"}fittingStub(e){if("string"!=typeof e.qcsRefId)throw`${e.qcsRefId} is not a string`;if("number"!=typeof e.layerIndex)throw`${e.layerIndex} is not a number`;return[{ID:"DB00189",drcPlot:"dummy1",AC50:21e-7,hill:1.1,source:"target1_validation"},{ID:"DB00193",drcPlot:"dummy2",AC50:42e-7,hill:null,source:"target1_validation"},{ID:"DB00203",drcPlot:"dummy3",AC50:1e-5,hill:.9,source:"target1_validation"},{ID:"DB00865",drcPlot:"dummy4",AC50:8.8e-8,hill:2.1,source:"target1_validation"},{ID:"DB01143",drcPlot:"dummy5",AC50:"n.d.",hill:null,source:"target1_validation"},{ID:"DB01240",drcPlot:"dummy6",AC50:null,hill:null,source:"target1_validation"}]}getRecords(e){return Promise.resolve({records:this.fittingStub(e)})}getRecordsByCompound(e){const t=this.fittingStub({qcsRefId:"QCS-YYYY",layerIndex:1}).filter(t=>t.ID===e);return Promise.resolve({records:t})}qcsInfoStub(e){if(!Array.isArray(e))throw`${e} is not a string`;const t=[{layerIndex:0,name:"Activity%"},{layerIndex:1,name:"Background%"},{layerIndex:2,name:"Correction"}];return[{qcsRefId:"QCS-XXX0",name:"hoge",layers:t},{qcsRefId:"QCS-XXX1",name:"fuga",layers:t},{qcsRefId:"QCS-XXX2",name:"piyo",layers:t}]}getQcsInfo(e){return Promise.resolve(this.qcsInfoStub(e))}}class We extends Xe{constructor(){super(),this.resourceFile="screener_rawvalue_stub.yaml"}rawValueStub(e){if("string"!=typeof e.qcsRefId)throw`${e.qcsRefId} is not a string`;if("number"!=typeof e.layerIndex)throw`${e.layerIndex} is not a number`;return[{ID:"DB00189",rawValue:12.7,source:"target1_screen"},{ID:"DB00193",rawValue:43.6,source:"target1_screen"},{ID:"DB00203",rawValue:102.6,source:"target1_screen"},{ID:"DB00865",rawValue:-.6,source:"target1_screen"},{ID:"DB01143",rawValue:50,source:"target1_screen"},{ID:"DB01240",rawValue:null,source:"target1_screen"}]}getRecords(e){return Promise.resolve({records:this.rawValueStub(e)})}getRecordsByCompound(e){const t=this.rawValueStub({qcsRefId:"QCS-XXXX",layerIndex:1}).filter(t=>t.ID===e);return Promise.resolve({records:t})}}const Ye={onLine:!0,server:{},templates:{},urlQuery:{}};window.location.search.substring(1).split("&").map(e=>e.split("=")).forEach(e=>{Ye.urlQuery[e[0]]=e[1]});const Je=new Map(Object.entries({chemical:new Me,activity:new Qe,screenerrawvalue:new Xe,screenerfitting:new Ve,screenerrawvaluestub:new We,screenerfittingstub:new Ne})),Ge=v(),He=(v(),e.forceSimulation().force("link",e.forceLink().id(e=>e._index).distance(60).strength(1)).force("charge",e.forceManyBody().strength(-600).distanceMin(15).distanceMax(720)).force("collide",e.forceCollide().radius(90)).force("center",e.forceCenter(600,600)).force("x",e.forceX().strength(.002)).force("y",e.forceY().strength(.002)).stop()),Ke=e.zoom().on("zoom",()=>{e.select("#graph-contents").attr("transform",e.event.transform)}),Ze=e.drag().on("start",()=>{e.select("#graph-contents").selectAll(".link").attr("visibility","hidden"),e.event.active||He.alphaTarget(.1).restart()}).on("drag",t=>{t.fx=e.event.x,t.fy=e.event.y}).on("end",t=>{e.event.active||He.alphaTarget(0),t.fx=null,t.fy=null}),et=e.drag().on("drag",function(t){e.select(this).attr("transform",()=>`translate(${e.event.x}, ${e.event.y})`),t.x=e.event.x,t.y=e.event.y;const n=e.select("#graph-contents").selectAll(".link").filter(e=>[e.source.index,e.target.index].includes(this.__data__.index));n.attr("transform",e=>`translate(${e.source.x}, ${e.source.y})`).attr("visibility","visible"),n.select(".edge-line").attr("x1",0).attr("y1",0).attr("x2",e=>e.target.x-e.source.x).attr("y2",e=>e.target.y-e.source.y),n.select(".edge-label").attr("x",e=>(e.target.x-e.source.x)/2).attr("y",e=>(e.target.y-e.source.y)/2)}).on("end",()=>{F()}),tt=v();e.select("#export").on("click",()=>ke().then(e=>y(e,e.edges.name))),e.select("#graph-field").attr("viewBox",`0 0 1200 1200`).call(Ke),e.select("#snapshot").on("click",ve),e.select("#restart").on("click",ye),e.select("#import-json").on("click",()=>document.getElementById("select-file").click()),e.select("#select-file").on("change",()=>{p(document.getElementById("select-file").files[0]).then(Re)}),b("urlQuery").hasOwnProperty("location")?f(b("urlQuery").location).then(e=>Promise.all([P(e.nodes),P(e.edges)]).then(()=>e.edges.id)).then(e=>{window.location=`graph.html?id=${e}`}):O().then(()=>b("urlQuery").hasOwnProperty("id")?(z(),qe("update").then($e)):(S(),Promise.resolve()))});
//# sourceMappingURL=graph.js.map
