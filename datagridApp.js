// https://github.com/mojaie/kiwiii Version 0.14.0. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("lodash"),require("Dexie"),require("pako"),require("vega")):"function"==typeof define&&define.amd?define(["d3","lodash","Dexie","pako","vega"],t):e.datagridApp=t(e.d3,e._,e.Dexie,e.pako,e.vega)}(this,function(e,t,s,a,o){"use strict";const n=!1;e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,s=s&&s.hasOwnProperty("default")?s.default:s,a=a&&a.hasOwnProperty("default")?a.default:a,o=o&&o.hasOwnProperty("default")?o.default:o;var l={defaultFieldProperties:function(e){return e.map(e=>(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),e))},sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id","assay_id","list"].includes(e)?"text":"none"},formatNum:function(t,s){return null==t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(s)(t):t},partialMatch:function(e,t){return null!=t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},URLQuery:function(){const e=window.location.search.substring(1).split("&").map(e=>e.split("="));return t.fromPairs(e)},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const r={items:"storeID, dataType, created"};let d=new s("Store");d.version(1).stores(r);var i={getAllItems:function(){return d.items.orderBy("created").reverse().toArray()},getItemsByDataType:function(e){return d.items.where("dataType").equals(e).reverse().sortBy("created").catch(t=>{console.error(`IDBError: Unexpected dataType: ${e}`,t)})},getItemByID:function(e){return d.items.where("storeID").equals(e).first().catch(t=>{console.error(`IDBError: Unexpected table ID: ${e}`,t)})},deleteItem:function(e){return d.items.where("storeID").equals(e).delete()},putItem:function(e){return e.storeID||(e.storeID=l.uuidv4()),d.items.put(e)},updateItem:function(e,t){return d.items.where("storeID").equals(e).modify(t).catch(e=>{console.error("IDBError: Update failed",e)})},reset:function(){return d.delete().then(()=>{(d=new s("Store")).version(1).stores(r)})}};const c="";var p={get:function(e,t={}){const s=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${c}${e}${s}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},json:function(e){return e.json()},text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${c}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null}};var u={serverStatus:function(){const e={};return p.get("server").then(p.json).then(t=>{e.server=t}).then(()=>p.get("schema")).then(p.json).then(t=>{e.schema=t}).catch(()=>{console.info("Server did not respond"),e.server={},e.schema={resources:[],templates:[],compoundIDPlaceholder:null}}).then(()=>e)},fetchProgress:function(e,t="update"){return i.getItemByID(e).then(s=>{if(!s)return Promise.reject(`Store: ${e} is not available`);if(!["ready","running"].includes(s.status))return;const a={id:s.reference.workflow,command:t};return p.get("progress",a).then(p.json).then(t=>"failure"===t.status?i.updateItem(e,e=>{e.status="failure"}):i.updateItem(e,e=>{e.status=t.status,e.progress=t.progress,e.execTime=t.execTime,e.fields=l.defaultFieldProperties(t.fields),e.records=t.records}))})}};function m(e,t,s){return new Promise((a,o)=>{const n=new FileReader,l=t?e.slice(0,t):e;n.onload=(e=>a(e.target.result)),n.onerror=(e=>o(e)),s?n.readAsArrayBuffer(l):n.readAsText(l)})}function f(e,t){const s=t?a.inflate(e,{to:"string"}):e;return JSON.parse(s)}function h(e,t){try{const s=window.URL.createObjectURL(new Blob([e])),a=document.createElement("a");a.download=t,a.href=s,a.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}var y={readFile:m,parseJSON:f,loadJSON:function(e){const t=e.name.endsWith("c")||e.name.endsWith(".gz");return m(e,!1,t).then(e=>f(e,t))},fetchJSON:function(e){const t=decodeURIComponent(e),s=t.endsWith("c")||t.endsWith(".gz");return fetch(t).then(e=>s?e.arrayBuffer():e.json()).then(e=>f(e,s))},downloadDataFile:h,downloadJSON:function(e,t,s=!0){const o=JSON.stringify(e),n=s?"c":"r";h(s?a.gzip(o):o,`${t}${e.hasOwnProperty("edges")?`.gf${n}`:`.nd${n}`}`)}};const g={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},b={datatable:"nodes",connection:"edges"};function x(e){const t=e.columns.map(e=>("numeric"===e.sort?e.format="numeric":"text"===e.sort?e.format="text":"none"===e.sort&&(e.format="raw"),e));return{id:e.id,name:e.name,dataType:b[e.format],schemaVersion:.8,revision:0,status:g[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function v(e){return{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:e.query,progress:e.progress,execTime:e.execTime,created:e.created,reference:{}}}var w={convertTable:function(e){let t=e;return t.hasOwnProperty("schemaVersion")||t.hasOwnProperty("$schema")||(t=x(t)),"0.8"==t.schemaVersion&&(t=v(t=function(e){return e.records.forEach((e,t)=>{e.index=t,e.structure=e._structure,delete e._index,delete e._structure}),e.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")}),e}(t))),t.hasOwnProperty("$schema")||(delete t.schemaVersion,delete t.revision,t.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),t.fields.forEach(e=>{"structure"===e.key&&(e.format="svg"),delete e.width,delete e.height}),t},convertNetwork:function(t){let s=t;return s.edges.hasOwnProperty("schemaVersion")||s.edges.hasOwnProperty("$schema")||(s.nodes=x(s.nodes),s.edges=function(e,t){const s={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(s.nodeColor.id=e.snapshot.nodeColor.id,s.nodeColor.scale=e.snapshot.nodeColor.scale,s.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):s.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(s.nodeSize.id=e.snapshot.nodeSize.id,s.nodeSize.scale=e.snapshot.nodeSize.scale,s.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):s.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(s.nodeLabel.id=e.snapshot.nodeLabel.id,s.nodeLabel.size=e.snapshot.nodeLabel.size,s.nodeLabel.text=e.snapshot.nodeLabel.text,s.nodeLabel.visible=e.snapshot.nodeLabel.visible,s.nodeLabel.scale=e.snapshot.nodeLabel.scale,s.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):s.nodeLabel={id:"label",size:12,text:"index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?s.nodeContent=e.snapshot.nodeContent:s.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?s.edge=e.snapshot.edge:s.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:b[e.format],schemaVersion:.8,revision:0,reference:{nodes:e.nodeTableId},status:g[e.status],fields:l.defaultFieldProperties([{key:"source"},{key:"target"},{key:"weight"}]),records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:s}}(s.edges,s.nodes.fields)),"0.8"!=s.edges.schemaVersion&&.1!==s.edges.schemaVersion||((s=function(e){if(e.edges.hasOwnProperty("reference")||(e.edges.reference={nodes:e.edges.nodesID}),e.nodes.fields.find(e=>"_index"===e.key)){const t={};e.nodes.records.forEach((e,s)=>{e.index=s,e.structure=e._structure,t[e._index]=e.index,delete e._index,delete e._structure}),e.edges.records.forEach(e=>{e.source=t[e.source],e.target=t[e.target]}),e.nodes.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")})}return e}(s)).nodes=v(s.nodes),s.edges=function(t){const s={networkThreshold:t.networkThreshold};return s.nodeContentVisible=t.snapshot.nodeContent.structure.visible,s.nodeColor=t.snapshot.nodeColor.scale||{},s.nodeColor.field&&(s.nodeColor.field=t.snapshot.nodeColor.field.key,"_index"===s.nodeColor.field&&(s.nodeColor.field="index")),"ordinal"===s.nodeColor.scale&&(s.nodeColor.range=e.schemeCategory20),s.nodeSize=t.snapshot.nodeSize.scale||{},t.snapshot.nodeSize.field&&(s.nodeSize.field=t.snapshot.nodeSize.field.key,"_index"===s.nodeSize.field&&(s.nodeSize.field="index")),s.nodeLabel={},t.snapshot.nodeLabel.text&&(s.nodeLabel.text=t.snapshot.nodeLabel.text.key,"_index"===s.nodeLabel.text&&(s.nodeLabel.text="index")),s.nodeLabel.size=t.snapshot.nodeLabel.size,s.nodeLabel.visible=t.snapshot.nodeLabel.visible,s.nodeLabelColor=t.snapshot.nodeLabel.scale||{},t.snapshot.nodeLabel.field&&(s.nodeLabelColor.field=t.snapshot.nodeLabel.field.key,"_index"===s.nodeLabelColor.field&&(s.nodeLabelColor.field="index")),"ordinal"===s.nodeLabelColor.scale&&(s.nodeLabelColor.range=e.schemeCategory20),s.edgeVisible=t.snapshot.edge.visible,s.edgeWidth=t.snapshot.edge.scale||{},s.edgeLabel={},s.edgeLabel.size=t.snapshot.edge.label.size,s.edgeLabel.visible=t.snapshot.edge.label.visible,s.networkThreshold=t.networkThreshold||t.query.threshold,s.coords=t.snapshot.nodePositions,{id:t.id,name:t.name,dataType:t.dataType,schemaVersion:"0.10",revision:t.revision,status:t.status,fields:t.fields,records:t.records,query:{params:t.query},progress:t.progress,execTime:t.execTime,created:t.created,snapshot:s,reference:t.reference}}(s.edges)),s.edges.hasOwnProperty("$schema")||(delete s.nodes.schemaVersion,delete s.edges.schemaVersion,delete s.nodes.revision,delete s.edges.revision,s.nodes.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json",s.edges.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),s}};function k(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}var B={singleToMulti:k,mappingToTable:function(e){const t=e.hasOwnProperty("field")?k(e):e,s={key:t.key,format:"text"};return{fields:l.defaultFieldProperties([s].concat(t.fields)),records:Object.entries(t.mapping).map(e=>{const s={};return s[t.key]=e[0],t.fields.forEach((t,a)=>{s[t.key]=e[1][a]}),s})}},tableToMapping:function(e,t,s=["index"]){const a={created:(new Date).toString(),fields:l.defaultFieldProperties(e.fields.filter(e=>e.key!==t).filter(e=>!s.includes(e.key))),key:t,mapping:{}};return e.records.forEach(e=>{a.mapping[e[t]]=a.fields.map(t=>e[t.key])}),a},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),s=t.shift().split(","),a=s.shift(),o=new Date,n=[],r=[];s.forEach((e,t)=>{""!==e&&(n.push(t),r.push({key:e,format:"text"}))});const d={created:o.toString(),fields:l.defaultFieldProperties(r),key:a,mapping:{}};return t.forEach(e=>{const t=e.split(","),s=t.shift();d.mapping[s]=Array(n.length),n.forEach(e=>{d.mapping[s][e]=t[e]})}),d},apply:function(e,s){const a=s.hasOwnProperty("field")?k(s):s;e.records.filter(e=>a.mapping.hasOwnProperty(e[a.key])).forEach(e=>{a.fields.forEach((t,s)=>{e[t.key]=a.mapping[e[a.key]][s]})}),e.fields=t(e.fields).concat(l.defaultFieldProperties(a.fields)).uniqBy("key").value()}};var T={registerServiceWorker:function(){"serviceWorker"in navigator?navigator.serviceWorker.register("sw.js").then(e=>{console.info("ServiceWorker registration successful with scope: ",e.scope)}).catch(e=>{console.info("ServiceWorker registration failed: ",e)}):console.info("Off-line mode is not supported")}};var S={buttonBox:function(e,t,s,a){e.classed("form-group",!0).classed("mb-1",!0).append("button").classed("btn",!0).classed(`btn-${a}`,!0).classed("btn-sm",!0).attr("id",t).text(s)},menuButton:function(e,t,s,a){e.classed("btn",!0).classed(`btn-${s}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("id",a).text(t)},menuButtonLink:function(e,t,s,a,o){e.classed("btn",!0).classed(`btn-${s}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("role","button").attr("href","#").attr("id",o),e.append("img").attr("src",a?`./assets/icon/${a}.svg`:null).style("width","1.25rem").style("height","1.25rem"),e.append("span").style("vertical-align","middle").text(t)},menuModalLink:function(e,t,s,a,o,n){e.classed("btn",!0).classed(`btn-${a}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("id",n).attr("href","#").attr("role","button").attr("data-toggle","modal").attr("data-target",`#${t}`),e.append("img").attr("src",o?`./assets/icon/${o}.svg`:null).style("width","1.25rem").style("height","1.25rem"),e.append("span").classed("label",!0).style("vertical-align","middle").text(s)},dropdownMenuButton:function(e,t,s,a,o){e.classed("btn-group",!0).classed("mr-1",!0).attr("id",o);const n=e.append("button").classed("btn",!0).classed(`btn-${s}`,!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown");n.append("img").attr("src",a?`./assets/icon/${a}.svg`:null).style("width","1.25rem").style("height","1.25rem"),n.append("span").style("vertical-align","middle").text(t),e.append("div").classed("dropdown-menu",!0)},dropdownMenuItem:function(e,t,s,a){e.classed("dropdown-item",!0).attr("id",a).attr("href","#"),e.append("img").attr("src",s?`./assets/icon/${s}.svg`:null).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuModal:function(e,t,s,a,o){e.classed("dropdown-item",!0).attr("id",o).attr("href","#").attr("data-toggle","modal").attr("data-target",`#${s}`),e.append("img").attr("src",`./assets/icon/${a}.svg`).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuFile:function(t,s,a,o,n){t.classed("dropdown-item",!0).attr("id",n).attr("href","#").on("click",function(){e.select(this).select("input").node().click()}),t.append("form").style("display","none").append("input").attr("type","file").attr("accept",a),t.append("img").attr("src",`./assets/icon/${o}.svg`).classed("mr-1",!0).style("width","2rem").style("height","2rem"),t.append("span").text(s)},dropdownMenuFileValue:function(e){return e.select("input").node().files[0]}};function C(e,t){e.classed("modal",!0).attr("tabindex",-1).attr("role","dialog").attr("aria-labelledby","").attr("aria-hidden",!0).attr("id",t),e.select(".modal-dialog").remove(),e.append("div").classed("modal-dialog",!0).attr("role","document").append("div").classed("modal-content",!0)}var O={confirmDialog:function(t,s,a){const o=t.call(C,s).select(".modal-content");o.append("div").classed("modal-body",!0).append("div").classed("message",!0).text(a);const n=o.append("div").classed("modal-footer",!0);n.append("button").classed("btn",!0).classed("btn-outline-secondary",!0).classed("cancel",!0).attr("type","button").attr("data-dismiss","modal").text("Cancel"),n.append("button").classed("btn",!0).classed("btn-warning",!0).classed("ok",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${s}-submit`).text("OK").on("click",()=>{e.select("#loading-icon").style("display","inline"),t.dispatch("submit")})},submitDialog:function(t,s,a){const o=t.call(C,s).select(".modal-content"),n=o.append("div").classed("modal-header",!0);n.append("h4").classed("modal-title",!0).text(a),n.append("button").attr("type","button").attr("data-dismiss","modal").attr("aria-label","Close").classed("close",!0).append("span").attr("aria-hidden",!0).html("&times;"),o.append("div").classed("modal-body",!0),o.append("div").classed("modal-footer",!0).append("button").classed("btn",!0).classed("btn-primary",!0).classed("submit",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${s}-submit`).text("Submit").on("click",()=>{e.select("#loading-icon").style("display","inline"),t.dispatch("submit")})}};function D(e,t){const s=e.select("select").selectAll("option").data(t,e=>e.key);s.exit().remove(),s.enter().append("option").attr("value",e=>e.key).text(e=>e.name)}function L(e,t){e.select("select").property("value",t)}function _(e,t){const s=e.select("ul").selectAll("li").data(t,e=>e.key);s.exit().remove();const a=s.enter().append("li").attr("class","form-check").append("label").attr("class","form-check-label");a.append("input").attr("type","checkbox").attr("class","form-check-input").property("value",e=>e.key),a.append("span").text(e=>e.name)}function F(t,s){s&&t.selectAll("input").each(function(t){e.select(this).property("checked",s.includes(t.key))})}var P={selectBox:function(e,t,s,a,o){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(s),e.append("select").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t),a&&(e.call(D,a),e.call(L,o))},selectBoxItems:D,updateSelectBox:L,selectBoxValue:function(e){return e.select("select").property("value")},checklistBox:function(e,t,s,a,o){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(s),e.append("ul").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t),a&&(e.call(_,a),e.call(F,o))},checklistBoxItems:_,updateChecklistBox:F,checklistBoxValue:function(e){return e.selectAll("input:checked").data().map(e=>e.key)}};function V(e,t,s){const a=e.select("thead tr").selectAll("th").data(t);a.exit().remove(),a.enter().append("th").text(e=>e.name),s&&e.call(I,s,e=>e.key,function(e){return(t,s)=>{e.forEach(e=>{const a=s[e.key],o=t.append("td").classed("align-middle",!0);void 0!==a&&("d3_format"===e.format?o.text(l.formatNum(a,e.d3_format)):"plot"===e.format?o.text("[plot]"):"image"===e.format?o.text("[image]"):"control"===e.format?o.call(a):o.text(a))})}}(t))}function I(t,s,a,o){const n=t.select("tbody").selectAll("tr").data(s,a);n.exit().remove(),n.enter().append("tr").merge(n).each(function(t){e.select(this).selectAll("td").remove(),e.select(this).call(o,t)})}var M={render:function(e,t,s,a,o){e.classed("table",!0).classed("table-striped",!0).classed("table-hover",!0).attr("id",t),s&&e.append("caption").text(s),e.append("thead").append("tr"),e.append("tbody"),a&&e.call(V,a,o)},updateHeader:V,updateContents:I};const z="fieldconf-dialog",R="Column setting";function N(e,t){e.append("td").classed("name",!0).text(t.name),e.append("td").classed("visible",!0).append("input").attr("type","checkbox").property("checked",t.visible);const s=["text","numeric","d3_format","raw","compound_id"],a=(s.includes(t.format)?s:[t.format]).map(e=>({key:e,name:e})),o=e.append("td").classed("format",!0),n=o.append("select");o.call(P.selectBoxItems,a),n.property("disabled",!s.includes(t.format)).property("value",t.format),e.append("td").classed("d3format",!0).append("input").attr("size",10).property("disabled","d3_format"!==t.format||null).property("value",t.d3_format||null),n.on("change",function(){e.select(".d3format").select("input").property("disabled","d3_format"!==this.value)})}var j={menuLink:function(e){e.call(S.dropdownMenuModal,R,z,"edittable")},updateRowFunc:N,body:function(e){const t=l.defaultFieldProperties([{key:"name",format:"text"},{key:"visible",format:"control"},{key:"format",format:"control"},{key:"d3_format",format:"control"}]);e.call(O.submitDialog,z,R).select(".modal-body").append("table").classed("field",!0).call(M.render,null,null,t)},updateBody:function(e,t){e.select(".field").call(M.updateContents,t.data.fields.slice(),e=>e.key,N)},value:function(t){const s=[];return t.select("tbody").selectAll("tr").each(function(t){const a=function(e){const t={};return t.visible=e.select(".visible").select("input").property("checked"),t.format=e.select(".format").select("select").property("value"),"d3_format"===t.format&&(t.d3_format=e.select(".d3format").select("input").property("value")),t}(e.select(this));a.key=t.key,a.name=t.name,s.push(a)}),s}};var A={plotCell:function(e,t,s){new o.View(o.parse(t[s.key])).initialize(e.node()).run()},plotThumbnail:function(e){return new o.View(o.parse(e)).toImageURL("png")},binaryToDataURI:function(e){return new Promise(t=>{const s=new FileReader;s.onload=(e=>{t(e.target.result)}),s.readAsDataURL(e)})}};function q(e,t,s){e.text(l.formatNum(t[s.key],s.d3_format))}function E(e,t,s){e.text(t[s.key])}function H(e,t,s){e.html(t[s.key])}function J(e,t,s){e.append("a").attr("href",`profile.html?compound=${t[s.key]}`).attr("target","_blank").text(t[s.key])}function U(e,t,s){e.append("img").attr("width",180).attr("height",180).attr("src",t[s.key])}function G(e,t,s){e.append("input").attr("type","checkbox").property("checked",t[s.key]).property("disabled",!!s.disabled&&t[s.disabled]).on("click",function(){t[s.key]=this.checked})}function W(e,t,s){e.append("input").attr("type","text").style("width","90%").property("value",t[s.key]).on("change",function(){t[s.key]=this.value})}function Q(e,t){e.call(t)}const K={numeric:E,text:E,raw:E,d3_format:q,compound_id:J,assay_id:E,list:E,plot:A.plotCell,image:U,checkbox:G,text_field:W,control:Q,svg:H,html:H};var X={d3Format:q,text:E,html:H,compound_id:J,image:U,checkbox:G,textField:W,call:Q,rowFactory:function(e){return(t,s)=>{e.forEach(e=>{const a=t.append("div").classed("dg-cell",!0).classed("align-middle",!0).classed("text-truncate",!0).style("display","inline-block").style("width",`${e.width}%`);s.hasOwnProperty(e.key)&&a.call(K[e.format],s,e)})}}};class Y{constructor(e){this.data=e,this.visibleFields=null,this.sortedRecords=null,this.filteredRecords=null;const t=this.data.snapshot||{sortOrder:[],filterText:null};this.sortOrder=t.sortOrder||[],this.filterText=t.filterText||null,this.defaultColumnHeight={numeric:40,text:40,none:200},this.scrollBarSpace=20,this.keyFunc=(e=>e.index),this.rowHeight=null,this.contentWidth=null,this.bodyHeight=null,this.viewportHeight=null,this.numViewportRows=null,this.previousNumViewportRows=null,this.viewportTop=null,this.previousVieportTop=null,this.viewportBottom=null,this.currentScrollTop=0,this.fixedViewportHeight=null,this.updateContentsNotifier=null,this.updateFilterNotifier=null,this.rowFactory=(()=>X.rowFactory(this.visibleFields)),this.applyData()}setViewportSize(e){this.viewportHeight=this.fixedViewportHeight||e,this.previousNumViewportRows=this.numViewportRows,this.numViewportRows=Math.ceil(this.viewportHeight/this.rowHeight)+1}setScrollPosition(e){this.previousViewportTop=this.viewportTop,this.viewportTop=e,this.viewportBottom=Math.min(this.viewportTop+this.numViewportRows,this.filteredRecords.length)}setSortOrder(e,t){const s=this.sortOrder.findIndex(e=>e.key),a={key:e,order:t};-1!==s&&this.sortOrder.splice(s,1),this.sortOrder.splice(0,0,a),this.applyOrder(e,t)}setFilterText(e){this.filterText=e,this.applyFilter()}joinFields(e){B.apply(this.data,e),this.applyData()}applyData(){this.visibleFields=this.data.fields.filter(e=>e.visible);const e=this.visibleFields.reduce((e,t)=>e+(t.widthf||1),0);this.visibleFields=this.visibleFields.map(t=>{const s={width:(t.widthf||1)/e*100,height:t.height||this.defaultColumnHeight[l.sortType(t.format)]};return Object.assign(s,t)}),this.rowHeight=this.visibleFields.reduce((e,t)=>e.height>t.height?e:t).height,this.applyOrder()}applyOrder(e,s){if(e)this.sortedRecords=t.orderBy(this.data.records.slice(),[e],[s]);else{const e=this.sortOrder.map(e=>e.key),s=this.sortOrder.map(e=>e.order);e&&(this.sortedRecords=t.orderBy(this.data.records.slice(),e,s))}this.applyFilter()}applyFilter(){if(null===this.filterText)this.filteredRecords=this.sortedRecords.slice();else{const e=this.visibleFields.filter(e=>"none"!==l.sortType(e.format)).map(e=>e.key);this.filteredRecords=this.sortedRecords.filter(t=>e.some(e=>l.partialMatch(this.filterText,t[e])))}this.bodyHeight=this.filteredRecords.length*this.rowHeight}recordsToShow(){return this.filteredRecords.slice(this.viewportTop,this.viewportBottom)}export(){return this.data.id=l.uuidv4(),this.data}}function Z(t,s){t.select(".dg-body").style("height",`${s.bodyHeight}px`);const a=t.select(".dg-body").selectAll(".dg-row").data(s.recordsToShow(),s.keyFunc);a.exit().remove(),a.enter().append("div").attr("class","dg-row").style("position","absolute").style("width","100%").merge(a).style("height",`${s.rowHeight}px`).each(function(t,a){const o=s.viewportTop+a,n=o*s.rowHeight;e.select(this).style("transform",`translate(0px, ${n}px)`).classed("odd",o%2==0),e.select(this).selectAll(".dg-cell").remove(),e.select(this).call(s.rowFactory(),t,o)})}var ee={updateHeader:function(e,t){const s=e.select(".dg-header");s.selectAll(".dg-hcell").remove(),s.selectAll(".dg-hcell").data(t.visibleFields).enter().append("div").classed("dg-hcell",!0).style("display","inline-block").style("width",e=>`${e.width}%`).text(e=>e.name),e.style("width","100%").dispatch("resize");const a=Math.floor(t.currentScrollTop/t.rowHeight);t.setScrollPosition(a),e.call(Z,t)},updateRows:Z,resizeViewport:function(e,t){e.select(".dg-viewport").style("height",`${t.viewportHeight}px`)}};function te(e,t){const s=e.select(".dg-viewport").node().getBoundingClientRect().top;t.setViewportSize(window.innerHeight-s-5),e.call(ee.resizeViewport,t)}var se={resize:te,datagrid:function(e,t){e.selectAll("div").remove(),e.on("resize",()=>e.call(te,t)),e.append("div").classed("dg-header",!0),e.append("div").classed("dg-viewport",!0).style("overflow-y","auto").on("scroll",function(){const s=Math.floor(this.scrollTop/t.rowHeight);t.currentScrollTop=this.scrollTop,s!==t.previousViewportTop&&(t.setScrollPosition(s),e.call(ee.updateRows,t))}).append("div").classed("dg-body",!0).style("position","relative"),t.updateContentsNotifier=(()=>{t.applyData(),e.call(ee.updateHeader,t)}),t.updateFilterNotifier=(s=>{t.setFilterText(s),t.setScrollPosition(0),e.call(ee.updateRows,t),e.select(".dg-viewport").node().scrollTop=0}),t.updateContentsNotifier()}};function ae(e,t){e.select("input").property("value",t)}function oe(e,t){e.select("textarea").property("value",t)}function ne(e,t){e.select("input").property("checked",t)}function le(e,t){e.select("input").property("value",t)}function re(e,t){e.select("input").property("value",t)}var de={textBox:function(e,t,s,a,o){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(s),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","text").attr("size",a),e.call(ae,o)},updateTextBox:ae,textBoxValue:function(e){return e.select("input").property("value")},readonlyBox:function(e,t,s,a){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(s),e.append("input").classed("form-control-plaintext",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","text").property("readonly",!0),e.call(ae,a)},textareaBox:function(e,t,s,a,o,n){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(s),e.append("textarea").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("rows",a).attr("placeholder",o).attr("id",t),e.call(oe,n)},updateTextareaBox:oe,textareaBoxValue:function(e){const t=e.select("textarea").property("value");if(t)return t;const s=e.select("textarea").attr("placeholder");return s||""},textareaBoxLines:function(e){const t=e.select("textarea").property("value");if(t)return t.split("\n").filter(e=>e.length>0);const s=e.select("textarea").attr("placeholder");return s?s.split("\n").filter(e=>e.length>0):[]},checkBox:function(e,t,s,a){const o=e.classed("form-group",!0).classed("form-row",!0).classed("form-check",!0).append("label").classed("form-check-label",!0).classed("col-form-label-sm",!0);o.append("input").classed("form-check-input",!0).attr("type","checkbox").attr("id",t),o.append("span").text(s),e.call(ne,a)},updateCheckBox:ne,checkBoxValue:function(e){return e.select("input").property("checked")},numberBox:function(e,t,s,a,o,n,l){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(s),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("id",t).attr("type","number").attr("min",a).attr("max",o).attr("step",n),e.call(le,l)},updateNumberBox:le,numberBoxValue:function(e){return e.select("input").property("value")},colorBox:function(t,s,a){t.classed("form-row",!0).classed("align-items-center",!0),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).text(s),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).append("input").classed("form-control",!0).classed("form-control-sm",!0).attr("type","color"),t.call(re,a).on("change",()=>{e.event.stopPropagation()})},updateColorBox:re,colorBoxValue:function(e){return e.select("input").property("value")},fileInputBox:function(e,t,s,a){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).attr("for",t).text(s),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",a).attr("id",t)},fileInputBoxValue:function(e){return e.select("input").property("files")[0]}};var ie={setFilter:function(e,t){const s=e.classed("row",!0).classed("justify-content-end",!0).append("div").classed("col-5",!0).call(de.textBox,null,"Search",40,null);s.select("label").classed("text-right",!0),s.select("input").on("keyup",function(){t.updateFilterNotifier(de.textBoxValue(s))})}};const ce="fieldfetch-dialog",pe="Append assays";let ue=null;var me={menuLink:function(e){e.call(S.dropdownMenuModal,pe,ce,"addassay")},body:function(e,s){const a=s.resources.filter(e=>"assay"===e.domain),o=t(a.map(e=>e.data)).flatten().flatMap(e=>e.value_types.map(t=>{const s=Object.assign({},e);return s.value_type=t.key,s})).value(),n={fields:l.defaultFieldProperties([{key:"check",name:"Check",format:"checkbox",widthf:.5,height:40,disabled:"check_d"},{key:"assay_id",name:"Assay ID",format:"assay_id"},{key:"name",name:"Name",format:"text"},{key:"value_type",name:"Value type",format:"text"},{key:"tags",name:"Tags",format:"list",widthf:2}]),records:o.map(e=>(e.check=!1,e))},r=e.call(O.submitDialog,ce,pe);r.select(".modal-dialog").classed("modal-lg",!0),ue=new Y(n);const d=r.select(".modal-body"),i=d.append("div").classed("fetchd-filter",!0),c=d.append("div").classed("fetchd-dg",!0);c.call(se.datagrid,ue),i.call(ie.setFilter,ue),ue.fixedViewportHeight=300,c.call(ee.resizeViewport,ue)},updateBody:function(e){ue.data.records.forEach(e=>{e.check&&(e.check_d=!0)}),ue.updateContentsNotifier()},queries:function(e,t,s){return ue.data.records.filter(e=>e.check&&!e.check_d).map(e=>({workflow:"activity",targets:t,assay_id:e.assay_id,condition:{compounds:s,value_types:[e.value_type]}}))}};const fe="fieldfile-dialog",he="Append JSON fields";var ye={menuLink:function(e){e.call(S.dropdownMenuModal,he,fe,"addfile")},body:function(e){const t=e.call(O.submitDialog,fe,he),s=t.select(".modal-body").append("div").classed("file",!0).call(de.fileInputBox,"fieldfile-file","File",".json,.csv"),a=t.select(".modal-body").append("div").classed("preview",!0).call(M.render);s.on("change",()=>{const e=de.fileInputBoxValue(s),t="csv"===e.name.split(".").pop();y.readFile(e).then(e=>{const s=t?B.csvToMapping(e):JSON.parse(e),o=B.mappingToTable(s);a.call(M.updateHeader,o.fields,o.records.slice(0,5))})})},readFile:function(e){const t=de.fileInputBoxValue(e.select(".file")),s="csv"===t.name.split(".").pop();return y.readFile(t).then(e=>{let t=s?B.csvToMapping(e):JSON.parse(e);t.hasOwnProperty("field")&&(t=B.singleToMulti(t));const a=[];if(t.fields.forEach((e,s)=>{"plot"===e.format&&(t.fields[s].format="image",a.push(s))}),a.length>0){const e=[];return Object.entries(t.mapping).forEach(s=>{a.forEach(a=>{const o=A.plotThumbnail(s[1][a]).then(e=>{t.mapping[s[0]][a]=e});e.push(o)})}),Promise.all(e).then(()=>t)}return t})}};const ge="fieldinput-dialog",be="Append input field";const xe={checkbox:!1,text_field:""};var ve={menuLink:function(e){e.call(S.dropdownMenuModal,be,ge,"addcheckbox")},body:function(e){const t=e.call(O.submitDialog,ge,be).select(".modal-body");t.append("div").classed("key",!0).call(de.textBox,null,"Field key",40,null),t.append("div").classed("type",!0).call(P.selectBox,null,"Type",[{key:"checkbox",name:"Checkbox"},{key:"text_field",name:"Text field"}],"checkbox")},updateBody:function(e){e.select(".key").call(de.updateTextBox,null),e.select(".type").call(P.updateSelectBox,"checkbox")},value:function(e){const t=de.textBoxValue(e.select(".key")),s=P.selectBoxValue(e.select(".type"));return{field:{key:t,name:t,format:s},default:xe[s]}}};function we(t){t.select(".format").on("change",function(){const s=P.selectBoxValue(e.select(this));t.select(".source").select("select").property("disabled","dbid"!==s),t.select(".textquery").property("hidden","dbid"!==s),t.select(".areaquery").property("hidden","molfile"!==s)}).dispatch("change"),t.select(".preview").on("click",function(){const s=ke(t);return p.get("strprev",s).then(p.text).then(t=>e.select("#previmg").html(t),p.error)})}function ke(e){const t=P.selectBoxValue(e.select(".format")),s=P.selectBoxValue(e.select(".source")),a=de.textBoxValue(e.select(".textquery")),o=de.textareaBoxLines(e.select(".areaquery"));return{format:t,source:"dbid"===t?s:null,value:"molfile"===t?o:a}}var Be={queryMolGroup:function(e,t,s){e.classed("mb-3",!0),e.append("div").classed("format",!0).classed("mb-1",!0).call(P.selectBox,`${t}-format`,"Format",[{key:"molfile",name:"MDL Molfile"},{key:"dbid",name:"Compound ID"}],"molfile");const a=s.map(e=>({key:e.id,name:e.name}));e.append("div").classed("source",!0).classed("mb-1",!0).call(P.selectBox,`${t}-source`,"Source",a,null),e.append("div").classed("textquery",!0).classed("mb-1",!0).call(de.textBox,`${t}-textquery`,"Query",null,""),e.append("div").classed("areaquery",!0).classed("mb-1",!0).call(de.textareaBox,`${t}-areaquery`,"Query",6,null,""),$(function(){$('[data-toggle="popover"]').popover({html:!0,trigger:"focus"})}),e.append("div").classed("form-row",!0).classed("justify-content-end",!0).append("button").classed("preview",!0).attr("data-toggle","popover").attr("data-html","true").attr("data-content",'<div id="previmg"></div>').call(S.menuButton,"Structure preview","primary"),e.call(we)},updateQueryMolGroup:we,queryMolGroupValue:ke,simOptionGroup:function(e,t){e.classed("mb-3",!0).append("p").append("button").classed("btn",!0).classed("btn-sm",!0).classed("btn-outline-primary",!0).classed("dropdown-toggle",!0).attr("data-toggle","collapse").attr("data-target",`#${t}-collapse`).attr("aria-expanded","false").attr("aria-controls",`${t}-collapse`).text("Optional parameters");const s=e.append("div").classed("collapse",!0).attr("id",`${t}-collapse`).append("div").classed("card",!0).classed("card-body",!0);s.append("div").classed("ignoreh",!0).classed("mb-1",!0).call(de.checkBox,`${t}-ignoreh`,"Ignore explicit hydrogens",!0),s.append("div").classed("timeout",!0).classed("mb-1",!0).call(de.numberBox,`${t}-timeout`,"Timeout",1,999,1,2),s.append("div").classed("diam",!0).classed("mb-1",!0).call(de.numberBox,`${t}-diam`,"Diameter (MCS-DR/GLS)",4,999,1,8),s.append("div").classed("tree",!0).classed("mb-1",!0).call(de.numberBox,`${t}-tree`,"Max tree size (MCS-DR/GLS)",20,999,1,40),s.selectAll("label.col-form-label").classed("col-4",!1).classed("col-6",!0),s.selectAll("input.form-control").classed("col-8",!1).classed("col-6",!0)},simOptionGroupValue:function(e){const t=e.select(".timeout"),s=e.select(".diam"),a=e.select(".tree"),o={ignoreHs:de.checkBoxValue(e.select(".ignoreh"))};return t.select("input").property("disabled")||(o.timeout=de.numberBoxValue(t)),s.select("input").property("disabled")||(o.diameter=de.numberBoxValue(s)),a.select("input").property("disabled")||(o.maxTreeSize=de.numberBoxValue(a)),o}};const Te="networkgen-dialog",Se="Generate similarity network";var Ce={menuLink:function(e){e.call(S.dropdownMenuModal,Se,Te,"network")},body:function(t,s){const a=t.call(O.submitDialog,Te,Se),o=[{key:"gls",name:"Graph-based local similarity(GLS)"}];s&&(o.push({key:"rdmorgan",name:"RDKit Morgan similarity"}),o.push({key:"rdfmcs",name:"RDKit FMCS"})),a.select(".modal-body").append("div").classed("measure",!0).call(P.selectBox,"networkgen-measure","Measure",o,"gls"),a.select(".modal-body").append("div").classed("thld",!0).call(de.numberBox,"networkgen-thld","Threshold",.5,1,.01,.5),a.select(".modal-body").append("div").classed("option",!0).call(Be.simOptionGroup,"networkgen"),a.select(".measure").on("change",function(){const t=P.selectBoxValue(e.select(this));a.selectAll(".diam, .tree").select("input").property("disabled","gls"!==t),a.select(".timeout").select("input").property("disabled",!["gls","rdfmcs"].includes(t))}).dispatch("change")},queryParams:function(e){const t=e.select(".measure"),s=e.select(".thld"),a=Be.simOptionGroupValue(e.select(".option"));return t.select("select").property("disabled")||(a.measure=P.selectBoxValue(t)),s.select("input").property("disabled")||(a.threshold=de.numberBoxValue(s)),a}};const Oe="rename-dialog",De="Rename";var Le={menuLink:function(e){e.call(S.dropdownMenuModal,De,Oe,"edittext")},body:function(e,t){e.call(O.submitDialog,Oe,De).select(".modal-body").append("div").classed("rename",!0).call(de.textBox,"rename","New name",40,t)},updateBody:function(e,t){e.select(".rename").call(de.updateTextBox,t.data.name)},value:function(e){return de.textBoxValue(e.select(".rename"))}};var _e={setFilter:function(e,t){const s=e.classed("row",!0).classed("justify-content-end",!0).append("div").classed("col-5",!0).call(de.textBox,null,"Search",40,null);s.select("label").classed("text-right",!0),s.select("input").on("keyup",function(){t.updateFilterNotifier(de.textBoxValue(s))})}};var $e={setSort:function t(s,a){s.select(".dg-header").selectAll(".dg-hcell").filter(e=>"none"!==l.sortType(e.format)).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",t=>{const o="v"===e.select(`#sort-${t.key}`).text();e.select(`#sort-${t.key}`).text(o?"^":"v"),a.setSortOrder(t.key,o?"desc":"asc"),s.call(ee.updateRows,a)}),a.updateContentsNotifier=(()=>{a.applyData(),s.call(ee.updateHeader,a).call(t,a)})}};function Fe(t,s,a){const o=e.select("#menubar");o.selectAll("div,span,a").remove();const n=e.select("#dialogs");n.selectAll("div").remove();const r=new Y(w.convertTable(t));r.serverStatus=s,r.resourceSchema=a;const d=o.append("div").call(S.dropdownMenuButton,"Datagrid","primary","table-white").select(".dropdown-menu");d.append("a").call(j.menuLink),d.append("a").classed("online-command",!0).call(me.menuLink),d.append("a").call(ye.menuLink),d.append("a").call(ve.menuLink),d.append("a").classed("online-command",!0).call(Ce.menuLink),d.append("a").call(Le.menuLink),d.append("a").call(S.dropdownMenuItem,"Save","save").on("click",function(){return r.data.storeID?i.updateItem(r.data.storeID,e=>{e.id=l.uuidv4(),e.name=r.data.name,e.fields=r.data.fields,e.records=r.data.records}).then(()=>console.info("Datagrid saved")):i.putItem(r.export()).then(e=>{window.location=`datagrid.html?id=${e}`})}),d.append("a").call(S.dropdownMenuItem,"Download JSON","export").on("click",()=>{const e=r.export();delete e.storeID,y.downloadJSON(e,e.name)}),d.append("a").classed("online-command",!0).call(S.dropdownMenuItem,"Download Excel","exportexcel").on("click",()=>{const e=r.export(),t=new FormData;return t.append("contents",new Blob([JSON.stringify(e)])),p.post("xlsx",t).then(p.blob).then(t=>y.downloadDataFile(t,`${e.name}.xlsx`))}),o.append("a").call(S.menuButtonLink,"Dashboard","outline-secondary","db-gray").attr("href","dashboard.html").attr("target","_blank"),o.append("a").classed("refresh",!0).call(S.menuButtonLink,"Refresh","outline-secondary","refresh-gray").on("click",function(){return u.fetchProgress(r.data.storeID).then(()=>i.getItemByID(r.data.storeID)).then(e=>{r.data=e,r.updateContentsNotifier(),Pe(r)})}),o.append("a").classed("abort",!0).call(S.menuButtonLink,"Abort server job","warning","delete-gray").attr("data-toggle","modal").attr("data-target","#abort-dialog"),o.append("span").classed("progress",!0).append("progress").attr("max",100),o.append("span").classed("title",!0),o.append("span").classed("status",!0),n.append("div").classed("fieldconfd",!0).call(j.body),n.append("div").classed("fieldfetchd",!0).call(me.body,a,r.fetchedAssays),n.append("div").classed("fieldfiled",!0).call(ye.body),n.append("div").classed("fieldinputd",!0).call(ve.body),n.append("div").classed("netgend",!0).call(Ce.body,s.rdkit),n.append("div").classed("renamed",!0).call(Le.body,r.data.name),n.append("div").classed("abortd",!0).call(O.confirmDialog,"abort-dialog","Are you sure you want to abort this calculation job?"),e.select("#datagrid").call(se.datagrid,r).call($e.setSort,r),e.select("#dg-search").call(_e.setFilter,r),e.select("#datagrid").dispatch("resize"),window.onresize=(()=>e.select("#datagrid").dispatch("resize")),Pe(r)}function Pe(t){e.select("#loading-icon").style("display","none"),e.select("title").text(t.data.name);const s=e.select("#menubar");s.select(".title").text(t.data.name),s.select(".status").text(`(${t.data.status} - ${t.data.records.length} records found in ${t.data.execTime} sec.)`),s.select(".progress").select("progress").attr("value",t.data.progress).text(`${t.data.progress}%`),t.serverStatus.instance||s.selectAll(".online-command").attr("data-target",null).classed("disabled",!0).on("click",null);const a=["running","ready"].includes(t.data.status);s.selectAll(".progress, .refresh, .abort").style("display",a?null:"none");const o=e.select("#dialogs");o.select(".fieldconfd").call(j.updateBody,t).on("submit",function(){t.data.fields=j.value(e.select(this)),t.updateContentsNotifier(),Pe(t)}),o.select(".fieldfetchd").call(me.updateBody).on("submit",function(){const s=t.resourceSchema.resources.filter(e=>"activity"===e.domain).map(e=>e.id),a=t.data.records.map(e=>e.compound_id),o=me.queries(e.select(this),s,a).map(e=>p.get(e.workflow,e).then(p.json).then(e=>B.tableToMapping(e,"compound_id",["index","assay_id"])));Promise.all(o).then(e=>{e.forEach(e=>t.joinFields(e)),t.updateContentsNotifier(),Pe(t)})}),o.select(".fieldfiled").on("submit",function(){return ye.readFile(e.select(this)).then(e=>{t.joinFields(e),t.updateContentsNotifier(),Pe(t)})}),o.select(".fieldinputd").on("submit",function(){const s=ve.value(e.select(this)),a=l.defaultFieldProperties([s.field])[0];t.data.fields.push(a),t.data.records.forEach(e=>{e[a.key]=s.default}),t.applyData(),t.updateContentsNotifier(),Pe(t)}),o.select(".netgend").on("submit",function(){const s=new FormData,a=Ce.queryParams(e.select(this));return s.append("params",JSON.stringify(a)),s.append("contents",new Blob([JSON.stringify(t.export())])),p.post(`${a.measure}net`,s).then(p.json).then(e=>(e.reference.nodes=t.data.storeID,e.fields=l.defaultFieldProperties(e.fields),e)).then(i.putItem).then(t=>{e.select("#loading-icon").style("display","none"),window.open(`network.html?id=${t}`,"_blank")})}),o.select(".renamed").call(Le.updateBody,t).on("submit",function(){t.data.name=Le.value(e.select(this)),Pe(t)}),o.select(".abortd").on("submit",function(){u.fetchProgress(t.data.storeID,"abort").then(()=>i.getItemByID(t.data.storeID)).then(e=>{t.data=e,t.updateContentsNotifier(),Pe(t)})})}return{run:function(){return document.location.protocol,"onLine"in navigator&&navigator.onLine,n?console.info("Off-line mode is disabled for debugging"):T.registerServiceWorker(),u.serverStatus().then(t=>{const s=l.URLQuery().id||null,a=l.URLQuery().location||null;s?u.fetchProgress(s,"update").then(()=>i.getItemByID(s)).then(e=>Fe(e,t.server,t.schema)):a?y.fetchJSON(a).then(e=>Fe(e,t.server,t.schema)):e.select("#datagrid").style("color","red").text("ERROR: invalid URL")})}}});
//# sourceMappingURL=datagridApp.js.map
